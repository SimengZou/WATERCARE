CREATE OR REPLACE VIEW DATAHUB_LANDING.VW_IPS_METERMANAGEMENT_WATER_WATERMETERANALYSIS AS SELECT
                        src:ADDBY::varchar AS ADDBY, 
                        src:ADDDTTM::datetime AS ADDDTTM, 
                        src:ADDRESS::varchar AS ADDRESS, 
                        src:ADDRESSKEY::integer AS ADDRESSKEY, 
                        src:ADDRESSKEY1::integer AS ADDRESSKEY1, 
                        src:APPROVE::varchar AS APPROVE, 
                        src:AUDITFLAG::varchar AS AUDITFLAG, 
                        src:BATCHKEY::integer AS BATCHKEY, 
                        src:COLORASSIGNMENTNEEDED::varchar AS COLORASSIGNMENTNEEDED, 
                        src:COMPAREBILLABLE::numeric(38, 10) AS COMPAREBILLABLE, 
                        src:COMPAREESTIMATEDFLAG::varchar AS COMPAREESTIMATEDFLAG, 
                        src:COMPAREHIGHBILLABLE::numeric(38, 10) AS COMPAREHIGHBILLABLE, 
                        src:COMPAREHIGHREADING::numeric(38, 10) AS COMPAREHIGHREADING, 
                        src:COMPAREHIGHUSAGE::numeric(38, 10) AS COMPAREHIGHUSAGE, 
                        src:COMPAREOPTION::integer AS COMPAREOPTION, 
                        src:COMPAREREADING::numeric(38, 10) AS COMPAREREADING, 
                        src:COMPAREREADINGDATE::datetime AS COMPAREREADINGDATE, 
                        src:COMPAREREADINGKEY::integer AS COMPAREREADINGKEY, 
                        src:COMPARETOTALBILLABLEUSAGE::numeric(38, 10) AS COMPARETOTALBILLABLEUSAGE, 
                        src:COMPARETOTALUSAGE::numeric(38, 10) AS COMPARETOTALUSAGE, 
                        src:COMPAREUSAGE::numeric(38, 10) AS COMPAREUSAGE, 
                        src:COMPAREUSAGEREADINGKEYS::varchar AS COMPAREUSAGEREADINGKEYS, 
                        src:CURRENTBILLABLE::numeric(38, 10) AS CURRENTBILLABLE, 
                        src:CURRENTCOMPKEY::integer AS CURRENTCOMPKEY, 
                        src:CURRENTESTIMATEDFLAG::varchar AS CURRENTESTIMATEDFLAG, 
                        src:CURRENTFIELDNOTES::varchar AS CURRENTFIELDNOTES, 
                        src:CURRENTHIGHBILLABLE::numeric(38, 10) AS CURRENTHIGHBILLABLE, 
                        src:CURRENTHIGHREADING::numeric(38, 10) AS CURRENTHIGHREADING, 
                        src:CURRENTHIGHUSAGE::numeric(38, 10) AS CURRENTHIGHUSAGE, 
                        src:CURRENTMETERID::varchar AS CURRENTMETERID, 
                        src:CURRENTREADING::numeric(38, 10) AS CURRENTREADING, 
                        src:CURRENTREADINGDATE::datetime AS CURRENTREADINGDATE, 
                        src:CURRENTREADINGKEY::integer AS CURRENTREADINGKEY, 
                        src:CURRENTTOTALBILLABLEUSAGE::numeric(38, 10) AS CURRENTTOTALBILLABLEUSAGE, 
                        src:CURRENTTOTALUSAGE::numeric(38, 10) AS CURRENTTOTALUSAGE, 
                        src:CURRENTUNITTYPE::varchar AS CURRENTUNITTYPE, 
                        src:CURRENTUSAGE::numeric(38, 10) AS CURRENTUSAGE, 
                        src:CURRENTUSAGEREADINGKEYS::varchar AS CURRENTUSAGEREADINGKEYS, 
                        src:DATALAKE_DELETED::boolean AS DATALAKE_DELETED, 
                        src:DEFAULTACTION::varchar AS DEFAULTACTION, 
                        src:EXCEPTION::varchar AS EXCEPTION, 
                        src:EXCEPTIONTYPE::integer AS EXCEPTIONTYPE, 
                        src:HIGHMULTIPLIER::numeric(38, 10) AS HIGHMULTIPLIER, 
                        src:INDEXNO::integer AS INDEXNO, 
                        src:ISPBCODESRVREQRESOLVED::varchar AS ISPBCODESRVREQRESOLVED, 
                        src:ISPBCODEWORESOLVED::varchar AS ISPBCODEWORESOLVED, 
                        src:ISPROBLEMCODEEXCEPTION::varchar AS ISPROBLEMCODEEXCEPTION, 
                        src:ISRDCODESRVREQRESOLVED::varchar AS ISRDCODESRVREQRESOLVED, 
                        src:ISRDCODEWORESOLVED::varchar AS ISRDCODEWORESOLVED, 
                        src:ISREADERCODEEXCEPTION::varchar AS ISREADERCODEEXCEPTION, 
                        src:ISREADINGAPPROVED::varchar AS ISREADINGAPPROVED, 
                        src:ISREREADRESOLVED::varchar AS ISREREADRESOLVED, 
                        src:KEYCOLUMN::varchar AS KEYCOLUMN, 
                        src:LOWMULTIPLIER::numeric(38, 10) AS LOWMULTIPLIER, 
                        src:MANUALREVIEWFLAG::varchar AS MANUALREVIEWFLAG, 
                        src:MODBY::varchar AS MODBY, 
                        src:MODDTTM::datetime AS MODDTTM, 
                        src:NOREADFLAG::varchar AS NOREADFLAG, 
                        src:OLDESTACCOUNTKEY::integer AS OLDESTACCOUNTKEY, 
                        src:OLDESTACCOUNTNO::varchar AS OLDESTACCOUNTNO, 
                        src:OTHERACTION::varchar AS OTHERACTION, 
                        src:PARENTKEY::integer AS PARENTKEY, 
                        src:POSITION::integer AS POSITION, 
                        src:PROBLEMCODE::varchar AS PROBLEMCODE, 
                        src:PROBLEMCODEBACKCOLOR::varchar AS PROBLEMCODEBACKCOLOR, 
                        src:PROBLEMCODESERVICEREQUESTNO::integer AS PROBLEMCODESERVICEREQUESTNO, 
                        src:PROBLEMCODESERVICEREQUESTTYPE::varchar AS PROBLEMCODESERVICEREQUESTTYPE, 
                        src:PROBLEMCODETEXTCOLOR::varchar AS PROBLEMCODETEXTCOLOR, 
                        src:PROBLEMCODEWORKORDERNO::integer AS PROBLEMCODEWORKORDERNO, 
                        src:PROBLEMCODEWORKORDERTYPE::varchar AS PROBLEMCODEWORKORDERTYPE, 
                        src:READERCODE::varchar AS READERCODE, 
                        src:READERCODEBACKCOLOR::varchar AS READERCODEBACKCOLOR, 
                        src:READERCODESERVICEREQUESTNO::integer AS READERCODESERVICEREQUESTNO, 
                        src:READERCODESERVICEREQUESTTYPE::varchar AS READERCODESERVICEREQUESTTYPE, 
                        src:READERCODETEXTCOLOR::varchar AS READERCODETEXTCOLOR, 
                        src:READERCODEWORKORDERNO::integer AS READERCODEWORKORDERNO, 
                        src:READERCODEWORKORDERTYPE::varchar AS READERCODEWORKORDERTYPE, 
                        src:READINGCOMPKEY::integer AS READINGCOMPKEY, 
                        src:READINGCYCLE::varchar AS READINGCYCLE, 
                        src:READINGMETERID::varchar AS READINGMETERID, 
                        src:READINGTYPE::integer AS READINGTYPE, 
                        src:READINGUNITTYPE::varchar AS READINGUNITTYPE, 
                        src:REREAD::varchar AS REREAD, 
                        src:REREADSERVICEREQUESTNO::integer AS REREADSERVICEREQUESTNO, 
                        src:ROUTEID::varchar AS ROUTEID, 
                        src:ROUTEKEY::integer AS ROUTEKEY, 
                        src:SEQUENCENO::integer AS SEQUENCENO, 
                        src:SERREQ::varchar AS SERREQ, 
                        src:USAGEPERCENTAGE::numeric(38, 10) AS USAGEPERCENTAGE, 
                        src:VARIATION_ID::integer AS VARIATION_ID, 
                        src:WATERMETERANALYSISKEY::integer AS WATERMETERANALYSISKEY, 
                        src:WORKORDER::varchar AS WORKORDER, 
            CASE
                WHEN 'IPS' = 'LN'
                THEN src:"deleted"::BOOLEAN
                WHEN 'IPS' = 'IPS'
                THEN src:"DATALAKE_DELETED"::BOOLEAN
                ELSE src:"_DELETED"::BOOLEAN
            END as ETL_DELETED,
            etl_load_datetime,
            etl_load_metadatafilename,
            ETL_RANK,
            IFNULL(TRY_TO_TIMESTAMP(replace(right(replace(lower(etl_load_metadatafilename),'.json'),23),'_','-'), 'yyyy-mm-dd-HH-MI-SS-FF') ,etl_load_datetime) as ETL_RANK_TIMESTAMP
            FROM 
            (
            select 
                src,
                etl_load_datetime,
                etl_load_metadatafilename,
                ROWNUMBER as ETL_RANK
                from
                (
                    SELECT
    
                        
                src:WATERMETERANALYSISKEY,
            src:VARIATION_ID
                ,src,
                etl_load_datetime,
                etl_load_metadatafilename,
                ROW_NUMBER() OVER (PARTITION BY 
                                        
                src:WATERMETERANALYSISKEY  ORDER BY 
            src:VARIATION_ID desc,IFNULL(TRY_TO_TIMESTAMP(replace(right(replace(lower(etl_load_metadatafilename),'.json'),23),'_','-'), 'yyyy-mm-dd-HH-MI-SS-FF') ,etl_load_datetime) desc) as ROWNUMBER
                FROM DATAHUB_LANDING.IPS_METERMANAGEMENT_WATER_WATERMETERANALYSIS as strm))