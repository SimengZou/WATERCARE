SELECT UPPER(SPLIT_PART(SRC:AlarmName::string, '-', 4)) AS "SOURCE",    
    'AWS CLOUDWATCH ALARMS' AS "STAGE",
    COUNT(*) AS "ERROR COUNT"
FROM WATERLAKE_${var.ENVIRONMENT}.LOGGING.S3_CLOUDWATCH_ALARMS
WHERE  "SOURCE" <> 'ATHENA'
AND "SOURCE" = :source_system
AND TO_TIMESTAMP(SRC:StateChangeTime::string, 'YYYY-MM-DD"T"HH24:MI:SS.FF3"+0000') = :daterange
GROUP BY "SOURCE",
    "STAGE"

UNION ALL

SELECT 
    CASE WHEN PIPE_CATALOG_NAME = 'WATERLAKE_${var.ENVIRONMENT}' THEN
            REGEXP_REPLACE(PIPE_SCHEMA_NAME,'^INTEGRATION_','')
        ELSE
            REGEXP_REPLACE(REGEXP_REPLACE(PIPE_NAME,'^.*PIPE_',''),'_.*','') 
    END AS "SOURCE", 
    'SNOWFLAKE PIPE ERRORS' AS "STAGE",
    COUNT(*) AS "TOTAL"
FROM SNOWFLAKE.ACCOUNT_USAGE.COPY_HISTORY 
WHERE PIPE_CATALOG_NAME IN ('${var.ENVIRONMENT}_WCC_DATAWAREHOUSE', 'WATERLAKE_${var.ENVIRONMENT}')
    AND PIPE_SCHEMA_NAME <> 'LOGGING'
    AND "SOURCE" = :source_system
    AND LAST_LOAD_TIME = :daterange  
    AND "STATUS" = 'Load failed'
GROUP BY "SOURCE",
    "STAGE"
    
UNION ALL 

SELECT  REGEXP_REPLACE(REGEXP_REPLACE(REGEXP_REPLACE(REGEXP_REPLACE(REGEXP_REPLACE(
        REGEXP_REPLACE(NAME,'^${var.ENVIRONMENT}_',''),'^TASK_',''),'^TARGET_',''),'^LANDING_CLEAN_',''),'^LANDING_RAW_',''),'_.*','') AS "SOURCE",
    'SNOWFLAKE TASK ERRORS' AS "STAGE",
    COUNT(*) AS "TOTAL"
FROM SNOWFLAKE.ACCOUNT_USAGE.TASK_HISTORY
WHERE DATABASE_NAME IN ('${var.ENVIRONMENT}_WCC_DATAWAREHOUSE', 'WATERLAKE_${var.ENVIRONMENT}')
      AND STATE ='FAILED'
      and SCHEMA_NAME NOT IN ('DATAHUB_EXTRACT', 'DATAHUB_ANALYTICS')
      AND "SOURCE" = :source_system
      AND COMPLETED_TIME = :daterange  
GROUP BY "SOURCE",
    "STAGE"

UNION ALL 

SELECT SOURCE, 'TOTAL' AS "STATE", SUM("ERROR COUNT") AS "TOTAL"
FROM
    (
    SELECT UPPER(SPLIT_PART(SRC:AlarmName::string, '-', 4)) AS "SOURCE",    
        'AWS CLOUDWATCH ALARMS' AS "STAGE",
        COUNT(*) AS "ERROR COUNT"
    FROM WATERLAKE_${var.ENVIRONMENT}.LOGGING.S3_CLOUDWATCH_ALARMS
    WHERE  "SOURCE" <> 'ATHENA'
    AND "SOURCE" = :source_system
    AND TO_TIMESTAMP(SRC:StateChangeTime::string, 'YYYY-MM-DD"T"HH24:MI:SS.FF3"+0000') = :daterange
    GROUP BY "SOURCE",
        "STAGE"
    
    UNION ALL
    
    SELECT 
        CASE WHEN PIPE_CATALOG_NAME = 'WATERLAKE_${var.ENVIRONMENT}' THEN
                REGEXP_REPLACE(PIPE_SCHEMA_NAME,'^INTEGRATION_','')
            ELSE
                REGEXP_REPLACE(REGEXP_REPLACE(PIPE_NAME,'^.*PIPE_',''),'_.*','') 
        END AS "SOURCE", 
        'SNOWFLAKE PIPE ERRORS' AS "STAGE",
        COUNT(*) AS "ERROR COUNT"
    FROM SNOWFLAKE.ACCOUNT_USAGE.COPY_HISTORY 
    WHERE PIPE_CATALOG_NAME IN ('${var.ENVIRONMENT}_WCC_DATAWAREHOUSE', 'WATERLAKE_${var.ENVIRONMENT}')
        AND PIPE_SCHEMA_NAME <> 'LOGGING'
        AND "SOURCE" = :source_system
        AND LAST_LOAD_TIME = :daterange  
        AND "STATUS" = 'Load failed'
    GROUP BY "SOURCE",
        "STAGE"
        
    UNION ALL 
    
    SELECT  REGEXP_REPLACE(REGEXP_REPLACE(REGEXP_REPLACE(REGEXP_REPLACE(REGEXP_REPLACE(
            REGEXP_REPLACE(NAME,'^${var.ENVIRONMENT}_',''),'^TASK_',''),'^TARGET_',''),'^LANDING_CLEAN_',''),'^LANDING_RAW_',''),'_.*','') AS "SOURCE",
        'SNOWFLAKE TASK ERRORS' AS "STAGE",
        COUNT(*) AS "ERROR COUNT"
    FROM SNOWFLAKE.ACCOUNT_USAGE.TASK_HISTORY
    WHERE DATABASE_NAME IN ('${var.ENVIRONMENT}_WCC_DATAWAREHOUSE', 'WATERLAKE_${var.ENVIRONMENT}')
          AND STATE ='FAILED'
          and SCHEMA_NAME NOT IN ('DATAHUB_EXTRACT', 'DATAHUB_ANALYTICS')
          AND "SOURCE" = :source_system
          AND COMPLETED_TIME = :daterange  
    GROUP BY "SOURCE",
        "STAGE"
    )

GROUP BY "SOURCE",
        "STAGE"
;     