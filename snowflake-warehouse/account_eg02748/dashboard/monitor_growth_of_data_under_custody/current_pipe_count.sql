SELECT
    CASE
        WHEN TABLE_SCHEMA = 'DATAHUB_TARGET' THEN 'IPS'
        ELSE REPLACE(TABLE_SCHEMA, 'TARGET_', '')
    END SOURCE,
    COUNT(P.PIPE_NAME) AS "PIPE COUNT"
FROM ${var.ENVIRONMENT}_WCC_DATAWAREHOUSE.INFORMATION_SCHEMA.TABLES T
    LEFT OUTER JOIN ${var.ENVIRONMENT}_WCC_DATAWAREHOUSE.INFORMATION_SCHEMA.PIPES P ON PIPE_NAME LIKE '%' || T.TABLE_NAME
WHERE
    TABLE_TYPE = 'BASE TABLE'
    AND (
        TABLE_SCHEMA LIKE 'TARGET_%'
        OR TABLE_SCHEMA = 'DATAHUB_TARGET'
    )
    AND TABLE_SCHEMA NOT LIKE '%HISTORY%'
    AND SOURCE = :source_system
GROUP BY
    CASE
        WHEN TABLE_SCHEMA = 'DATAHUB_TARGET' THEN 'IPS'
        ELSE REPLACE(TABLE_SCHEMA, 'TARGET_', '')
    END
UNION ALL
SELECT
    CASE
        WHEN TABLE_SCHEMA = 'DATAHUB_TARGET' THEN 'IPS'
        ELSE REPLACE(TABLE_SCHEMA, 'TARGET_', '')
    END SOURCE,
    COUNT(P.PIPE_NAME) AS "PIPE COUNT"
FROM WATERLAKE_${var.ENVIRONMENT}.INFORMATION_SCHEMA.TABLES T
    LEFT OUTER JOIN WATERLAKE_${var.ENVIRONMENT}.INFORMATION_SCHEMA.PIPES P ON PIPE_NAME LIKE '%' || T.TABLE_NAME
WHERE
    TABLE_TYPE = 'BASE TABLE'
    AND (
        TABLE_SCHEMA LIKE 'TARGET_%'
        OR TABLE_SCHEMA = 'DATAHUB_TARGET'
    )
    AND TABLE_SCHEMA NOT LIKE '%HISTORY%'
    AND SOURCE = :source_system
GROUP BY
    CASE
        WHEN TABLE_SCHEMA = 'DATAHUB_TARGET' THEN 'IPS'
        ELSE REPLACE(TABLE_SCHEMA, 'TARGET_', '')
    END