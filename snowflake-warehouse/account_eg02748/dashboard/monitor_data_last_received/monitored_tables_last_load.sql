SELECT R.SOURCE AS "SOURCE",
    U.TABLE_NAME AS "TABLE",
    R.TABLE_DESCRIPTION AS "DESCRIPTION",    
    MAX(TO_TIMESTAMP_NTZ(U.LAST_LOAD_TIME)) as "LAST LOAD TIME",
    DATEDIFF('DAY', MAX(TO_TIMESTAMP_NTZ(U.LAST_LOAD_TIME)), CURRENT_DATE) AS "DAYS SINCE LAST LOAD",
    MAX_BY(U.ROW_COUNT,U.LAST_LOAD_TIME)  AS "LAST LOAD COUNT",
     CASE WHEN DATEDIFF('DAY', MAX(TO_TIMESTAMP_NTZ(U.LAST_LOAD_TIME)), CURRENT_DATE) >= 90 THEN '90+ DAYS'
        WHEN DATEDIFF('DAY', MAX(TO_TIMESTAMP_NTZ(U.LAST_LOAD_TIME)), CURRENT_DATE) BETWEEN 30 AND 89 THEN '30-89 DAYS'
        WHEN DATEDIFF('DAY', MAX(TO_TIMESTAMP_NTZ(U.LAST_LOAD_TIME)), CURRENT_DATE) BETWEEN 14 AND 29 THEN '14-29 DAYS'
        WHEN DATEDIFF('DAY', MAX(TO_TIMESTAMP_NTZ(U.LAST_LOAD_TIME)), CURRENT_DATE) BETWEEN 7 AND 13 THEN '07-13 DAYS'
        WHEN DATEDIFF('DAY', MAX(TO_TIMESTAMP_NTZ(U.LAST_LOAD_TIME)), CURRENT_DATE) <= 6 THEN '0-6 DAYS'
    END AS "LAST LOAD BUCKET"    
FROM SNOWFLAKE.ACCOUNT_USAGE.COPY_HISTORY U
INNER JOIN ${var.ENVIRONMENT}_WCC_DATAWAREHOUSE.DATAHUB_SOURCE_METADATA.MONITORING_REQUIRED_TABLES R ON
    regexp_replace(U.TABLE_NAME, '_.*', '') = R.SOURCE AND
    U.TABLE_NAME = R.TABLE_NAME
INNER JOIN ${var.ENVIRONMENT}_WCC_DATAWAREHOUSE.INFORMATION_SCHEMA.TABLES T ON
    CASE WHEN T.TABLE_SCHEMA = 'DATAHUB_TARGET' THEN 'IPS' ELSE REPLACE(T.TABLE_SCHEMA, 'TARGET_', '') END = R.SOURCE AND
    T.TABLE_NAME = R.TABLE_NAME
WHERE  U.TABLE_CATALOG_NAME = '${var.ENVIRONMENT}_WCC_DATAWAREHOUSE' AND
    T.TABLE_TYPE = 'BASE TABLE' AND
    (T.TABLE_SCHEMA = 'DATAHUB_TARGET' OR T.TABLE_SCHEMA LIKE 'TARGET_%') AND
    T.TABLE_SCHEMA NOT LIKE '%HISTORY%' AND
    R.SOURCE = :source_system AND
    U.TABLE_NAME = :monitored_table
GROUP BY "SOURCE", 
    "TABLE",
    "DESCRIPTION"
UNION ALL
SELECT R.SOURCE AS "SOURCE",
    U.TABLE_NAME AS "TABLE",
    R.TABLE_DESCRIPTION AS "DESCRIPTION",    
    MAX(TO_TIMESTAMP_NTZ(U.LAST_LOAD_TIME)) as "LAST LOAD TIME",
    DATEDIFF('DAY', MAX(TO_TIMESTAMP_NTZ(U.LAST_LOAD_TIME)), CURRENT_DATE) AS "DAYS SINCE LAST LOAD",
    MAX_BY(U.ROW_COUNT,U.LAST_LOAD_TIME)  AS "LAST LOAD COUNT",
     CASE WHEN DATEDIFF('DAY', MAX(TO_TIMESTAMP_NTZ(U.LAST_LOAD_TIME)), CURRENT_DATE) >= 90 THEN '90+ DAYS'
        WHEN DATEDIFF('DAY', MAX(TO_TIMESTAMP_NTZ(U.LAST_LOAD_TIME)), CURRENT_DATE) BETWEEN 30 AND 89 THEN '30-89 DAYS'
        WHEN DATEDIFF('DAY', MAX(TO_TIMESTAMP_NTZ(U.LAST_LOAD_TIME)), CURRENT_DATE) BETWEEN 14 AND 29 THEN '14-29 DAYS'
        WHEN DATEDIFF('DAY', MAX(TO_TIMESTAMP_NTZ(U.LAST_LOAD_TIME)), CURRENT_DATE) BETWEEN 7 AND 13 THEN '07-13 DAYS'
        WHEN DATEDIFF('DAY', MAX(TO_TIMESTAMP_NTZ(U.LAST_LOAD_TIME)), CURRENT_DATE) <= 3 THEN '0-6 DAYS'
    END AS "LAST LOAD BUCKET" 
FROM SNOWFLAKE.ACCOUNT_USAGE.COPY_HISTORY U
INNER JOIN ${var.ENVIRONMENT}_WCC_DATAWAREHOUSE.DATAHUB_SOURCE_METADATA.MONITORING_REQUIRED_TABLES R ON
    regexp_replace(U.TABLE_SCHEMA_NAME, '^.*_', '') = R.SOURCE AND
    U.TABLE_NAME = R.TABLE_NAME
INNER JOIN WATERLAKE_${var.ENVIRONMENT}.INFORMATION_SCHEMA.TABLES T ON
    REPLACE(T.TABLE_SCHEMA, 'TARGET_', '') = R.SOURCE AND
    T.TABLE_NAME = R.TABLE_NAME
WHERE  U.TABLE_CATALOG_NAME = 'WATERLAKE_${var.ENVIRONMENT}' AND
    T.TABLE_TYPE = 'BASE TABLE' AND
    T.TABLE_SCHEMA LIKE 'TARGET_%' AND
    T.TABLE_SCHEMA NOT LIKE '%HISTORY%' AND
    R.SOURCE = :source_system AND
    U.TABLE_NAME = :monitored_table
GROUP BY "SOURCE", 
    "TABLE",
    "DESCRIPTION"
ORDER BY "LAST LOAD TIME";