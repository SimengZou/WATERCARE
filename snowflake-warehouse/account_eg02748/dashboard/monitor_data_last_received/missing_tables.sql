SELECT T1.SOURCE AS "SOURCE",
    T1.TABLE_NAME AS "TABLE"
FROM (
    SELECT SOURCE,
        TABLE_NAME
    FROM ${var.ENVIRONMENT}_WCC_DATAWAREHOUSE.DATAHUB_SOURCE_METADATA.INFOR_TABLES_IN_SCOPE
    WHERE SOURCE = :source_system
    
) AS T1
LEFT OUTER JOIN (
    SELECT DISTINCT CASE WHEN TABLE_SCHEMA = 'DATAHUB_TARGET' THEN 'IPS' ELSE REPLACE(TABLE_SCHEMA, 'TARGET_', '') END AS "SOURCE",
        TABLE_NAME
    FROM ${var.ENVIRONMENT}_WCC_DATAWAREHOUSE.INFORMATION_SCHEMA.TABLES
    WHERE TABLE_TYPE = 'BASE TABLE' AND
        (TABLE_SCHEMA = 'DATAHUB_TARGET' OR TABLE_SCHEMA LIKE 'TARGET_%') AND
        TABLE_SCHEMA NOT LIKE '%HISTORY%' AND
        SOURCE = :source_system
) AS T2 ON 
    T1.SOURCE = T2.SOURCE AND
    T1.TABLE_NAME = T2.TABLE_NAME
WHERE T2.TABLE_NAME IS NULL
ORDER BY "SOURCE", "TABLE"