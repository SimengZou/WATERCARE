SELECT "SOURCE", 
    "TABLE", 
    MAX("LAST LOAD TIME") AS "LAST LOAD TIME", 
    MAX("DAYS SINCE LAST LOAD") AS "DAYS SINCE LAST LOAD"
FROM (
    SELECT SPLIT_PART(TABLE_SCHEMA_NAME, '_', -1) as "SOURCE",
        TABLE_NAME AS "TABLE",
        FILE_NAME AS "FILE NAME",
        MAX(LAST_LOAD_TIME) AS "LAST LOAD TIME",
        DATEDIFF('DAY', MAX(LAST_LOAD_TIME), CURRENT_DATE) AS "DAYS SINCE LAST LOAD"
    FROM SNOWFLAKE.ACCOUNT_USAGE.COPY_HISTORY
    WHERE TABLE_CATALOG_NAME = 'WATERLAKE_${var.ENVIRONMENT}' 
    AND TABLE_NAME IN (
        SELECT DISTINCT TABLE_NAME 
        FROM  WATERLAKE_${var.ENVIRONMENT}.INFORMATION_SCHEMA.TABLES 
        WHERE TABLE_SCHEMA LIKE 'TARGET_%'
        AND TABLE_SCHEMA NOT LIKE '%HISTORY%' 
        AND ROW_COUNT > 0
    )
    AND "SOURCE" = :source_system
    GROUP BY "SOURCE", 
        "TABLE",
        "FILE NAME"
)
GROUP BY "SOURCE",
    "TABLE"
HAVING COUNT(DISTINCT DATE("LAST LOAD TIME")) = 1

UNION ALL

SELECT "SOURCE", "TABLE", MAX("LAST LOAD TIME"), MAX("DAYS SINCE LAST LOAD")
FROM (
    SELECT SPLIT_PART(TABLE_NAME, '_', 1) as "SOURCE",
        TABLE_NAME AS "TABLE",
        FILE_NAME AS "FILE NAME",
        MAX(LAST_LOAD_TIME) AS "LAST LOAD TIME",
        DATEDIFF('DAY', MAX(LAST_LOAD_TIME), CURRENT_DATE) AS "DAYS SINCE LAST LOAD"
    FROM SNOWFLAKE.ACCOUNT_USAGE.COPY_HISTORY C
    WHERE TABLE_CATALOG_NAME = '${var.ENVIRONMENT}_WCC_DATAWAREHOUSE' 
    AND TABLE_NAME IN (
        SELECT DISTINCT TABLE_NAME 
        FROM  ${var.ENVIRONMENT}_WCC_DATAWAREHOUSE.INFORMATION_SCHEMA.TABLES 
        WHERE (TABLE_SCHEMA = 'DATAHUB_TARGET' OR TABLE_SCHEMA LIKE 'TARGET_%')
        AND TABLE_SCHEMA NOT LIKE '%HISTORY%' 
        -- AND TABLE_NAME = 'EAM_R5ACDPARAMS'
        AND ROW_COUNT > 0
    )
    AND "SOURCE" = :source_system
    GROUP BY "SOURCE", 
        "TABLE",
        "FILE NAME"
)
GROUP BY "SOURCE", 
        "TABLE"
HAVING COUNT(DISTINCT DATE("LAST LOAD TIME")) = 1
;