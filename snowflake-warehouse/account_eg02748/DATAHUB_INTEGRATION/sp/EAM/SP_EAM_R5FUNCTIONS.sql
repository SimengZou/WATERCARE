create or replace procedure DATAHUB_INTEGRATION.SP_EAM_R5FUNCTIONS()
    returns varchar not null
                language javascript
                as
                $$

//  Variables

var result = "";                                    // return status of this proc call
const process_name = Object.keys(this)[0];          // name of currently executing process
var number_of_rows_inserted = 0;                             // track number of rows we have inserted
var number_of_rows_updated = 0;                             // track number of rows we have updated


//  Step 1.

//  Start execution - log start

log_sql_command = "call datahub_logging.sp_etl_log_ingestion_process('Insert','" + process_name + "','Running','Started process execution.', 0,0,0);";
snowflake.execute({sqlText: log_sql_command});

snowflake.execute( {sqlText: "begin transaction;"} );
try
    {
        var sql_command = `
                            INSERT INTO LANDING_ERROR.EAM_RAW_ERROR
                            SELECT * FROM LANDING_ERROR.VW_STREAM_EAM_R5FUNCTIONS_ERROR`;
    var sqlStmt = snowflake.createStatement( {sqlText:  sql_command} );
    var rs = sqlStmt.execute();
        
        var sql_command = ` 
                            merge into  TARGET_EAM.EAM_R5FUNCTIONS as target using (SELECT * FROM (SELECT 
            strm.FUN_ADVREPT, 
            strm.FUN_APPLICATION, 
            strm.FUN_AUTO, 
            strm.FUN_AUTOREFRESHTIMER, 
            strm.FUN_BACKGROUND, 
            strm.FUN_BACKGROUNDGRAPH, 
            strm.FUN_BACKGROUNDREP, 
            strm.FUN_BLOCKDURATION, 
            strm.FUN_CLASS, 
            strm.FUN_CLASS_ORG, 
            strm.FUN_CODE, 
            strm.FUN_COMMAND, 
            strm.FUN_DEFAULTRESERVATIONSTATUS, 
            strm.FUN_DEFAULTRESERVATIONTYPE, 
            strm.FUN_DELETE, 
            strm.FUN_DESC, 
            strm.FUN_DESCCHANGED, 
            strm.FUN_DEVICE, 
            strm.FUN_DIRECTORY, 
            strm.FUN_DIRSEL, 
            strm.FUN_DISPLAYAP, 
            strm.FUN_DISPLAYFT, 
            strm.FUN_EWSBTN, 
            strm.FUN_EWSREPORT, 
            strm.FUN_EWSURLNEW, 
            strm.FUN_FIELDFILTERCFCLASS, 
            strm.FUN_FIELDFILTERCFCLASS_ORG, 
            strm.FUN_FIELDFILTERCFORG, 
            strm.FUN_FIELDFILTERCHECKLIST, 
            strm.FUN_FIELDFILTERCLASS, 
            strm.FUN_FIELDFILTERTYPE, 
            strm.FUN_FIELDFILTERWOOBJTYPE, 
            strm.FUN_FILE, 
            strm.FUN_FRIDAY, 
            strm.FUN_HDR, 
            strm.FUN_ICON, 
            strm.FUN_INSERT, 
            strm.FUN_LASTSAVED, 
            strm.FUN_LASTVALUE, 
            strm.FUN_LST, 
            strm.FUN_MEKEY, 
            strm.FUN_MOBILEROUTE, 
            strm.FUN_MODE, 
            strm.FUN_MONDAY, 
            strm.FUN_NODESIGN, 
            strm.FUN_NOW, 
            strm.FUN_ORIENTATION, 
            strm.FUN_PARENTFUNCTION, 
            strm.FUN_PARENTTAB, 
            strm.FUN_PERTYPE, 
            strm.FUN_POPUPAP, 
            strm.FUN_POPUPFT, 
            strm.FUN_POPUPFUNCTION, 
            strm.FUN_PRDDATASRC, 
            strm.FUN_PUBLIC, 
            strm.FUN_RENTITY, 
            strm.FUN_REPDISABLED, 
            strm.FUN_RESERVATIONCALENDAR, 
            strm.FUN_RPTFILEUPDATED, 
            strm.FUN_RPTFILEUPDATEDBY, 
            strm.FUN_RS, 
            strm.FUN_SATURDAY, 
            strm.FUN_SCHEDULERVIEW, 
            strm.FUN_SELECT, 
            strm.FUN_SPLITVIEWDISPLAY, 
            strm.FUN_STARTUPVIEW, 
            strm.FUN_SUBTYPE, 
            strm.FUN_SUNDAY, 
            strm.FUN_SYSTEM, 
            strm.FUN_THURSDAY, 
            strm.FUN_TICKET, 
            strm.FUN_TUESDAY, 
            strm.FUN_TXTCODE, 
            strm.FUN_UDFRENTITY, 
            strm.FUN_UGFILE, 
            strm.FUN_UPDATE, 
            strm.FUN_UPDATECOUNT, 
            strm.FUN_UPDATED, 
            strm.FUN_WEDNESDAY, 
            strm.FUN_WORKBOOK, 
            strm.FUN_WORKINGENDTIMEHOURS, 
            strm.FUN_WORKINGENDTIMEMINUTES, 
            strm.FUN_WORKINGSTARTTIMEHOURS, 
            strm.FUN_WORKINGSTARTTIMEMINUTES, 
            strm.FUN_WORKSHEET, 
            strm.FUN_XTYPE, 
            strm._DELETED, 
            strm.ETL_LASTSAVED,
            strm.ETL_DELETED,
            strm.etl_load_datetime,
            strm.etl_load_metadatafilename,
            ROW_NUMBER() OVER (PARTITION BY 
            strm.FUN_CODE ORDER BY strm.ETL_LASTSAVED desc,IFNULL(TRY_TO_TIMESTAMP(replace(right(replace(lower(etl_load_metadatafilename),'.json'),23),'_','-'), 'yyyy-mm-dd-HH-MI-SS-FF') ,etl_load_datetime) desc) as ROWNUMBER
        FROM DATAHUB_INTEGRATION.VW_STREAM_EAM_R5FUNCTIONS as  strm
                    )   
            WHERE ROWNUMBER=1  
            
                    ) as src on
            ((target.FUN_CODE=src.FUN_CODE) OR (target.FUN_CODE IS NULL AND src.FUN_CODE IS NULL)) 
                when matched and src.ETL_DELETED=TRUE THEN DELETE
                when matched then update set
                    target.FUN_ADVREPT=src.FUN_ADVREPT, 
                    target.FUN_APPLICATION=src.FUN_APPLICATION, 
                    target.FUN_AUTO=src.FUN_AUTO, 
                    target.FUN_AUTOREFRESHTIMER=src.FUN_AUTOREFRESHTIMER, 
                    target.FUN_BACKGROUND=src.FUN_BACKGROUND, 
                    target.FUN_BACKGROUNDGRAPH=src.FUN_BACKGROUNDGRAPH, 
                    target.FUN_BACKGROUNDREP=src.FUN_BACKGROUNDREP, 
                    target.FUN_BLOCKDURATION=src.FUN_BLOCKDURATION, 
                    target.FUN_CLASS=src.FUN_CLASS, 
                    target.FUN_CLASS_ORG=src.FUN_CLASS_ORG, 
                    target.FUN_CODE=src.FUN_CODE, 
                    target.FUN_COMMAND=src.FUN_COMMAND, 
                    target.FUN_DEFAULTRESERVATIONSTATUS=src.FUN_DEFAULTRESERVATIONSTATUS, 
                    target.FUN_DEFAULTRESERVATIONTYPE=src.FUN_DEFAULTRESERVATIONTYPE, 
                    target.FUN_DELETE=src.FUN_DELETE, 
                    target.FUN_DESC=src.FUN_DESC, 
                    target.FUN_DESCCHANGED=src.FUN_DESCCHANGED, 
                    target.FUN_DEVICE=src.FUN_DEVICE, 
                    target.FUN_DIRECTORY=src.FUN_DIRECTORY, 
                    target.FUN_DIRSEL=src.FUN_DIRSEL, 
                    target.FUN_DISPLAYAP=src.FUN_DISPLAYAP, 
                    target.FUN_DISPLAYFT=src.FUN_DISPLAYFT, 
                    target.FUN_EWSBTN=src.FUN_EWSBTN, 
                    target.FUN_EWSREPORT=src.FUN_EWSREPORT, 
                    target.FUN_EWSURLNEW=src.FUN_EWSURLNEW, 
                    target.FUN_FIELDFILTERCFCLASS=src.FUN_FIELDFILTERCFCLASS, 
                    target.FUN_FIELDFILTERCFCLASS_ORG=src.FUN_FIELDFILTERCFCLASS_ORG, 
                    target.FUN_FIELDFILTERCFORG=src.FUN_FIELDFILTERCFORG, 
                    target.FUN_FIELDFILTERCHECKLIST=src.FUN_FIELDFILTERCHECKLIST, 
                    target.FUN_FIELDFILTERCLASS=src.FUN_FIELDFILTERCLASS, 
                    target.FUN_FIELDFILTERTYPE=src.FUN_FIELDFILTERTYPE, 
                    target.FUN_FIELDFILTERWOOBJTYPE=src.FUN_FIELDFILTERWOOBJTYPE, 
                    target.FUN_FILE=src.FUN_FILE, 
                    target.FUN_FRIDAY=src.FUN_FRIDAY, 
                    target.FUN_HDR=src.FUN_HDR, 
                    target.FUN_ICON=src.FUN_ICON, 
                    target.FUN_INSERT=src.FUN_INSERT, 
                    target.FUN_LASTSAVED=src.FUN_LASTSAVED, 
                    target.FUN_LASTVALUE=src.FUN_LASTVALUE, 
                    target.FUN_LST=src.FUN_LST, 
                    target.FUN_MEKEY=src.FUN_MEKEY, 
                    target.FUN_MOBILEROUTE=src.FUN_MOBILEROUTE, 
                    target.FUN_MODE=src.FUN_MODE, 
                    target.FUN_MONDAY=src.FUN_MONDAY, 
                    target.FUN_NODESIGN=src.FUN_NODESIGN, 
                    target.FUN_NOW=src.FUN_NOW, 
                    target.FUN_ORIENTATION=src.FUN_ORIENTATION, 
                    target.FUN_PARENTFUNCTION=src.FUN_PARENTFUNCTION, 
                    target.FUN_PARENTTAB=src.FUN_PARENTTAB, 
                    target.FUN_PERTYPE=src.FUN_PERTYPE, 
                    target.FUN_POPUPAP=src.FUN_POPUPAP, 
                    target.FUN_POPUPFT=src.FUN_POPUPFT, 
                    target.FUN_POPUPFUNCTION=src.FUN_POPUPFUNCTION, 
                    target.FUN_PRDDATASRC=src.FUN_PRDDATASRC, 
                    target.FUN_PUBLIC=src.FUN_PUBLIC, 
                    target.FUN_RENTITY=src.FUN_RENTITY, 
                    target.FUN_REPDISABLED=src.FUN_REPDISABLED, 
                    target.FUN_RESERVATIONCALENDAR=src.FUN_RESERVATIONCALENDAR, 
                    target.FUN_RPTFILEUPDATED=src.FUN_RPTFILEUPDATED, 
                    target.FUN_RPTFILEUPDATEDBY=src.FUN_RPTFILEUPDATEDBY, 
                    target.FUN_RS=src.FUN_RS, 
                    target.FUN_SATURDAY=src.FUN_SATURDAY, 
                    target.FUN_SCHEDULERVIEW=src.FUN_SCHEDULERVIEW, 
                    target.FUN_SELECT=src.FUN_SELECT, 
                    target.FUN_SPLITVIEWDISPLAY=src.FUN_SPLITVIEWDISPLAY, 
                    target.FUN_STARTUPVIEW=src.FUN_STARTUPVIEW, 
                    target.FUN_SUBTYPE=src.FUN_SUBTYPE, 
                    target.FUN_SUNDAY=src.FUN_SUNDAY, 
                    target.FUN_SYSTEM=src.FUN_SYSTEM, 
                    target.FUN_THURSDAY=src.FUN_THURSDAY, 
                    target.FUN_TICKET=src.FUN_TICKET, 
                    target.FUN_TUESDAY=src.FUN_TUESDAY, 
                    target.FUN_TXTCODE=src.FUN_TXTCODE, 
                    target.FUN_UDFRENTITY=src.FUN_UDFRENTITY, 
                    target.FUN_UGFILE=src.FUN_UGFILE, 
                    target.FUN_UPDATE=src.FUN_UPDATE, 
                    target.FUN_UPDATECOUNT=src.FUN_UPDATECOUNT, 
                    target.FUN_UPDATED=src.FUN_UPDATED, 
                    target.FUN_WEDNESDAY=src.FUN_WEDNESDAY, 
                    target.FUN_WORKBOOK=src.FUN_WORKBOOK, 
                    target.FUN_WORKINGENDTIMEHOURS=src.FUN_WORKINGENDTIMEHOURS, 
                    target.FUN_WORKINGENDTIMEMINUTES=src.FUN_WORKINGENDTIMEMINUTES, 
                    target.FUN_WORKINGSTARTTIMEHOURS=src.FUN_WORKINGSTARTTIMEHOURS, 
                    target.FUN_WORKINGSTARTTIMEMINUTES=src.FUN_WORKINGSTARTTIMEMINUTES, 
                    target.FUN_WORKSHEET=src.FUN_WORKSHEET, 
                    target.FUN_XTYPE=src.FUN_XTYPE, 
                    target._DELETED=src._DELETED, 
                    target.ETL_LASTSAVED=src.ETL_LASTSAVED,
                    target.etl_load_datetime=CURRENT_TIMESTAMP,
                    target.etl_load_metadatafilename=src.etl_load_metadatafilename
        when not matched and (src.ETL_DELETED=FALSE OR src.ETL_DELETED IS NULL)  then insert ( 
                    FUN_ADVREPT, 
                    FUN_APPLICATION, 
                    FUN_AUTO, 
                    FUN_AUTOREFRESHTIMER, 
                    FUN_BACKGROUND, 
                    FUN_BACKGROUNDGRAPH, 
                    FUN_BACKGROUNDREP, 
                    FUN_BLOCKDURATION, 
                    FUN_CLASS, 
                    FUN_CLASS_ORG, 
                    FUN_CODE, 
                    FUN_COMMAND, 
                    FUN_DEFAULTRESERVATIONSTATUS, 
                    FUN_DEFAULTRESERVATIONTYPE, 
                    FUN_DELETE, 
                    FUN_DESC, 
                    FUN_DESCCHANGED, 
                    FUN_DEVICE, 
                    FUN_DIRECTORY, 
                    FUN_DIRSEL, 
                    FUN_DISPLAYAP, 
                    FUN_DISPLAYFT, 
                    FUN_EWSBTN, 
                    FUN_EWSREPORT, 
                    FUN_EWSURLNEW, 
                    FUN_FIELDFILTERCFCLASS, 
                    FUN_FIELDFILTERCFCLASS_ORG, 
                    FUN_FIELDFILTERCFORG, 
                    FUN_FIELDFILTERCHECKLIST, 
                    FUN_FIELDFILTERCLASS, 
                    FUN_FIELDFILTERTYPE, 
                    FUN_FIELDFILTERWOOBJTYPE, 
                    FUN_FILE, 
                    FUN_FRIDAY, 
                    FUN_HDR, 
                    FUN_ICON, 
                    FUN_INSERT, 
                    FUN_LASTSAVED, 
                    FUN_LASTVALUE, 
                    FUN_LST, 
                    FUN_MEKEY, 
                    FUN_MOBILEROUTE, 
                    FUN_MODE, 
                    FUN_MONDAY, 
                    FUN_NODESIGN, 
                    FUN_NOW, 
                    FUN_ORIENTATION, 
                    FUN_PARENTFUNCTION, 
                    FUN_PARENTTAB, 
                    FUN_PERTYPE, 
                    FUN_POPUPAP, 
                    FUN_POPUPFT, 
                    FUN_POPUPFUNCTION, 
                    FUN_PRDDATASRC, 
                    FUN_PUBLIC, 
                    FUN_RENTITY, 
                    FUN_REPDISABLED, 
                    FUN_RESERVATIONCALENDAR, 
                    FUN_RPTFILEUPDATED, 
                    FUN_RPTFILEUPDATEDBY, 
                    FUN_RS, 
                    FUN_SATURDAY, 
                    FUN_SCHEDULERVIEW, 
                    FUN_SELECT, 
                    FUN_SPLITVIEWDISPLAY, 
                    FUN_STARTUPVIEW, 
                    FUN_SUBTYPE, 
                    FUN_SUNDAY, 
                    FUN_SYSTEM, 
                    FUN_THURSDAY, 
                    FUN_TICKET, 
                    FUN_TUESDAY, 
                    FUN_TXTCODE, 
                    FUN_UDFRENTITY, 
                    FUN_UGFILE, 
                    FUN_UPDATE, 
                    FUN_UPDATECOUNT, 
                    FUN_UPDATED, 
                    FUN_WEDNESDAY, 
                    FUN_WORKBOOK, 
                    FUN_WORKINGENDTIMEHOURS, 
                    FUN_WORKINGENDTIMEMINUTES, 
                    FUN_WORKINGSTARTTIMEHOURS, 
                    FUN_WORKINGSTARTTIMEMINUTES, 
                    FUN_WORKSHEET, 
                    FUN_XTYPE, 
                    _DELETED, 
                    ETL_LASTSAVED,                       
                    etl_load_datetime,
                    etl_load_metadatafilename) 
            values (
                    src.FUN_ADVREPT, 
                    src.FUN_APPLICATION, 
                    src.FUN_AUTO, 
                    src.FUN_AUTOREFRESHTIMER, 
                    src.FUN_BACKGROUND, 
                    src.FUN_BACKGROUNDGRAPH, 
                    src.FUN_BACKGROUNDREP, 
                    src.FUN_BLOCKDURATION, 
                    src.FUN_CLASS, 
                    src.FUN_CLASS_ORG, 
                    src.FUN_CODE, 
                    src.FUN_COMMAND, 
                    src.FUN_DEFAULTRESERVATIONSTATUS, 
                    src.FUN_DEFAULTRESERVATIONTYPE, 
                    src.FUN_DELETE, 
                    src.FUN_DESC, 
                    src.FUN_DESCCHANGED, 
                    src.FUN_DEVICE, 
                    src.FUN_DIRECTORY, 
                    src.FUN_DIRSEL, 
                    src.FUN_DISPLAYAP, 
                    src.FUN_DISPLAYFT, 
                    src.FUN_EWSBTN, 
                    src.FUN_EWSREPORT, 
                    src.FUN_EWSURLNEW, 
                    src.FUN_FIELDFILTERCFCLASS, 
                    src.FUN_FIELDFILTERCFCLASS_ORG, 
                    src.FUN_FIELDFILTERCFORG, 
                    src.FUN_FIELDFILTERCHECKLIST, 
                    src.FUN_FIELDFILTERCLASS, 
                    src.FUN_FIELDFILTERTYPE, 
                    src.FUN_FIELDFILTERWOOBJTYPE, 
                    src.FUN_FILE, 
                    src.FUN_FRIDAY, 
                    src.FUN_HDR, 
                    src.FUN_ICON, 
                    src.FUN_INSERT, 
                    src.FUN_LASTSAVED, 
                    src.FUN_LASTVALUE, 
                    src.FUN_LST, 
                    src.FUN_MEKEY, 
                    src.FUN_MOBILEROUTE, 
                    src.FUN_MODE, 
                    src.FUN_MONDAY, 
                    src.FUN_NODESIGN, 
                    src.FUN_NOW, 
                    src.FUN_ORIENTATION, 
                    src.FUN_PARENTFUNCTION, 
                    src.FUN_PARENTTAB, 
                    src.FUN_PERTYPE, 
                    src.FUN_POPUPAP, 
                    src.FUN_POPUPFT, 
                    src.FUN_POPUPFUNCTION, 
                    src.FUN_PRDDATASRC, 
                    src.FUN_PUBLIC, 
                    src.FUN_RENTITY, 
                    src.FUN_REPDISABLED, 
                    src.FUN_RESERVATIONCALENDAR, 
                    src.FUN_RPTFILEUPDATED, 
                    src.FUN_RPTFILEUPDATEDBY, 
                    src.FUN_RS, 
                    src.FUN_SATURDAY, 
                    src.FUN_SCHEDULERVIEW, 
                    src.FUN_SELECT, 
                    src.FUN_SPLITVIEWDISPLAY, 
                    src.FUN_STARTUPVIEW, 
                    src.FUN_SUBTYPE, 
                    src.FUN_SUNDAY, 
                    src.FUN_SYSTEM, 
                    src.FUN_THURSDAY, 
                    src.FUN_TICKET, 
                    src.FUN_TUESDAY, 
                    src.FUN_TXTCODE, 
                    src.FUN_UDFRENTITY, 
                    src.FUN_UGFILE, 
                    src.FUN_UPDATE, 
                    src.FUN_UPDATECOUNT, 
                    src.FUN_UPDATED, 
                    src.FUN_WEDNESDAY, 
                    src.FUN_WORKBOOK, 
                    src.FUN_WORKINGENDTIMEHOURS, 
                    src.FUN_WORKINGENDTIMEMINUTES, 
                    src.FUN_WORKINGSTARTTIMEHOURS, 
                    src.FUN_WORKINGSTARTTIMEMINUTES, 
                    src.FUN_WORKSHEET, 
                    src.FUN_XTYPE, 
                    src._DELETED,     
                    src.ETL_LASTSAVED,
                    CURRENT_TIMESTAMP,
                    src.etl_load_metadatafilename);`;

    var sqlStmt = snowflake.createStatement( {sqlText:  sql_command} );
    var rs = sqlStmt.execute();

    snowflake.execute( {sqlText: `merge into TARGET_HISTORY_EAM.EAM_R5FUNCTIONS_DELETED as target using (
                SELECT * FROM (SELECT 
            strm.FUN_ADVREPT, 
            strm.FUN_APPLICATION, 
            strm.FUN_AUTO, 
            strm.FUN_AUTOREFRESHTIMER, 
            strm.FUN_BACKGROUND, 
            strm.FUN_BACKGROUNDGRAPH, 
            strm.FUN_BACKGROUNDREP, 
            strm.FUN_BLOCKDURATION, 
            strm.FUN_CLASS, 
            strm.FUN_CLASS_ORG, 
            strm.FUN_CODE, 
            strm.FUN_COMMAND, 
            strm.FUN_DEFAULTRESERVATIONSTATUS, 
            strm.FUN_DEFAULTRESERVATIONTYPE, 
            strm.FUN_DELETE, 
            strm.FUN_DESC, 
            strm.FUN_DESCCHANGED, 
            strm.FUN_DEVICE, 
            strm.FUN_DIRECTORY, 
            strm.FUN_DIRSEL, 
            strm.FUN_DISPLAYAP, 
            strm.FUN_DISPLAYFT, 
            strm.FUN_EWSBTN, 
            strm.FUN_EWSREPORT, 
            strm.FUN_EWSURLNEW, 
            strm.FUN_FIELDFILTERCFCLASS, 
            strm.FUN_FIELDFILTERCFCLASS_ORG, 
            strm.FUN_FIELDFILTERCFORG, 
            strm.FUN_FIELDFILTERCHECKLIST, 
            strm.FUN_FIELDFILTERCLASS, 
            strm.FUN_FIELDFILTERTYPE, 
            strm.FUN_FIELDFILTERWOOBJTYPE, 
            strm.FUN_FILE, 
            strm.FUN_FRIDAY, 
            strm.FUN_HDR, 
            strm.FUN_ICON, 
            strm.FUN_INSERT, 
            strm.FUN_LASTSAVED, 
            strm.FUN_LASTVALUE, 
            strm.FUN_LST, 
            strm.FUN_MEKEY, 
            strm.FUN_MOBILEROUTE, 
            strm.FUN_MODE, 
            strm.FUN_MONDAY, 
            strm.FUN_NODESIGN, 
            strm.FUN_NOW, 
            strm.FUN_ORIENTATION, 
            strm.FUN_PARENTFUNCTION, 
            strm.FUN_PARENTTAB, 
            strm.FUN_PERTYPE, 
            strm.FUN_POPUPAP, 
            strm.FUN_POPUPFT, 
            strm.FUN_POPUPFUNCTION, 
            strm.FUN_PRDDATASRC, 
            strm.FUN_PUBLIC, 
            strm.FUN_RENTITY, 
            strm.FUN_REPDISABLED, 
            strm.FUN_RESERVATIONCALENDAR, 
            strm.FUN_RPTFILEUPDATED, 
            strm.FUN_RPTFILEUPDATEDBY, 
            strm.FUN_RS, 
            strm.FUN_SATURDAY, 
            strm.FUN_SCHEDULERVIEW, 
            strm.FUN_SELECT, 
            strm.FUN_SPLITVIEWDISPLAY, 
            strm.FUN_STARTUPVIEW, 
            strm.FUN_SUBTYPE, 
            strm.FUN_SUNDAY, 
            strm.FUN_SYSTEM, 
            strm.FUN_THURSDAY, 
            strm.FUN_TICKET, 
            strm.FUN_TUESDAY, 
            strm.FUN_TXTCODE, 
            strm.FUN_UDFRENTITY, 
            strm.FUN_UGFILE, 
            strm.FUN_UPDATE, 
            strm.FUN_UPDATECOUNT, 
            strm.FUN_UPDATED, 
            strm.FUN_WEDNESDAY, 
            strm.FUN_WORKBOOK, 
            strm.FUN_WORKINGENDTIMEHOURS, 
            strm.FUN_WORKINGENDTIMEMINUTES, 
            strm.FUN_WORKINGSTARTTIMEHOURS, 
            strm.FUN_WORKINGSTARTTIMEMINUTES, 
            strm.FUN_WORKSHEET, 
            strm.FUN_XTYPE, 
            strm._DELETED, 
            strm.ETL_LASTSAVED,
            strm.ETL_DELETED,
            strm.etl_load_datetime,
            strm.etl_load_metadatafilename,
            ROW_NUMBER() OVER (PARTITION BY 
            strm.FUN_CODE ORDER BY strm.ETL_LASTSAVED desc,IFNULL(TRY_TO_TIMESTAMP(replace(right(replace(lower(etl_load_metadatafilename),'.json'),23),'_','-'), 'yyyy-mm-dd-HH-MI-SS-FF') ,etl_load_datetime) desc) as ROWNUMBER
        FROM DATAHUB_INTEGRATION.VW_STREAM_EAM_R5FUNCTIONS as  strm
        WHERE strm.ETL_DELETED=TRUE
                    )   
            WHERE ROWNUMBER=1  
            
                    ) as src on
            ((target.FUN_CODE=src.FUN_CODE) OR (target.FUN_CODE IS NULL AND src.FUN_CODE IS NULL)) 
                when matched then update set
                    target.FUN_ADVREPT=src.FUN_ADVREPT, 
                    target.FUN_APPLICATION=src.FUN_APPLICATION, 
                    target.FUN_AUTO=src.FUN_AUTO, 
                    target.FUN_AUTOREFRESHTIMER=src.FUN_AUTOREFRESHTIMER, 
                    target.FUN_BACKGROUND=src.FUN_BACKGROUND, 
                    target.FUN_BACKGROUNDGRAPH=src.FUN_BACKGROUNDGRAPH, 
                    target.FUN_BACKGROUNDREP=src.FUN_BACKGROUNDREP, 
                    target.FUN_BLOCKDURATION=src.FUN_BLOCKDURATION, 
                    target.FUN_CLASS=src.FUN_CLASS, 
                    target.FUN_CLASS_ORG=src.FUN_CLASS_ORG, 
                    target.FUN_CODE=src.FUN_CODE, 
                    target.FUN_COMMAND=src.FUN_COMMAND, 
                    target.FUN_DEFAULTRESERVATIONSTATUS=src.FUN_DEFAULTRESERVATIONSTATUS, 
                    target.FUN_DEFAULTRESERVATIONTYPE=src.FUN_DEFAULTRESERVATIONTYPE, 
                    target.FUN_DELETE=src.FUN_DELETE, 
                    target.FUN_DESC=src.FUN_DESC, 
                    target.FUN_DESCCHANGED=src.FUN_DESCCHANGED, 
                    target.FUN_DEVICE=src.FUN_DEVICE, 
                    target.FUN_DIRECTORY=src.FUN_DIRECTORY, 
                    target.FUN_DIRSEL=src.FUN_DIRSEL, 
                    target.FUN_DISPLAYAP=src.FUN_DISPLAYAP, 
                    target.FUN_DISPLAYFT=src.FUN_DISPLAYFT, 
                    target.FUN_EWSBTN=src.FUN_EWSBTN, 
                    target.FUN_EWSREPORT=src.FUN_EWSREPORT, 
                    target.FUN_EWSURLNEW=src.FUN_EWSURLNEW, 
                    target.FUN_FIELDFILTERCFCLASS=src.FUN_FIELDFILTERCFCLASS, 
                    target.FUN_FIELDFILTERCFCLASS_ORG=src.FUN_FIELDFILTERCFCLASS_ORG, 
                    target.FUN_FIELDFILTERCFORG=src.FUN_FIELDFILTERCFORG, 
                    target.FUN_FIELDFILTERCHECKLIST=src.FUN_FIELDFILTERCHECKLIST, 
                    target.FUN_FIELDFILTERCLASS=src.FUN_FIELDFILTERCLASS, 
                    target.FUN_FIELDFILTERTYPE=src.FUN_FIELDFILTERTYPE, 
                    target.FUN_FIELDFILTERWOOBJTYPE=src.FUN_FIELDFILTERWOOBJTYPE, 
                    target.FUN_FILE=src.FUN_FILE, 
                    target.FUN_FRIDAY=src.FUN_FRIDAY, 
                    target.FUN_HDR=src.FUN_HDR, 
                    target.FUN_ICON=src.FUN_ICON, 
                    target.FUN_INSERT=src.FUN_INSERT, 
                    target.FUN_LASTSAVED=src.FUN_LASTSAVED, 
                    target.FUN_LASTVALUE=src.FUN_LASTVALUE, 
                    target.FUN_LST=src.FUN_LST, 
                    target.FUN_MEKEY=src.FUN_MEKEY, 
                    target.FUN_MOBILEROUTE=src.FUN_MOBILEROUTE, 
                    target.FUN_MODE=src.FUN_MODE, 
                    target.FUN_MONDAY=src.FUN_MONDAY, 
                    target.FUN_NODESIGN=src.FUN_NODESIGN, 
                    target.FUN_NOW=src.FUN_NOW, 
                    target.FUN_ORIENTATION=src.FUN_ORIENTATION, 
                    target.FUN_PARENTFUNCTION=src.FUN_PARENTFUNCTION, 
                    target.FUN_PARENTTAB=src.FUN_PARENTTAB, 
                    target.FUN_PERTYPE=src.FUN_PERTYPE, 
                    target.FUN_POPUPAP=src.FUN_POPUPAP, 
                    target.FUN_POPUPFT=src.FUN_POPUPFT, 
                    target.FUN_POPUPFUNCTION=src.FUN_POPUPFUNCTION, 
                    target.FUN_PRDDATASRC=src.FUN_PRDDATASRC, 
                    target.FUN_PUBLIC=src.FUN_PUBLIC, 
                    target.FUN_RENTITY=src.FUN_RENTITY, 
                    target.FUN_REPDISABLED=src.FUN_REPDISABLED, 
                    target.FUN_RESERVATIONCALENDAR=src.FUN_RESERVATIONCALENDAR, 
                    target.FUN_RPTFILEUPDATED=src.FUN_RPTFILEUPDATED, 
                    target.FUN_RPTFILEUPDATEDBY=src.FUN_RPTFILEUPDATEDBY, 
                    target.FUN_RS=src.FUN_RS, 
                    target.FUN_SATURDAY=src.FUN_SATURDAY, 
                    target.FUN_SCHEDULERVIEW=src.FUN_SCHEDULERVIEW, 
                    target.FUN_SELECT=src.FUN_SELECT, 
                    target.FUN_SPLITVIEWDISPLAY=src.FUN_SPLITVIEWDISPLAY, 
                    target.FUN_STARTUPVIEW=src.FUN_STARTUPVIEW, 
                    target.FUN_SUBTYPE=src.FUN_SUBTYPE, 
                    target.FUN_SUNDAY=src.FUN_SUNDAY, 
                    target.FUN_SYSTEM=src.FUN_SYSTEM, 
                    target.FUN_THURSDAY=src.FUN_THURSDAY, 
                    target.FUN_TICKET=src.FUN_TICKET, 
                    target.FUN_TUESDAY=src.FUN_TUESDAY, 
                    target.FUN_TXTCODE=src.FUN_TXTCODE, 
                    target.FUN_UDFRENTITY=src.FUN_UDFRENTITY, 
                    target.FUN_UGFILE=src.FUN_UGFILE, 
                    target.FUN_UPDATE=src.FUN_UPDATE, 
                    target.FUN_UPDATECOUNT=src.FUN_UPDATECOUNT, 
                    target.FUN_UPDATED=src.FUN_UPDATED, 
                    target.FUN_WEDNESDAY=src.FUN_WEDNESDAY, 
                    target.FUN_WORKBOOK=src.FUN_WORKBOOK, 
                    target.FUN_WORKINGENDTIMEHOURS=src.FUN_WORKINGENDTIMEHOURS, 
                    target.FUN_WORKINGENDTIMEMINUTES=src.FUN_WORKINGENDTIMEMINUTES, 
                    target.FUN_WORKINGSTARTTIMEHOURS=src.FUN_WORKINGSTARTTIMEHOURS, 
                    target.FUN_WORKINGSTARTTIMEMINUTES=src.FUN_WORKINGSTARTTIMEMINUTES, 
                    target.FUN_WORKSHEET=src.FUN_WORKSHEET, 
                    target.FUN_XTYPE=src.FUN_XTYPE, 
                    target._DELETED=src._DELETED, 
                    target.ETL_LASTSAVED=src.ETL_LASTSAVED,
                    target.etl_load_datetime=CURRENT_TIMESTAMP,
                    target.etl_load_metadatafilename=src.etl_load_metadatafilename,
                    target.ETL_DELETED=src.ETL_DELETED
        when not matched   then insert ( FUN_ADVREPT, FUN_APPLICATION, FUN_AUTO, FUN_AUTOREFRESHTIMER, FUN_BACKGROUND, FUN_BACKGROUNDGRAPH, FUN_BACKGROUNDREP, FUN_BLOCKDURATION, FUN_CLASS, FUN_CLASS_ORG, FUN_CODE, FUN_COMMAND, FUN_DEFAULTRESERVATIONSTATUS, FUN_DEFAULTRESERVATIONTYPE, FUN_DELETE, FUN_DESC, FUN_DESCCHANGED, FUN_DEVICE, FUN_DIRECTORY, FUN_DIRSEL, FUN_DISPLAYAP, FUN_DISPLAYFT, FUN_EWSBTN, FUN_EWSREPORT, FUN_EWSURLNEW, FUN_FIELDFILTERCFCLASS, FUN_FIELDFILTERCFCLASS_ORG, FUN_FIELDFILTERCFORG, FUN_FIELDFILTERCHECKLIST, FUN_FIELDFILTERCLASS, FUN_FIELDFILTERTYPE, FUN_FIELDFILTERWOOBJTYPE, FUN_FILE, FUN_FRIDAY, FUN_HDR, FUN_ICON, FUN_INSERT, FUN_LASTSAVED, FUN_LASTVALUE, FUN_LST, FUN_MEKEY, FUN_MOBILEROUTE, FUN_MODE, FUN_MONDAY, FUN_NODESIGN, FUN_NOW, FUN_ORIENTATION, FUN_PARENTFUNCTION, FUN_PARENTTAB, FUN_PERTYPE, FUN_POPUPAP, FUN_POPUPFT, FUN_POPUPFUNCTION, FUN_PRDDATASRC, FUN_PUBLIC, FUN_RENTITY, FUN_REPDISABLED, FUN_RESERVATIONCALENDAR, FUN_RPTFILEUPDATED, FUN_RPTFILEUPDATEDBY, FUN_RS, FUN_SATURDAY, FUN_SCHEDULERVIEW, FUN_SELECT, FUN_SPLITVIEWDISPLAY, FUN_STARTUPVIEW, FUN_SUBTYPE, FUN_SUNDAY, FUN_SYSTEM, FUN_THURSDAY, FUN_TICKET, FUN_TUESDAY, FUN_TXTCODE, FUN_UDFRENTITY, FUN_UGFILE, FUN_UPDATE, FUN_UPDATECOUNT, FUN_UPDATED, FUN_WEDNESDAY, FUN_WORKBOOK, FUN_WORKINGENDTIMEHOURS, FUN_WORKINGENDTIMEMINUTES, FUN_WORKINGSTARTTIMEHOURS, FUN_WORKINGSTARTTIMEMINUTES, FUN_WORKSHEET, FUN_XTYPE, _DELETED, 
                    ETL_LASTSAVED,                       
                    etl_load_datetime,
                    etl_load_metadatafilename,
                    etl_is_deleted,
                    ETL_DELETED) 
            values (
                    src.FUN_ADVREPT, 
                    src.FUN_APPLICATION, 
                    src.FUN_AUTO, 
                    src.FUN_AUTOREFRESHTIMER, 
                    src.FUN_BACKGROUND, 
                    src.FUN_BACKGROUNDGRAPH, 
                    src.FUN_BACKGROUNDREP, 
                    src.FUN_BLOCKDURATION, 
                    src.FUN_CLASS, 
                    src.FUN_CLASS_ORG, 
                    src.FUN_CODE, 
                    src.FUN_COMMAND, 
                    src.FUN_DEFAULTRESERVATIONSTATUS, 
                    src.FUN_DEFAULTRESERVATIONTYPE, 
                    src.FUN_DELETE, 
                    src.FUN_DESC, 
                    src.FUN_DESCCHANGED, 
                    src.FUN_DEVICE, 
                    src.FUN_DIRECTORY, 
                    src.FUN_DIRSEL, 
                    src.FUN_DISPLAYAP, 
                    src.FUN_DISPLAYFT, 
                    src.FUN_EWSBTN, 
                    src.FUN_EWSREPORT, 
                    src.FUN_EWSURLNEW, 
                    src.FUN_FIELDFILTERCFCLASS, 
                    src.FUN_FIELDFILTERCFCLASS_ORG, 
                    src.FUN_FIELDFILTERCFORG, 
                    src.FUN_FIELDFILTERCHECKLIST, 
                    src.FUN_FIELDFILTERCLASS, 
                    src.FUN_FIELDFILTERTYPE, 
                    src.FUN_FIELDFILTERWOOBJTYPE, 
                    src.FUN_FILE, 
                    src.FUN_FRIDAY, 
                    src.FUN_HDR, 
                    src.FUN_ICON, 
                    src.FUN_INSERT, 
                    src.FUN_LASTSAVED, 
                    src.FUN_LASTVALUE, 
                    src.FUN_LST, 
                    src.FUN_MEKEY, 
                    src.FUN_MOBILEROUTE, 
                    src.FUN_MODE, 
                    src.FUN_MONDAY, 
                    src.FUN_NODESIGN, 
                    src.FUN_NOW, 
                    src.FUN_ORIENTATION, 
                    src.FUN_PARENTFUNCTION, 
                    src.FUN_PARENTTAB, 
                    src.FUN_PERTYPE, 
                    src.FUN_POPUPAP, 
                    src.FUN_POPUPFT, 
                    src.FUN_POPUPFUNCTION, 
                    src.FUN_PRDDATASRC, 
                    src.FUN_PUBLIC, 
                    src.FUN_RENTITY, 
                    src.FUN_REPDISABLED, 
                    src.FUN_RESERVATIONCALENDAR, 
                    src.FUN_RPTFILEUPDATED, 
                    src.FUN_RPTFILEUPDATEDBY, 
                    src.FUN_RS, 
                    src.FUN_SATURDAY, 
                    src.FUN_SCHEDULERVIEW, 
                    src.FUN_SELECT, 
                    src.FUN_SPLITVIEWDISPLAY, 
                    src.FUN_STARTUPVIEW, 
                    src.FUN_SUBTYPE, 
                    src.FUN_SUNDAY, 
                    src.FUN_SYSTEM, 
                    src.FUN_THURSDAY, 
                    src.FUN_TICKET, 
                    src.FUN_TUESDAY, 
                    src.FUN_TXTCODE, 
                    src.FUN_UDFRENTITY, 
                    src.FUN_UGFILE, 
                    src.FUN_UPDATE, 
                    src.FUN_UPDATECOUNT, 
                    src.FUN_UPDATED, 
                    src.FUN_WEDNESDAY, 
                    src.FUN_WORKBOOK, 
                    src.FUN_WORKINGENDTIMEHOURS, 
                    src.FUN_WORKINGENDTIMEMINUTES, 
                    src.FUN_WORKINGSTARTTIMEHOURS, 
                    src.FUN_WORKINGSTARTTIMEMINUTES, 
                    src.FUN_WORKSHEET, 
                    src.FUN_XTYPE, 
                    src._DELETED,     
                    src.ETL_LASTSAVED,
                    CURRENT_TIMESTAMP,
                    src.etl_load_metadatafilename,
                    case when ETL_DELETED=TRUE then TRUE else FALSE end,
                    ETL_DELETED);
    `
} );

                    
//  Get number of rows inserted
        
        var sqlStmt = snowflake.createStatement( {sqlText:  sql_command} );
        var rs = sqlStmt.execute();
        var number_of_rows_inserted = sqlStmt.getNumRowsInserted();
        var number_of_rows_updated =  sqlStmt.getNumRowsUpdated();
                    

        
    snowflake.execute ({sqlText: "commit"});

    log_sql_command = "call datahub_logging.sp_etl_log_ingestion_process('UpdateEnd','" + process_name + "','Success','Completed process execution.', 0 ," + number_of_rows_inserted.toString()+ "," +  number_of_rows_updated.toString() + ");";
    snowflake.execute({sqlText: log_sql_command});

    result = "Success"; 

    }       

    catch (err)  {
        snowflake.execute( {sqlText: "rollback;"} )
        var clean_error_msg = err.message.replace(/[^\w\s]/gi, '');
    //  Create a log entry to say INSERT STATEMENT failed
    
    log_sql_command = "call datahub_logging.sp_etl_log_ingestion_process('UpdateEnd','" + process_name + "','Failed','MERGE Failed. Error:" + err.code.toString()+" : "+ clean_error_msg  + "', 0 ,0,0);";
    snowflake.execute({sqlText: log_sql_command});
        ;
        throw "Failed: " + err.message;   // Return a success/error indicator.
        }
    return result;
    $$;