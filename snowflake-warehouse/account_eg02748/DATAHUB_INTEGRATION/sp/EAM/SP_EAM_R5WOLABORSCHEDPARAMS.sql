create or replace procedure DATAHUB_INTEGRATION.SP_EAM_R5WOLABORSCHEDPARAMS()
    returns varchar not null
                language javascript
                as
                $$

//  Variables

var result = "";                                    // return status of this proc call
const process_name = Object.keys(this)[0];          // name of currently executing process
var number_of_rows_inserted = 0;                             // track number of rows we have inserted
var number_of_rows_updated = 0;                             // track number of rows we have updated


//  Step 1.

//  Start execution - log start

log_sql_command = "call datahub_logging.sp_etl_log_ingestion_process('Insert','" + process_name + "','Running','Started process execution.', 0,0,0);";
snowflake.execute({sqlText: log_sql_command});

snowflake.execute( {sqlText: "begin transaction;"} );
try
    {
        var sql_command = `
                            INSERT INTO LANDING_ERROR.EAM_RAW_ERROR
                            SELECT * FROM LANDING_ERROR.VW_STREAM_EAM_R5WOLABORSCHEDPARAMS_ERROR`;
    var sqlStmt = snowflake.createStatement( {sqlText:  sql_command} );
    var rs = sqlStmt.execute();
        
        var sql_command = ` 
                            merge into  TARGET_EAM.EAM_R5WOLABORSCHEDPARAMS as target using (SELECT * FROM (SELECT 
            strm.WLS_ACTENDDATE, 
            strm.WLS_ACTSTARTDATE, 
            strm.WLS_ACTTASK, 
            strm.WLS_ACTTRADE, 
            strm.WLS_ALLOWACTSONDIFFSESSION, 
            strm.WLS_AUTOSELECTACTIVITY, 
            strm.WLS_CAMPAIGN, 
            strm.WLS_CAMPAIGN_LINE, 
            strm.WLS_CODE, 
            strm.WLS_CONSIST, 
            strm.WLS_CREATED, 
            strm.WLS_DATALASTGEN, 
            strm.WLS_DEFPARAM, 
            strm.WLS_EMPCLASS, 
            strm.WLS_EMPCLASSORG, 
            strm.WLS_EMPCREW, 
            strm.WLS_EMPCREWORG, 
            strm.WLS_EMPMRC, 
            strm.WLS_EMPSHIFT, 
            strm.WLS_EMPTRADE, 
            strm.WLS_EVENT_ORG, 
            strm.WLS_EXCLUDEDURATION, 
            strm.WLS_EXCLUDEPEOPLEREQUIRED, 
            strm.WLS_FULLYSCHEDCOLOR, 
            strm.WLS_GENAVAILTHROUGH, 
            strm.WLS_LASTSAVED, 
            strm.WLS_LIGHTLYSCHEDCOLOR, 
            strm.WLS_LISTLASTREFRESHED, 
            strm.WLS_MAXCALCPRIORITY, 
            strm.WLS_MODERATELYSCHEDCOLOR, 
            strm.WLS_MP, 
            strm.WLS_MP_ORG, 
            strm.WLS_MP_SEQ, 
            strm.WLS_OBJCATEGORY, 
            strm.WLS_OBJCLASS, 
            strm.WLS_OBJCLASSORG, 
            strm.WLS_OBJCOSTCODE, 
            strm.WLS_OBJECT, 
            strm.WLS_OBJINCLUDECHILDREN, 
            strm.WLS_OBJLOC, 
            strm.WLS_OBJLOCORG, 
            strm.WLS_OBJMRC, 
            strm.WLS_OBJORG, 
            strm.WLS_OBJPARENT, 
            strm.WLS_OBJPARENTORG, 
            strm.WLS_OBJSTATUS, 
            strm.WLS_OBJTYPE, 
            strm.WLS_OPERATIONALSTATUS, 
            strm.WLS_OVERSCHEDCOLOR, 
            strm.WLS_PARAMETER, 
            strm.WLS_SCHEDULING, 
            strm.WLS_SCHEDULINGSTARTDATE, 
            strm.WLS_SESSIONID, 
            strm.WLS_SHIFTDURATION, 
            strm.WLS_SHIFTSCHEDULING, 
            strm.WLS_SHIFTSTART, 
            strm.WLS_SKIPEQUIPSELECTIONPROCESS, 
            strm.WLS_THRESHOLDPERCENT, 
            strm.WLS_UNSCHEDCOLOR, 
            strm.WLS_UPDATECOUNT, 
            strm.WLS_UPDATED, 
            strm.WLS_USER, 
            strm.WLS_WOASSIGNEDBY, 
            strm.WLS_WOASSIGNEDTO, 
            strm.WLS_WOCLASS, 
            strm.WLS_WOCLASSORG, 
            strm.WLS_WOCRITICALITY, 
            strm.WLS_WOJOBTYPE, 
            strm.WLS_WOLOC, 
            strm.WLS_WOLOCORG, 
            strm.WLS_WOMRC, 
            strm.WLS_WOOBJECT, 
            strm.WLS_WOOBJECTORG, 
            strm.WLS_WOPMSCHEDULE, 
            strm.WLS_WOPRIORITY, 
            strm.WLS_WOPROJBUD, 
            strm.WLS_WOPROJECT, 
            strm.WLS_WOREPORTEDBY, 
            strm.WLS_WORKORDER, 
            strm.WLS_WOSCHEDENDDATE, 
            strm.WLS_WOSCHEDSTARTDATE, 
            strm.WLS_WOSHIFT, 
            strm.WLS_WOSTATUS, 
            strm._DELETED, 
            strm.ETL_LASTSAVED,
            strm.ETL_DELETED,
            strm.etl_load_datetime,
            strm.etl_load_metadatafilename,
            ROW_NUMBER() OVER (PARTITION BY 
            strm.WLS_CODE ORDER BY strm.ETL_LASTSAVED desc,IFNULL(TRY_TO_TIMESTAMP(replace(right(replace(lower(etl_load_metadatafilename),'.json'),23),'_','-'), 'yyyy-mm-dd-HH-MI-SS-FF') ,etl_load_datetime) desc) as ROWNUMBER
        FROM DATAHUB_INTEGRATION.VW_STREAM_EAM_R5WOLABORSCHEDPARAMS as  strm
                    )   
            WHERE ROWNUMBER=1  
            
                    ) as src on
            ((target.WLS_CODE=src.WLS_CODE) OR (target.WLS_CODE IS NULL AND src.WLS_CODE IS NULL)) 
                when matched and src.ETL_DELETED=TRUE THEN DELETE
                when matched then update set
                    target.WLS_ACTENDDATE=src.WLS_ACTENDDATE, 
                    target.WLS_ACTSTARTDATE=src.WLS_ACTSTARTDATE, 
                    target.WLS_ACTTASK=src.WLS_ACTTASK, 
                    target.WLS_ACTTRADE=src.WLS_ACTTRADE, 
                    target.WLS_ALLOWACTSONDIFFSESSION=src.WLS_ALLOWACTSONDIFFSESSION, 
                    target.WLS_AUTOSELECTACTIVITY=src.WLS_AUTOSELECTACTIVITY, 
                    target.WLS_CAMPAIGN=src.WLS_CAMPAIGN, 
                    target.WLS_CAMPAIGN_LINE=src.WLS_CAMPAIGN_LINE, 
                    target.WLS_CODE=src.WLS_CODE, 
                    target.WLS_CONSIST=src.WLS_CONSIST, 
                    target.WLS_CREATED=src.WLS_CREATED, 
                    target.WLS_DATALASTGEN=src.WLS_DATALASTGEN, 
                    target.WLS_DEFPARAM=src.WLS_DEFPARAM, 
                    target.WLS_EMPCLASS=src.WLS_EMPCLASS, 
                    target.WLS_EMPCLASSORG=src.WLS_EMPCLASSORG, 
                    target.WLS_EMPCREW=src.WLS_EMPCREW, 
                    target.WLS_EMPCREWORG=src.WLS_EMPCREWORG, 
                    target.WLS_EMPMRC=src.WLS_EMPMRC, 
                    target.WLS_EMPSHIFT=src.WLS_EMPSHIFT, 
                    target.WLS_EMPTRADE=src.WLS_EMPTRADE, 
                    target.WLS_EVENT_ORG=src.WLS_EVENT_ORG, 
                    target.WLS_EXCLUDEDURATION=src.WLS_EXCLUDEDURATION, 
                    target.WLS_EXCLUDEPEOPLEREQUIRED=src.WLS_EXCLUDEPEOPLEREQUIRED, 
                    target.WLS_FULLYSCHEDCOLOR=src.WLS_FULLYSCHEDCOLOR, 
                    target.WLS_GENAVAILTHROUGH=src.WLS_GENAVAILTHROUGH, 
                    target.WLS_LASTSAVED=src.WLS_LASTSAVED, 
                    target.WLS_LIGHTLYSCHEDCOLOR=src.WLS_LIGHTLYSCHEDCOLOR, 
                    target.WLS_LISTLASTREFRESHED=src.WLS_LISTLASTREFRESHED, 
                    target.WLS_MAXCALCPRIORITY=src.WLS_MAXCALCPRIORITY, 
                    target.WLS_MODERATELYSCHEDCOLOR=src.WLS_MODERATELYSCHEDCOLOR, 
                    target.WLS_MP=src.WLS_MP, 
                    target.WLS_MP_ORG=src.WLS_MP_ORG, 
                    target.WLS_MP_SEQ=src.WLS_MP_SEQ, 
                    target.WLS_OBJCATEGORY=src.WLS_OBJCATEGORY, 
                    target.WLS_OBJCLASS=src.WLS_OBJCLASS, 
                    target.WLS_OBJCLASSORG=src.WLS_OBJCLASSORG, 
                    target.WLS_OBJCOSTCODE=src.WLS_OBJCOSTCODE, 
                    target.WLS_OBJECT=src.WLS_OBJECT, 
                    target.WLS_OBJINCLUDECHILDREN=src.WLS_OBJINCLUDECHILDREN, 
                    target.WLS_OBJLOC=src.WLS_OBJLOC, 
                    target.WLS_OBJLOCORG=src.WLS_OBJLOCORG, 
                    target.WLS_OBJMRC=src.WLS_OBJMRC, 
                    target.WLS_OBJORG=src.WLS_OBJORG, 
                    target.WLS_OBJPARENT=src.WLS_OBJPARENT, 
                    target.WLS_OBJPARENTORG=src.WLS_OBJPARENTORG, 
                    target.WLS_OBJSTATUS=src.WLS_OBJSTATUS, 
                    target.WLS_OBJTYPE=src.WLS_OBJTYPE, 
                    target.WLS_OPERATIONALSTATUS=src.WLS_OPERATIONALSTATUS, 
                    target.WLS_OVERSCHEDCOLOR=src.WLS_OVERSCHEDCOLOR, 
                    target.WLS_PARAMETER=src.WLS_PARAMETER, 
                    target.WLS_SCHEDULING=src.WLS_SCHEDULING, 
                    target.WLS_SCHEDULINGSTARTDATE=src.WLS_SCHEDULINGSTARTDATE, 
                    target.WLS_SESSIONID=src.WLS_SESSIONID, 
                    target.WLS_SHIFTDURATION=src.WLS_SHIFTDURATION, 
                    target.WLS_SHIFTSCHEDULING=src.WLS_SHIFTSCHEDULING, 
                    target.WLS_SHIFTSTART=src.WLS_SHIFTSTART, 
                    target.WLS_SKIPEQUIPSELECTIONPROCESS=src.WLS_SKIPEQUIPSELECTIONPROCESS, 
                    target.WLS_THRESHOLDPERCENT=src.WLS_THRESHOLDPERCENT, 
                    target.WLS_UNSCHEDCOLOR=src.WLS_UNSCHEDCOLOR, 
                    target.WLS_UPDATECOUNT=src.WLS_UPDATECOUNT, 
                    target.WLS_UPDATED=src.WLS_UPDATED, 
                    target.WLS_USER=src.WLS_USER, 
                    target.WLS_WOASSIGNEDBY=src.WLS_WOASSIGNEDBY, 
                    target.WLS_WOASSIGNEDTO=src.WLS_WOASSIGNEDTO, 
                    target.WLS_WOCLASS=src.WLS_WOCLASS, 
                    target.WLS_WOCLASSORG=src.WLS_WOCLASSORG, 
                    target.WLS_WOCRITICALITY=src.WLS_WOCRITICALITY, 
                    target.WLS_WOJOBTYPE=src.WLS_WOJOBTYPE, 
                    target.WLS_WOLOC=src.WLS_WOLOC, 
                    target.WLS_WOLOCORG=src.WLS_WOLOCORG, 
                    target.WLS_WOMRC=src.WLS_WOMRC, 
                    target.WLS_WOOBJECT=src.WLS_WOOBJECT, 
                    target.WLS_WOOBJECTORG=src.WLS_WOOBJECTORG, 
                    target.WLS_WOPMSCHEDULE=src.WLS_WOPMSCHEDULE, 
                    target.WLS_WOPRIORITY=src.WLS_WOPRIORITY, 
                    target.WLS_WOPROJBUD=src.WLS_WOPROJBUD, 
                    target.WLS_WOPROJECT=src.WLS_WOPROJECT, 
                    target.WLS_WOREPORTEDBY=src.WLS_WOREPORTEDBY, 
                    target.WLS_WORKORDER=src.WLS_WORKORDER, 
                    target.WLS_WOSCHEDENDDATE=src.WLS_WOSCHEDENDDATE, 
                    target.WLS_WOSCHEDSTARTDATE=src.WLS_WOSCHEDSTARTDATE, 
                    target.WLS_WOSHIFT=src.WLS_WOSHIFT, 
                    target.WLS_WOSTATUS=src.WLS_WOSTATUS, 
                    target._DELETED=src._DELETED, 
                    target.ETL_LASTSAVED=src.ETL_LASTSAVED,
                    target.etl_load_datetime=CURRENT_TIMESTAMP,
                    target.etl_load_metadatafilename=src.etl_load_metadatafilename
        when not matched and (src.ETL_DELETED=FALSE OR src.ETL_DELETED IS NULL)  then insert ( 
                    WLS_ACTENDDATE, 
                    WLS_ACTSTARTDATE, 
                    WLS_ACTTASK, 
                    WLS_ACTTRADE, 
                    WLS_ALLOWACTSONDIFFSESSION, 
                    WLS_AUTOSELECTACTIVITY, 
                    WLS_CAMPAIGN, 
                    WLS_CAMPAIGN_LINE, 
                    WLS_CODE, 
                    WLS_CONSIST, 
                    WLS_CREATED, 
                    WLS_DATALASTGEN, 
                    WLS_DEFPARAM, 
                    WLS_EMPCLASS, 
                    WLS_EMPCLASSORG, 
                    WLS_EMPCREW, 
                    WLS_EMPCREWORG, 
                    WLS_EMPMRC, 
                    WLS_EMPSHIFT, 
                    WLS_EMPTRADE, 
                    WLS_EVENT_ORG, 
                    WLS_EXCLUDEDURATION, 
                    WLS_EXCLUDEPEOPLEREQUIRED, 
                    WLS_FULLYSCHEDCOLOR, 
                    WLS_GENAVAILTHROUGH, 
                    WLS_LASTSAVED, 
                    WLS_LIGHTLYSCHEDCOLOR, 
                    WLS_LISTLASTREFRESHED, 
                    WLS_MAXCALCPRIORITY, 
                    WLS_MODERATELYSCHEDCOLOR, 
                    WLS_MP, 
                    WLS_MP_ORG, 
                    WLS_MP_SEQ, 
                    WLS_OBJCATEGORY, 
                    WLS_OBJCLASS, 
                    WLS_OBJCLASSORG, 
                    WLS_OBJCOSTCODE, 
                    WLS_OBJECT, 
                    WLS_OBJINCLUDECHILDREN, 
                    WLS_OBJLOC, 
                    WLS_OBJLOCORG, 
                    WLS_OBJMRC, 
                    WLS_OBJORG, 
                    WLS_OBJPARENT, 
                    WLS_OBJPARENTORG, 
                    WLS_OBJSTATUS, 
                    WLS_OBJTYPE, 
                    WLS_OPERATIONALSTATUS, 
                    WLS_OVERSCHEDCOLOR, 
                    WLS_PARAMETER, 
                    WLS_SCHEDULING, 
                    WLS_SCHEDULINGSTARTDATE, 
                    WLS_SESSIONID, 
                    WLS_SHIFTDURATION, 
                    WLS_SHIFTSCHEDULING, 
                    WLS_SHIFTSTART, 
                    WLS_SKIPEQUIPSELECTIONPROCESS, 
                    WLS_THRESHOLDPERCENT, 
                    WLS_UNSCHEDCOLOR, 
                    WLS_UPDATECOUNT, 
                    WLS_UPDATED, 
                    WLS_USER, 
                    WLS_WOASSIGNEDBY, 
                    WLS_WOASSIGNEDTO, 
                    WLS_WOCLASS, 
                    WLS_WOCLASSORG, 
                    WLS_WOCRITICALITY, 
                    WLS_WOJOBTYPE, 
                    WLS_WOLOC, 
                    WLS_WOLOCORG, 
                    WLS_WOMRC, 
                    WLS_WOOBJECT, 
                    WLS_WOOBJECTORG, 
                    WLS_WOPMSCHEDULE, 
                    WLS_WOPRIORITY, 
                    WLS_WOPROJBUD, 
                    WLS_WOPROJECT, 
                    WLS_WOREPORTEDBY, 
                    WLS_WORKORDER, 
                    WLS_WOSCHEDENDDATE, 
                    WLS_WOSCHEDSTARTDATE, 
                    WLS_WOSHIFT, 
                    WLS_WOSTATUS, 
                    _DELETED, 
                    ETL_LASTSAVED,                       
                    etl_load_datetime,
                    etl_load_metadatafilename) 
            values (
                    src.WLS_ACTENDDATE, 
                    src.WLS_ACTSTARTDATE, 
                    src.WLS_ACTTASK, 
                    src.WLS_ACTTRADE, 
                    src.WLS_ALLOWACTSONDIFFSESSION, 
                    src.WLS_AUTOSELECTACTIVITY, 
                    src.WLS_CAMPAIGN, 
                    src.WLS_CAMPAIGN_LINE, 
                    src.WLS_CODE, 
                    src.WLS_CONSIST, 
                    src.WLS_CREATED, 
                    src.WLS_DATALASTGEN, 
                    src.WLS_DEFPARAM, 
                    src.WLS_EMPCLASS, 
                    src.WLS_EMPCLASSORG, 
                    src.WLS_EMPCREW, 
                    src.WLS_EMPCREWORG, 
                    src.WLS_EMPMRC, 
                    src.WLS_EMPSHIFT, 
                    src.WLS_EMPTRADE, 
                    src.WLS_EVENT_ORG, 
                    src.WLS_EXCLUDEDURATION, 
                    src.WLS_EXCLUDEPEOPLEREQUIRED, 
                    src.WLS_FULLYSCHEDCOLOR, 
                    src.WLS_GENAVAILTHROUGH, 
                    src.WLS_LASTSAVED, 
                    src.WLS_LIGHTLYSCHEDCOLOR, 
                    src.WLS_LISTLASTREFRESHED, 
                    src.WLS_MAXCALCPRIORITY, 
                    src.WLS_MODERATELYSCHEDCOLOR, 
                    src.WLS_MP, 
                    src.WLS_MP_ORG, 
                    src.WLS_MP_SEQ, 
                    src.WLS_OBJCATEGORY, 
                    src.WLS_OBJCLASS, 
                    src.WLS_OBJCLASSORG, 
                    src.WLS_OBJCOSTCODE, 
                    src.WLS_OBJECT, 
                    src.WLS_OBJINCLUDECHILDREN, 
                    src.WLS_OBJLOC, 
                    src.WLS_OBJLOCORG, 
                    src.WLS_OBJMRC, 
                    src.WLS_OBJORG, 
                    src.WLS_OBJPARENT, 
                    src.WLS_OBJPARENTORG, 
                    src.WLS_OBJSTATUS, 
                    src.WLS_OBJTYPE, 
                    src.WLS_OPERATIONALSTATUS, 
                    src.WLS_OVERSCHEDCOLOR, 
                    src.WLS_PARAMETER, 
                    src.WLS_SCHEDULING, 
                    src.WLS_SCHEDULINGSTARTDATE, 
                    src.WLS_SESSIONID, 
                    src.WLS_SHIFTDURATION, 
                    src.WLS_SHIFTSCHEDULING, 
                    src.WLS_SHIFTSTART, 
                    src.WLS_SKIPEQUIPSELECTIONPROCESS, 
                    src.WLS_THRESHOLDPERCENT, 
                    src.WLS_UNSCHEDCOLOR, 
                    src.WLS_UPDATECOUNT, 
                    src.WLS_UPDATED, 
                    src.WLS_USER, 
                    src.WLS_WOASSIGNEDBY, 
                    src.WLS_WOASSIGNEDTO, 
                    src.WLS_WOCLASS, 
                    src.WLS_WOCLASSORG, 
                    src.WLS_WOCRITICALITY, 
                    src.WLS_WOJOBTYPE, 
                    src.WLS_WOLOC, 
                    src.WLS_WOLOCORG, 
                    src.WLS_WOMRC, 
                    src.WLS_WOOBJECT, 
                    src.WLS_WOOBJECTORG, 
                    src.WLS_WOPMSCHEDULE, 
                    src.WLS_WOPRIORITY, 
                    src.WLS_WOPROJBUD, 
                    src.WLS_WOPROJECT, 
                    src.WLS_WOREPORTEDBY, 
                    src.WLS_WORKORDER, 
                    src.WLS_WOSCHEDENDDATE, 
                    src.WLS_WOSCHEDSTARTDATE, 
                    src.WLS_WOSHIFT, 
                    src.WLS_WOSTATUS, 
                    src._DELETED,     
                    src.ETL_LASTSAVED,
                    CURRENT_TIMESTAMP,
                    src.etl_load_metadatafilename);`;

    var sqlStmt = snowflake.createStatement( {sqlText:  sql_command} );
    var rs = sqlStmt.execute();

    snowflake.execute( {sqlText: `merge into TARGET_HISTORY_EAM.EAM_R5WOLABORSCHEDPARAMS_DELETED as target using (
                SELECT * FROM (SELECT 
            strm.WLS_ACTENDDATE, 
            strm.WLS_ACTSTARTDATE, 
            strm.WLS_ACTTASK, 
            strm.WLS_ACTTRADE, 
            strm.WLS_ALLOWACTSONDIFFSESSION, 
            strm.WLS_AUTOSELECTACTIVITY, 
            strm.WLS_CAMPAIGN, 
            strm.WLS_CAMPAIGN_LINE, 
            strm.WLS_CODE, 
            strm.WLS_CONSIST, 
            strm.WLS_CREATED, 
            strm.WLS_DATALASTGEN, 
            strm.WLS_DEFPARAM, 
            strm.WLS_EMPCLASS, 
            strm.WLS_EMPCLASSORG, 
            strm.WLS_EMPCREW, 
            strm.WLS_EMPCREWORG, 
            strm.WLS_EMPMRC, 
            strm.WLS_EMPSHIFT, 
            strm.WLS_EMPTRADE, 
            strm.WLS_EVENT_ORG, 
            strm.WLS_EXCLUDEDURATION, 
            strm.WLS_EXCLUDEPEOPLEREQUIRED, 
            strm.WLS_FULLYSCHEDCOLOR, 
            strm.WLS_GENAVAILTHROUGH, 
            strm.WLS_LASTSAVED, 
            strm.WLS_LIGHTLYSCHEDCOLOR, 
            strm.WLS_LISTLASTREFRESHED, 
            strm.WLS_MAXCALCPRIORITY, 
            strm.WLS_MODERATELYSCHEDCOLOR, 
            strm.WLS_MP, 
            strm.WLS_MP_ORG, 
            strm.WLS_MP_SEQ, 
            strm.WLS_OBJCATEGORY, 
            strm.WLS_OBJCLASS, 
            strm.WLS_OBJCLASSORG, 
            strm.WLS_OBJCOSTCODE, 
            strm.WLS_OBJECT, 
            strm.WLS_OBJINCLUDECHILDREN, 
            strm.WLS_OBJLOC, 
            strm.WLS_OBJLOCORG, 
            strm.WLS_OBJMRC, 
            strm.WLS_OBJORG, 
            strm.WLS_OBJPARENT, 
            strm.WLS_OBJPARENTORG, 
            strm.WLS_OBJSTATUS, 
            strm.WLS_OBJTYPE, 
            strm.WLS_OPERATIONALSTATUS, 
            strm.WLS_OVERSCHEDCOLOR, 
            strm.WLS_PARAMETER, 
            strm.WLS_SCHEDULING, 
            strm.WLS_SCHEDULINGSTARTDATE, 
            strm.WLS_SESSIONID, 
            strm.WLS_SHIFTDURATION, 
            strm.WLS_SHIFTSCHEDULING, 
            strm.WLS_SHIFTSTART, 
            strm.WLS_SKIPEQUIPSELECTIONPROCESS, 
            strm.WLS_THRESHOLDPERCENT, 
            strm.WLS_UNSCHEDCOLOR, 
            strm.WLS_UPDATECOUNT, 
            strm.WLS_UPDATED, 
            strm.WLS_USER, 
            strm.WLS_WOASSIGNEDBY, 
            strm.WLS_WOASSIGNEDTO, 
            strm.WLS_WOCLASS, 
            strm.WLS_WOCLASSORG, 
            strm.WLS_WOCRITICALITY, 
            strm.WLS_WOJOBTYPE, 
            strm.WLS_WOLOC, 
            strm.WLS_WOLOCORG, 
            strm.WLS_WOMRC, 
            strm.WLS_WOOBJECT, 
            strm.WLS_WOOBJECTORG, 
            strm.WLS_WOPMSCHEDULE, 
            strm.WLS_WOPRIORITY, 
            strm.WLS_WOPROJBUD, 
            strm.WLS_WOPROJECT, 
            strm.WLS_WOREPORTEDBY, 
            strm.WLS_WORKORDER, 
            strm.WLS_WOSCHEDENDDATE, 
            strm.WLS_WOSCHEDSTARTDATE, 
            strm.WLS_WOSHIFT, 
            strm.WLS_WOSTATUS, 
            strm._DELETED, 
            strm.ETL_LASTSAVED,
            strm.ETL_DELETED,
            strm.etl_load_datetime,
            strm.etl_load_metadatafilename,
            ROW_NUMBER() OVER (PARTITION BY 
            strm.WLS_CODE ORDER BY strm.ETL_LASTSAVED desc,IFNULL(TRY_TO_TIMESTAMP(replace(right(replace(lower(etl_load_metadatafilename),'.json'),23),'_','-'), 'yyyy-mm-dd-HH-MI-SS-FF') ,etl_load_datetime) desc) as ROWNUMBER
        FROM DATAHUB_INTEGRATION.VW_STREAM_EAM_R5WOLABORSCHEDPARAMS as  strm
        WHERE strm.ETL_DELETED=TRUE
                    )   
            WHERE ROWNUMBER=1  
            
                    ) as src on
            ((target.WLS_CODE=src.WLS_CODE) OR (target.WLS_CODE IS NULL AND src.WLS_CODE IS NULL)) 
                when matched then update set
                    target.WLS_ACTENDDATE=src.WLS_ACTENDDATE, 
                    target.WLS_ACTSTARTDATE=src.WLS_ACTSTARTDATE, 
                    target.WLS_ACTTASK=src.WLS_ACTTASK, 
                    target.WLS_ACTTRADE=src.WLS_ACTTRADE, 
                    target.WLS_ALLOWACTSONDIFFSESSION=src.WLS_ALLOWACTSONDIFFSESSION, 
                    target.WLS_AUTOSELECTACTIVITY=src.WLS_AUTOSELECTACTIVITY, 
                    target.WLS_CAMPAIGN=src.WLS_CAMPAIGN, 
                    target.WLS_CAMPAIGN_LINE=src.WLS_CAMPAIGN_LINE, 
                    target.WLS_CODE=src.WLS_CODE, 
                    target.WLS_CONSIST=src.WLS_CONSIST, 
                    target.WLS_CREATED=src.WLS_CREATED, 
                    target.WLS_DATALASTGEN=src.WLS_DATALASTGEN, 
                    target.WLS_DEFPARAM=src.WLS_DEFPARAM, 
                    target.WLS_EMPCLASS=src.WLS_EMPCLASS, 
                    target.WLS_EMPCLASSORG=src.WLS_EMPCLASSORG, 
                    target.WLS_EMPCREW=src.WLS_EMPCREW, 
                    target.WLS_EMPCREWORG=src.WLS_EMPCREWORG, 
                    target.WLS_EMPMRC=src.WLS_EMPMRC, 
                    target.WLS_EMPSHIFT=src.WLS_EMPSHIFT, 
                    target.WLS_EMPTRADE=src.WLS_EMPTRADE, 
                    target.WLS_EVENT_ORG=src.WLS_EVENT_ORG, 
                    target.WLS_EXCLUDEDURATION=src.WLS_EXCLUDEDURATION, 
                    target.WLS_EXCLUDEPEOPLEREQUIRED=src.WLS_EXCLUDEPEOPLEREQUIRED, 
                    target.WLS_FULLYSCHEDCOLOR=src.WLS_FULLYSCHEDCOLOR, 
                    target.WLS_GENAVAILTHROUGH=src.WLS_GENAVAILTHROUGH, 
                    target.WLS_LASTSAVED=src.WLS_LASTSAVED, 
                    target.WLS_LIGHTLYSCHEDCOLOR=src.WLS_LIGHTLYSCHEDCOLOR, 
                    target.WLS_LISTLASTREFRESHED=src.WLS_LISTLASTREFRESHED, 
                    target.WLS_MAXCALCPRIORITY=src.WLS_MAXCALCPRIORITY, 
                    target.WLS_MODERATELYSCHEDCOLOR=src.WLS_MODERATELYSCHEDCOLOR, 
                    target.WLS_MP=src.WLS_MP, 
                    target.WLS_MP_ORG=src.WLS_MP_ORG, 
                    target.WLS_MP_SEQ=src.WLS_MP_SEQ, 
                    target.WLS_OBJCATEGORY=src.WLS_OBJCATEGORY, 
                    target.WLS_OBJCLASS=src.WLS_OBJCLASS, 
                    target.WLS_OBJCLASSORG=src.WLS_OBJCLASSORG, 
                    target.WLS_OBJCOSTCODE=src.WLS_OBJCOSTCODE, 
                    target.WLS_OBJECT=src.WLS_OBJECT, 
                    target.WLS_OBJINCLUDECHILDREN=src.WLS_OBJINCLUDECHILDREN, 
                    target.WLS_OBJLOC=src.WLS_OBJLOC, 
                    target.WLS_OBJLOCORG=src.WLS_OBJLOCORG, 
                    target.WLS_OBJMRC=src.WLS_OBJMRC, 
                    target.WLS_OBJORG=src.WLS_OBJORG, 
                    target.WLS_OBJPARENT=src.WLS_OBJPARENT, 
                    target.WLS_OBJPARENTORG=src.WLS_OBJPARENTORG, 
                    target.WLS_OBJSTATUS=src.WLS_OBJSTATUS, 
                    target.WLS_OBJTYPE=src.WLS_OBJTYPE, 
                    target.WLS_OPERATIONALSTATUS=src.WLS_OPERATIONALSTATUS, 
                    target.WLS_OVERSCHEDCOLOR=src.WLS_OVERSCHEDCOLOR, 
                    target.WLS_PARAMETER=src.WLS_PARAMETER, 
                    target.WLS_SCHEDULING=src.WLS_SCHEDULING, 
                    target.WLS_SCHEDULINGSTARTDATE=src.WLS_SCHEDULINGSTARTDATE, 
                    target.WLS_SESSIONID=src.WLS_SESSIONID, 
                    target.WLS_SHIFTDURATION=src.WLS_SHIFTDURATION, 
                    target.WLS_SHIFTSCHEDULING=src.WLS_SHIFTSCHEDULING, 
                    target.WLS_SHIFTSTART=src.WLS_SHIFTSTART, 
                    target.WLS_SKIPEQUIPSELECTIONPROCESS=src.WLS_SKIPEQUIPSELECTIONPROCESS, 
                    target.WLS_THRESHOLDPERCENT=src.WLS_THRESHOLDPERCENT, 
                    target.WLS_UNSCHEDCOLOR=src.WLS_UNSCHEDCOLOR, 
                    target.WLS_UPDATECOUNT=src.WLS_UPDATECOUNT, 
                    target.WLS_UPDATED=src.WLS_UPDATED, 
                    target.WLS_USER=src.WLS_USER, 
                    target.WLS_WOASSIGNEDBY=src.WLS_WOASSIGNEDBY, 
                    target.WLS_WOASSIGNEDTO=src.WLS_WOASSIGNEDTO, 
                    target.WLS_WOCLASS=src.WLS_WOCLASS, 
                    target.WLS_WOCLASSORG=src.WLS_WOCLASSORG, 
                    target.WLS_WOCRITICALITY=src.WLS_WOCRITICALITY, 
                    target.WLS_WOJOBTYPE=src.WLS_WOJOBTYPE, 
                    target.WLS_WOLOC=src.WLS_WOLOC, 
                    target.WLS_WOLOCORG=src.WLS_WOLOCORG, 
                    target.WLS_WOMRC=src.WLS_WOMRC, 
                    target.WLS_WOOBJECT=src.WLS_WOOBJECT, 
                    target.WLS_WOOBJECTORG=src.WLS_WOOBJECTORG, 
                    target.WLS_WOPMSCHEDULE=src.WLS_WOPMSCHEDULE, 
                    target.WLS_WOPRIORITY=src.WLS_WOPRIORITY, 
                    target.WLS_WOPROJBUD=src.WLS_WOPROJBUD, 
                    target.WLS_WOPROJECT=src.WLS_WOPROJECT, 
                    target.WLS_WOREPORTEDBY=src.WLS_WOREPORTEDBY, 
                    target.WLS_WORKORDER=src.WLS_WORKORDER, 
                    target.WLS_WOSCHEDENDDATE=src.WLS_WOSCHEDENDDATE, 
                    target.WLS_WOSCHEDSTARTDATE=src.WLS_WOSCHEDSTARTDATE, 
                    target.WLS_WOSHIFT=src.WLS_WOSHIFT, 
                    target.WLS_WOSTATUS=src.WLS_WOSTATUS, 
                    target._DELETED=src._DELETED, 
                    target.ETL_LASTSAVED=src.ETL_LASTSAVED,
                    target.etl_load_datetime=CURRENT_TIMESTAMP,
                    target.etl_load_metadatafilename=src.etl_load_metadatafilename,
                    target.ETL_DELETED=src.ETL_DELETED
        when not matched   then insert ( WLS_ACTENDDATE, WLS_ACTSTARTDATE, WLS_ACTTASK, WLS_ACTTRADE, WLS_ALLOWACTSONDIFFSESSION, WLS_AUTOSELECTACTIVITY, WLS_CAMPAIGN, WLS_CAMPAIGN_LINE, WLS_CODE, WLS_CONSIST, WLS_CREATED, WLS_DATALASTGEN, WLS_DEFPARAM, WLS_EMPCLASS, WLS_EMPCLASSORG, WLS_EMPCREW, WLS_EMPCREWORG, WLS_EMPMRC, WLS_EMPSHIFT, WLS_EMPTRADE, WLS_EVENT_ORG, WLS_EXCLUDEDURATION, WLS_EXCLUDEPEOPLEREQUIRED, WLS_FULLYSCHEDCOLOR, WLS_GENAVAILTHROUGH, WLS_LASTSAVED, WLS_LIGHTLYSCHEDCOLOR, WLS_LISTLASTREFRESHED, WLS_MAXCALCPRIORITY, WLS_MODERATELYSCHEDCOLOR, WLS_MP, WLS_MP_ORG, WLS_MP_SEQ, WLS_OBJCATEGORY, WLS_OBJCLASS, WLS_OBJCLASSORG, WLS_OBJCOSTCODE, WLS_OBJECT, WLS_OBJINCLUDECHILDREN, WLS_OBJLOC, WLS_OBJLOCORG, WLS_OBJMRC, WLS_OBJORG, WLS_OBJPARENT, WLS_OBJPARENTORG, WLS_OBJSTATUS, WLS_OBJTYPE, WLS_OPERATIONALSTATUS, WLS_OVERSCHEDCOLOR, WLS_PARAMETER, WLS_SCHEDULING, WLS_SCHEDULINGSTARTDATE, WLS_SESSIONID, WLS_SHIFTDURATION, WLS_SHIFTSCHEDULING, WLS_SHIFTSTART, WLS_SKIPEQUIPSELECTIONPROCESS, WLS_THRESHOLDPERCENT, WLS_UNSCHEDCOLOR, WLS_UPDATECOUNT, WLS_UPDATED, WLS_USER, WLS_WOASSIGNEDBY, WLS_WOASSIGNEDTO, WLS_WOCLASS, WLS_WOCLASSORG, WLS_WOCRITICALITY, WLS_WOJOBTYPE, WLS_WOLOC, WLS_WOLOCORG, WLS_WOMRC, WLS_WOOBJECT, WLS_WOOBJECTORG, WLS_WOPMSCHEDULE, WLS_WOPRIORITY, WLS_WOPROJBUD, WLS_WOPROJECT, WLS_WOREPORTEDBY, WLS_WORKORDER, WLS_WOSCHEDENDDATE, WLS_WOSCHEDSTARTDATE, WLS_WOSHIFT, WLS_WOSTATUS, _DELETED, 
                    ETL_LASTSAVED,                       
                    etl_load_datetime,
                    etl_load_metadatafilename,
                    etl_is_deleted,
                    ETL_DELETED) 
            values (
                    src.WLS_ACTENDDATE, 
                    src.WLS_ACTSTARTDATE, 
                    src.WLS_ACTTASK, 
                    src.WLS_ACTTRADE, 
                    src.WLS_ALLOWACTSONDIFFSESSION, 
                    src.WLS_AUTOSELECTACTIVITY, 
                    src.WLS_CAMPAIGN, 
                    src.WLS_CAMPAIGN_LINE, 
                    src.WLS_CODE, 
                    src.WLS_CONSIST, 
                    src.WLS_CREATED, 
                    src.WLS_DATALASTGEN, 
                    src.WLS_DEFPARAM, 
                    src.WLS_EMPCLASS, 
                    src.WLS_EMPCLASSORG, 
                    src.WLS_EMPCREW, 
                    src.WLS_EMPCREWORG, 
                    src.WLS_EMPMRC, 
                    src.WLS_EMPSHIFT, 
                    src.WLS_EMPTRADE, 
                    src.WLS_EVENT_ORG, 
                    src.WLS_EXCLUDEDURATION, 
                    src.WLS_EXCLUDEPEOPLEREQUIRED, 
                    src.WLS_FULLYSCHEDCOLOR, 
                    src.WLS_GENAVAILTHROUGH, 
                    src.WLS_LASTSAVED, 
                    src.WLS_LIGHTLYSCHEDCOLOR, 
                    src.WLS_LISTLASTREFRESHED, 
                    src.WLS_MAXCALCPRIORITY, 
                    src.WLS_MODERATELYSCHEDCOLOR, 
                    src.WLS_MP, 
                    src.WLS_MP_ORG, 
                    src.WLS_MP_SEQ, 
                    src.WLS_OBJCATEGORY, 
                    src.WLS_OBJCLASS, 
                    src.WLS_OBJCLASSORG, 
                    src.WLS_OBJCOSTCODE, 
                    src.WLS_OBJECT, 
                    src.WLS_OBJINCLUDECHILDREN, 
                    src.WLS_OBJLOC, 
                    src.WLS_OBJLOCORG, 
                    src.WLS_OBJMRC, 
                    src.WLS_OBJORG, 
                    src.WLS_OBJPARENT, 
                    src.WLS_OBJPARENTORG, 
                    src.WLS_OBJSTATUS, 
                    src.WLS_OBJTYPE, 
                    src.WLS_OPERATIONALSTATUS, 
                    src.WLS_OVERSCHEDCOLOR, 
                    src.WLS_PARAMETER, 
                    src.WLS_SCHEDULING, 
                    src.WLS_SCHEDULINGSTARTDATE, 
                    src.WLS_SESSIONID, 
                    src.WLS_SHIFTDURATION, 
                    src.WLS_SHIFTSCHEDULING, 
                    src.WLS_SHIFTSTART, 
                    src.WLS_SKIPEQUIPSELECTIONPROCESS, 
                    src.WLS_THRESHOLDPERCENT, 
                    src.WLS_UNSCHEDCOLOR, 
                    src.WLS_UPDATECOUNT, 
                    src.WLS_UPDATED, 
                    src.WLS_USER, 
                    src.WLS_WOASSIGNEDBY, 
                    src.WLS_WOASSIGNEDTO, 
                    src.WLS_WOCLASS, 
                    src.WLS_WOCLASSORG, 
                    src.WLS_WOCRITICALITY, 
                    src.WLS_WOJOBTYPE, 
                    src.WLS_WOLOC, 
                    src.WLS_WOLOCORG, 
                    src.WLS_WOMRC, 
                    src.WLS_WOOBJECT, 
                    src.WLS_WOOBJECTORG, 
                    src.WLS_WOPMSCHEDULE, 
                    src.WLS_WOPRIORITY, 
                    src.WLS_WOPROJBUD, 
                    src.WLS_WOPROJECT, 
                    src.WLS_WOREPORTEDBY, 
                    src.WLS_WORKORDER, 
                    src.WLS_WOSCHEDENDDATE, 
                    src.WLS_WOSCHEDSTARTDATE, 
                    src.WLS_WOSHIFT, 
                    src.WLS_WOSTATUS, 
                    src._DELETED,     
                    src.ETL_LASTSAVED,
                    CURRENT_TIMESTAMP,
                    src.etl_load_metadatafilename,
                    case when ETL_DELETED=TRUE then TRUE else FALSE end,
                    ETL_DELETED);
    `
} );

                    
//  Get number of rows inserted
        
        var sqlStmt = snowflake.createStatement( {sqlText:  sql_command} );
        var rs = sqlStmt.execute();
        var number_of_rows_inserted = sqlStmt.getNumRowsInserted();
        var number_of_rows_updated =  sqlStmt.getNumRowsUpdated();
                    

        
    snowflake.execute ({sqlText: "commit"});

    log_sql_command = "call datahub_logging.sp_etl_log_ingestion_process('UpdateEnd','" + process_name + "','Success','Completed process execution.', 0 ," + number_of_rows_inserted.toString()+ "," +  number_of_rows_updated.toString() + ");";
    snowflake.execute({sqlText: log_sql_command});

    result = "Success"; 

    }       

    catch (err)  {
        snowflake.execute( {sqlText: "rollback;"} )
        var clean_error_msg = err.message.replace(/[^\w\s]/gi, '');
    //  Create a log entry to say INSERT STATEMENT failed
    
    log_sql_command = "call datahub_logging.sp_etl_log_ingestion_process('UpdateEnd','" + process_name + "','Failed','MERGE Failed. Error:" + err.code.toString()+" : "+ clean_error_msg  + "', 0 ,0,0);";
    snowflake.execute({sqlText: log_sql_command});
        ;
        throw "Failed: " + err.message;   // Return a success/error indicator.
        }
    return result;
    $$;