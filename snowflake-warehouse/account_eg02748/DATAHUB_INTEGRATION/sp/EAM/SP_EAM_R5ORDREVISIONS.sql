create or replace procedure DATAHUB_INTEGRATION.SP_EAM_R5ORDREVISIONS()
    returns varchar not null
                language javascript
                as
                $$

//  Variables

var result = "";                                    // return status of this proc call
const process_name = Object.keys(this)[0];          // name of currently executing process
var number_of_rows_inserted = 0;                             // track number of rows we have inserted
var number_of_rows_updated = 0;                             // track number of rows we have updated


//  Step 1.

//  Start execution - log start

log_sql_command = "call datahub_logging.sp_etl_log_ingestion_process('Insert','" + process_name + "','Running','Started process execution.', 0,0,0);";
snowflake.execute({sqlText: log_sql_command});

snowflake.execute( {sqlText: "begin transaction;"} );
try
    {
        var sql_command = `
                            INSERT INTO LANDING_ERROR.EAM_RAW_ERROR
                            SELECT * FROM LANDING_ERROR.VW_STREAM_EAM_R5ORDREVISIONS_ERROR`;
    var sqlStmt = snowflake.createStatement( {sqlText:  sql_command} );
    var rs = sqlStmt.execute();
        
        var sql_command = ` 
                            merge into  TARGET_EAM.EAM_R5ORDREVISIONS as target using (SELECT * FROM (SELECT 
            strm.ORR_ACD, 
            strm.ORR_APPROV, 
            strm.ORR_ATTENTIONTO, 
            strm.ORR_AUTH, 
            strm.ORR_BLANKETORDER, 
            strm.ORR_BLANKETRELEASE, 
            strm.ORR_BUYER, 
            strm.ORR_CLASS, 
            strm.ORR_CLASS_ORG, 
            strm.ORR_CONTRACT, 
            strm.ORR_CONTROLNO, 
            strm.ORR_CREATED, 
            strm.ORR_CREDITCARD, 
            strm.ORR_CURR, 
            strm.ORR_DATE, 
            strm.ORR_DELADDRESS, 
            strm.ORR_DESC, 
            strm.ORR_DFLTAUTH, 
            strm.ORR_DISCOUNT, 
            strm.ORR_DISCPERC, 
            strm.ORR_DUE, 
            strm.ORR_EXCH, 
            strm.ORR_EXCHFROMDUAL, 
            strm.ORR_EXCHTODUAL, 
            strm.ORR_FOBPOINT, 
            strm.ORR_FREIGHTTERMS, 
            strm.ORR_INTERFACE, 
            strm.ORR_IPTRANSMITTED, 
            strm.ORR_JECATEGORY, 
            strm.ORR_JESOURCE, 
            strm.ORR_LASTSAVED, 
            strm.ORR_LASTSTATUSUPDATE, 
            strm.ORR_MAILTOSITE, 
            strm.ORR_ORDER, 
            strm.ORR_ORDER_ORG, 
            strm.ORR_ORIGIN, 
            strm.ORR_PACKAGETRACKINGNUMBER, 
            strm.ORR_PAYBYMETHOD, 
            strm.ORR_PAYMENTTERMS, 
            strm.ORR_PRICE, 
            strm.ORR_PRINTED, 
            strm.ORR_REVISED, 
            strm.ORR_REVISEDBY, 
            strm.ORR_REVISEDORDER, 
            strm.ORR_REVISION, 
            strm.ORR_REVISIONREASON, 
            strm.ORR_RSTATUS, 
            strm.ORR_RTYPE, 
            strm.ORR_SHIPVIA, 
            strm.ORR_SOURCECODE, 
            strm.ORR_SOURCESYSTEM, 
            strm.ORR_STATUS, 
            strm.ORR_STORE, 
            strm.ORR_SUPPLIER, 
            strm.ORR_SUPPLIER_ORG, 
            strm.ORR_TYPE, 
            strm.ORR_UDFCHAR01, 
            strm.ORR_UDFCHAR02, 
            strm.ORR_UDFCHAR03, 
            strm.ORR_UDFCHAR04, 
            strm.ORR_UDFCHAR05, 
            strm.ORR_UDFCHAR06, 
            strm.ORR_UDFCHAR07, 
            strm.ORR_UDFCHAR08, 
            strm.ORR_UDFCHAR09, 
            strm.ORR_UDFCHAR10, 
            strm.ORR_UDFCHAR11, 
            strm.ORR_UDFCHAR12, 
            strm.ORR_UDFCHAR13, 
            strm.ORR_UDFCHAR14, 
            strm.ORR_UDFCHAR15, 
            strm.ORR_UDFCHAR16, 
            strm.ORR_UDFCHAR17, 
            strm.ORR_UDFCHAR18, 
            strm.ORR_UDFCHAR19, 
            strm.ORR_UDFCHAR20, 
            strm.ORR_UDFCHAR21, 
            strm.ORR_UDFCHAR22, 
            strm.ORR_UDFCHAR23, 
            strm.ORR_UDFCHAR24, 
            strm.ORR_UDFCHAR25, 
            strm.ORR_UDFCHAR26, 
            strm.ORR_UDFCHAR27, 
            strm.ORR_UDFCHAR28, 
            strm.ORR_UDFCHAR29, 
            strm.ORR_UDFCHAR30, 
            strm.ORR_UDFCHKBOX01, 
            strm.ORR_UDFCHKBOX02, 
            strm.ORR_UDFCHKBOX03, 
            strm.ORR_UDFCHKBOX04, 
            strm.ORR_UDFCHKBOX05, 
            strm.ORR_UDFDATE01, 
            strm.ORR_UDFDATE02, 
            strm.ORR_UDFDATE03, 
            strm.ORR_UDFDATE04, 
            strm.ORR_UDFDATE05, 
            strm.ORR_UDFNUM01, 
            strm.ORR_UDFNUM02, 
            strm.ORR_UDFNUM03, 
            strm.ORR_UDFNUM04, 
            strm.ORR_UDFNUM05, 
            strm.ORR_UPDATECOUNT, 
            strm.ORR_UPDATED, 
            strm._DELETED, 
            strm.ETL_LASTSAVED,
            strm.ETL_DELETED,
            strm.etl_load_datetime,
            strm.etl_load_metadatafilename,
            ROW_NUMBER() OVER (PARTITION BY 
            strm.ORR_ORDER,
            strm.ORR_ORDER_ORG,
            strm.ORR_REVISION ORDER BY strm.ETL_LASTSAVED desc,IFNULL(TRY_TO_TIMESTAMP(replace(right(replace(lower(etl_load_metadatafilename),'.json'),23),'_','-'), 'yyyy-mm-dd-HH-MI-SS-FF') ,etl_load_datetime) desc) as ROWNUMBER
        FROM DATAHUB_INTEGRATION.VW_STREAM_EAM_R5ORDREVISIONS as  strm
                    )   
            WHERE ROWNUMBER=1  
            
                    ) as src on
            ((target.ORR_ORDER=src.ORR_ORDER) OR (target.ORR_ORDER IS NULL AND src.ORR_ORDER IS NULL)) AND
            ((target.ORR_ORDER_ORG=src.ORR_ORDER_ORG) OR (target.ORR_ORDER_ORG IS NULL AND src.ORR_ORDER_ORG IS NULL)) AND
            ((target.ORR_REVISION=src.ORR_REVISION) OR (target.ORR_REVISION IS NULL AND src.ORR_REVISION IS NULL)) 
                when matched and src.ETL_DELETED=TRUE THEN DELETE
                when matched then update set
                    target.ORR_ACD=src.ORR_ACD, 
                    target.ORR_APPROV=src.ORR_APPROV, 
                    target.ORR_ATTENTIONTO=src.ORR_ATTENTIONTO, 
                    target.ORR_AUTH=src.ORR_AUTH, 
                    target.ORR_BLANKETORDER=src.ORR_BLANKETORDER, 
                    target.ORR_BLANKETRELEASE=src.ORR_BLANKETRELEASE, 
                    target.ORR_BUYER=src.ORR_BUYER, 
                    target.ORR_CLASS=src.ORR_CLASS, 
                    target.ORR_CLASS_ORG=src.ORR_CLASS_ORG, 
                    target.ORR_CONTRACT=src.ORR_CONTRACT, 
                    target.ORR_CONTROLNO=src.ORR_CONTROLNO, 
                    target.ORR_CREATED=src.ORR_CREATED, 
                    target.ORR_CREDITCARD=src.ORR_CREDITCARD, 
                    target.ORR_CURR=src.ORR_CURR, 
                    target.ORR_DATE=src.ORR_DATE, 
                    target.ORR_DELADDRESS=src.ORR_DELADDRESS, 
                    target.ORR_DESC=src.ORR_DESC, 
                    target.ORR_DFLTAUTH=src.ORR_DFLTAUTH, 
                    target.ORR_DISCOUNT=src.ORR_DISCOUNT, 
                    target.ORR_DISCPERC=src.ORR_DISCPERC, 
                    target.ORR_DUE=src.ORR_DUE, 
                    target.ORR_EXCH=src.ORR_EXCH, 
                    target.ORR_EXCHFROMDUAL=src.ORR_EXCHFROMDUAL, 
                    target.ORR_EXCHTODUAL=src.ORR_EXCHTODUAL, 
                    target.ORR_FOBPOINT=src.ORR_FOBPOINT, 
                    target.ORR_FREIGHTTERMS=src.ORR_FREIGHTTERMS, 
                    target.ORR_INTERFACE=src.ORR_INTERFACE, 
                    target.ORR_IPTRANSMITTED=src.ORR_IPTRANSMITTED, 
                    target.ORR_JECATEGORY=src.ORR_JECATEGORY, 
                    target.ORR_JESOURCE=src.ORR_JESOURCE, 
                    target.ORR_LASTSAVED=src.ORR_LASTSAVED, 
                    target.ORR_LASTSTATUSUPDATE=src.ORR_LASTSTATUSUPDATE, 
                    target.ORR_MAILTOSITE=src.ORR_MAILTOSITE, 
                    target.ORR_ORDER=src.ORR_ORDER, 
                    target.ORR_ORDER_ORG=src.ORR_ORDER_ORG, 
                    target.ORR_ORIGIN=src.ORR_ORIGIN, 
                    target.ORR_PACKAGETRACKINGNUMBER=src.ORR_PACKAGETRACKINGNUMBER, 
                    target.ORR_PAYBYMETHOD=src.ORR_PAYBYMETHOD, 
                    target.ORR_PAYMENTTERMS=src.ORR_PAYMENTTERMS, 
                    target.ORR_PRICE=src.ORR_PRICE, 
                    target.ORR_PRINTED=src.ORR_PRINTED, 
                    target.ORR_REVISED=src.ORR_REVISED, 
                    target.ORR_REVISEDBY=src.ORR_REVISEDBY, 
                    target.ORR_REVISEDORDER=src.ORR_REVISEDORDER, 
                    target.ORR_REVISION=src.ORR_REVISION, 
                    target.ORR_REVISIONREASON=src.ORR_REVISIONREASON, 
                    target.ORR_RSTATUS=src.ORR_RSTATUS, 
                    target.ORR_RTYPE=src.ORR_RTYPE, 
                    target.ORR_SHIPVIA=src.ORR_SHIPVIA, 
                    target.ORR_SOURCECODE=src.ORR_SOURCECODE, 
                    target.ORR_SOURCESYSTEM=src.ORR_SOURCESYSTEM, 
                    target.ORR_STATUS=src.ORR_STATUS, 
                    target.ORR_STORE=src.ORR_STORE, 
                    target.ORR_SUPPLIER=src.ORR_SUPPLIER, 
                    target.ORR_SUPPLIER_ORG=src.ORR_SUPPLIER_ORG, 
                    target.ORR_TYPE=src.ORR_TYPE, 
                    target.ORR_UDFCHAR01=src.ORR_UDFCHAR01, 
                    target.ORR_UDFCHAR02=src.ORR_UDFCHAR02, 
                    target.ORR_UDFCHAR03=src.ORR_UDFCHAR03, 
                    target.ORR_UDFCHAR04=src.ORR_UDFCHAR04, 
                    target.ORR_UDFCHAR05=src.ORR_UDFCHAR05, 
                    target.ORR_UDFCHAR06=src.ORR_UDFCHAR06, 
                    target.ORR_UDFCHAR07=src.ORR_UDFCHAR07, 
                    target.ORR_UDFCHAR08=src.ORR_UDFCHAR08, 
                    target.ORR_UDFCHAR09=src.ORR_UDFCHAR09, 
                    target.ORR_UDFCHAR10=src.ORR_UDFCHAR10, 
                    target.ORR_UDFCHAR11=src.ORR_UDFCHAR11, 
                    target.ORR_UDFCHAR12=src.ORR_UDFCHAR12, 
                    target.ORR_UDFCHAR13=src.ORR_UDFCHAR13, 
                    target.ORR_UDFCHAR14=src.ORR_UDFCHAR14, 
                    target.ORR_UDFCHAR15=src.ORR_UDFCHAR15, 
                    target.ORR_UDFCHAR16=src.ORR_UDFCHAR16, 
                    target.ORR_UDFCHAR17=src.ORR_UDFCHAR17, 
                    target.ORR_UDFCHAR18=src.ORR_UDFCHAR18, 
                    target.ORR_UDFCHAR19=src.ORR_UDFCHAR19, 
                    target.ORR_UDFCHAR20=src.ORR_UDFCHAR20, 
                    target.ORR_UDFCHAR21=src.ORR_UDFCHAR21, 
                    target.ORR_UDFCHAR22=src.ORR_UDFCHAR22, 
                    target.ORR_UDFCHAR23=src.ORR_UDFCHAR23, 
                    target.ORR_UDFCHAR24=src.ORR_UDFCHAR24, 
                    target.ORR_UDFCHAR25=src.ORR_UDFCHAR25, 
                    target.ORR_UDFCHAR26=src.ORR_UDFCHAR26, 
                    target.ORR_UDFCHAR27=src.ORR_UDFCHAR27, 
                    target.ORR_UDFCHAR28=src.ORR_UDFCHAR28, 
                    target.ORR_UDFCHAR29=src.ORR_UDFCHAR29, 
                    target.ORR_UDFCHAR30=src.ORR_UDFCHAR30, 
                    target.ORR_UDFCHKBOX01=src.ORR_UDFCHKBOX01, 
                    target.ORR_UDFCHKBOX02=src.ORR_UDFCHKBOX02, 
                    target.ORR_UDFCHKBOX03=src.ORR_UDFCHKBOX03, 
                    target.ORR_UDFCHKBOX04=src.ORR_UDFCHKBOX04, 
                    target.ORR_UDFCHKBOX05=src.ORR_UDFCHKBOX05, 
                    target.ORR_UDFDATE01=src.ORR_UDFDATE01, 
                    target.ORR_UDFDATE02=src.ORR_UDFDATE02, 
                    target.ORR_UDFDATE03=src.ORR_UDFDATE03, 
                    target.ORR_UDFDATE04=src.ORR_UDFDATE04, 
                    target.ORR_UDFDATE05=src.ORR_UDFDATE05, 
                    target.ORR_UDFNUM01=src.ORR_UDFNUM01, 
                    target.ORR_UDFNUM02=src.ORR_UDFNUM02, 
                    target.ORR_UDFNUM03=src.ORR_UDFNUM03, 
                    target.ORR_UDFNUM04=src.ORR_UDFNUM04, 
                    target.ORR_UDFNUM05=src.ORR_UDFNUM05, 
                    target.ORR_UPDATECOUNT=src.ORR_UPDATECOUNT, 
                    target.ORR_UPDATED=src.ORR_UPDATED, 
                    target._DELETED=src._DELETED, 
                    target.ETL_LASTSAVED=src.ETL_LASTSAVED,
                    target.etl_load_datetime=CURRENT_TIMESTAMP,
                    target.etl_load_metadatafilename=src.etl_load_metadatafilename
        when not matched and (src.ETL_DELETED=FALSE OR src.ETL_DELETED IS NULL)  then insert ( 
                    ORR_ACD, 
                    ORR_APPROV, 
                    ORR_ATTENTIONTO, 
                    ORR_AUTH, 
                    ORR_BLANKETORDER, 
                    ORR_BLANKETRELEASE, 
                    ORR_BUYER, 
                    ORR_CLASS, 
                    ORR_CLASS_ORG, 
                    ORR_CONTRACT, 
                    ORR_CONTROLNO, 
                    ORR_CREATED, 
                    ORR_CREDITCARD, 
                    ORR_CURR, 
                    ORR_DATE, 
                    ORR_DELADDRESS, 
                    ORR_DESC, 
                    ORR_DFLTAUTH, 
                    ORR_DISCOUNT, 
                    ORR_DISCPERC, 
                    ORR_DUE, 
                    ORR_EXCH, 
                    ORR_EXCHFROMDUAL, 
                    ORR_EXCHTODUAL, 
                    ORR_FOBPOINT, 
                    ORR_FREIGHTTERMS, 
                    ORR_INTERFACE, 
                    ORR_IPTRANSMITTED, 
                    ORR_JECATEGORY, 
                    ORR_JESOURCE, 
                    ORR_LASTSAVED, 
                    ORR_LASTSTATUSUPDATE, 
                    ORR_MAILTOSITE, 
                    ORR_ORDER, 
                    ORR_ORDER_ORG, 
                    ORR_ORIGIN, 
                    ORR_PACKAGETRACKINGNUMBER, 
                    ORR_PAYBYMETHOD, 
                    ORR_PAYMENTTERMS, 
                    ORR_PRICE, 
                    ORR_PRINTED, 
                    ORR_REVISED, 
                    ORR_REVISEDBY, 
                    ORR_REVISEDORDER, 
                    ORR_REVISION, 
                    ORR_REVISIONREASON, 
                    ORR_RSTATUS, 
                    ORR_RTYPE, 
                    ORR_SHIPVIA, 
                    ORR_SOURCECODE, 
                    ORR_SOURCESYSTEM, 
                    ORR_STATUS, 
                    ORR_STORE, 
                    ORR_SUPPLIER, 
                    ORR_SUPPLIER_ORG, 
                    ORR_TYPE, 
                    ORR_UDFCHAR01, 
                    ORR_UDFCHAR02, 
                    ORR_UDFCHAR03, 
                    ORR_UDFCHAR04, 
                    ORR_UDFCHAR05, 
                    ORR_UDFCHAR06, 
                    ORR_UDFCHAR07, 
                    ORR_UDFCHAR08, 
                    ORR_UDFCHAR09, 
                    ORR_UDFCHAR10, 
                    ORR_UDFCHAR11, 
                    ORR_UDFCHAR12, 
                    ORR_UDFCHAR13, 
                    ORR_UDFCHAR14, 
                    ORR_UDFCHAR15, 
                    ORR_UDFCHAR16, 
                    ORR_UDFCHAR17, 
                    ORR_UDFCHAR18, 
                    ORR_UDFCHAR19, 
                    ORR_UDFCHAR20, 
                    ORR_UDFCHAR21, 
                    ORR_UDFCHAR22, 
                    ORR_UDFCHAR23, 
                    ORR_UDFCHAR24, 
                    ORR_UDFCHAR25, 
                    ORR_UDFCHAR26, 
                    ORR_UDFCHAR27, 
                    ORR_UDFCHAR28, 
                    ORR_UDFCHAR29, 
                    ORR_UDFCHAR30, 
                    ORR_UDFCHKBOX01, 
                    ORR_UDFCHKBOX02, 
                    ORR_UDFCHKBOX03, 
                    ORR_UDFCHKBOX04, 
                    ORR_UDFCHKBOX05, 
                    ORR_UDFDATE01, 
                    ORR_UDFDATE02, 
                    ORR_UDFDATE03, 
                    ORR_UDFDATE04, 
                    ORR_UDFDATE05, 
                    ORR_UDFNUM01, 
                    ORR_UDFNUM02, 
                    ORR_UDFNUM03, 
                    ORR_UDFNUM04, 
                    ORR_UDFNUM05, 
                    ORR_UPDATECOUNT, 
                    ORR_UPDATED, 
                    _DELETED, 
                    ETL_LASTSAVED,                       
                    etl_load_datetime,
                    etl_load_metadatafilename) 
            values (
                    src.ORR_ACD, 
                    src.ORR_APPROV, 
                    src.ORR_ATTENTIONTO, 
                    src.ORR_AUTH, 
                    src.ORR_BLANKETORDER, 
                    src.ORR_BLANKETRELEASE, 
                    src.ORR_BUYER, 
                    src.ORR_CLASS, 
                    src.ORR_CLASS_ORG, 
                    src.ORR_CONTRACT, 
                    src.ORR_CONTROLNO, 
                    src.ORR_CREATED, 
                    src.ORR_CREDITCARD, 
                    src.ORR_CURR, 
                    src.ORR_DATE, 
                    src.ORR_DELADDRESS, 
                    src.ORR_DESC, 
                    src.ORR_DFLTAUTH, 
                    src.ORR_DISCOUNT, 
                    src.ORR_DISCPERC, 
                    src.ORR_DUE, 
                    src.ORR_EXCH, 
                    src.ORR_EXCHFROMDUAL, 
                    src.ORR_EXCHTODUAL, 
                    src.ORR_FOBPOINT, 
                    src.ORR_FREIGHTTERMS, 
                    src.ORR_INTERFACE, 
                    src.ORR_IPTRANSMITTED, 
                    src.ORR_JECATEGORY, 
                    src.ORR_JESOURCE, 
                    src.ORR_LASTSAVED, 
                    src.ORR_LASTSTATUSUPDATE, 
                    src.ORR_MAILTOSITE, 
                    src.ORR_ORDER, 
                    src.ORR_ORDER_ORG, 
                    src.ORR_ORIGIN, 
                    src.ORR_PACKAGETRACKINGNUMBER, 
                    src.ORR_PAYBYMETHOD, 
                    src.ORR_PAYMENTTERMS, 
                    src.ORR_PRICE, 
                    src.ORR_PRINTED, 
                    src.ORR_REVISED, 
                    src.ORR_REVISEDBY, 
                    src.ORR_REVISEDORDER, 
                    src.ORR_REVISION, 
                    src.ORR_REVISIONREASON, 
                    src.ORR_RSTATUS, 
                    src.ORR_RTYPE, 
                    src.ORR_SHIPVIA, 
                    src.ORR_SOURCECODE, 
                    src.ORR_SOURCESYSTEM, 
                    src.ORR_STATUS, 
                    src.ORR_STORE, 
                    src.ORR_SUPPLIER, 
                    src.ORR_SUPPLIER_ORG, 
                    src.ORR_TYPE, 
                    src.ORR_UDFCHAR01, 
                    src.ORR_UDFCHAR02, 
                    src.ORR_UDFCHAR03, 
                    src.ORR_UDFCHAR04, 
                    src.ORR_UDFCHAR05, 
                    src.ORR_UDFCHAR06, 
                    src.ORR_UDFCHAR07, 
                    src.ORR_UDFCHAR08, 
                    src.ORR_UDFCHAR09, 
                    src.ORR_UDFCHAR10, 
                    src.ORR_UDFCHAR11, 
                    src.ORR_UDFCHAR12, 
                    src.ORR_UDFCHAR13, 
                    src.ORR_UDFCHAR14, 
                    src.ORR_UDFCHAR15, 
                    src.ORR_UDFCHAR16, 
                    src.ORR_UDFCHAR17, 
                    src.ORR_UDFCHAR18, 
                    src.ORR_UDFCHAR19, 
                    src.ORR_UDFCHAR20, 
                    src.ORR_UDFCHAR21, 
                    src.ORR_UDFCHAR22, 
                    src.ORR_UDFCHAR23, 
                    src.ORR_UDFCHAR24, 
                    src.ORR_UDFCHAR25, 
                    src.ORR_UDFCHAR26, 
                    src.ORR_UDFCHAR27, 
                    src.ORR_UDFCHAR28, 
                    src.ORR_UDFCHAR29, 
                    src.ORR_UDFCHAR30, 
                    src.ORR_UDFCHKBOX01, 
                    src.ORR_UDFCHKBOX02, 
                    src.ORR_UDFCHKBOX03, 
                    src.ORR_UDFCHKBOX04, 
                    src.ORR_UDFCHKBOX05, 
                    src.ORR_UDFDATE01, 
                    src.ORR_UDFDATE02, 
                    src.ORR_UDFDATE03, 
                    src.ORR_UDFDATE04, 
                    src.ORR_UDFDATE05, 
                    src.ORR_UDFNUM01, 
                    src.ORR_UDFNUM02, 
                    src.ORR_UDFNUM03, 
                    src.ORR_UDFNUM04, 
                    src.ORR_UDFNUM05, 
                    src.ORR_UPDATECOUNT, 
                    src.ORR_UPDATED, 
                    src._DELETED,     
                    src.ETL_LASTSAVED,
                    CURRENT_TIMESTAMP,
                    src.etl_load_metadatafilename);`;

    var sqlStmt = snowflake.createStatement( {sqlText:  sql_command} );
    var rs = sqlStmt.execute();

    snowflake.execute( {sqlText: `merge into TARGET_HISTORY_EAM.EAM_R5ORDREVISIONS_DELETED as target using (
                SELECT * FROM (SELECT 
            strm.ORR_ACD, 
            strm.ORR_APPROV, 
            strm.ORR_ATTENTIONTO, 
            strm.ORR_AUTH, 
            strm.ORR_BLANKETORDER, 
            strm.ORR_BLANKETRELEASE, 
            strm.ORR_BUYER, 
            strm.ORR_CLASS, 
            strm.ORR_CLASS_ORG, 
            strm.ORR_CONTRACT, 
            strm.ORR_CONTROLNO, 
            strm.ORR_CREATED, 
            strm.ORR_CREDITCARD, 
            strm.ORR_CURR, 
            strm.ORR_DATE, 
            strm.ORR_DELADDRESS, 
            strm.ORR_DESC, 
            strm.ORR_DFLTAUTH, 
            strm.ORR_DISCOUNT, 
            strm.ORR_DISCPERC, 
            strm.ORR_DUE, 
            strm.ORR_EXCH, 
            strm.ORR_EXCHFROMDUAL, 
            strm.ORR_EXCHTODUAL, 
            strm.ORR_FOBPOINT, 
            strm.ORR_FREIGHTTERMS, 
            strm.ORR_INTERFACE, 
            strm.ORR_IPTRANSMITTED, 
            strm.ORR_JECATEGORY, 
            strm.ORR_JESOURCE, 
            strm.ORR_LASTSAVED, 
            strm.ORR_LASTSTATUSUPDATE, 
            strm.ORR_MAILTOSITE, 
            strm.ORR_ORDER, 
            strm.ORR_ORDER_ORG, 
            strm.ORR_ORIGIN, 
            strm.ORR_PACKAGETRACKINGNUMBER, 
            strm.ORR_PAYBYMETHOD, 
            strm.ORR_PAYMENTTERMS, 
            strm.ORR_PRICE, 
            strm.ORR_PRINTED, 
            strm.ORR_REVISED, 
            strm.ORR_REVISEDBY, 
            strm.ORR_REVISEDORDER, 
            strm.ORR_REVISION, 
            strm.ORR_REVISIONREASON, 
            strm.ORR_RSTATUS, 
            strm.ORR_RTYPE, 
            strm.ORR_SHIPVIA, 
            strm.ORR_SOURCECODE, 
            strm.ORR_SOURCESYSTEM, 
            strm.ORR_STATUS, 
            strm.ORR_STORE, 
            strm.ORR_SUPPLIER, 
            strm.ORR_SUPPLIER_ORG, 
            strm.ORR_TYPE, 
            strm.ORR_UDFCHAR01, 
            strm.ORR_UDFCHAR02, 
            strm.ORR_UDFCHAR03, 
            strm.ORR_UDFCHAR04, 
            strm.ORR_UDFCHAR05, 
            strm.ORR_UDFCHAR06, 
            strm.ORR_UDFCHAR07, 
            strm.ORR_UDFCHAR08, 
            strm.ORR_UDFCHAR09, 
            strm.ORR_UDFCHAR10, 
            strm.ORR_UDFCHAR11, 
            strm.ORR_UDFCHAR12, 
            strm.ORR_UDFCHAR13, 
            strm.ORR_UDFCHAR14, 
            strm.ORR_UDFCHAR15, 
            strm.ORR_UDFCHAR16, 
            strm.ORR_UDFCHAR17, 
            strm.ORR_UDFCHAR18, 
            strm.ORR_UDFCHAR19, 
            strm.ORR_UDFCHAR20, 
            strm.ORR_UDFCHAR21, 
            strm.ORR_UDFCHAR22, 
            strm.ORR_UDFCHAR23, 
            strm.ORR_UDFCHAR24, 
            strm.ORR_UDFCHAR25, 
            strm.ORR_UDFCHAR26, 
            strm.ORR_UDFCHAR27, 
            strm.ORR_UDFCHAR28, 
            strm.ORR_UDFCHAR29, 
            strm.ORR_UDFCHAR30, 
            strm.ORR_UDFCHKBOX01, 
            strm.ORR_UDFCHKBOX02, 
            strm.ORR_UDFCHKBOX03, 
            strm.ORR_UDFCHKBOX04, 
            strm.ORR_UDFCHKBOX05, 
            strm.ORR_UDFDATE01, 
            strm.ORR_UDFDATE02, 
            strm.ORR_UDFDATE03, 
            strm.ORR_UDFDATE04, 
            strm.ORR_UDFDATE05, 
            strm.ORR_UDFNUM01, 
            strm.ORR_UDFNUM02, 
            strm.ORR_UDFNUM03, 
            strm.ORR_UDFNUM04, 
            strm.ORR_UDFNUM05, 
            strm.ORR_UPDATECOUNT, 
            strm.ORR_UPDATED, 
            strm._DELETED, 
            strm.ETL_LASTSAVED,
            strm.ETL_DELETED,
            strm.etl_load_datetime,
            strm.etl_load_metadatafilename,
            ROW_NUMBER() OVER (PARTITION BY 
            strm.ORR_ORDER,
            strm.ORR_ORDER_ORG,
            strm.ORR_REVISION ORDER BY strm.ETL_LASTSAVED desc,IFNULL(TRY_TO_TIMESTAMP(replace(right(replace(lower(etl_load_metadatafilename),'.json'),23),'_','-'), 'yyyy-mm-dd-HH-MI-SS-FF') ,etl_load_datetime) desc) as ROWNUMBER
        FROM DATAHUB_INTEGRATION.VW_STREAM_EAM_R5ORDREVISIONS as  strm
        WHERE strm.ETL_DELETED=TRUE
                    )   
            WHERE ROWNUMBER=1  
            
                    ) as src on
            ((target.ORR_ORDER=src.ORR_ORDER) OR (target.ORR_ORDER IS NULL AND src.ORR_ORDER IS NULL)) AND
            ((target.ORR_ORDER_ORG=src.ORR_ORDER_ORG) OR (target.ORR_ORDER_ORG IS NULL AND src.ORR_ORDER_ORG IS NULL)) AND
            ((target.ORR_REVISION=src.ORR_REVISION) OR (target.ORR_REVISION IS NULL AND src.ORR_REVISION IS NULL)) 
                when matched then update set
                    target.ORR_ACD=src.ORR_ACD, 
                    target.ORR_APPROV=src.ORR_APPROV, 
                    target.ORR_ATTENTIONTO=src.ORR_ATTENTIONTO, 
                    target.ORR_AUTH=src.ORR_AUTH, 
                    target.ORR_BLANKETORDER=src.ORR_BLANKETORDER, 
                    target.ORR_BLANKETRELEASE=src.ORR_BLANKETRELEASE, 
                    target.ORR_BUYER=src.ORR_BUYER, 
                    target.ORR_CLASS=src.ORR_CLASS, 
                    target.ORR_CLASS_ORG=src.ORR_CLASS_ORG, 
                    target.ORR_CONTRACT=src.ORR_CONTRACT, 
                    target.ORR_CONTROLNO=src.ORR_CONTROLNO, 
                    target.ORR_CREATED=src.ORR_CREATED, 
                    target.ORR_CREDITCARD=src.ORR_CREDITCARD, 
                    target.ORR_CURR=src.ORR_CURR, 
                    target.ORR_DATE=src.ORR_DATE, 
                    target.ORR_DELADDRESS=src.ORR_DELADDRESS, 
                    target.ORR_DESC=src.ORR_DESC, 
                    target.ORR_DFLTAUTH=src.ORR_DFLTAUTH, 
                    target.ORR_DISCOUNT=src.ORR_DISCOUNT, 
                    target.ORR_DISCPERC=src.ORR_DISCPERC, 
                    target.ORR_DUE=src.ORR_DUE, 
                    target.ORR_EXCH=src.ORR_EXCH, 
                    target.ORR_EXCHFROMDUAL=src.ORR_EXCHFROMDUAL, 
                    target.ORR_EXCHTODUAL=src.ORR_EXCHTODUAL, 
                    target.ORR_FOBPOINT=src.ORR_FOBPOINT, 
                    target.ORR_FREIGHTTERMS=src.ORR_FREIGHTTERMS, 
                    target.ORR_INTERFACE=src.ORR_INTERFACE, 
                    target.ORR_IPTRANSMITTED=src.ORR_IPTRANSMITTED, 
                    target.ORR_JECATEGORY=src.ORR_JECATEGORY, 
                    target.ORR_JESOURCE=src.ORR_JESOURCE, 
                    target.ORR_LASTSAVED=src.ORR_LASTSAVED, 
                    target.ORR_LASTSTATUSUPDATE=src.ORR_LASTSTATUSUPDATE, 
                    target.ORR_MAILTOSITE=src.ORR_MAILTOSITE, 
                    target.ORR_ORDER=src.ORR_ORDER, 
                    target.ORR_ORDER_ORG=src.ORR_ORDER_ORG, 
                    target.ORR_ORIGIN=src.ORR_ORIGIN, 
                    target.ORR_PACKAGETRACKINGNUMBER=src.ORR_PACKAGETRACKINGNUMBER, 
                    target.ORR_PAYBYMETHOD=src.ORR_PAYBYMETHOD, 
                    target.ORR_PAYMENTTERMS=src.ORR_PAYMENTTERMS, 
                    target.ORR_PRICE=src.ORR_PRICE, 
                    target.ORR_PRINTED=src.ORR_PRINTED, 
                    target.ORR_REVISED=src.ORR_REVISED, 
                    target.ORR_REVISEDBY=src.ORR_REVISEDBY, 
                    target.ORR_REVISEDORDER=src.ORR_REVISEDORDER, 
                    target.ORR_REVISION=src.ORR_REVISION, 
                    target.ORR_REVISIONREASON=src.ORR_REVISIONREASON, 
                    target.ORR_RSTATUS=src.ORR_RSTATUS, 
                    target.ORR_RTYPE=src.ORR_RTYPE, 
                    target.ORR_SHIPVIA=src.ORR_SHIPVIA, 
                    target.ORR_SOURCECODE=src.ORR_SOURCECODE, 
                    target.ORR_SOURCESYSTEM=src.ORR_SOURCESYSTEM, 
                    target.ORR_STATUS=src.ORR_STATUS, 
                    target.ORR_STORE=src.ORR_STORE, 
                    target.ORR_SUPPLIER=src.ORR_SUPPLIER, 
                    target.ORR_SUPPLIER_ORG=src.ORR_SUPPLIER_ORG, 
                    target.ORR_TYPE=src.ORR_TYPE, 
                    target.ORR_UDFCHAR01=src.ORR_UDFCHAR01, 
                    target.ORR_UDFCHAR02=src.ORR_UDFCHAR02, 
                    target.ORR_UDFCHAR03=src.ORR_UDFCHAR03, 
                    target.ORR_UDFCHAR04=src.ORR_UDFCHAR04, 
                    target.ORR_UDFCHAR05=src.ORR_UDFCHAR05, 
                    target.ORR_UDFCHAR06=src.ORR_UDFCHAR06, 
                    target.ORR_UDFCHAR07=src.ORR_UDFCHAR07, 
                    target.ORR_UDFCHAR08=src.ORR_UDFCHAR08, 
                    target.ORR_UDFCHAR09=src.ORR_UDFCHAR09, 
                    target.ORR_UDFCHAR10=src.ORR_UDFCHAR10, 
                    target.ORR_UDFCHAR11=src.ORR_UDFCHAR11, 
                    target.ORR_UDFCHAR12=src.ORR_UDFCHAR12, 
                    target.ORR_UDFCHAR13=src.ORR_UDFCHAR13, 
                    target.ORR_UDFCHAR14=src.ORR_UDFCHAR14, 
                    target.ORR_UDFCHAR15=src.ORR_UDFCHAR15, 
                    target.ORR_UDFCHAR16=src.ORR_UDFCHAR16, 
                    target.ORR_UDFCHAR17=src.ORR_UDFCHAR17, 
                    target.ORR_UDFCHAR18=src.ORR_UDFCHAR18, 
                    target.ORR_UDFCHAR19=src.ORR_UDFCHAR19, 
                    target.ORR_UDFCHAR20=src.ORR_UDFCHAR20, 
                    target.ORR_UDFCHAR21=src.ORR_UDFCHAR21, 
                    target.ORR_UDFCHAR22=src.ORR_UDFCHAR22, 
                    target.ORR_UDFCHAR23=src.ORR_UDFCHAR23, 
                    target.ORR_UDFCHAR24=src.ORR_UDFCHAR24, 
                    target.ORR_UDFCHAR25=src.ORR_UDFCHAR25, 
                    target.ORR_UDFCHAR26=src.ORR_UDFCHAR26, 
                    target.ORR_UDFCHAR27=src.ORR_UDFCHAR27, 
                    target.ORR_UDFCHAR28=src.ORR_UDFCHAR28, 
                    target.ORR_UDFCHAR29=src.ORR_UDFCHAR29, 
                    target.ORR_UDFCHAR30=src.ORR_UDFCHAR30, 
                    target.ORR_UDFCHKBOX01=src.ORR_UDFCHKBOX01, 
                    target.ORR_UDFCHKBOX02=src.ORR_UDFCHKBOX02, 
                    target.ORR_UDFCHKBOX03=src.ORR_UDFCHKBOX03, 
                    target.ORR_UDFCHKBOX04=src.ORR_UDFCHKBOX04, 
                    target.ORR_UDFCHKBOX05=src.ORR_UDFCHKBOX05, 
                    target.ORR_UDFDATE01=src.ORR_UDFDATE01, 
                    target.ORR_UDFDATE02=src.ORR_UDFDATE02, 
                    target.ORR_UDFDATE03=src.ORR_UDFDATE03, 
                    target.ORR_UDFDATE04=src.ORR_UDFDATE04, 
                    target.ORR_UDFDATE05=src.ORR_UDFDATE05, 
                    target.ORR_UDFNUM01=src.ORR_UDFNUM01, 
                    target.ORR_UDFNUM02=src.ORR_UDFNUM02, 
                    target.ORR_UDFNUM03=src.ORR_UDFNUM03, 
                    target.ORR_UDFNUM04=src.ORR_UDFNUM04, 
                    target.ORR_UDFNUM05=src.ORR_UDFNUM05, 
                    target.ORR_UPDATECOUNT=src.ORR_UPDATECOUNT, 
                    target.ORR_UPDATED=src.ORR_UPDATED, 
                    target._DELETED=src._DELETED, 
                    target.ETL_LASTSAVED=src.ETL_LASTSAVED,
                    target.etl_load_datetime=CURRENT_TIMESTAMP,
                    target.etl_load_metadatafilename=src.etl_load_metadatafilename,
                    target.ETL_DELETED=src.ETL_DELETED
        when not matched   then insert ( ORR_ACD, ORR_APPROV, ORR_ATTENTIONTO, ORR_AUTH, ORR_BLANKETORDER, ORR_BLANKETRELEASE, ORR_BUYER, ORR_CLASS, ORR_CLASS_ORG, ORR_CONTRACT, ORR_CONTROLNO, ORR_CREATED, ORR_CREDITCARD, ORR_CURR, ORR_DATE, ORR_DELADDRESS, ORR_DESC, ORR_DFLTAUTH, ORR_DISCOUNT, ORR_DISCPERC, ORR_DUE, ORR_EXCH, ORR_EXCHFROMDUAL, ORR_EXCHTODUAL, ORR_FOBPOINT, ORR_FREIGHTTERMS, ORR_INTERFACE, ORR_IPTRANSMITTED, ORR_JECATEGORY, ORR_JESOURCE, ORR_LASTSAVED, ORR_LASTSTATUSUPDATE, ORR_MAILTOSITE, ORR_ORDER, ORR_ORDER_ORG, ORR_ORIGIN, ORR_PACKAGETRACKINGNUMBER, ORR_PAYBYMETHOD, ORR_PAYMENTTERMS, ORR_PRICE, ORR_PRINTED, ORR_REVISED, ORR_REVISEDBY, ORR_REVISEDORDER, ORR_REVISION, ORR_REVISIONREASON, ORR_RSTATUS, ORR_RTYPE, ORR_SHIPVIA, ORR_SOURCECODE, ORR_SOURCESYSTEM, ORR_STATUS, ORR_STORE, ORR_SUPPLIER, ORR_SUPPLIER_ORG, ORR_TYPE, ORR_UDFCHAR01, ORR_UDFCHAR02, ORR_UDFCHAR03, ORR_UDFCHAR04, ORR_UDFCHAR05, ORR_UDFCHAR06, ORR_UDFCHAR07, ORR_UDFCHAR08, ORR_UDFCHAR09, ORR_UDFCHAR10, ORR_UDFCHAR11, ORR_UDFCHAR12, ORR_UDFCHAR13, ORR_UDFCHAR14, ORR_UDFCHAR15, ORR_UDFCHAR16, ORR_UDFCHAR17, ORR_UDFCHAR18, ORR_UDFCHAR19, ORR_UDFCHAR20, ORR_UDFCHAR21, ORR_UDFCHAR22, ORR_UDFCHAR23, ORR_UDFCHAR24, ORR_UDFCHAR25, ORR_UDFCHAR26, ORR_UDFCHAR27, ORR_UDFCHAR28, ORR_UDFCHAR29, ORR_UDFCHAR30, ORR_UDFCHKBOX01, ORR_UDFCHKBOX02, ORR_UDFCHKBOX03, ORR_UDFCHKBOX04, ORR_UDFCHKBOX05, ORR_UDFDATE01, ORR_UDFDATE02, ORR_UDFDATE03, ORR_UDFDATE04, ORR_UDFDATE05, ORR_UDFNUM01, ORR_UDFNUM02, ORR_UDFNUM03, ORR_UDFNUM04, ORR_UDFNUM05, ORR_UPDATECOUNT, ORR_UPDATED, _DELETED, 
                    ETL_LASTSAVED,                       
                    etl_load_datetime,
                    etl_load_metadatafilename,
                    etl_is_deleted,
                    ETL_DELETED) 
            values (
                    src.ORR_ACD, 
                    src.ORR_APPROV, 
                    src.ORR_ATTENTIONTO, 
                    src.ORR_AUTH, 
                    src.ORR_BLANKETORDER, 
                    src.ORR_BLANKETRELEASE, 
                    src.ORR_BUYER, 
                    src.ORR_CLASS, 
                    src.ORR_CLASS_ORG, 
                    src.ORR_CONTRACT, 
                    src.ORR_CONTROLNO, 
                    src.ORR_CREATED, 
                    src.ORR_CREDITCARD, 
                    src.ORR_CURR, 
                    src.ORR_DATE, 
                    src.ORR_DELADDRESS, 
                    src.ORR_DESC, 
                    src.ORR_DFLTAUTH, 
                    src.ORR_DISCOUNT, 
                    src.ORR_DISCPERC, 
                    src.ORR_DUE, 
                    src.ORR_EXCH, 
                    src.ORR_EXCHFROMDUAL, 
                    src.ORR_EXCHTODUAL, 
                    src.ORR_FOBPOINT, 
                    src.ORR_FREIGHTTERMS, 
                    src.ORR_INTERFACE, 
                    src.ORR_IPTRANSMITTED, 
                    src.ORR_JECATEGORY, 
                    src.ORR_JESOURCE, 
                    src.ORR_LASTSAVED, 
                    src.ORR_LASTSTATUSUPDATE, 
                    src.ORR_MAILTOSITE, 
                    src.ORR_ORDER, 
                    src.ORR_ORDER_ORG, 
                    src.ORR_ORIGIN, 
                    src.ORR_PACKAGETRACKINGNUMBER, 
                    src.ORR_PAYBYMETHOD, 
                    src.ORR_PAYMENTTERMS, 
                    src.ORR_PRICE, 
                    src.ORR_PRINTED, 
                    src.ORR_REVISED, 
                    src.ORR_REVISEDBY, 
                    src.ORR_REVISEDORDER, 
                    src.ORR_REVISION, 
                    src.ORR_REVISIONREASON, 
                    src.ORR_RSTATUS, 
                    src.ORR_RTYPE, 
                    src.ORR_SHIPVIA, 
                    src.ORR_SOURCECODE, 
                    src.ORR_SOURCESYSTEM, 
                    src.ORR_STATUS, 
                    src.ORR_STORE, 
                    src.ORR_SUPPLIER, 
                    src.ORR_SUPPLIER_ORG, 
                    src.ORR_TYPE, 
                    src.ORR_UDFCHAR01, 
                    src.ORR_UDFCHAR02, 
                    src.ORR_UDFCHAR03, 
                    src.ORR_UDFCHAR04, 
                    src.ORR_UDFCHAR05, 
                    src.ORR_UDFCHAR06, 
                    src.ORR_UDFCHAR07, 
                    src.ORR_UDFCHAR08, 
                    src.ORR_UDFCHAR09, 
                    src.ORR_UDFCHAR10, 
                    src.ORR_UDFCHAR11, 
                    src.ORR_UDFCHAR12, 
                    src.ORR_UDFCHAR13, 
                    src.ORR_UDFCHAR14, 
                    src.ORR_UDFCHAR15, 
                    src.ORR_UDFCHAR16, 
                    src.ORR_UDFCHAR17, 
                    src.ORR_UDFCHAR18, 
                    src.ORR_UDFCHAR19, 
                    src.ORR_UDFCHAR20, 
                    src.ORR_UDFCHAR21, 
                    src.ORR_UDFCHAR22, 
                    src.ORR_UDFCHAR23, 
                    src.ORR_UDFCHAR24, 
                    src.ORR_UDFCHAR25, 
                    src.ORR_UDFCHAR26, 
                    src.ORR_UDFCHAR27, 
                    src.ORR_UDFCHAR28, 
                    src.ORR_UDFCHAR29, 
                    src.ORR_UDFCHAR30, 
                    src.ORR_UDFCHKBOX01, 
                    src.ORR_UDFCHKBOX02, 
                    src.ORR_UDFCHKBOX03, 
                    src.ORR_UDFCHKBOX04, 
                    src.ORR_UDFCHKBOX05, 
                    src.ORR_UDFDATE01, 
                    src.ORR_UDFDATE02, 
                    src.ORR_UDFDATE03, 
                    src.ORR_UDFDATE04, 
                    src.ORR_UDFDATE05, 
                    src.ORR_UDFNUM01, 
                    src.ORR_UDFNUM02, 
                    src.ORR_UDFNUM03, 
                    src.ORR_UDFNUM04, 
                    src.ORR_UDFNUM05, 
                    src.ORR_UPDATECOUNT, 
                    src.ORR_UPDATED, 
                    src._DELETED,     
                    src.ETL_LASTSAVED,
                    CURRENT_TIMESTAMP,
                    src.etl_load_metadatafilename,
                    case when ETL_DELETED=TRUE then TRUE else FALSE end,
                    ETL_DELETED);
    `
} );

                    
//  Get number of rows inserted
        
        var sqlStmt = snowflake.createStatement( {sqlText:  sql_command} );
        var rs = sqlStmt.execute();
        var number_of_rows_inserted = sqlStmt.getNumRowsInserted();
        var number_of_rows_updated =  sqlStmt.getNumRowsUpdated();
                    

        
    snowflake.execute ({sqlText: "commit"});

    log_sql_command = "call datahub_logging.sp_etl_log_ingestion_process('UpdateEnd','" + process_name + "','Success','Completed process execution.', 0 ," + number_of_rows_inserted.toString()+ "," +  number_of_rows_updated.toString() + ");";
    snowflake.execute({sqlText: log_sql_command});

    result = "Success"; 

    }       

    catch (err)  {
        snowflake.execute( {sqlText: "rollback;"} )
        var clean_error_msg = err.message.replace(/[^\w\s]/gi, '');
    //  Create a log entry to say INSERT STATEMENT failed
    
    log_sql_command = "call datahub_logging.sp_etl_log_ingestion_process('UpdateEnd','" + process_name + "','Failed','MERGE Failed. Error:" + err.code.toString()+" : "+ clean_error_msg  + "', 0 ,0,0);";
    snowflake.execute({sqlText: log_sql_command});
        ;
        throw "Failed: " + err.message;   // Return a success/error indicator.
        }
    return result;
    $$;