create or replace procedure DATAHUB_INTEGRATION.SP_EAM_R5USERS()
    returns varchar not null
                language javascript
                as
                $$

//  Variables

var result = "";                                    // return status of this proc call
const process_name = Object.keys(this)[0];          // name of currently executing process
var number_of_rows_inserted = 0;                             // track number of rows we have inserted
var number_of_rows_updated = 0;                             // track number of rows we have updated


//  Step 1.

//  Start execution - log start

log_sql_command = "call datahub_logging.sp_etl_log_ingestion_process('Insert','" + process_name + "','Running','Started process execution.', 0,0,0);";
snowflake.execute({sqlText: log_sql_command});

snowflake.execute( {sqlText: "begin transaction;"} );
try
    {
        var sql_command = `
                            INSERT INTO LANDING_ERROR.EAM_RAW_ERROR
                            SELECT * FROM LANDING_ERROR.VW_STREAM_EAM_R5USERS_ERROR`;
    var sqlStmt = snowflake.createStatement( {sqlText:  sql_command} );
    var rs = sqlStmt.execute();
        
        var sql_command = ` 
                            merge into  TARGET_EAM.EAM_R5USERS as target using (SELECT * FROM (SELECT 
            strm.USR_508, 
            strm.USR_ACTIVE, 
            strm.USR_ADVANCEDFILTERS, 
            strm.USR_ALLOWCONTAINSSEARCH, 
            strm.USR_ALLOWCREATEIMPORTUTILTEMP, 
            strm.USR_ALLOWMOBILESETTINGS, 
            strm.USR_ALLOWSCREENCACHESETUP, 
            strm.USR_ALLOWUPDATEFIELD, 
            strm.USR_ALLOWVIEWINGAUDITTRAIL, 
            strm.USR_ALLOWVIEWINGPRIVATECASES, 
            strm.USR_ANALYTICS, 
            strm.USR_APPROVER, 
            strm.USR_ARCGIS_PASSWORD, 
            strm.USR_ARCGIS_USERCODE, 
            strm.USR_BARCODE, 
            strm.USR_BROWSER, 
            strm.USR_BUYER, 
            strm.USR_CANCELDAILYSCHEDSESSION, 
            strm.USR_CLASS, 
            strm.USR_CLASS_ORG, 
            strm.USR_CODE, 
            strm.USR_CONNECTOR, 
            strm.USR_CONSUMER, 
            strm.USR_CREATED, 
            strm.USR_DATELOCKED, 
            strm.USR_DEFAULTSTORE, 
            strm.USR_DEFAULT_CHART_GROUPBY, 
            strm.USR_DEFAULT_CHART_PERIOD, 
            strm.USR_DEFAULT_CHART_SHOWYEAR, 
            strm.USR_DEFAULT_CHART_STATE, 
            strm.USR_DEFAULT_CHART_TYPE, 
            strm.USR_DEFAULT_KPI_SIZE, 
            strm.USR_DEFAULT_ORG, 
            strm.USR_DESC, 
            strm.USR_EDITDATASPY, 
            strm.USR_EDITOTHERSCOMMENTS, 
            strm.USR_EDITOWNCOMMENTS, 
            strm.USR_EMAILADDRESS, 
            strm.USR_ENABLESCREENCACHEDECK, 
            strm.USR_ENABLETRANSITIONANIMATIONS, 
            strm.USR_ENXUSER, 
            strm.USR_EWSFIRSTFUNC, 
            strm.USR_EXPPASS, 
            strm.USR_EXPUSER, 
            strm.USR_EXTERNCODE, 
            strm.USR_FACILITY, 
            strm.USR_FIRSTFUNC, 
            strm.USR_GLOBALDATASPY, 
            strm.USR_GROUP, 
            strm.USR_INBOXTAB, 
            strm.USR_INVAPPVLIMIT, 
            strm.USR_INVAPPVLIMITNONPO, 
            strm.USR_LANG, 
            strm.USR_LASTFUNC, 
            strm.USR_LASTSAVED, 
            strm.USR_LOCALE, 
            strm.USR_LOGIN, 
            strm.USR_MOBILE, 
            strm.USR_MOBILEADM, 
            strm.USR_MOBILEFIRSTSCREEN, 
            strm.USR_MRC, 
            strm.USR_NOTIFICATIONPREF, 
            strm.USR_NOTUSED, 
            strm.USR_PASSWORD, 
            strm.USR_PICAPPVLIMIT, 
            strm.USR_PORDAPPVLIMIT, 
            strm.USR_PORDAUTHAPPVLIMIT, 
            strm.USR_PRINTER, 
            strm.USR_PROFESSIONAL, 
            strm.USR_PROFILEPICTURE, 
            strm.USR_REQAPPVLIMIT, 
            strm.USR_REQAUTHAPPVLIMIT, 
            strm.USR_REQUESTOR, 
            strm.USR_ROUTER, 
            strm.USR_SCREENDESIGNER, 
            strm.USR_SESSIONTIMEOUT, 
            strm.USR_SUCCESSMSGTIMEOUT, 
            strm.USR_SUPPLIER, 
            strm.USR_SUPPLIER_ORG, 
            strm.USR_SYSMAN, 
            strm.USR_UDFCHAR01, 
            strm.USR_UDFCHAR02, 
            strm.USR_UDFCHAR03, 
            strm.USR_UDFCHAR04, 
            strm.USR_UDFCHAR05, 
            strm.USR_UDFCHAR06, 
            strm.USR_UDFCHAR07, 
            strm.USR_UDFCHAR08, 
            strm.USR_UDFCHAR09, 
            strm.USR_UDFCHAR10, 
            strm.USR_UDFCHAR11, 
            strm.USR_UDFCHAR12, 
            strm.USR_UDFCHAR13, 
            strm.USR_UDFCHAR14, 
            strm.USR_UDFCHAR15, 
            strm.USR_UDFCHAR16, 
            strm.USR_UDFCHAR17, 
            strm.USR_UDFCHAR18, 
            strm.USR_UDFCHAR19, 
            strm.USR_UDFCHAR20, 
            strm.USR_UDFCHAR21, 
            strm.USR_UDFCHAR22, 
            strm.USR_UDFCHAR23, 
            strm.USR_UDFCHAR24, 
            strm.USR_UDFCHAR25, 
            strm.USR_UDFCHAR26, 
            strm.USR_UDFCHAR27, 
            strm.USR_UDFCHAR28, 
            strm.USR_UDFCHAR29, 
            strm.USR_UDFCHAR30, 
            strm.USR_UDFCHKBOX01, 
            strm.USR_UDFCHKBOX02, 
            strm.USR_UDFCHKBOX03, 
            strm.USR_UDFCHKBOX04, 
            strm.USR_UDFCHKBOX05, 
            strm.USR_UDFDATE01, 
            strm.USR_UDFDATE02, 
            strm.USR_UDFDATE03, 
            strm.USR_UDFDATE04, 
            strm.USR_UDFDATE05, 
            strm.USR_UDFNUM01, 
            strm.USR_UDFNUM02, 
            strm.USR_UDFNUM03, 
            strm.USR_UDFNUM04, 
            strm.USR_UDFNUM05, 
            strm.USR_UPDATECOUNT, 
            strm.USR_UPDATED, 
            strm.USR_VIOLATIONS, 
            strm._DELETED, 
            strm.ETL_LASTSAVED,
            strm.ETL_DELETED,
            strm.etl_load_datetime,
            strm.etl_load_metadatafilename,
            ROW_NUMBER() OVER (PARTITION BY 
            strm.USR_CODE ORDER BY strm.ETL_LASTSAVED desc,IFNULL(TRY_TO_TIMESTAMP(replace(right(replace(lower(etl_load_metadatafilename),'.json'),23),'_','-'), 'yyyy-mm-dd-HH-MI-SS-FF') ,etl_load_datetime) desc) as ROWNUMBER
        FROM DATAHUB_INTEGRATION.VW_STREAM_EAM_R5USERS as  strm
                    )   
            WHERE ROWNUMBER=1  
            
                    ) as src on
            ((target.USR_CODE=src.USR_CODE) OR (target.USR_CODE IS NULL AND src.USR_CODE IS NULL)) 
                when matched and src.ETL_DELETED=TRUE THEN DELETE
                when matched then update set
                    target.USR_508=src.USR_508, 
                    target.USR_ACTIVE=src.USR_ACTIVE, 
                    target.USR_ADVANCEDFILTERS=src.USR_ADVANCEDFILTERS, 
                    target.USR_ALLOWCONTAINSSEARCH=src.USR_ALLOWCONTAINSSEARCH, 
                    target.USR_ALLOWCREATEIMPORTUTILTEMP=src.USR_ALLOWCREATEIMPORTUTILTEMP, 
                    target.USR_ALLOWMOBILESETTINGS=src.USR_ALLOWMOBILESETTINGS, 
                    target.USR_ALLOWSCREENCACHESETUP=src.USR_ALLOWSCREENCACHESETUP, 
                    target.USR_ALLOWUPDATEFIELD=src.USR_ALLOWUPDATEFIELD, 
                    target.USR_ALLOWVIEWINGAUDITTRAIL=src.USR_ALLOWVIEWINGAUDITTRAIL, 
                    target.USR_ALLOWVIEWINGPRIVATECASES=src.USR_ALLOWVIEWINGPRIVATECASES, 
                    target.USR_ANALYTICS=src.USR_ANALYTICS, 
                    target.USR_APPROVER=src.USR_APPROVER, 
                    target.USR_ARCGIS_PASSWORD=src.USR_ARCGIS_PASSWORD, 
                    target.USR_ARCGIS_USERCODE=src.USR_ARCGIS_USERCODE, 
                    target.USR_BARCODE=src.USR_BARCODE, 
                    target.USR_BROWSER=src.USR_BROWSER, 
                    target.USR_BUYER=src.USR_BUYER, 
                    target.USR_CANCELDAILYSCHEDSESSION=src.USR_CANCELDAILYSCHEDSESSION, 
                    target.USR_CLASS=src.USR_CLASS, 
                    target.USR_CLASS_ORG=src.USR_CLASS_ORG, 
                    target.USR_CODE=src.USR_CODE, 
                    target.USR_CONNECTOR=src.USR_CONNECTOR, 
                    target.USR_CONSUMER=src.USR_CONSUMER, 
                    target.USR_CREATED=src.USR_CREATED, 
                    target.USR_DATELOCKED=src.USR_DATELOCKED, 
                    target.USR_DEFAULTSTORE=src.USR_DEFAULTSTORE, 
                    target.USR_DEFAULT_CHART_GROUPBY=src.USR_DEFAULT_CHART_GROUPBY, 
                    target.USR_DEFAULT_CHART_PERIOD=src.USR_DEFAULT_CHART_PERIOD, 
                    target.USR_DEFAULT_CHART_SHOWYEAR=src.USR_DEFAULT_CHART_SHOWYEAR, 
                    target.USR_DEFAULT_CHART_STATE=src.USR_DEFAULT_CHART_STATE, 
                    target.USR_DEFAULT_CHART_TYPE=src.USR_DEFAULT_CHART_TYPE, 
                    target.USR_DEFAULT_KPI_SIZE=src.USR_DEFAULT_KPI_SIZE, 
                    target.USR_DEFAULT_ORG=src.USR_DEFAULT_ORG, 
                    target.USR_DESC=src.USR_DESC, 
                    target.USR_EDITDATASPY=src.USR_EDITDATASPY, 
                    target.USR_EDITOTHERSCOMMENTS=src.USR_EDITOTHERSCOMMENTS, 
                    target.USR_EDITOWNCOMMENTS=src.USR_EDITOWNCOMMENTS, 
                    target.USR_EMAILADDRESS=src.USR_EMAILADDRESS, 
                    target.USR_ENABLESCREENCACHEDECK=src.USR_ENABLESCREENCACHEDECK, 
                    target.USR_ENABLETRANSITIONANIMATIONS=src.USR_ENABLETRANSITIONANIMATIONS, 
                    target.USR_ENXUSER=src.USR_ENXUSER, 
                    target.USR_EWSFIRSTFUNC=src.USR_EWSFIRSTFUNC, 
                    target.USR_EXPPASS=src.USR_EXPPASS, 
                    target.USR_EXPUSER=src.USR_EXPUSER, 
                    target.USR_EXTERNCODE=src.USR_EXTERNCODE, 
                    target.USR_FACILITY=src.USR_FACILITY, 
                    target.USR_FIRSTFUNC=src.USR_FIRSTFUNC, 
                    target.USR_GLOBALDATASPY=src.USR_GLOBALDATASPY, 
                    target.USR_GROUP=src.USR_GROUP, 
                    target.USR_INBOXTAB=src.USR_INBOXTAB, 
                    target.USR_INVAPPVLIMIT=src.USR_INVAPPVLIMIT, 
                    target.USR_INVAPPVLIMITNONPO=src.USR_INVAPPVLIMITNONPO, 
                    target.USR_LANG=src.USR_LANG, 
                    target.USR_LASTFUNC=src.USR_LASTFUNC, 
                    target.USR_LASTSAVED=src.USR_LASTSAVED, 
                    target.USR_LOCALE=src.USR_LOCALE, 
                    target.USR_LOGIN=src.USR_LOGIN, 
                    target.USR_MOBILE=src.USR_MOBILE, 
                    target.USR_MOBILEADM=src.USR_MOBILEADM, 
                    target.USR_MOBILEFIRSTSCREEN=src.USR_MOBILEFIRSTSCREEN, 
                    target.USR_MRC=src.USR_MRC, 
                    target.USR_NOTIFICATIONPREF=src.USR_NOTIFICATIONPREF, 
                    target.USR_NOTUSED=src.USR_NOTUSED, 
                    target.USR_PASSWORD=src.USR_PASSWORD, 
                    target.USR_PICAPPVLIMIT=src.USR_PICAPPVLIMIT, 
                    target.USR_PORDAPPVLIMIT=src.USR_PORDAPPVLIMIT, 
                    target.USR_PORDAUTHAPPVLIMIT=src.USR_PORDAUTHAPPVLIMIT, 
                    target.USR_PRINTER=src.USR_PRINTER, 
                    target.USR_PROFESSIONAL=src.USR_PROFESSIONAL, 
                    target.USR_PROFILEPICTURE=src.USR_PROFILEPICTURE, 
                    target.USR_REQAPPVLIMIT=src.USR_REQAPPVLIMIT, 
                    target.USR_REQAUTHAPPVLIMIT=src.USR_REQAUTHAPPVLIMIT, 
                    target.USR_REQUESTOR=src.USR_REQUESTOR, 
                    target.USR_ROUTER=src.USR_ROUTER, 
                    target.USR_SCREENDESIGNER=src.USR_SCREENDESIGNER, 
                    target.USR_SESSIONTIMEOUT=src.USR_SESSIONTIMEOUT, 
                    target.USR_SUCCESSMSGTIMEOUT=src.USR_SUCCESSMSGTIMEOUT, 
                    target.USR_SUPPLIER=src.USR_SUPPLIER, 
                    target.USR_SUPPLIER_ORG=src.USR_SUPPLIER_ORG, 
                    target.USR_SYSMAN=src.USR_SYSMAN, 
                    target.USR_UDFCHAR01=src.USR_UDFCHAR01, 
                    target.USR_UDFCHAR02=src.USR_UDFCHAR02, 
                    target.USR_UDFCHAR03=src.USR_UDFCHAR03, 
                    target.USR_UDFCHAR04=src.USR_UDFCHAR04, 
                    target.USR_UDFCHAR05=src.USR_UDFCHAR05, 
                    target.USR_UDFCHAR06=src.USR_UDFCHAR06, 
                    target.USR_UDFCHAR07=src.USR_UDFCHAR07, 
                    target.USR_UDFCHAR08=src.USR_UDFCHAR08, 
                    target.USR_UDFCHAR09=src.USR_UDFCHAR09, 
                    target.USR_UDFCHAR10=src.USR_UDFCHAR10, 
                    target.USR_UDFCHAR11=src.USR_UDFCHAR11, 
                    target.USR_UDFCHAR12=src.USR_UDFCHAR12, 
                    target.USR_UDFCHAR13=src.USR_UDFCHAR13, 
                    target.USR_UDFCHAR14=src.USR_UDFCHAR14, 
                    target.USR_UDFCHAR15=src.USR_UDFCHAR15, 
                    target.USR_UDFCHAR16=src.USR_UDFCHAR16, 
                    target.USR_UDFCHAR17=src.USR_UDFCHAR17, 
                    target.USR_UDFCHAR18=src.USR_UDFCHAR18, 
                    target.USR_UDFCHAR19=src.USR_UDFCHAR19, 
                    target.USR_UDFCHAR20=src.USR_UDFCHAR20, 
                    target.USR_UDFCHAR21=src.USR_UDFCHAR21, 
                    target.USR_UDFCHAR22=src.USR_UDFCHAR22, 
                    target.USR_UDFCHAR23=src.USR_UDFCHAR23, 
                    target.USR_UDFCHAR24=src.USR_UDFCHAR24, 
                    target.USR_UDFCHAR25=src.USR_UDFCHAR25, 
                    target.USR_UDFCHAR26=src.USR_UDFCHAR26, 
                    target.USR_UDFCHAR27=src.USR_UDFCHAR27, 
                    target.USR_UDFCHAR28=src.USR_UDFCHAR28, 
                    target.USR_UDFCHAR29=src.USR_UDFCHAR29, 
                    target.USR_UDFCHAR30=src.USR_UDFCHAR30, 
                    target.USR_UDFCHKBOX01=src.USR_UDFCHKBOX01, 
                    target.USR_UDFCHKBOX02=src.USR_UDFCHKBOX02, 
                    target.USR_UDFCHKBOX03=src.USR_UDFCHKBOX03, 
                    target.USR_UDFCHKBOX04=src.USR_UDFCHKBOX04, 
                    target.USR_UDFCHKBOX05=src.USR_UDFCHKBOX05, 
                    target.USR_UDFDATE01=src.USR_UDFDATE01, 
                    target.USR_UDFDATE02=src.USR_UDFDATE02, 
                    target.USR_UDFDATE03=src.USR_UDFDATE03, 
                    target.USR_UDFDATE04=src.USR_UDFDATE04, 
                    target.USR_UDFDATE05=src.USR_UDFDATE05, 
                    target.USR_UDFNUM01=src.USR_UDFNUM01, 
                    target.USR_UDFNUM02=src.USR_UDFNUM02, 
                    target.USR_UDFNUM03=src.USR_UDFNUM03, 
                    target.USR_UDFNUM04=src.USR_UDFNUM04, 
                    target.USR_UDFNUM05=src.USR_UDFNUM05, 
                    target.USR_UPDATECOUNT=src.USR_UPDATECOUNT, 
                    target.USR_UPDATED=src.USR_UPDATED, 
                    target.USR_VIOLATIONS=src.USR_VIOLATIONS, 
                    target._DELETED=src._DELETED, 
                    target.ETL_LASTSAVED=src.ETL_LASTSAVED,
                    target.etl_load_datetime=CURRENT_TIMESTAMP,
                    target.etl_load_metadatafilename=src.etl_load_metadatafilename
        when not matched and (src.ETL_DELETED=FALSE OR src.ETL_DELETED IS NULL)  then insert ( 
                    USR_508, 
                    USR_ACTIVE, 
                    USR_ADVANCEDFILTERS, 
                    USR_ALLOWCONTAINSSEARCH, 
                    USR_ALLOWCREATEIMPORTUTILTEMP, 
                    USR_ALLOWMOBILESETTINGS, 
                    USR_ALLOWSCREENCACHESETUP, 
                    USR_ALLOWUPDATEFIELD, 
                    USR_ALLOWVIEWINGAUDITTRAIL, 
                    USR_ALLOWVIEWINGPRIVATECASES, 
                    USR_ANALYTICS, 
                    USR_APPROVER, 
                    USR_ARCGIS_PASSWORD, 
                    USR_ARCGIS_USERCODE, 
                    USR_BARCODE, 
                    USR_BROWSER, 
                    USR_BUYER, 
                    USR_CANCELDAILYSCHEDSESSION, 
                    USR_CLASS, 
                    USR_CLASS_ORG, 
                    USR_CODE, 
                    USR_CONNECTOR, 
                    USR_CONSUMER, 
                    USR_CREATED, 
                    USR_DATELOCKED, 
                    USR_DEFAULTSTORE, 
                    USR_DEFAULT_CHART_GROUPBY, 
                    USR_DEFAULT_CHART_PERIOD, 
                    USR_DEFAULT_CHART_SHOWYEAR, 
                    USR_DEFAULT_CHART_STATE, 
                    USR_DEFAULT_CHART_TYPE, 
                    USR_DEFAULT_KPI_SIZE, 
                    USR_DEFAULT_ORG, 
                    USR_DESC, 
                    USR_EDITDATASPY, 
                    USR_EDITOTHERSCOMMENTS, 
                    USR_EDITOWNCOMMENTS, 
                    USR_EMAILADDRESS, 
                    USR_ENABLESCREENCACHEDECK, 
                    USR_ENABLETRANSITIONANIMATIONS, 
                    USR_ENXUSER, 
                    USR_EWSFIRSTFUNC, 
                    USR_EXPPASS, 
                    USR_EXPUSER, 
                    USR_EXTERNCODE, 
                    USR_FACILITY, 
                    USR_FIRSTFUNC, 
                    USR_GLOBALDATASPY, 
                    USR_GROUP, 
                    USR_INBOXTAB, 
                    USR_INVAPPVLIMIT, 
                    USR_INVAPPVLIMITNONPO, 
                    USR_LANG, 
                    USR_LASTFUNC, 
                    USR_LASTSAVED, 
                    USR_LOCALE, 
                    USR_LOGIN, 
                    USR_MOBILE, 
                    USR_MOBILEADM, 
                    USR_MOBILEFIRSTSCREEN, 
                    USR_MRC, 
                    USR_NOTIFICATIONPREF, 
                    USR_NOTUSED, 
                    USR_PASSWORD, 
                    USR_PICAPPVLIMIT, 
                    USR_PORDAPPVLIMIT, 
                    USR_PORDAUTHAPPVLIMIT, 
                    USR_PRINTER, 
                    USR_PROFESSIONAL, 
                    USR_PROFILEPICTURE, 
                    USR_REQAPPVLIMIT, 
                    USR_REQAUTHAPPVLIMIT, 
                    USR_REQUESTOR, 
                    USR_ROUTER, 
                    USR_SCREENDESIGNER, 
                    USR_SESSIONTIMEOUT, 
                    USR_SUCCESSMSGTIMEOUT, 
                    USR_SUPPLIER, 
                    USR_SUPPLIER_ORG, 
                    USR_SYSMAN, 
                    USR_UDFCHAR01, 
                    USR_UDFCHAR02, 
                    USR_UDFCHAR03, 
                    USR_UDFCHAR04, 
                    USR_UDFCHAR05, 
                    USR_UDFCHAR06, 
                    USR_UDFCHAR07, 
                    USR_UDFCHAR08, 
                    USR_UDFCHAR09, 
                    USR_UDFCHAR10, 
                    USR_UDFCHAR11, 
                    USR_UDFCHAR12, 
                    USR_UDFCHAR13, 
                    USR_UDFCHAR14, 
                    USR_UDFCHAR15, 
                    USR_UDFCHAR16, 
                    USR_UDFCHAR17, 
                    USR_UDFCHAR18, 
                    USR_UDFCHAR19, 
                    USR_UDFCHAR20, 
                    USR_UDFCHAR21, 
                    USR_UDFCHAR22, 
                    USR_UDFCHAR23, 
                    USR_UDFCHAR24, 
                    USR_UDFCHAR25, 
                    USR_UDFCHAR26, 
                    USR_UDFCHAR27, 
                    USR_UDFCHAR28, 
                    USR_UDFCHAR29, 
                    USR_UDFCHAR30, 
                    USR_UDFCHKBOX01, 
                    USR_UDFCHKBOX02, 
                    USR_UDFCHKBOX03, 
                    USR_UDFCHKBOX04, 
                    USR_UDFCHKBOX05, 
                    USR_UDFDATE01, 
                    USR_UDFDATE02, 
                    USR_UDFDATE03, 
                    USR_UDFDATE04, 
                    USR_UDFDATE05, 
                    USR_UDFNUM01, 
                    USR_UDFNUM02, 
                    USR_UDFNUM03, 
                    USR_UDFNUM04, 
                    USR_UDFNUM05, 
                    USR_UPDATECOUNT, 
                    USR_UPDATED, 
                    USR_VIOLATIONS, 
                    _DELETED, 
                    ETL_LASTSAVED,                       
                    etl_load_datetime,
                    etl_load_metadatafilename) 
            values (
                    src.USR_508, 
                    src.USR_ACTIVE, 
                    src.USR_ADVANCEDFILTERS, 
                    src.USR_ALLOWCONTAINSSEARCH, 
                    src.USR_ALLOWCREATEIMPORTUTILTEMP, 
                    src.USR_ALLOWMOBILESETTINGS, 
                    src.USR_ALLOWSCREENCACHESETUP, 
                    src.USR_ALLOWUPDATEFIELD, 
                    src.USR_ALLOWVIEWINGAUDITTRAIL, 
                    src.USR_ALLOWVIEWINGPRIVATECASES, 
                    src.USR_ANALYTICS, 
                    src.USR_APPROVER, 
                    src.USR_ARCGIS_PASSWORD, 
                    src.USR_ARCGIS_USERCODE, 
                    src.USR_BARCODE, 
                    src.USR_BROWSER, 
                    src.USR_BUYER, 
                    src.USR_CANCELDAILYSCHEDSESSION, 
                    src.USR_CLASS, 
                    src.USR_CLASS_ORG, 
                    src.USR_CODE, 
                    src.USR_CONNECTOR, 
                    src.USR_CONSUMER, 
                    src.USR_CREATED, 
                    src.USR_DATELOCKED, 
                    src.USR_DEFAULTSTORE, 
                    src.USR_DEFAULT_CHART_GROUPBY, 
                    src.USR_DEFAULT_CHART_PERIOD, 
                    src.USR_DEFAULT_CHART_SHOWYEAR, 
                    src.USR_DEFAULT_CHART_STATE, 
                    src.USR_DEFAULT_CHART_TYPE, 
                    src.USR_DEFAULT_KPI_SIZE, 
                    src.USR_DEFAULT_ORG, 
                    src.USR_DESC, 
                    src.USR_EDITDATASPY, 
                    src.USR_EDITOTHERSCOMMENTS, 
                    src.USR_EDITOWNCOMMENTS, 
                    src.USR_EMAILADDRESS, 
                    src.USR_ENABLESCREENCACHEDECK, 
                    src.USR_ENABLETRANSITIONANIMATIONS, 
                    src.USR_ENXUSER, 
                    src.USR_EWSFIRSTFUNC, 
                    src.USR_EXPPASS, 
                    src.USR_EXPUSER, 
                    src.USR_EXTERNCODE, 
                    src.USR_FACILITY, 
                    src.USR_FIRSTFUNC, 
                    src.USR_GLOBALDATASPY, 
                    src.USR_GROUP, 
                    src.USR_INBOXTAB, 
                    src.USR_INVAPPVLIMIT, 
                    src.USR_INVAPPVLIMITNONPO, 
                    src.USR_LANG, 
                    src.USR_LASTFUNC, 
                    src.USR_LASTSAVED, 
                    src.USR_LOCALE, 
                    src.USR_LOGIN, 
                    src.USR_MOBILE, 
                    src.USR_MOBILEADM, 
                    src.USR_MOBILEFIRSTSCREEN, 
                    src.USR_MRC, 
                    src.USR_NOTIFICATIONPREF, 
                    src.USR_NOTUSED, 
                    src.USR_PASSWORD, 
                    src.USR_PICAPPVLIMIT, 
                    src.USR_PORDAPPVLIMIT, 
                    src.USR_PORDAUTHAPPVLIMIT, 
                    src.USR_PRINTER, 
                    src.USR_PROFESSIONAL, 
                    src.USR_PROFILEPICTURE, 
                    src.USR_REQAPPVLIMIT, 
                    src.USR_REQAUTHAPPVLIMIT, 
                    src.USR_REQUESTOR, 
                    src.USR_ROUTER, 
                    src.USR_SCREENDESIGNER, 
                    src.USR_SESSIONTIMEOUT, 
                    src.USR_SUCCESSMSGTIMEOUT, 
                    src.USR_SUPPLIER, 
                    src.USR_SUPPLIER_ORG, 
                    src.USR_SYSMAN, 
                    src.USR_UDFCHAR01, 
                    src.USR_UDFCHAR02, 
                    src.USR_UDFCHAR03, 
                    src.USR_UDFCHAR04, 
                    src.USR_UDFCHAR05, 
                    src.USR_UDFCHAR06, 
                    src.USR_UDFCHAR07, 
                    src.USR_UDFCHAR08, 
                    src.USR_UDFCHAR09, 
                    src.USR_UDFCHAR10, 
                    src.USR_UDFCHAR11, 
                    src.USR_UDFCHAR12, 
                    src.USR_UDFCHAR13, 
                    src.USR_UDFCHAR14, 
                    src.USR_UDFCHAR15, 
                    src.USR_UDFCHAR16, 
                    src.USR_UDFCHAR17, 
                    src.USR_UDFCHAR18, 
                    src.USR_UDFCHAR19, 
                    src.USR_UDFCHAR20, 
                    src.USR_UDFCHAR21, 
                    src.USR_UDFCHAR22, 
                    src.USR_UDFCHAR23, 
                    src.USR_UDFCHAR24, 
                    src.USR_UDFCHAR25, 
                    src.USR_UDFCHAR26, 
                    src.USR_UDFCHAR27, 
                    src.USR_UDFCHAR28, 
                    src.USR_UDFCHAR29, 
                    src.USR_UDFCHAR30, 
                    src.USR_UDFCHKBOX01, 
                    src.USR_UDFCHKBOX02, 
                    src.USR_UDFCHKBOX03, 
                    src.USR_UDFCHKBOX04, 
                    src.USR_UDFCHKBOX05, 
                    src.USR_UDFDATE01, 
                    src.USR_UDFDATE02, 
                    src.USR_UDFDATE03, 
                    src.USR_UDFDATE04, 
                    src.USR_UDFDATE05, 
                    src.USR_UDFNUM01, 
                    src.USR_UDFNUM02, 
                    src.USR_UDFNUM03, 
                    src.USR_UDFNUM04, 
                    src.USR_UDFNUM05, 
                    src.USR_UPDATECOUNT, 
                    src.USR_UPDATED, 
                    src.USR_VIOLATIONS, 
                    src._DELETED,     
                    src.ETL_LASTSAVED,
                    CURRENT_TIMESTAMP,
                    src.etl_load_metadatafilename);`;

    var sqlStmt = snowflake.createStatement( {sqlText:  sql_command} );
    var rs = sqlStmt.execute();

    snowflake.execute( {sqlText: `merge into TARGET_HISTORY_EAM.EAM_R5USERS_DELETED as target using (
                SELECT * FROM (SELECT 
            strm.USR_508, 
            strm.USR_ACTIVE, 
            strm.USR_ADVANCEDFILTERS, 
            strm.USR_ALLOWCONTAINSSEARCH, 
            strm.USR_ALLOWCREATEIMPORTUTILTEMP, 
            strm.USR_ALLOWMOBILESETTINGS, 
            strm.USR_ALLOWSCREENCACHESETUP, 
            strm.USR_ALLOWUPDATEFIELD, 
            strm.USR_ALLOWVIEWINGAUDITTRAIL, 
            strm.USR_ALLOWVIEWINGPRIVATECASES, 
            strm.USR_ANALYTICS, 
            strm.USR_APPROVER, 
            strm.USR_ARCGIS_PASSWORD, 
            strm.USR_ARCGIS_USERCODE, 
            strm.USR_BARCODE, 
            strm.USR_BROWSER, 
            strm.USR_BUYER, 
            strm.USR_CANCELDAILYSCHEDSESSION, 
            strm.USR_CLASS, 
            strm.USR_CLASS_ORG, 
            strm.USR_CODE, 
            strm.USR_CONNECTOR, 
            strm.USR_CONSUMER, 
            strm.USR_CREATED, 
            strm.USR_DATELOCKED, 
            strm.USR_DEFAULTSTORE, 
            strm.USR_DEFAULT_CHART_GROUPBY, 
            strm.USR_DEFAULT_CHART_PERIOD, 
            strm.USR_DEFAULT_CHART_SHOWYEAR, 
            strm.USR_DEFAULT_CHART_STATE, 
            strm.USR_DEFAULT_CHART_TYPE, 
            strm.USR_DEFAULT_KPI_SIZE, 
            strm.USR_DEFAULT_ORG, 
            strm.USR_DESC, 
            strm.USR_EDITDATASPY, 
            strm.USR_EDITOTHERSCOMMENTS, 
            strm.USR_EDITOWNCOMMENTS, 
            strm.USR_EMAILADDRESS, 
            strm.USR_ENABLESCREENCACHEDECK, 
            strm.USR_ENABLETRANSITIONANIMATIONS, 
            strm.USR_ENXUSER, 
            strm.USR_EWSFIRSTFUNC, 
            strm.USR_EXPPASS, 
            strm.USR_EXPUSER, 
            strm.USR_EXTERNCODE, 
            strm.USR_FACILITY, 
            strm.USR_FIRSTFUNC, 
            strm.USR_GLOBALDATASPY, 
            strm.USR_GROUP, 
            strm.USR_INBOXTAB, 
            strm.USR_INVAPPVLIMIT, 
            strm.USR_INVAPPVLIMITNONPO, 
            strm.USR_LANG, 
            strm.USR_LASTFUNC, 
            strm.USR_LASTSAVED, 
            strm.USR_LOCALE, 
            strm.USR_LOGIN, 
            strm.USR_MOBILE, 
            strm.USR_MOBILEADM, 
            strm.USR_MOBILEFIRSTSCREEN, 
            strm.USR_MRC, 
            strm.USR_NOTIFICATIONPREF, 
            strm.USR_NOTUSED, 
            strm.USR_PASSWORD, 
            strm.USR_PICAPPVLIMIT, 
            strm.USR_PORDAPPVLIMIT, 
            strm.USR_PORDAUTHAPPVLIMIT, 
            strm.USR_PRINTER, 
            strm.USR_PROFESSIONAL, 
            strm.USR_PROFILEPICTURE, 
            strm.USR_REQAPPVLIMIT, 
            strm.USR_REQAUTHAPPVLIMIT, 
            strm.USR_REQUESTOR, 
            strm.USR_ROUTER, 
            strm.USR_SCREENDESIGNER, 
            strm.USR_SESSIONTIMEOUT, 
            strm.USR_SUCCESSMSGTIMEOUT, 
            strm.USR_SUPPLIER, 
            strm.USR_SUPPLIER_ORG, 
            strm.USR_SYSMAN, 
            strm.USR_UDFCHAR01, 
            strm.USR_UDFCHAR02, 
            strm.USR_UDFCHAR03, 
            strm.USR_UDFCHAR04, 
            strm.USR_UDFCHAR05, 
            strm.USR_UDFCHAR06, 
            strm.USR_UDFCHAR07, 
            strm.USR_UDFCHAR08, 
            strm.USR_UDFCHAR09, 
            strm.USR_UDFCHAR10, 
            strm.USR_UDFCHAR11, 
            strm.USR_UDFCHAR12, 
            strm.USR_UDFCHAR13, 
            strm.USR_UDFCHAR14, 
            strm.USR_UDFCHAR15, 
            strm.USR_UDFCHAR16, 
            strm.USR_UDFCHAR17, 
            strm.USR_UDFCHAR18, 
            strm.USR_UDFCHAR19, 
            strm.USR_UDFCHAR20, 
            strm.USR_UDFCHAR21, 
            strm.USR_UDFCHAR22, 
            strm.USR_UDFCHAR23, 
            strm.USR_UDFCHAR24, 
            strm.USR_UDFCHAR25, 
            strm.USR_UDFCHAR26, 
            strm.USR_UDFCHAR27, 
            strm.USR_UDFCHAR28, 
            strm.USR_UDFCHAR29, 
            strm.USR_UDFCHAR30, 
            strm.USR_UDFCHKBOX01, 
            strm.USR_UDFCHKBOX02, 
            strm.USR_UDFCHKBOX03, 
            strm.USR_UDFCHKBOX04, 
            strm.USR_UDFCHKBOX05, 
            strm.USR_UDFDATE01, 
            strm.USR_UDFDATE02, 
            strm.USR_UDFDATE03, 
            strm.USR_UDFDATE04, 
            strm.USR_UDFDATE05, 
            strm.USR_UDFNUM01, 
            strm.USR_UDFNUM02, 
            strm.USR_UDFNUM03, 
            strm.USR_UDFNUM04, 
            strm.USR_UDFNUM05, 
            strm.USR_UPDATECOUNT, 
            strm.USR_UPDATED, 
            strm.USR_VIOLATIONS, 
            strm._DELETED, 
            strm.ETL_LASTSAVED,
            strm.ETL_DELETED,
            strm.etl_load_datetime,
            strm.etl_load_metadatafilename,
            ROW_NUMBER() OVER (PARTITION BY 
            strm.USR_CODE ORDER BY strm.ETL_LASTSAVED desc,IFNULL(TRY_TO_TIMESTAMP(replace(right(replace(lower(etl_load_metadatafilename),'.json'),23),'_','-'), 'yyyy-mm-dd-HH-MI-SS-FF') ,etl_load_datetime) desc) as ROWNUMBER
        FROM DATAHUB_INTEGRATION.VW_STREAM_EAM_R5USERS as  strm
        WHERE strm.ETL_DELETED=TRUE
                    )   
            WHERE ROWNUMBER=1  
            
                    ) as src on
            ((target.USR_CODE=src.USR_CODE) OR (target.USR_CODE IS NULL AND src.USR_CODE IS NULL)) 
                when matched then update set
                    target.USR_508=src.USR_508, 
                    target.USR_ACTIVE=src.USR_ACTIVE, 
                    target.USR_ADVANCEDFILTERS=src.USR_ADVANCEDFILTERS, 
                    target.USR_ALLOWCONTAINSSEARCH=src.USR_ALLOWCONTAINSSEARCH, 
                    target.USR_ALLOWCREATEIMPORTUTILTEMP=src.USR_ALLOWCREATEIMPORTUTILTEMP, 
                    target.USR_ALLOWMOBILESETTINGS=src.USR_ALLOWMOBILESETTINGS, 
                    target.USR_ALLOWSCREENCACHESETUP=src.USR_ALLOWSCREENCACHESETUP, 
                    target.USR_ALLOWUPDATEFIELD=src.USR_ALLOWUPDATEFIELD, 
                    target.USR_ALLOWVIEWINGAUDITTRAIL=src.USR_ALLOWVIEWINGAUDITTRAIL, 
                    target.USR_ALLOWVIEWINGPRIVATECASES=src.USR_ALLOWVIEWINGPRIVATECASES, 
                    target.USR_ANALYTICS=src.USR_ANALYTICS, 
                    target.USR_APPROVER=src.USR_APPROVER, 
                    target.USR_ARCGIS_PASSWORD=src.USR_ARCGIS_PASSWORD, 
                    target.USR_ARCGIS_USERCODE=src.USR_ARCGIS_USERCODE, 
                    target.USR_BARCODE=src.USR_BARCODE, 
                    target.USR_BROWSER=src.USR_BROWSER, 
                    target.USR_BUYER=src.USR_BUYER, 
                    target.USR_CANCELDAILYSCHEDSESSION=src.USR_CANCELDAILYSCHEDSESSION, 
                    target.USR_CLASS=src.USR_CLASS, 
                    target.USR_CLASS_ORG=src.USR_CLASS_ORG, 
                    target.USR_CODE=src.USR_CODE, 
                    target.USR_CONNECTOR=src.USR_CONNECTOR, 
                    target.USR_CONSUMER=src.USR_CONSUMER, 
                    target.USR_CREATED=src.USR_CREATED, 
                    target.USR_DATELOCKED=src.USR_DATELOCKED, 
                    target.USR_DEFAULTSTORE=src.USR_DEFAULTSTORE, 
                    target.USR_DEFAULT_CHART_GROUPBY=src.USR_DEFAULT_CHART_GROUPBY, 
                    target.USR_DEFAULT_CHART_PERIOD=src.USR_DEFAULT_CHART_PERIOD, 
                    target.USR_DEFAULT_CHART_SHOWYEAR=src.USR_DEFAULT_CHART_SHOWYEAR, 
                    target.USR_DEFAULT_CHART_STATE=src.USR_DEFAULT_CHART_STATE, 
                    target.USR_DEFAULT_CHART_TYPE=src.USR_DEFAULT_CHART_TYPE, 
                    target.USR_DEFAULT_KPI_SIZE=src.USR_DEFAULT_KPI_SIZE, 
                    target.USR_DEFAULT_ORG=src.USR_DEFAULT_ORG, 
                    target.USR_DESC=src.USR_DESC, 
                    target.USR_EDITDATASPY=src.USR_EDITDATASPY, 
                    target.USR_EDITOTHERSCOMMENTS=src.USR_EDITOTHERSCOMMENTS, 
                    target.USR_EDITOWNCOMMENTS=src.USR_EDITOWNCOMMENTS, 
                    target.USR_EMAILADDRESS=src.USR_EMAILADDRESS, 
                    target.USR_ENABLESCREENCACHEDECK=src.USR_ENABLESCREENCACHEDECK, 
                    target.USR_ENABLETRANSITIONANIMATIONS=src.USR_ENABLETRANSITIONANIMATIONS, 
                    target.USR_ENXUSER=src.USR_ENXUSER, 
                    target.USR_EWSFIRSTFUNC=src.USR_EWSFIRSTFUNC, 
                    target.USR_EXPPASS=src.USR_EXPPASS, 
                    target.USR_EXPUSER=src.USR_EXPUSER, 
                    target.USR_EXTERNCODE=src.USR_EXTERNCODE, 
                    target.USR_FACILITY=src.USR_FACILITY, 
                    target.USR_FIRSTFUNC=src.USR_FIRSTFUNC, 
                    target.USR_GLOBALDATASPY=src.USR_GLOBALDATASPY, 
                    target.USR_GROUP=src.USR_GROUP, 
                    target.USR_INBOXTAB=src.USR_INBOXTAB, 
                    target.USR_INVAPPVLIMIT=src.USR_INVAPPVLIMIT, 
                    target.USR_INVAPPVLIMITNONPO=src.USR_INVAPPVLIMITNONPO, 
                    target.USR_LANG=src.USR_LANG, 
                    target.USR_LASTFUNC=src.USR_LASTFUNC, 
                    target.USR_LASTSAVED=src.USR_LASTSAVED, 
                    target.USR_LOCALE=src.USR_LOCALE, 
                    target.USR_LOGIN=src.USR_LOGIN, 
                    target.USR_MOBILE=src.USR_MOBILE, 
                    target.USR_MOBILEADM=src.USR_MOBILEADM, 
                    target.USR_MOBILEFIRSTSCREEN=src.USR_MOBILEFIRSTSCREEN, 
                    target.USR_MRC=src.USR_MRC, 
                    target.USR_NOTIFICATIONPREF=src.USR_NOTIFICATIONPREF, 
                    target.USR_NOTUSED=src.USR_NOTUSED, 
                    target.USR_PASSWORD=src.USR_PASSWORD, 
                    target.USR_PICAPPVLIMIT=src.USR_PICAPPVLIMIT, 
                    target.USR_PORDAPPVLIMIT=src.USR_PORDAPPVLIMIT, 
                    target.USR_PORDAUTHAPPVLIMIT=src.USR_PORDAUTHAPPVLIMIT, 
                    target.USR_PRINTER=src.USR_PRINTER, 
                    target.USR_PROFESSIONAL=src.USR_PROFESSIONAL, 
                    target.USR_PROFILEPICTURE=src.USR_PROFILEPICTURE, 
                    target.USR_REQAPPVLIMIT=src.USR_REQAPPVLIMIT, 
                    target.USR_REQAUTHAPPVLIMIT=src.USR_REQAUTHAPPVLIMIT, 
                    target.USR_REQUESTOR=src.USR_REQUESTOR, 
                    target.USR_ROUTER=src.USR_ROUTER, 
                    target.USR_SCREENDESIGNER=src.USR_SCREENDESIGNER, 
                    target.USR_SESSIONTIMEOUT=src.USR_SESSIONTIMEOUT, 
                    target.USR_SUCCESSMSGTIMEOUT=src.USR_SUCCESSMSGTIMEOUT, 
                    target.USR_SUPPLIER=src.USR_SUPPLIER, 
                    target.USR_SUPPLIER_ORG=src.USR_SUPPLIER_ORG, 
                    target.USR_SYSMAN=src.USR_SYSMAN, 
                    target.USR_UDFCHAR01=src.USR_UDFCHAR01, 
                    target.USR_UDFCHAR02=src.USR_UDFCHAR02, 
                    target.USR_UDFCHAR03=src.USR_UDFCHAR03, 
                    target.USR_UDFCHAR04=src.USR_UDFCHAR04, 
                    target.USR_UDFCHAR05=src.USR_UDFCHAR05, 
                    target.USR_UDFCHAR06=src.USR_UDFCHAR06, 
                    target.USR_UDFCHAR07=src.USR_UDFCHAR07, 
                    target.USR_UDFCHAR08=src.USR_UDFCHAR08, 
                    target.USR_UDFCHAR09=src.USR_UDFCHAR09, 
                    target.USR_UDFCHAR10=src.USR_UDFCHAR10, 
                    target.USR_UDFCHAR11=src.USR_UDFCHAR11, 
                    target.USR_UDFCHAR12=src.USR_UDFCHAR12, 
                    target.USR_UDFCHAR13=src.USR_UDFCHAR13, 
                    target.USR_UDFCHAR14=src.USR_UDFCHAR14, 
                    target.USR_UDFCHAR15=src.USR_UDFCHAR15, 
                    target.USR_UDFCHAR16=src.USR_UDFCHAR16, 
                    target.USR_UDFCHAR17=src.USR_UDFCHAR17, 
                    target.USR_UDFCHAR18=src.USR_UDFCHAR18, 
                    target.USR_UDFCHAR19=src.USR_UDFCHAR19, 
                    target.USR_UDFCHAR20=src.USR_UDFCHAR20, 
                    target.USR_UDFCHAR21=src.USR_UDFCHAR21, 
                    target.USR_UDFCHAR22=src.USR_UDFCHAR22, 
                    target.USR_UDFCHAR23=src.USR_UDFCHAR23, 
                    target.USR_UDFCHAR24=src.USR_UDFCHAR24, 
                    target.USR_UDFCHAR25=src.USR_UDFCHAR25, 
                    target.USR_UDFCHAR26=src.USR_UDFCHAR26, 
                    target.USR_UDFCHAR27=src.USR_UDFCHAR27, 
                    target.USR_UDFCHAR28=src.USR_UDFCHAR28, 
                    target.USR_UDFCHAR29=src.USR_UDFCHAR29, 
                    target.USR_UDFCHAR30=src.USR_UDFCHAR30, 
                    target.USR_UDFCHKBOX01=src.USR_UDFCHKBOX01, 
                    target.USR_UDFCHKBOX02=src.USR_UDFCHKBOX02, 
                    target.USR_UDFCHKBOX03=src.USR_UDFCHKBOX03, 
                    target.USR_UDFCHKBOX04=src.USR_UDFCHKBOX04, 
                    target.USR_UDFCHKBOX05=src.USR_UDFCHKBOX05, 
                    target.USR_UDFDATE01=src.USR_UDFDATE01, 
                    target.USR_UDFDATE02=src.USR_UDFDATE02, 
                    target.USR_UDFDATE03=src.USR_UDFDATE03, 
                    target.USR_UDFDATE04=src.USR_UDFDATE04, 
                    target.USR_UDFDATE05=src.USR_UDFDATE05, 
                    target.USR_UDFNUM01=src.USR_UDFNUM01, 
                    target.USR_UDFNUM02=src.USR_UDFNUM02, 
                    target.USR_UDFNUM03=src.USR_UDFNUM03, 
                    target.USR_UDFNUM04=src.USR_UDFNUM04, 
                    target.USR_UDFNUM05=src.USR_UDFNUM05, 
                    target.USR_UPDATECOUNT=src.USR_UPDATECOUNT, 
                    target.USR_UPDATED=src.USR_UPDATED, 
                    target.USR_VIOLATIONS=src.USR_VIOLATIONS, 
                    target._DELETED=src._DELETED, 
                    target.ETL_LASTSAVED=src.ETL_LASTSAVED,
                    target.etl_load_datetime=CURRENT_TIMESTAMP,
                    target.etl_load_metadatafilename=src.etl_load_metadatafilename,
                    target.ETL_DELETED=src.ETL_DELETED
        when not matched   then insert ( USR_508, USR_ACTIVE, USR_ADVANCEDFILTERS, USR_ALLOWCONTAINSSEARCH, USR_ALLOWCREATEIMPORTUTILTEMP, USR_ALLOWMOBILESETTINGS, USR_ALLOWSCREENCACHESETUP, USR_ALLOWUPDATEFIELD, USR_ALLOWVIEWINGAUDITTRAIL, USR_ALLOWVIEWINGPRIVATECASES, USR_ANALYTICS, USR_APPROVER, USR_ARCGIS_PASSWORD, USR_ARCGIS_USERCODE, USR_BARCODE, USR_BROWSER, USR_BUYER, USR_CANCELDAILYSCHEDSESSION, USR_CLASS, USR_CLASS_ORG, USR_CODE, USR_CONNECTOR, USR_CONSUMER, USR_CREATED, USR_DATELOCKED, USR_DEFAULTSTORE, USR_DEFAULT_CHART_GROUPBY, USR_DEFAULT_CHART_PERIOD, USR_DEFAULT_CHART_SHOWYEAR, USR_DEFAULT_CHART_STATE, USR_DEFAULT_CHART_TYPE, USR_DEFAULT_KPI_SIZE, USR_DEFAULT_ORG, USR_DESC, USR_EDITDATASPY, USR_EDITOTHERSCOMMENTS, USR_EDITOWNCOMMENTS, USR_EMAILADDRESS, USR_ENABLESCREENCACHEDECK, USR_ENABLETRANSITIONANIMATIONS, USR_ENXUSER, USR_EWSFIRSTFUNC, USR_EXPPASS, USR_EXPUSER, USR_EXTERNCODE, USR_FACILITY, USR_FIRSTFUNC, USR_GLOBALDATASPY, USR_GROUP, USR_INBOXTAB, USR_INVAPPVLIMIT, USR_INVAPPVLIMITNONPO, USR_LANG, USR_LASTFUNC, USR_LASTSAVED, USR_LOCALE, USR_LOGIN, USR_MOBILE, USR_MOBILEADM, USR_MOBILEFIRSTSCREEN, USR_MRC, USR_NOTIFICATIONPREF, USR_NOTUSED, USR_PASSWORD, USR_PICAPPVLIMIT, USR_PORDAPPVLIMIT, USR_PORDAUTHAPPVLIMIT, USR_PRINTER, USR_PROFESSIONAL, USR_PROFILEPICTURE, USR_REQAPPVLIMIT, USR_REQAUTHAPPVLIMIT, USR_REQUESTOR, USR_ROUTER, USR_SCREENDESIGNER, USR_SESSIONTIMEOUT, USR_SUCCESSMSGTIMEOUT, USR_SUPPLIER, USR_SUPPLIER_ORG, USR_SYSMAN, USR_UDFCHAR01, USR_UDFCHAR02, USR_UDFCHAR03, USR_UDFCHAR04, USR_UDFCHAR05, USR_UDFCHAR06, USR_UDFCHAR07, USR_UDFCHAR08, USR_UDFCHAR09, USR_UDFCHAR10, USR_UDFCHAR11, USR_UDFCHAR12, USR_UDFCHAR13, USR_UDFCHAR14, USR_UDFCHAR15, USR_UDFCHAR16, USR_UDFCHAR17, USR_UDFCHAR18, USR_UDFCHAR19, USR_UDFCHAR20, USR_UDFCHAR21, USR_UDFCHAR22, USR_UDFCHAR23, USR_UDFCHAR24, USR_UDFCHAR25, USR_UDFCHAR26, USR_UDFCHAR27, USR_UDFCHAR28, USR_UDFCHAR29, USR_UDFCHAR30, USR_UDFCHKBOX01, USR_UDFCHKBOX02, USR_UDFCHKBOX03, USR_UDFCHKBOX04, USR_UDFCHKBOX05, USR_UDFDATE01, USR_UDFDATE02, USR_UDFDATE03, USR_UDFDATE04, USR_UDFDATE05, USR_UDFNUM01, USR_UDFNUM02, USR_UDFNUM03, USR_UDFNUM04, USR_UDFNUM05, USR_UPDATECOUNT, USR_UPDATED, USR_VIOLATIONS, _DELETED, 
                    ETL_LASTSAVED,                       
                    etl_load_datetime,
                    etl_load_metadatafilename,
                    etl_is_deleted,
                    ETL_DELETED) 
            values (
                    src.USR_508, 
                    src.USR_ACTIVE, 
                    src.USR_ADVANCEDFILTERS, 
                    src.USR_ALLOWCONTAINSSEARCH, 
                    src.USR_ALLOWCREATEIMPORTUTILTEMP, 
                    src.USR_ALLOWMOBILESETTINGS, 
                    src.USR_ALLOWSCREENCACHESETUP, 
                    src.USR_ALLOWUPDATEFIELD, 
                    src.USR_ALLOWVIEWINGAUDITTRAIL, 
                    src.USR_ALLOWVIEWINGPRIVATECASES, 
                    src.USR_ANALYTICS, 
                    src.USR_APPROVER, 
                    src.USR_ARCGIS_PASSWORD, 
                    src.USR_ARCGIS_USERCODE, 
                    src.USR_BARCODE, 
                    src.USR_BROWSER, 
                    src.USR_BUYER, 
                    src.USR_CANCELDAILYSCHEDSESSION, 
                    src.USR_CLASS, 
                    src.USR_CLASS_ORG, 
                    src.USR_CODE, 
                    src.USR_CONNECTOR, 
                    src.USR_CONSUMER, 
                    src.USR_CREATED, 
                    src.USR_DATELOCKED, 
                    src.USR_DEFAULTSTORE, 
                    src.USR_DEFAULT_CHART_GROUPBY, 
                    src.USR_DEFAULT_CHART_PERIOD, 
                    src.USR_DEFAULT_CHART_SHOWYEAR, 
                    src.USR_DEFAULT_CHART_STATE, 
                    src.USR_DEFAULT_CHART_TYPE, 
                    src.USR_DEFAULT_KPI_SIZE, 
                    src.USR_DEFAULT_ORG, 
                    src.USR_DESC, 
                    src.USR_EDITDATASPY, 
                    src.USR_EDITOTHERSCOMMENTS, 
                    src.USR_EDITOWNCOMMENTS, 
                    src.USR_EMAILADDRESS, 
                    src.USR_ENABLESCREENCACHEDECK, 
                    src.USR_ENABLETRANSITIONANIMATIONS, 
                    src.USR_ENXUSER, 
                    src.USR_EWSFIRSTFUNC, 
                    src.USR_EXPPASS, 
                    src.USR_EXPUSER, 
                    src.USR_EXTERNCODE, 
                    src.USR_FACILITY, 
                    src.USR_FIRSTFUNC, 
                    src.USR_GLOBALDATASPY, 
                    src.USR_GROUP, 
                    src.USR_INBOXTAB, 
                    src.USR_INVAPPVLIMIT, 
                    src.USR_INVAPPVLIMITNONPO, 
                    src.USR_LANG, 
                    src.USR_LASTFUNC, 
                    src.USR_LASTSAVED, 
                    src.USR_LOCALE, 
                    src.USR_LOGIN, 
                    src.USR_MOBILE, 
                    src.USR_MOBILEADM, 
                    src.USR_MOBILEFIRSTSCREEN, 
                    src.USR_MRC, 
                    src.USR_NOTIFICATIONPREF, 
                    src.USR_NOTUSED, 
                    src.USR_PASSWORD, 
                    src.USR_PICAPPVLIMIT, 
                    src.USR_PORDAPPVLIMIT, 
                    src.USR_PORDAUTHAPPVLIMIT, 
                    src.USR_PRINTER, 
                    src.USR_PROFESSIONAL, 
                    src.USR_PROFILEPICTURE, 
                    src.USR_REQAPPVLIMIT, 
                    src.USR_REQAUTHAPPVLIMIT, 
                    src.USR_REQUESTOR, 
                    src.USR_ROUTER, 
                    src.USR_SCREENDESIGNER, 
                    src.USR_SESSIONTIMEOUT, 
                    src.USR_SUCCESSMSGTIMEOUT, 
                    src.USR_SUPPLIER, 
                    src.USR_SUPPLIER_ORG, 
                    src.USR_SYSMAN, 
                    src.USR_UDFCHAR01, 
                    src.USR_UDFCHAR02, 
                    src.USR_UDFCHAR03, 
                    src.USR_UDFCHAR04, 
                    src.USR_UDFCHAR05, 
                    src.USR_UDFCHAR06, 
                    src.USR_UDFCHAR07, 
                    src.USR_UDFCHAR08, 
                    src.USR_UDFCHAR09, 
                    src.USR_UDFCHAR10, 
                    src.USR_UDFCHAR11, 
                    src.USR_UDFCHAR12, 
                    src.USR_UDFCHAR13, 
                    src.USR_UDFCHAR14, 
                    src.USR_UDFCHAR15, 
                    src.USR_UDFCHAR16, 
                    src.USR_UDFCHAR17, 
                    src.USR_UDFCHAR18, 
                    src.USR_UDFCHAR19, 
                    src.USR_UDFCHAR20, 
                    src.USR_UDFCHAR21, 
                    src.USR_UDFCHAR22, 
                    src.USR_UDFCHAR23, 
                    src.USR_UDFCHAR24, 
                    src.USR_UDFCHAR25, 
                    src.USR_UDFCHAR26, 
                    src.USR_UDFCHAR27, 
                    src.USR_UDFCHAR28, 
                    src.USR_UDFCHAR29, 
                    src.USR_UDFCHAR30, 
                    src.USR_UDFCHKBOX01, 
                    src.USR_UDFCHKBOX02, 
                    src.USR_UDFCHKBOX03, 
                    src.USR_UDFCHKBOX04, 
                    src.USR_UDFCHKBOX05, 
                    src.USR_UDFDATE01, 
                    src.USR_UDFDATE02, 
                    src.USR_UDFDATE03, 
                    src.USR_UDFDATE04, 
                    src.USR_UDFDATE05, 
                    src.USR_UDFNUM01, 
                    src.USR_UDFNUM02, 
                    src.USR_UDFNUM03, 
                    src.USR_UDFNUM04, 
                    src.USR_UDFNUM05, 
                    src.USR_UPDATECOUNT, 
                    src.USR_UPDATED, 
                    src.USR_VIOLATIONS, 
                    src._DELETED,     
                    src.ETL_LASTSAVED,
                    CURRENT_TIMESTAMP,
                    src.etl_load_metadatafilename,
                    case when ETL_DELETED=TRUE then TRUE else FALSE end,
                    ETL_DELETED);
    `
} );

                    
//  Get number of rows inserted
        
        var sqlStmt = snowflake.createStatement( {sqlText:  sql_command} );
        var rs = sqlStmt.execute();
        var number_of_rows_inserted = sqlStmt.getNumRowsInserted();
        var number_of_rows_updated =  sqlStmt.getNumRowsUpdated();
                    

        
    snowflake.execute ({sqlText: "commit"});

    log_sql_command = "call datahub_logging.sp_etl_log_ingestion_process('UpdateEnd','" + process_name + "','Success','Completed process execution.', 0 ," + number_of_rows_inserted.toString()+ "," +  number_of_rows_updated.toString() + ");";
    snowflake.execute({sqlText: log_sql_command});

    result = "Success"; 

    }       

    catch (err)  {
        snowflake.execute( {sqlText: "rollback;"} )
        var clean_error_msg = err.message.replace(/[^\w\s]/gi, '');
    //  Create a log entry to say INSERT STATEMENT failed
    
    log_sql_command = "call datahub_logging.sp_etl_log_ingestion_process('UpdateEnd','" + process_name + "','Failed','MERGE Failed. Error:" + err.code.toString()+" : "+ clean_error_msg  + "', 0 ,0,0);";
    snowflake.execute({sqlText: log_sql_command});
        ;
        throw "Failed: " + err.message;   // Return a success/error indicator.
        }
    return result;
    $$;