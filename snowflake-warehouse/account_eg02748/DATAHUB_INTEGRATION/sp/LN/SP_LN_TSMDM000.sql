create or replace procedure DATAHUB_INTEGRATION.SP_LN_TSMDM000()
    returns varchar not null
                language javascript
                as
                $$

//  Variables

var result = "";                                    // return status of this proc call
const process_name = Object.keys(this)[0];          // name of currently executing process
var number_of_rows_inserted = 0;                             // track number of rows we have inserted
var number_of_rows_updated = 0;                             // track number of rows we have updated


//  Step 1.

//  Start execution - log start

log_sql_command = "call datahub_logging.sp_etl_log_ingestion_process('Insert','" + process_name + "','Running','Started process execution.', 0,0,0);";
snowflake.execute({sqlText: log_sql_command});

snowflake.execute( {sqlText: "begin transaction;"} );
try
    {
        var sql_command = `
                            INSERT INTO LANDING_ERROR.LN_RAW_ERROR
                            SELECT * FROM LANDING_ERROR.VW_STREAM_LN_TSMDM000_ERROR`;
    var sqlStmt = snowflake.createStatement( {sqlText:  sql_command} );
    var rs = sqlStmt.execute();
        
        var sql_command = ` 
                            merge into  TARGET_LN.LN_TSMDM000 as target using (SELECT * FROM (SELECT 
            strm.alrm, 
            strm.alrm_kw, 
            strm.atws_1, 
            strm.atws_10, 
            strm.atws_2, 
            strm.atws_3, 
            strm.atws_4, 
            strm.atws_5, 
            strm.atws_6, 
            strm.atws_7, 
            strm.atws_8, 
            strm.atws_9, 
            strm.atws_kw_1, 
            strm.atws_kw_10, 
            strm.atws_kw_2, 
            strm.atws_kw_3, 
            strm.atws_kw_4, 
            strm.atws_kw_5, 
            strm.atws_kw_6, 
            strm.atws_kw_7, 
            strm.atws_kw_8, 
            strm.atws_kw_9, 
            strm.ccli, 
            strm.ccli_kw, 
            strm.ccur, 
            strm.ccur_ref_compnr, 
            strm.cibp, 
            strm.cibp_kw, 
            strm.clgr, 
            strm.clgr_ref_compnr, 
            strm.clyn, 
            strm.clyn_kw, 
            strm.compnr, 
            strm.cpdi_1, 
            strm.cpdi_2, 
            strm.cpdi_3, 
            strm.ctii, 
            strm.ctii_kw, 
            strm.deleted, 
            strm.dfpb, 
            strm.dfpb_kw, 
            strm.dipy, 
            strm.dipy_kw, 
            strm.dist, 
            strm.dist_kw, 
            strm.dsca, 
            strm.erac, 
            strm.erac_kw, 
            strm.erdc, 
            strm.erdc_kw, 
            strm.feyn, 
            strm.feyn_kw, 
            strm.flds, 
            strm.flds_kw, 
            strm.grpl, 
            strm.grpl_kw, 
            strm.icpr_1, 
            strm.icpr_2, 
            strm.icpr_3, 
            strm.icpr_4, 
            strm.icpr_5, 
            strm.icpr_kw_1, 
            strm.icpr_kw_2, 
            strm.icpr_kw_3, 
            strm.icpr_kw_4, 
            strm.icpr_kw_5, 
            strm.icrr, 
            strm.icrr_kw, 
            strm.icsc, 
            strm.inby, 
            strm.inby_kw, 
            strm.indt, 
            strm.ingr, 
            strm.ingr_kw, 
            strm.ipsm, 
            strm.ipsm_kw, 
            strm.isdp, 
            strm.isdp_kw, 
            strm.isom, 
            strm.isom_kw, 
            strm.iwos, 
            strm.iwos_kw, 
            strm.kpad, 
            strm.kpad_kw, 
            strm.meyn, 
            strm.meyn_kw, 
            strm.ncri, 
            strm.ncri_kw, 
            strm.ngtb, 
            strm.ngtb_ref_compnr, 
            strm.ngtb_sntb_ref_compnr, 
            strm.npeg, 
            strm.npeg_kw, 
            strm.pmnt, 
            strm.pmnt_kw, 
            strm.prnt, 
            strm.prnt_kw, 
            strm.pvap, 
            strm.ract, 
            strm.ract_ref_compnr, 
            strm.sbmt, 
            strm.sbmt_kw, 
            strm.scin, 
            strm.scin_kw, 
            strm.scli, 
            strm.scli_kw, 
            strm.sequencenumber, 
            strm.shpm, 
            strm.shpm_kw, 
            strm.siyn, 
            strm.siyn_kw, 
            strm.skla, 
            strm.skla_kw, 
            strm.sklb, 
            strm.sklb_kw, 
            strm.sklc, 
            strm.sklc_kw, 
            strm.skll, 
            strm.skll_kw, 
            strm.sntb, 
            strm.spdi, 
            strm.spsm, 
            strm.spsm_kw, 
            strm.text, 
            strm.text_ref_compnr, 
            strm.timestamp, 
            strm.tlgi, 
            strm.tlgi_kw, 
            strm.trac_1, 
            strm.trac_2, 
            strm.trac_3, 
            strm.tras, 
            strm.trmd, 
            strm.trmd_kw, 
            strm.ttpl, 
            strm.ttpl_kw, 
            strm.ubpp, 
            strm.ubpp_kw, 
            strm.uday, 
            strm.uday_ref_compnr, 
            strm.udgn, 
            strm.udgn_kw, 
            strm.umon, 
            strm.umon_ref_compnr, 
            strm.undi, 
            strm.undi_ref_compnr, 
            strm.unlr, 
            strm.unlr_ref_compnr, 
            strm.untd, 
            strm.untd_ref_compnr, 
            strm.untm, 
            strm.untm_ref_compnr, 
            strm.usar, 
            strm.usar_kw, 
            strm.username, 
            strm.uspg, 
            strm.uspg_kw, 
            strm.utpd, 
            strm.utpd_kw, 
            strm.uwev, 
            strm.uwev_kw, 
            strm.uwks, 
            strm.uwks_ref_compnr, 
            strm.uyrs, 
            strm.uyrs_ref_compnr, 
            strm.ETL_SEQUENCE_NUMBER,
            strm.ETL_DELETED,
            strm.etl_load_datetime,
            strm.etl_load_metadatafilename,
            ROW_NUMBER() OVER (PARTITION BY 
            strm.compnr,
            strm.indt ORDER BY strm.ETL_SEQUENCE_NUMBER desc,IFNULL(TRY_TO_TIMESTAMP(replace(right(replace(lower(etl_load_metadatafilename),'.json'),23),'_','-'), 'yyyy-mm-dd-HH-MI-SS-FF') ,etl_load_datetime) desc) as ROWNUMBER
        FROM DATAHUB_INTEGRATION.VW_STREAM_LN_TSMDM000 as  strm
                    )   
            WHERE ROWNUMBER=1  
            
                    ) as src on
            ((target.compnr=src.compnr) OR (target.compnr IS NULL AND src.compnr IS NULL)) AND
            ((target.indt=src.indt) OR (target.indt IS NULL AND src.indt IS NULL)) 
                when matched and src.ETL_DELETED=TRUE THEN DELETE
                when matched then update set
                    target.alrm=src.alrm, 
                    target.alrm_kw=src.alrm_kw, 
                    target.atws_1=src.atws_1, 
                    target.atws_10=src.atws_10, 
                    target.atws_2=src.atws_2, 
                    target.atws_3=src.atws_3, 
                    target.atws_4=src.atws_4, 
                    target.atws_5=src.atws_5, 
                    target.atws_6=src.atws_6, 
                    target.atws_7=src.atws_7, 
                    target.atws_8=src.atws_8, 
                    target.atws_9=src.atws_9, 
                    target.atws_kw_1=src.atws_kw_1, 
                    target.atws_kw_10=src.atws_kw_10, 
                    target.atws_kw_2=src.atws_kw_2, 
                    target.atws_kw_3=src.atws_kw_3, 
                    target.atws_kw_4=src.atws_kw_4, 
                    target.atws_kw_5=src.atws_kw_5, 
                    target.atws_kw_6=src.atws_kw_6, 
                    target.atws_kw_7=src.atws_kw_7, 
                    target.atws_kw_8=src.atws_kw_8, 
                    target.atws_kw_9=src.atws_kw_9, 
                    target.ccli=src.ccli, 
                    target.ccli_kw=src.ccli_kw, 
                    target.ccur=src.ccur, 
                    target.ccur_ref_compnr=src.ccur_ref_compnr, 
                    target.cibp=src.cibp, 
                    target.cibp_kw=src.cibp_kw, 
                    target.clgr=src.clgr, 
                    target.clgr_ref_compnr=src.clgr_ref_compnr, 
                    target.clyn=src.clyn, 
                    target.clyn_kw=src.clyn_kw, 
                    target.compnr=src.compnr, 
                    target.cpdi_1=src.cpdi_1, 
                    target.cpdi_2=src.cpdi_2, 
                    target.cpdi_3=src.cpdi_3, 
                    target.ctii=src.ctii, 
                    target.ctii_kw=src.ctii_kw, 
                    target.deleted=src.deleted, 
                    target.dfpb=src.dfpb, 
                    target.dfpb_kw=src.dfpb_kw, 
                    target.dipy=src.dipy, 
                    target.dipy_kw=src.dipy_kw, 
                    target.dist=src.dist, 
                    target.dist_kw=src.dist_kw, 
                    target.dsca=src.dsca, 
                    target.erac=src.erac, 
                    target.erac_kw=src.erac_kw, 
                    target.erdc=src.erdc, 
                    target.erdc_kw=src.erdc_kw, 
                    target.feyn=src.feyn, 
                    target.feyn_kw=src.feyn_kw, 
                    target.flds=src.flds, 
                    target.flds_kw=src.flds_kw, 
                    target.grpl=src.grpl, 
                    target.grpl_kw=src.grpl_kw, 
                    target.icpr_1=src.icpr_1, 
                    target.icpr_2=src.icpr_2, 
                    target.icpr_3=src.icpr_3, 
                    target.icpr_4=src.icpr_4, 
                    target.icpr_5=src.icpr_5, 
                    target.icpr_kw_1=src.icpr_kw_1, 
                    target.icpr_kw_2=src.icpr_kw_2, 
                    target.icpr_kw_3=src.icpr_kw_3, 
                    target.icpr_kw_4=src.icpr_kw_4, 
                    target.icpr_kw_5=src.icpr_kw_5, 
                    target.icrr=src.icrr, 
                    target.icrr_kw=src.icrr_kw, 
                    target.icsc=src.icsc, 
                    target.inby=src.inby, 
                    target.inby_kw=src.inby_kw, 
                    target.indt=src.indt, 
                    target.ingr=src.ingr, 
                    target.ingr_kw=src.ingr_kw, 
                    target.ipsm=src.ipsm, 
                    target.ipsm_kw=src.ipsm_kw, 
                    target.isdp=src.isdp, 
                    target.isdp_kw=src.isdp_kw, 
                    target.isom=src.isom, 
                    target.isom_kw=src.isom_kw, 
                    target.iwos=src.iwos, 
                    target.iwos_kw=src.iwos_kw, 
                    target.kpad=src.kpad, 
                    target.kpad_kw=src.kpad_kw, 
                    target.meyn=src.meyn, 
                    target.meyn_kw=src.meyn_kw, 
                    target.ncri=src.ncri, 
                    target.ncri_kw=src.ncri_kw, 
                    target.ngtb=src.ngtb, 
                    target.ngtb_ref_compnr=src.ngtb_ref_compnr, 
                    target.ngtb_sntb_ref_compnr=src.ngtb_sntb_ref_compnr, 
                    target.npeg=src.npeg, 
                    target.npeg_kw=src.npeg_kw, 
                    target.pmnt=src.pmnt, 
                    target.pmnt_kw=src.pmnt_kw, 
                    target.prnt=src.prnt, 
                    target.prnt_kw=src.prnt_kw, 
                    target.pvap=src.pvap, 
                    target.ract=src.ract, 
                    target.ract_ref_compnr=src.ract_ref_compnr, 
                    target.sbmt=src.sbmt, 
                    target.sbmt_kw=src.sbmt_kw, 
                    target.scin=src.scin, 
                    target.scin_kw=src.scin_kw, 
                    target.scli=src.scli, 
                    target.scli_kw=src.scli_kw, 
                    target.sequencenumber=src.sequencenumber, 
                    target.shpm=src.shpm, 
                    target.shpm_kw=src.shpm_kw, 
                    target.siyn=src.siyn, 
                    target.siyn_kw=src.siyn_kw, 
                    target.skla=src.skla, 
                    target.skla_kw=src.skla_kw, 
                    target.sklb=src.sklb, 
                    target.sklb_kw=src.sklb_kw, 
                    target.sklc=src.sklc, 
                    target.sklc_kw=src.sklc_kw, 
                    target.skll=src.skll, 
                    target.skll_kw=src.skll_kw, 
                    target.sntb=src.sntb, 
                    target.spdi=src.spdi, 
                    target.spsm=src.spsm, 
                    target.spsm_kw=src.spsm_kw, 
                    target.text=src.text, 
                    target.text_ref_compnr=src.text_ref_compnr, 
                    target.timestamp=src.timestamp, 
                    target.tlgi=src.tlgi, 
                    target.tlgi_kw=src.tlgi_kw, 
                    target.trac_1=src.trac_1, 
                    target.trac_2=src.trac_2, 
                    target.trac_3=src.trac_3, 
                    target.tras=src.tras, 
                    target.trmd=src.trmd, 
                    target.trmd_kw=src.trmd_kw, 
                    target.ttpl=src.ttpl, 
                    target.ttpl_kw=src.ttpl_kw, 
                    target.ubpp=src.ubpp, 
                    target.ubpp_kw=src.ubpp_kw, 
                    target.uday=src.uday, 
                    target.uday_ref_compnr=src.uday_ref_compnr, 
                    target.udgn=src.udgn, 
                    target.udgn_kw=src.udgn_kw, 
                    target.umon=src.umon, 
                    target.umon_ref_compnr=src.umon_ref_compnr, 
                    target.undi=src.undi, 
                    target.undi_ref_compnr=src.undi_ref_compnr, 
                    target.unlr=src.unlr, 
                    target.unlr_ref_compnr=src.unlr_ref_compnr, 
                    target.untd=src.untd, 
                    target.untd_ref_compnr=src.untd_ref_compnr, 
                    target.untm=src.untm, 
                    target.untm_ref_compnr=src.untm_ref_compnr, 
                    target.usar=src.usar, 
                    target.usar_kw=src.usar_kw, 
                    target.username=src.username, 
                    target.uspg=src.uspg, 
                    target.uspg_kw=src.uspg_kw, 
                    target.utpd=src.utpd, 
                    target.utpd_kw=src.utpd_kw, 
                    target.uwev=src.uwev, 
                    target.uwev_kw=src.uwev_kw, 
                    target.uwks=src.uwks, 
                    target.uwks_ref_compnr=src.uwks_ref_compnr, 
                    target.uyrs=src.uyrs, 
                    target.uyrs_ref_compnr=src.uyrs_ref_compnr, 
                    target.ETL_SEQUENCE_NUMBER=src.ETL_SEQUENCE_NUMBER,
                    target.etl_load_datetime=CURRENT_TIMESTAMP,
                    target.etl_load_metadatafilename=src.etl_load_metadatafilename
        when not matched and (src.ETL_DELETED=FALSE OR src.ETL_DELETED IS NULL)  then insert ( 
                    alrm, 
                    alrm_kw, 
                    atws_1, 
                    atws_10, 
                    atws_2, 
                    atws_3, 
                    atws_4, 
                    atws_5, 
                    atws_6, 
                    atws_7, 
                    atws_8, 
                    atws_9, 
                    atws_kw_1, 
                    atws_kw_10, 
                    atws_kw_2, 
                    atws_kw_3, 
                    atws_kw_4, 
                    atws_kw_5, 
                    atws_kw_6, 
                    atws_kw_7, 
                    atws_kw_8, 
                    atws_kw_9, 
                    ccli, 
                    ccli_kw, 
                    ccur, 
                    ccur_ref_compnr, 
                    cibp, 
                    cibp_kw, 
                    clgr, 
                    clgr_ref_compnr, 
                    clyn, 
                    clyn_kw, 
                    compnr, 
                    cpdi_1, 
                    cpdi_2, 
                    cpdi_3, 
                    ctii, 
                    ctii_kw, 
                    deleted, 
                    dfpb, 
                    dfpb_kw, 
                    dipy, 
                    dipy_kw, 
                    dist, 
                    dist_kw, 
                    dsca, 
                    erac, 
                    erac_kw, 
                    erdc, 
                    erdc_kw, 
                    feyn, 
                    feyn_kw, 
                    flds, 
                    flds_kw, 
                    grpl, 
                    grpl_kw, 
                    icpr_1, 
                    icpr_2, 
                    icpr_3, 
                    icpr_4, 
                    icpr_5, 
                    icpr_kw_1, 
                    icpr_kw_2, 
                    icpr_kw_3, 
                    icpr_kw_4, 
                    icpr_kw_5, 
                    icrr, 
                    icrr_kw, 
                    icsc, 
                    inby, 
                    inby_kw, 
                    indt, 
                    ingr, 
                    ingr_kw, 
                    ipsm, 
                    ipsm_kw, 
                    isdp, 
                    isdp_kw, 
                    isom, 
                    isom_kw, 
                    iwos, 
                    iwos_kw, 
                    kpad, 
                    kpad_kw, 
                    meyn, 
                    meyn_kw, 
                    ncri, 
                    ncri_kw, 
                    ngtb, 
                    ngtb_ref_compnr, 
                    ngtb_sntb_ref_compnr, 
                    npeg, 
                    npeg_kw, 
                    pmnt, 
                    pmnt_kw, 
                    prnt, 
                    prnt_kw, 
                    pvap, 
                    ract, 
                    ract_ref_compnr, 
                    sbmt, 
                    sbmt_kw, 
                    scin, 
                    scin_kw, 
                    scli, 
                    scli_kw, 
                    sequencenumber, 
                    shpm, 
                    shpm_kw, 
                    siyn, 
                    siyn_kw, 
                    skla, 
                    skla_kw, 
                    sklb, 
                    sklb_kw, 
                    sklc, 
                    sklc_kw, 
                    skll, 
                    skll_kw, 
                    sntb, 
                    spdi, 
                    spsm, 
                    spsm_kw, 
                    text, 
                    text_ref_compnr, 
                    timestamp, 
                    tlgi, 
                    tlgi_kw, 
                    trac_1, 
                    trac_2, 
                    trac_3, 
                    tras, 
                    trmd, 
                    trmd_kw, 
                    ttpl, 
                    ttpl_kw, 
                    ubpp, 
                    ubpp_kw, 
                    uday, 
                    uday_ref_compnr, 
                    udgn, 
                    udgn_kw, 
                    umon, 
                    umon_ref_compnr, 
                    undi, 
                    undi_ref_compnr, 
                    unlr, 
                    unlr_ref_compnr, 
                    untd, 
                    untd_ref_compnr, 
                    untm, 
                    untm_ref_compnr, 
                    usar, 
                    usar_kw, 
                    username, 
                    uspg, 
                    uspg_kw, 
                    utpd, 
                    utpd_kw, 
                    uwev, 
                    uwev_kw, 
                    uwks, 
                    uwks_ref_compnr, 
                    uyrs, 
                    uyrs_ref_compnr, 
                    ETL_SEQUENCE_NUMBER,                       
                    etl_load_datetime,
                    etl_load_metadatafilename) 
            values (
                    src.alrm, 
                    src.alrm_kw, 
                    src.atws_1, 
                    src.atws_10, 
                    src.atws_2, 
                    src.atws_3, 
                    src.atws_4, 
                    src.atws_5, 
                    src.atws_6, 
                    src.atws_7, 
                    src.atws_8, 
                    src.atws_9, 
                    src.atws_kw_1, 
                    src.atws_kw_10, 
                    src.atws_kw_2, 
                    src.atws_kw_3, 
                    src.atws_kw_4, 
                    src.atws_kw_5, 
                    src.atws_kw_6, 
                    src.atws_kw_7, 
                    src.atws_kw_8, 
                    src.atws_kw_9, 
                    src.ccli, 
                    src.ccli_kw, 
                    src.ccur, 
                    src.ccur_ref_compnr, 
                    src.cibp, 
                    src.cibp_kw, 
                    src.clgr, 
                    src.clgr_ref_compnr, 
                    src.clyn, 
                    src.clyn_kw, 
                    src.compnr, 
                    src.cpdi_1, 
                    src.cpdi_2, 
                    src.cpdi_3, 
                    src.ctii, 
                    src.ctii_kw, 
                    src.deleted, 
                    src.dfpb, 
                    src.dfpb_kw, 
                    src.dipy, 
                    src.dipy_kw, 
                    src.dist, 
                    src.dist_kw, 
                    src.dsca, 
                    src.erac, 
                    src.erac_kw, 
                    src.erdc, 
                    src.erdc_kw, 
                    src.feyn, 
                    src.feyn_kw, 
                    src.flds, 
                    src.flds_kw, 
                    src.grpl, 
                    src.grpl_kw, 
                    src.icpr_1, 
                    src.icpr_2, 
                    src.icpr_3, 
                    src.icpr_4, 
                    src.icpr_5, 
                    src.icpr_kw_1, 
                    src.icpr_kw_2, 
                    src.icpr_kw_3, 
                    src.icpr_kw_4, 
                    src.icpr_kw_5, 
                    src.icrr, 
                    src.icrr_kw, 
                    src.icsc, 
                    src.inby, 
                    src.inby_kw, 
                    src.indt, 
                    src.ingr, 
                    src.ingr_kw, 
                    src.ipsm, 
                    src.ipsm_kw, 
                    src.isdp, 
                    src.isdp_kw, 
                    src.isom, 
                    src.isom_kw, 
                    src.iwos, 
                    src.iwos_kw, 
                    src.kpad, 
                    src.kpad_kw, 
                    src.meyn, 
                    src.meyn_kw, 
                    src.ncri, 
                    src.ncri_kw, 
                    src.ngtb, 
                    src.ngtb_ref_compnr, 
                    src.ngtb_sntb_ref_compnr, 
                    src.npeg, 
                    src.npeg_kw, 
                    src.pmnt, 
                    src.pmnt_kw, 
                    src.prnt, 
                    src.prnt_kw, 
                    src.pvap, 
                    src.ract, 
                    src.ract_ref_compnr, 
                    src.sbmt, 
                    src.sbmt_kw, 
                    src.scin, 
                    src.scin_kw, 
                    src.scli, 
                    src.scli_kw, 
                    src.sequencenumber, 
                    src.shpm, 
                    src.shpm_kw, 
                    src.siyn, 
                    src.siyn_kw, 
                    src.skla, 
                    src.skla_kw, 
                    src.sklb, 
                    src.sklb_kw, 
                    src.sklc, 
                    src.sklc_kw, 
                    src.skll, 
                    src.skll_kw, 
                    src.sntb, 
                    src.spdi, 
                    src.spsm, 
                    src.spsm_kw, 
                    src.text, 
                    src.text_ref_compnr, 
                    src.timestamp, 
                    src.tlgi, 
                    src.tlgi_kw, 
                    src.trac_1, 
                    src.trac_2, 
                    src.trac_3, 
                    src.tras, 
                    src.trmd, 
                    src.trmd_kw, 
                    src.ttpl, 
                    src.ttpl_kw, 
                    src.ubpp, 
                    src.ubpp_kw, 
                    src.uday, 
                    src.uday_ref_compnr, 
                    src.udgn, 
                    src.udgn_kw, 
                    src.umon, 
                    src.umon_ref_compnr, 
                    src.undi, 
                    src.undi_ref_compnr, 
                    src.unlr, 
                    src.unlr_ref_compnr, 
                    src.untd, 
                    src.untd_ref_compnr, 
                    src.untm, 
                    src.untm_ref_compnr, 
                    src.usar, 
                    src.usar_kw, 
                    src.username, 
                    src.uspg, 
                    src.uspg_kw, 
                    src.utpd, 
                    src.utpd_kw, 
                    src.uwev, 
                    src.uwev_kw, 
                    src.uwks, 
                    src.uwks_ref_compnr, 
                    src.uyrs, 
                    src.uyrs_ref_compnr,     
                    src.ETL_SEQUENCE_NUMBER,
                    CURRENT_TIMESTAMP,
                    src.etl_load_metadatafilename);`;

    var sqlStmt = snowflake.createStatement( {sqlText:  sql_command} );
    var rs = sqlStmt.execute();

    snowflake.execute( {sqlText: `merge into TARGET_HISTORY_LN.LN_TSMDM000_DELETED as target using (
                SELECT * FROM (SELECT 
            strm.alrm, 
            strm.alrm_kw, 
            strm.atws_1, 
            strm.atws_10, 
            strm.atws_2, 
            strm.atws_3, 
            strm.atws_4, 
            strm.atws_5, 
            strm.atws_6, 
            strm.atws_7, 
            strm.atws_8, 
            strm.atws_9, 
            strm.atws_kw_1, 
            strm.atws_kw_10, 
            strm.atws_kw_2, 
            strm.atws_kw_3, 
            strm.atws_kw_4, 
            strm.atws_kw_5, 
            strm.atws_kw_6, 
            strm.atws_kw_7, 
            strm.atws_kw_8, 
            strm.atws_kw_9, 
            strm.ccli, 
            strm.ccli_kw, 
            strm.ccur, 
            strm.ccur_ref_compnr, 
            strm.cibp, 
            strm.cibp_kw, 
            strm.clgr, 
            strm.clgr_ref_compnr, 
            strm.clyn, 
            strm.clyn_kw, 
            strm.compnr, 
            strm.cpdi_1, 
            strm.cpdi_2, 
            strm.cpdi_3, 
            strm.ctii, 
            strm.ctii_kw, 
            strm.deleted, 
            strm.dfpb, 
            strm.dfpb_kw, 
            strm.dipy, 
            strm.dipy_kw, 
            strm.dist, 
            strm.dist_kw, 
            strm.dsca, 
            strm.erac, 
            strm.erac_kw, 
            strm.erdc, 
            strm.erdc_kw, 
            strm.feyn, 
            strm.feyn_kw, 
            strm.flds, 
            strm.flds_kw, 
            strm.grpl, 
            strm.grpl_kw, 
            strm.icpr_1, 
            strm.icpr_2, 
            strm.icpr_3, 
            strm.icpr_4, 
            strm.icpr_5, 
            strm.icpr_kw_1, 
            strm.icpr_kw_2, 
            strm.icpr_kw_3, 
            strm.icpr_kw_4, 
            strm.icpr_kw_5, 
            strm.icrr, 
            strm.icrr_kw, 
            strm.icsc, 
            strm.inby, 
            strm.inby_kw, 
            strm.indt, 
            strm.ingr, 
            strm.ingr_kw, 
            strm.ipsm, 
            strm.ipsm_kw, 
            strm.isdp, 
            strm.isdp_kw, 
            strm.isom, 
            strm.isom_kw, 
            strm.iwos, 
            strm.iwos_kw, 
            strm.kpad, 
            strm.kpad_kw, 
            strm.meyn, 
            strm.meyn_kw, 
            strm.ncri, 
            strm.ncri_kw, 
            strm.ngtb, 
            strm.ngtb_ref_compnr, 
            strm.ngtb_sntb_ref_compnr, 
            strm.npeg, 
            strm.npeg_kw, 
            strm.pmnt, 
            strm.pmnt_kw, 
            strm.prnt, 
            strm.prnt_kw, 
            strm.pvap, 
            strm.ract, 
            strm.ract_ref_compnr, 
            strm.sbmt, 
            strm.sbmt_kw, 
            strm.scin, 
            strm.scin_kw, 
            strm.scli, 
            strm.scli_kw, 
            strm.sequencenumber, 
            strm.shpm, 
            strm.shpm_kw, 
            strm.siyn, 
            strm.siyn_kw, 
            strm.skla, 
            strm.skla_kw, 
            strm.sklb, 
            strm.sklb_kw, 
            strm.sklc, 
            strm.sklc_kw, 
            strm.skll, 
            strm.skll_kw, 
            strm.sntb, 
            strm.spdi, 
            strm.spsm, 
            strm.spsm_kw, 
            strm.text, 
            strm.text_ref_compnr, 
            strm.timestamp, 
            strm.tlgi, 
            strm.tlgi_kw, 
            strm.trac_1, 
            strm.trac_2, 
            strm.trac_3, 
            strm.tras, 
            strm.trmd, 
            strm.trmd_kw, 
            strm.ttpl, 
            strm.ttpl_kw, 
            strm.ubpp, 
            strm.ubpp_kw, 
            strm.uday, 
            strm.uday_ref_compnr, 
            strm.udgn, 
            strm.udgn_kw, 
            strm.umon, 
            strm.umon_ref_compnr, 
            strm.undi, 
            strm.undi_ref_compnr, 
            strm.unlr, 
            strm.unlr_ref_compnr, 
            strm.untd, 
            strm.untd_ref_compnr, 
            strm.untm, 
            strm.untm_ref_compnr, 
            strm.usar, 
            strm.usar_kw, 
            strm.username, 
            strm.uspg, 
            strm.uspg_kw, 
            strm.utpd, 
            strm.utpd_kw, 
            strm.uwev, 
            strm.uwev_kw, 
            strm.uwks, 
            strm.uwks_ref_compnr, 
            strm.uyrs, 
            strm.uyrs_ref_compnr, 
            strm.ETL_SEQUENCE_NUMBER,
            strm.ETL_DELETED,
            strm.etl_load_datetime,
            strm.etl_load_metadatafilename,
            ROW_NUMBER() OVER (PARTITION BY 
            strm.compnr,
            strm.indt ORDER BY strm.ETL_SEQUENCE_NUMBER desc,IFNULL(TRY_TO_TIMESTAMP(replace(right(replace(lower(etl_load_metadatafilename),'.json'),23),'_','-'), 'yyyy-mm-dd-HH-MI-SS-FF') ,etl_load_datetime) desc) as ROWNUMBER
        FROM DATAHUB_INTEGRATION.VW_STREAM_LN_TSMDM000 as  strm
        WHERE strm.ETL_DELETED=TRUE
                    )   
            WHERE ROWNUMBER=1  
            
                    ) as src on
            ((target.compnr=src.compnr) OR (target.compnr IS NULL AND src.compnr IS NULL)) AND
            ((target.indt=src.indt) OR (target.indt IS NULL AND src.indt IS NULL)) 
                when matched then update set
                    target.alrm=src.alrm, 
                    target.alrm_kw=src.alrm_kw, 
                    target.atws_1=src.atws_1, 
                    target.atws_10=src.atws_10, 
                    target.atws_2=src.atws_2, 
                    target.atws_3=src.atws_3, 
                    target.atws_4=src.atws_4, 
                    target.atws_5=src.atws_5, 
                    target.atws_6=src.atws_6, 
                    target.atws_7=src.atws_7, 
                    target.atws_8=src.atws_8, 
                    target.atws_9=src.atws_9, 
                    target.atws_kw_1=src.atws_kw_1, 
                    target.atws_kw_10=src.atws_kw_10, 
                    target.atws_kw_2=src.atws_kw_2, 
                    target.atws_kw_3=src.atws_kw_3, 
                    target.atws_kw_4=src.atws_kw_4, 
                    target.atws_kw_5=src.atws_kw_5, 
                    target.atws_kw_6=src.atws_kw_6, 
                    target.atws_kw_7=src.atws_kw_7, 
                    target.atws_kw_8=src.atws_kw_8, 
                    target.atws_kw_9=src.atws_kw_9, 
                    target.ccli=src.ccli, 
                    target.ccli_kw=src.ccli_kw, 
                    target.ccur=src.ccur, 
                    target.ccur_ref_compnr=src.ccur_ref_compnr, 
                    target.cibp=src.cibp, 
                    target.cibp_kw=src.cibp_kw, 
                    target.clgr=src.clgr, 
                    target.clgr_ref_compnr=src.clgr_ref_compnr, 
                    target.clyn=src.clyn, 
                    target.clyn_kw=src.clyn_kw, 
                    target.compnr=src.compnr, 
                    target.cpdi_1=src.cpdi_1, 
                    target.cpdi_2=src.cpdi_2, 
                    target.cpdi_3=src.cpdi_3, 
                    target.ctii=src.ctii, 
                    target.ctii_kw=src.ctii_kw, 
                    target.deleted=src.deleted, 
                    target.dfpb=src.dfpb, 
                    target.dfpb_kw=src.dfpb_kw, 
                    target.dipy=src.dipy, 
                    target.dipy_kw=src.dipy_kw, 
                    target.dist=src.dist, 
                    target.dist_kw=src.dist_kw, 
                    target.dsca=src.dsca, 
                    target.erac=src.erac, 
                    target.erac_kw=src.erac_kw, 
                    target.erdc=src.erdc, 
                    target.erdc_kw=src.erdc_kw, 
                    target.feyn=src.feyn, 
                    target.feyn_kw=src.feyn_kw, 
                    target.flds=src.flds, 
                    target.flds_kw=src.flds_kw, 
                    target.grpl=src.grpl, 
                    target.grpl_kw=src.grpl_kw, 
                    target.icpr_1=src.icpr_1, 
                    target.icpr_2=src.icpr_2, 
                    target.icpr_3=src.icpr_3, 
                    target.icpr_4=src.icpr_4, 
                    target.icpr_5=src.icpr_5, 
                    target.icpr_kw_1=src.icpr_kw_1, 
                    target.icpr_kw_2=src.icpr_kw_2, 
                    target.icpr_kw_3=src.icpr_kw_3, 
                    target.icpr_kw_4=src.icpr_kw_4, 
                    target.icpr_kw_5=src.icpr_kw_5, 
                    target.icrr=src.icrr, 
                    target.icrr_kw=src.icrr_kw, 
                    target.icsc=src.icsc, 
                    target.inby=src.inby, 
                    target.inby_kw=src.inby_kw, 
                    target.indt=src.indt, 
                    target.ingr=src.ingr, 
                    target.ingr_kw=src.ingr_kw, 
                    target.ipsm=src.ipsm, 
                    target.ipsm_kw=src.ipsm_kw, 
                    target.isdp=src.isdp, 
                    target.isdp_kw=src.isdp_kw, 
                    target.isom=src.isom, 
                    target.isom_kw=src.isom_kw, 
                    target.iwos=src.iwos, 
                    target.iwos_kw=src.iwos_kw, 
                    target.kpad=src.kpad, 
                    target.kpad_kw=src.kpad_kw, 
                    target.meyn=src.meyn, 
                    target.meyn_kw=src.meyn_kw, 
                    target.ncri=src.ncri, 
                    target.ncri_kw=src.ncri_kw, 
                    target.ngtb=src.ngtb, 
                    target.ngtb_ref_compnr=src.ngtb_ref_compnr, 
                    target.ngtb_sntb_ref_compnr=src.ngtb_sntb_ref_compnr, 
                    target.npeg=src.npeg, 
                    target.npeg_kw=src.npeg_kw, 
                    target.pmnt=src.pmnt, 
                    target.pmnt_kw=src.pmnt_kw, 
                    target.prnt=src.prnt, 
                    target.prnt_kw=src.prnt_kw, 
                    target.pvap=src.pvap, 
                    target.ract=src.ract, 
                    target.ract_ref_compnr=src.ract_ref_compnr, 
                    target.sbmt=src.sbmt, 
                    target.sbmt_kw=src.sbmt_kw, 
                    target.scin=src.scin, 
                    target.scin_kw=src.scin_kw, 
                    target.scli=src.scli, 
                    target.scli_kw=src.scli_kw, 
                    target.sequencenumber=src.sequencenumber, 
                    target.shpm=src.shpm, 
                    target.shpm_kw=src.shpm_kw, 
                    target.siyn=src.siyn, 
                    target.siyn_kw=src.siyn_kw, 
                    target.skla=src.skla, 
                    target.skla_kw=src.skla_kw, 
                    target.sklb=src.sklb, 
                    target.sklb_kw=src.sklb_kw, 
                    target.sklc=src.sklc, 
                    target.sklc_kw=src.sklc_kw, 
                    target.skll=src.skll, 
                    target.skll_kw=src.skll_kw, 
                    target.sntb=src.sntb, 
                    target.spdi=src.spdi, 
                    target.spsm=src.spsm, 
                    target.spsm_kw=src.spsm_kw, 
                    target.text=src.text, 
                    target.text_ref_compnr=src.text_ref_compnr, 
                    target.timestamp=src.timestamp, 
                    target.tlgi=src.tlgi, 
                    target.tlgi_kw=src.tlgi_kw, 
                    target.trac_1=src.trac_1, 
                    target.trac_2=src.trac_2, 
                    target.trac_3=src.trac_3, 
                    target.tras=src.tras, 
                    target.trmd=src.trmd, 
                    target.trmd_kw=src.trmd_kw, 
                    target.ttpl=src.ttpl, 
                    target.ttpl_kw=src.ttpl_kw, 
                    target.ubpp=src.ubpp, 
                    target.ubpp_kw=src.ubpp_kw, 
                    target.uday=src.uday, 
                    target.uday_ref_compnr=src.uday_ref_compnr, 
                    target.udgn=src.udgn, 
                    target.udgn_kw=src.udgn_kw, 
                    target.umon=src.umon, 
                    target.umon_ref_compnr=src.umon_ref_compnr, 
                    target.undi=src.undi, 
                    target.undi_ref_compnr=src.undi_ref_compnr, 
                    target.unlr=src.unlr, 
                    target.unlr_ref_compnr=src.unlr_ref_compnr, 
                    target.untd=src.untd, 
                    target.untd_ref_compnr=src.untd_ref_compnr, 
                    target.untm=src.untm, 
                    target.untm_ref_compnr=src.untm_ref_compnr, 
                    target.usar=src.usar, 
                    target.usar_kw=src.usar_kw, 
                    target.username=src.username, 
                    target.uspg=src.uspg, 
                    target.uspg_kw=src.uspg_kw, 
                    target.utpd=src.utpd, 
                    target.utpd_kw=src.utpd_kw, 
                    target.uwev=src.uwev, 
                    target.uwev_kw=src.uwev_kw, 
                    target.uwks=src.uwks, 
                    target.uwks_ref_compnr=src.uwks_ref_compnr, 
                    target.uyrs=src.uyrs, 
                    target.uyrs_ref_compnr=src.uyrs_ref_compnr, 
                    target.ETL_SEQUENCE_NUMBER=src.ETL_SEQUENCE_NUMBER,
                    target.etl_load_datetime=CURRENT_TIMESTAMP,
                    target.etl_load_metadatafilename=src.etl_load_metadatafilename,
                    target.ETL_DELETED=src.ETL_DELETED
        when not matched   then insert ( alrm, alrm_kw, atws_1, atws_10, atws_2, atws_3, atws_4, atws_5, atws_6, atws_7, atws_8, atws_9, atws_kw_1, atws_kw_10, atws_kw_2, atws_kw_3, atws_kw_4, atws_kw_5, atws_kw_6, atws_kw_7, atws_kw_8, atws_kw_9, ccli, ccli_kw, ccur, ccur_ref_compnr, cibp, cibp_kw, clgr, clgr_ref_compnr, clyn, clyn_kw, compnr, cpdi_1, cpdi_2, cpdi_3, ctii, ctii_kw, deleted, dfpb, dfpb_kw, dipy, dipy_kw, dist, dist_kw, dsca, erac, erac_kw, erdc, erdc_kw, feyn, feyn_kw, flds, flds_kw, grpl, grpl_kw, icpr_1, icpr_2, icpr_3, icpr_4, icpr_5, icpr_kw_1, icpr_kw_2, icpr_kw_3, icpr_kw_4, icpr_kw_5, icrr, icrr_kw, icsc, inby, inby_kw, indt, ingr, ingr_kw, ipsm, ipsm_kw, isdp, isdp_kw, isom, isom_kw, iwos, iwos_kw, kpad, kpad_kw, meyn, meyn_kw, ncri, ncri_kw, ngtb, ngtb_ref_compnr, ngtb_sntb_ref_compnr, npeg, npeg_kw, pmnt, pmnt_kw, prnt, prnt_kw, pvap, ract, ract_ref_compnr, sbmt, sbmt_kw, scin, scin_kw, scli, scli_kw, sequencenumber, shpm, shpm_kw, siyn, siyn_kw, skla, skla_kw, sklb, sklb_kw, sklc, sklc_kw, skll, skll_kw, sntb, spdi, spsm, spsm_kw, text, text_ref_compnr, timestamp, tlgi, tlgi_kw, trac_1, trac_2, trac_3, tras, trmd, trmd_kw, ttpl, ttpl_kw, ubpp, ubpp_kw, uday, uday_ref_compnr, udgn, udgn_kw, umon, umon_ref_compnr, undi, undi_ref_compnr, unlr, unlr_ref_compnr, untd, untd_ref_compnr, untm, untm_ref_compnr, usar, usar_kw, username, uspg, uspg_kw, utpd, utpd_kw, uwev, uwev_kw, uwks, uwks_ref_compnr, uyrs, uyrs_ref_compnr, 
                    ETL_SEQUENCE_NUMBER,                       
                    etl_load_datetime,
                    etl_load_metadatafilename,
                    etl_is_deleted,
                    ETL_DELETED) 
            values (
                    src.alrm, 
                    src.alrm_kw, 
                    src.atws_1, 
                    src.atws_10, 
                    src.atws_2, 
                    src.atws_3, 
                    src.atws_4, 
                    src.atws_5, 
                    src.atws_6, 
                    src.atws_7, 
                    src.atws_8, 
                    src.atws_9, 
                    src.atws_kw_1, 
                    src.atws_kw_10, 
                    src.atws_kw_2, 
                    src.atws_kw_3, 
                    src.atws_kw_4, 
                    src.atws_kw_5, 
                    src.atws_kw_6, 
                    src.atws_kw_7, 
                    src.atws_kw_8, 
                    src.atws_kw_9, 
                    src.ccli, 
                    src.ccli_kw, 
                    src.ccur, 
                    src.ccur_ref_compnr, 
                    src.cibp, 
                    src.cibp_kw, 
                    src.clgr, 
                    src.clgr_ref_compnr, 
                    src.clyn, 
                    src.clyn_kw, 
                    src.compnr, 
                    src.cpdi_1, 
                    src.cpdi_2, 
                    src.cpdi_3, 
                    src.ctii, 
                    src.ctii_kw, 
                    src.deleted, 
                    src.dfpb, 
                    src.dfpb_kw, 
                    src.dipy, 
                    src.dipy_kw, 
                    src.dist, 
                    src.dist_kw, 
                    src.dsca, 
                    src.erac, 
                    src.erac_kw, 
                    src.erdc, 
                    src.erdc_kw, 
                    src.feyn, 
                    src.feyn_kw, 
                    src.flds, 
                    src.flds_kw, 
                    src.grpl, 
                    src.grpl_kw, 
                    src.icpr_1, 
                    src.icpr_2, 
                    src.icpr_3, 
                    src.icpr_4, 
                    src.icpr_5, 
                    src.icpr_kw_1, 
                    src.icpr_kw_2, 
                    src.icpr_kw_3, 
                    src.icpr_kw_4, 
                    src.icpr_kw_5, 
                    src.icrr, 
                    src.icrr_kw, 
                    src.icsc, 
                    src.inby, 
                    src.inby_kw, 
                    src.indt, 
                    src.ingr, 
                    src.ingr_kw, 
                    src.ipsm, 
                    src.ipsm_kw, 
                    src.isdp, 
                    src.isdp_kw, 
                    src.isom, 
                    src.isom_kw, 
                    src.iwos, 
                    src.iwos_kw, 
                    src.kpad, 
                    src.kpad_kw, 
                    src.meyn, 
                    src.meyn_kw, 
                    src.ncri, 
                    src.ncri_kw, 
                    src.ngtb, 
                    src.ngtb_ref_compnr, 
                    src.ngtb_sntb_ref_compnr, 
                    src.npeg, 
                    src.npeg_kw, 
                    src.pmnt, 
                    src.pmnt_kw, 
                    src.prnt, 
                    src.prnt_kw, 
                    src.pvap, 
                    src.ract, 
                    src.ract_ref_compnr, 
                    src.sbmt, 
                    src.sbmt_kw, 
                    src.scin, 
                    src.scin_kw, 
                    src.scli, 
                    src.scli_kw, 
                    src.sequencenumber, 
                    src.shpm, 
                    src.shpm_kw, 
                    src.siyn, 
                    src.siyn_kw, 
                    src.skla, 
                    src.skla_kw, 
                    src.sklb, 
                    src.sklb_kw, 
                    src.sklc, 
                    src.sklc_kw, 
                    src.skll, 
                    src.skll_kw, 
                    src.sntb, 
                    src.spdi, 
                    src.spsm, 
                    src.spsm_kw, 
                    src.text, 
                    src.text_ref_compnr, 
                    src.timestamp, 
                    src.tlgi, 
                    src.tlgi_kw, 
                    src.trac_1, 
                    src.trac_2, 
                    src.trac_3, 
                    src.tras, 
                    src.trmd, 
                    src.trmd_kw, 
                    src.ttpl, 
                    src.ttpl_kw, 
                    src.ubpp, 
                    src.ubpp_kw, 
                    src.uday, 
                    src.uday_ref_compnr, 
                    src.udgn, 
                    src.udgn_kw, 
                    src.umon, 
                    src.umon_ref_compnr, 
                    src.undi, 
                    src.undi_ref_compnr, 
                    src.unlr, 
                    src.unlr_ref_compnr, 
                    src.untd, 
                    src.untd_ref_compnr, 
                    src.untm, 
                    src.untm_ref_compnr, 
                    src.usar, 
                    src.usar_kw, 
                    src.username, 
                    src.uspg, 
                    src.uspg_kw, 
                    src.utpd, 
                    src.utpd_kw, 
                    src.uwev, 
                    src.uwev_kw, 
                    src.uwks, 
                    src.uwks_ref_compnr, 
                    src.uyrs, 
                    src.uyrs_ref_compnr,     
                    src.ETL_SEQUENCE_NUMBER,
                    CURRENT_TIMESTAMP,
                    src.etl_load_metadatafilename,
                    case when ETL_DELETED=TRUE then TRUE else FALSE end,
                    ETL_DELETED);
    `
} );

                    
//  Get number of rows inserted
        
        var sqlStmt = snowflake.createStatement( {sqlText:  sql_command} );
        var rs = sqlStmt.execute();
        var number_of_rows_inserted = sqlStmt.getNumRowsInserted();
        var number_of_rows_updated =  sqlStmt.getNumRowsUpdated();
                    

        
    snowflake.execute ({sqlText: "commit"});

    log_sql_command = "call datahub_logging.sp_etl_log_ingestion_process('UpdateEnd','" + process_name + "','Success','Completed process execution.', 0 ," + number_of_rows_inserted.toString()+ "," +  number_of_rows_updated.toString() + ");";
    snowflake.execute({sqlText: log_sql_command});

    result = "Success"; 

    }       

    catch (err)  {
        snowflake.execute( {sqlText: "rollback;"} )
        var clean_error_msg = err.message.replace(/[^\w\s]/gi, '');
    //  Create a log entry to say INSERT STATEMENT failed
    
    log_sql_command = "call datahub_logging.sp_etl_log_ingestion_process('UpdateEnd','" + process_name + "','Failed','MERGE Failed. Error:" + err.code.toString()+" : "+ clean_error_msg  + "', 0 ,0,0);";
    snowflake.execute({sqlText: log_sql_command});
        ;
        throw "Failed: " + err.message;   // Return a success/error indicator.
        }
    return result;
    $$;