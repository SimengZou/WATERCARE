create or replace procedure DATAHUB_INTEGRATION.SP_LN_TPPDM000()
    returns varchar not null
                language javascript
                as
                $$

//  Variables

var result = "";                                    // return status of this proc call
const process_name = Object.keys(this)[0];          // name of currently executing process
var number_of_rows_inserted = 0;                             // track number of rows we have inserted
var number_of_rows_updated = 0;                             // track number of rows we have updated


//  Step 1.

//  Start execution - log start

log_sql_command = "call datahub_logging.sp_etl_log_ingestion_process('Insert','" + process_name + "','Running','Started process execution.', 0,0,0);";
snowflake.execute({sqlText: log_sql_command});

snowflake.execute( {sqlText: "begin transaction;"} );
try
    {
        var sql_command = `
                            INSERT INTO LANDING_ERROR.LN_RAW_ERROR
                            SELECT * FROM LANDING_ERROR.VW_STREAM_LN_TPPDM000_ERROR`;
    var sqlStmt = snowflake.createStatement( {sqlText:  sql_command} );
    var rs = sqlStmt.execute();
        
        var sql_command = ` 
                            merge into  TARGET_LN.LN_TPPDM000 as target using (SELECT * FROM (SELECT 
            strm.achs, 
            strm.achs_kw, 
            strm.acus, 
            strm.acus_kw, 
            strm.bghi, 
            strm.bghi_kw, 
            strm.bgnw, 
            strm.bgnw_kw, 
            strm.cacc, 
            strm.cacc_kw, 
            strm.cact, 
            strm.cact_kw, 
            strm.cacu, 
            strm.cacu_kw, 
            strm.capp, 
            strm.capp_ref_compnr, 
            strm.ccpr, 
            strm.ccpr_kw, 
            strm.ccus, 
            strm.ccus_kw, 
            strm.cdf_acnl, 
            strm.cdf_acnl_kw, 
            strm.cdf_ocrl, 
            strm.cdf_ocrl_kw, 
            strm.cdf_scrl, 
            strm.cdf_scrl_kw, 
            strm.cgch, 
            strm.cgch_kw, 
            strm.citg, 
            strm.citg_ref_compnr, 
            strm.citt, 
            strm.citt_ref_compnr, 
            strm.compnr, 
            strm.cpac, 
            strm.cpac_kw, 
            strm.cprc, 
            strm.cprc_kw, 
            strm.cprt, 
            strm.cprt_kw, 
            strm.cpru, 
            strm.cpru_kw, 
            strm.cpsp, 
            strm.cpsp_kw, 
            strm.cpst, 
            strm.cpst_kw, 
            strm.crtp, 
            strm.crtp_ref_compnr, 
            strm.cspc, 
            strm.cspc_kw, 
            strm.cspt, 
            strm.cspt_kw, 
            strm.cspu, 
            strm.cspu_kw, 
            strm.cstc, 
            strm.cstc_kw, 
            strm.cstt, 
            strm.cstt_kw, 
            strm.cstu, 
            strm.cstu_kw, 
            strm.ctut, 
            strm.ctut_ref_compnr, 
            strm.deleted, 
            strm.dpca, 
            strm.dpca_ref_compnr, 
            strm.dpch, 
            strm.dpch_ref_compnr, 
            strm.dpci, 
            strm.dpci_ref_compnr, 
            strm.dsca, 
            strm.egrp, 
            strm.egrp_essr_ref_compnr, 
            strm.elhs, 
            strm.elhs_kw, 
            strm.elus, 
            strm.elus_kw, 
            strm.essr, 
            strm.ests, 
            strm.exus, 
            strm.exus_kw, 
            strm.frvt, 
            strm.indt, 
            strm.lccc, 
            strm.lccc_kw, 
            strm.lexp, 
            strm.lexp_kw, 
            strm.ngrp, 
            strm.ngrp_ests_ref_compnr, 
            strm.ngrp_prsr_ref_compnr, 
            strm.ngrp_ref_compnr, 
            strm.nlci, 
            strm.nleq, 
            strm.nlit, 
            strm.nlsb, 
            strm.nlta, 
            strm.ohac, 
            strm.ohac_kw, 
            strm.ohhc, 
            strm.ohhc_kw, 
            strm.ohim, 
            strm.ohim_kw, 
            strm.pcmp, 
            strm.pcmp_kw, 
            strm.pcsp, 
            strm.pcsp_kw, 
            strm.plmc, 
            strm.plmc_ref_compnr, 
            strm.plmi, 
            strm.plmi_kw, 
            strm.prbs, 
            strm.prbs_kw, 
            strm.prhs, 
            strm.prhs_kw, 
            strm.prsr, 
            strm.pwar, 
            strm.pwar_ref_compnr, 
            strm.rcap, 
            strm.rcap_ref_compnr, 
            strm.rcfe, 
            strm.rcfe_ref_compnr, 
            strm.rcpp, 
            strm.rcpp_ref_compnr, 
            strm.rcpt, 
            strm.rcpt_ref_compnr, 
            strm.rrtp, 
            strm.rrtp_ref_compnr, 
            strm.rscs, 
            strm.rtus, 
            strm.rtus_kw, 
            strm.rtyp, 
            strm.rtyp_ref_compnr, 
            strm.sequencenumber, 
            strm.serr, 
            strm.text, 
            strm.text_ref_compnr, 
            strm.tgrp, 
            strm.tgrp_ref_compnr, 
            strm.tgrp_tpsr_ref_compnr, 
            strm.timestamp, 
            strm.tpsr, 
            strm.tpte, 
            strm.tpte_ref_compnr, 
            strm.upra, 
            strm.upra_kw, 
            strm.username, 
            strm.uset, 
            strm.uset_ref_compnr, 
            strm.usev, 
            strm.usev_kw, 
            strm.uwka, 
            strm.uwka_kw, 
            strm.ETL_SEQUENCE_NUMBER,
            strm.ETL_DELETED,
            strm.etl_load_datetime,
            strm.etl_load_metadatafilename,
            ROW_NUMBER() OVER (PARTITION BY 
            strm.compnr,
            strm.indt ORDER BY strm.ETL_SEQUENCE_NUMBER desc,IFNULL(TRY_TO_TIMESTAMP(replace(right(replace(lower(etl_load_metadatafilename),'.json'),23),'_','-'), 'yyyy-mm-dd-HH-MI-SS-FF') ,etl_load_datetime) desc) as ROWNUMBER
        FROM DATAHUB_INTEGRATION.VW_STREAM_LN_TPPDM000 as  strm
                    )   
            WHERE ROWNUMBER=1  
            
                    ) as src on
            ((target.compnr=src.compnr) OR (target.compnr IS NULL AND src.compnr IS NULL)) AND
            ((target.indt=src.indt) OR (target.indt IS NULL AND src.indt IS NULL)) 
                when matched and src.ETL_DELETED=TRUE THEN DELETE
                when matched then update set
                    target.achs=src.achs, 
                    target.achs_kw=src.achs_kw, 
                    target.acus=src.acus, 
                    target.acus_kw=src.acus_kw, 
                    target.bghi=src.bghi, 
                    target.bghi_kw=src.bghi_kw, 
                    target.bgnw=src.bgnw, 
                    target.bgnw_kw=src.bgnw_kw, 
                    target.cacc=src.cacc, 
                    target.cacc_kw=src.cacc_kw, 
                    target.cact=src.cact, 
                    target.cact_kw=src.cact_kw, 
                    target.cacu=src.cacu, 
                    target.cacu_kw=src.cacu_kw, 
                    target.capp=src.capp, 
                    target.capp_ref_compnr=src.capp_ref_compnr, 
                    target.ccpr=src.ccpr, 
                    target.ccpr_kw=src.ccpr_kw, 
                    target.ccus=src.ccus, 
                    target.ccus_kw=src.ccus_kw, 
                    target.cdf_acnl=src.cdf_acnl, 
                    target.cdf_acnl_kw=src.cdf_acnl_kw, 
                    target.cdf_ocrl=src.cdf_ocrl, 
                    target.cdf_ocrl_kw=src.cdf_ocrl_kw, 
                    target.cdf_scrl=src.cdf_scrl, 
                    target.cdf_scrl_kw=src.cdf_scrl_kw, 
                    target.cgch=src.cgch, 
                    target.cgch_kw=src.cgch_kw, 
                    target.citg=src.citg, 
                    target.citg_ref_compnr=src.citg_ref_compnr, 
                    target.citt=src.citt, 
                    target.citt_ref_compnr=src.citt_ref_compnr, 
                    target.compnr=src.compnr, 
                    target.cpac=src.cpac, 
                    target.cpac_kw=src.cpac_kw, 
                    target.cprc=src.cprc, 
                    target.cprc_kw=src.cprc_kw, 
                    target.cprt=src.cprt, 
                    target.cprt_kw=src.cprt_kw, 
                    target.cpru=src.cpru, 
                    target.cpru_kw=src.cpru_kw, 
                    target.cpsp=src.cpsp, 
                    target.cpsp_kw=src.cpsp_kw, 
                    target.cpst=src.cpst, 
                    target.cpst_kw=src.cpst_kw, 
                    target.crtp=src.crtp, 
                    target.crtp_ref_compnr=src.crtp_ref_compnr, 
                    target.cspc=src.cspc, 
                    target.cspc_kw=src.cspc_kw, 
                    target.cspt=src.cspt, 
                    target.cspt_kw=src.cspt_kw, 
                    target.cspu=src.cspu, 
                    target.cspu_kw=src.cspu_kw, 
                    target.cstc=src.cstc, 
                    target.cstc_kw=src.cstc_kw, 
                    target.cstt=src.cstt, 
                    target.cstt_kw=src.cstt_kw, 
                    target.cstu=src.cstu, 
                    target.cstu_kw=src.cstu_kw, 
                    target.ctut=src.ctut, 
                    target.ctut_ref_compnr=src.ctut_ref_compnr, 
                    target.deleted=src.deleted, 
                    target.dpca=src.dpca, 
                    target.dpca_ref_compnr=src.dpca_ref_compnr, 
                    target.dpch=src.dpch, 
                    target.dpch_ref_compnr=src.dpch_ref_compnr, 
                    target.dpci=src.dpci, 
                    target.dpci_ref_compnr=src.dpci_ref_compnr, 
                    target.dsca=src.dsca, 
                    target.egrp=src.egrp, 
                    target.egrp_essr_ref_compnr=src.egrp_essr_ref_compnr, 
                    target.elhs=src.elhs, 
                    target.elhs_kw=src.elhs_kw, 
                    target.elus=src.elus, 
                    target.elus_kw=src.elus_kw, 
                    target.essr=src.essr, 
                    target.ests=src.ests, 
                    target.exus=src.exus, 
                    target.exus_kw=src.exus_kw, 
                    target.frvt=src.frvt, 
                    target.indt=src.indt, 
                    target.lccc=src.lccc, 
                    target.lccc_kw=src.lccc_kw, 
                    target.lexp=src.lexp, 
                    target.lexp_kw=src.lexp_kw, 
                    target.ngrp=src.ngrp, 
                    target.ngrp_ests_ref_compnr=src.ngrp_ests_ref_compnr, 
                    target.ngrp_prsr_ref_compnr=src.ngrp_prsr_ref_compnr, 
                    target.ngrp_ref_compnr=src.ngrp_ref_compnr, 
                    target.nlci=src.nlci, 
                    target.nleq=src.nleq, 
                    target.nlit=src.nlit, 
                    target.nlsb=src.nlsb, 
                    target.nlta=src.nlta, 
                    target.ohac=src.ohac, 
                    target.ohac_kw=src.ohac_kw, 
                    target.ohhc=src.ohhc, 
                    target.ohhc_kw=src.ohhc_kw, 
                    target.ohim=src.ohim, 
                    target.ohim_kw=src.ohim_kw, 
                    target.pcmp=src.pcmp, 
                    target.pcmp_kw=src.pcmp_kw, 
                    target.pcsp=src.pcsp, 
                    target.pcsp_kw=src.pcsp_kw, 
                    target.plmc=src.plmc, 
                    target.plmc_ref_compnr=src.plmc_ref_compnr, 
                    target.plmi=src.plmi, 
                    target.plmi_kw=src.plmi_kw, 
                    target.prbs=src.prbs, 
                    target.prbs_kw=src.prbs_kw, 
                    target.prhs=src.prhs, 
                    target.prhs_kw=src.prhs_kw, 
                    target.prsr=src.prsr, 
                    target.pwar=src.pwar, 
                    target.pwar_ref_compnr=src.pwar_ref_compnr, 
                    target.rcap=src.rcap, 
                    target.rcap_ref_compnr=src.rcap_ref_compnr, 
                    target.rcfe=src.rcfe, 
                    target.rcfe_ref_compnr=src.rcfe_ref_compnr, 
                    target.rcpp=src.rcpp, 
                    target.rcpp_ref_compnr=src.rcpp_ref_compnr, 
                    target.rcpt=src.rcpt, 
                    target.rcpt_ref_compnr=src.rcpt_ref_compnr, 
                    target.rrtp=src.rrtp, 
                    target.rrtp_ref_compnr=src.rrtp_ref_compnr, 
                    target.rscs=src.rscs, 
                    target.rtus=src.rtus, 
                    target.rtus_kw=src.rtus_kw, 
                    target.rtyp=src.rtyp, 
                    target.rtyp_ref_compnr=src.rtyp_ref_compnr, 
                    target.sequencenumber=src.sequencenumber, 
                    target.serr=src.serr, 
                    target.text=src.text, 
                    target.text_ref_compnr=src.text_ref_compnr, 
                    target.tgrp=src.tgrp, 
                    target.tgrp_ref_compnr=src.tgrp_ref_compnr, 
                    target.tgrp_tpsr_ref_compnr=src.tgrp_tpsr_ref_compnr, 
                    target.timestamp=src.timestamp, 
                    target.tpsr=src.tpsr, 
                    target.tpte=src.tpte, 
                    target.tpte_ref_compnr=src.tpte_ref_compnr, 
                    target.upra=src.upra, 
                    target.upra_kw=src.upra_kw, 
                    target.username=src.username, 
                    target.uset=src.uset, 
                    target.uset_ref_compnr=src.uset_ref_compnr, 
                    target.usev=src.usev, 
                    target.usev_kw=src.usev_kw, 
                    target.uwka=src.uwka, 
                    target.uwka_kw=src.uwka_kw, 
                    target.ETL_SEQUENCE_NUMBER=src.ETL_SEQUENCE_NUMBER,
                    target.etl_load_datetime=CURRENT_TIMESTAMP,
                    target.etl_load_metadatafilename=src.etl_load_metadatafilename
        when not matched and (src.ETL_DELETED=FALSE OR src.ETL_DELETED IS NULL)  then insert ( 
                    achs, 
                    achs_kw, 
                    acus, 
                    acus_kw, 
                    bghi, 
                    bghi_kw, 
                    bgnw, 
                    bgnw_kw, 
                    cacc, 
                    cacc_kw, 
                    cact, 
                    cact_kw, 
                    cacu, 
                    cacu_kw, 
                    capp, 
                    capp_ref_compnr, 
                    ccpr, 
                    ccpr_kw, 
                    ccus, 
                    ccus_kw, 
                    cdf_acnl, 
                    cdf_acnl_kw, 
                    cdf_ocrl, 
                    cdf_ocrl_kw, 
                    cdf_scrl, 
                    cdf_scrl_kw, 
                    cgch, 
                    cgch_kw, 
                    citg, 
                    citg_ref_compnr, 
                    citt, 
                    citt_ref_compnr, 
                    compnr, 
                    cpac, 
                    cpac_kw, 
                    cprc, 
                    cprc_kw, 
                    cprt, 
                    cprt_kw, 
                    cpru, 
                    cpru_kw, 
                    cpsp, 
                    cpsp_kw, 
                    cpst, 
                    cpst_kw, 
                    crtp, 
                    crtp_ref_compnr, 
                    cspc, 
                    cspc_kw, 
                    cspt, 
                    cspt_kw, 
                    cspu, 
                    cspu_kw, 
                    cstc, 
                    cstc_kw, 
                    cstt, 
                    cstt_kw, 
                    cstu, 
                    cstu_kw, 
                    ctut, 
                    ctut_ref_compnr, 
                    deleted, 
                    dpca, 
                    dpca_ref_compnr, 
                    dpch, 
                    dpch_ref_compnr, 
                    dpci, 
                    dpci_ref_compnr, 
                    dsca, 
                    egrp, 
                    egrp_essr_ref_compnr, 
                    elhs, 
                    elhs_kw, 
                    elus, 
                    elus_kw, 
                    essr, 
                    ests, 
                    exus, 
                    exus_kw, 
                    frvt, 
                    indt, 
                    lccc, 
                    lccc_kw, 
                    lexp, 
                    lexp_kw, 
                    ngrp, 
                    ngrp_ests_ref_compnr, 
                    ngrp_prsr_ref_compnr, 
                    ngrp_ref_compnr, 
                    nlci, 
                    nleq, 
                    nlit, 
                    nlsb, 
                    nlta, 
                    ohac, 
                    ohac_kw, 
                    ohhc, 
                    ohhc_kw, 
                    ohim, 
                    ohim_kw, 
                    pcmp, 
                    pcmp_kw, 
                    pcsp, 
                    pcsp_kw, 
                    plmc, 
                    plmc_ref_compnr, 
                    plmi, 
                    plmi_kw, 
                    prbs, 
                    prbs_kw, 
                    prhs, 
                    prhs_kw, 
                    prsr, 
                    pwar, 
                    pwar_ref_compnr, 
                    rcap, 
                    rcap_ref_compnr, 
                    rcfe, 
                    rcfe_ref_compnr, 
                    rcpp, 
                    rcpp_ref_compnr, 
                    rcpt, 
                    rcpt_ref_compnr, 
                    rrtp, 
                    rrtp_ref_compnr, 
                    rscs, 
                    rtus, 
                    rtus_kw, 
                    rtyp, 
                    rtyp_ref_compnr, 
                    sequencenumber, 
                    serr, 
                    text, 
                    text_ref_compnr, 
                    tgrp, 
                    tgrp_ref_compnr, 
                    tgrp_tpsr_ref_compnr, 
                    timestamp, 
                    tpsr, 
                    tpte, 
                    tpte_ref_compnr, 
                    upra, 
                    upra_kw, 
                    username, 
                    uset, 
                    uset_ref_compnr, 
                    usev, 
                    usev_kw, 
                    uwka, 
                    uwka_kw, 
                    ETL_SEQUENCE_NUMBER,                       
                    etl_load_datetime,
                    etl_load_metadatafilename) 
            values (
                    src.achs, 
                    src.achs_kw, 
                    src.acus, 
                    src.acus_kw, 
                    src.bghi, 
                    src.bghi_kw, 
                    src.bgnw, 
                    src.bgnw_kw, 
                    src.cacc, 
                    src.cacc_kw, 
                    src.cact, 
                    src.cact_kw, 
                    src.cacu, 
                    src.cacu_kw, 
                    src.capp, 
                    src.capp_ref_compnr, 
                    src.ccpr, 
                    src.ccpr_kw, 
                    src.ccus, 
                    src.ccus_kw, 
                    src.cdf_acnl, 
                    src.cdf_acnl_kw, 
                    src.cdf_ocrl, 
                    src.cdf_ocrl_kw, 
                    src.cdf_scrl, 
                    src.cdf_scrl_kw, 
                    src.cgch, 
                    src.cgch_kw, 
                    src.citg, 
                    src.citg_ref_compnr, 
                    src.citt, 
                    src.citt_ref_compnr, 
                    src.compnr, 
                    src.cpac, 
                    src.cpac_kw, 
                    src.cprc, 
                    src.cprc_kw, 
                    src.cprt, 
                    src.cprt_kw, 
                    src.cpru, 
                    src.cpru_kw, 
                    src.cpsp, 
                    src.cpsp_kw, 
                    src.cpst, 
                    src.cpst_kw, 
                    src.crtp, 
                    src.crtp_ref_compnr, 
                    src.cspc, 
                    src.cspc_kw, 
                    src.cspt, 
                    src.cspt_kw, 
                    src.cspu, 
                    src.cspu_kw, 
                    src.cstc, 
                    src.cstc_kw, 
                    src.cstt, 
                    src.cstt_kw, 
                    src.cstu, 
                    src.cstu_kw, 
                    src.ctut, 
                    src.ctut_ref_compnr, 
                    src.deleted, 
                    src.dpca, 
                    src.dpca_ref_compnr, 
                    src.dpch, 
                    src.dpch_ref_compnr, 
                    src.dpci, 
                    src.dpci_ref_compnr, 
                    src.dsca, 
                    src.egrp, 
                    src.egrp_essr_ref_compnr, 
                    src.elhs, 
                    src.elhs_kw, 
                    src.elus, 
                    src.elus_kw, 
                    src.essr, 
                    src.ests, 
                    src.exus, 
                    src.exus_kw, 
                    src.frvt, 
                    src.indt, 
                    src.lccc, 
                    src.lccc_kw, 
                    src.lexp, 
                    src.lexp_kw, 
                    src.ngrp, 
                    src.ngrp_ests_ref_compnr, 
                    src.ngrp_prsr_ref_compnr, 
                    src.ngrp_ref_compnr, 
                    src.nlci, 
                    src.nleq, 
                    src.nlit, 
                    src.nlsb, 
                    src.nlta, 
                    src.ohac, 
                    src.ohac_kw, 
                    src.ohhc, 
                    src.ohhc_kw, 
                    src.ohim, 
                    src.ohim_kw, 
                    src.pcmp, 
                    src.pcmp_kw, 
                    src.pcsp, 
                    src.pcsp_kw, 
                    src.plmc, 
                    src.plmc_ref_compnr, 
                    src.plmi, 
                    src.plmi_kw, 
                    src.prbs, 
                    src.prbs_kw, 
                    src.prhs, 
                    src.prhs_kw, 
                    src.prsr, 
                    src.pwar, 
                    src.pwar_ref_compnr, 
                    src.rcap, 
                    src.rcap_ref_compnr, 
                    src.rcfe, 
                    src.rcfe_ref_compnr, 
                    src.rcpp, 
                    src.rcpp_ref_compnr, 
                    src.rcpt, 
                    src.rcpt_ref_compnr, 
                    src.rrtp, 
                    src.rrtp_ref_compnr, 
                    src.rscs, 
                    src.rtus, 
                    src.rtus_kw, 
                    src.rtyp, 
                    src.rtyp_ref_compnr, 
                    src.sequencenumber, 
                    src.serr, 
                    src.text, 
                    src.text_ref_compnr, 
                    src.tgrp, 
                    src.tgrp_ref_compnr, 
                    src.tgrp_tpsr_ref_compnr, 
                    src.timestamp, 
                    src.tpsr, 
                    src.tpte, 
                    src.tpte_ref_compnr, 
                    src.upra, 
                    src.upra_kw, 
                    src.username, 
                    src.uset, 
                    src.uset_ref_compnr, 
                    src.usev, 
                    src.usev_kw, 
                    src.uwka, 
                    src.uwka_kw,     
                    src.ETL_SEQUENCE_NUMBER,
                    CURRENT_TIMESTAMP,
                    src.etl_load_metadatafilename);`;

    var sqlStmt = snowflake.createStatement( {sqlText:  sql_command} );
    var rs = sqlStmt.execute();

    snowflake.execute( {sqlText: `merge into TARGET_HISTORY_LN.LN_TPPDM000_DELETED as target using (
                SELECT * FROM (SELECT 
            strm.achs, 
            strm.achs_kw, 
            strm.acus, 
            strm.acus_kw, 
            strm.bghi, 
            strm.bghi_kw, 
            strm.bgnw, 
            strm.bgnw_kw, 
            strm.cacc, 
            strm.cacc_kw, 
            strm.cact, 
            strm.cact_kw, 
            strm.cacu, 
            strm.cacu_kw, 
            strm.capp, 
            strm.capp_ref_compnr, 
            strm.ccpr, 
            strm.ccpr_kw, 
            strm.ccus, 
            strm.ccus_kw, 
            strm.cdf_acnl, 
            strm.cdf_acnl_kw, 
            strm.cdf_ocrl, 
            strm.cdf_ocrl_kw, 
            strm.cdf_scrl, 
            strm.cdf_scrl_kw, 
            strm.cgch, 
            strm.cgch_kw, 
            strm.citg, 
            strm.citg_ref_compnr, 
            strm.citt, 
            strm.citt_ref_compnr, 
            strm.compnr, 
            strm.cpac, 
            strm.cpac_kw, 
            strm.cprc, 
            strm.cprc_kw, 
            strm.cprt, 
            strm.cprt_kw, 
            strm.cpru, 
            strm.cpru_kw, 
            strm.cpsp, 
            strm.cpsp_kw, 
            strm.cpst, 
            strm.cpst_kw, 
            strm.crtp, 
            strm.crtp_ref_compnr, 
            strm.cspc, 
            strm.cspc_kw, 
            strm.cspt, 
            strm.cspt_kw, 
            strm.cspu, 
            strm.cspu_kw, 
            strm.cstc, 
            strm.cstc_kw, 
            strm.cstt, 
            strm.cstt_kw, 
            strm.cstu, 
            strm.cstu_kw, 
            strm.ctut, 
            strm.ctut_ref_compnr, 
            strm.deleted, 
            strm.dpca, 
            strm.dpca_ref_compnr, 
            strm.dpch, 
            strm.dpch_ref_compnr, 
            strm.dpci, 
            strm.dpci_ref_compnr, 
            strm.dsca, 
            strm.egrp, 
            strm.egrp_essr_ref_compnr, 
            strm.elhs, 
            strm.elhs_kw, 
            strm.elus, 
            strm.elus_kw, 
            strm.essr, 
            strm.ests, 
            strm.exus, 
            strm.exus_kw, 
            strm.frvt, 
            strm.indt, 
            strm.lccc, 
            strm.lccc_kw, 
            strm.lexp, 
            strm.lexp_kw, 
            strm.ngrp, 
            strm.ngrp_ests_ref_compnr, 
            strm.ngrp_prsr_ref_compnr, 
            strm.ngrp_ref_compnr, 
            strm.nlci, 
            strm.nleq, 
            strm.nlit, 
            strm.nlsb, 
            strm.nlta, 
            strm.ohac, 
            strm.ohac_kw, 
            strm.ohhc, 
            strm.ohhc_kw, 
            strm.ohim, 
            strm.ohim_kw, 
            strm.pcmp, 
            strm.pcmp_kw, 
            strm.pcsp, 
            strm.pcsp_kw, 
            strm.plmc, 
            strm.plmc_ref_compnr, 
            strm.plmi, 
            strm.plmi_kw, 
            strm.prbs, 
            strm.prbs_kw, 
            strm.prhs, 
            strm.prhs_kw, 
            strm.prsr, 
            strm.pwar, 
            strm.pwar_ref_compnr, 
            strm.rcap, 
            strm.rcap_ref_compnr, 
            strm.rcfe, 
            strm.rcfe_ref_compnr, 
            strm.rcpp, 
            strm.rcpp_ref_compnr, 
            strm.rcpt, 
            strm.rcpt_ref_compnr, 
            strm.rrtp, 
            strm.rrtp_ref_compnr, 
            strm.rscs, 
            strm.rtus, 
            strm.rtus_kw, 
            strm.rtyp, 
            strm.rtyp_ref_compnr, 
            strm.sequencenumber, 
            strm.serr, 
            strm.text, 
            strm.text_ref_compnr, 
            strm.tgrp, 
            strm.tgrp_ref_compnr, 
            strm.tgrp_tpsr_ref_compnr, 
            strm.timestamp, 
            strm.tpsr, 
            strm.tpte, 
            strm.tpte_ref_compnr, 
            strm.upra, 
            strm.upra_kw, 
            strm.username, 
            strm.uset, 
            strm.uset_ref_compnr, 
            strm.usev, 
            strm.usev_kw, 
            strm.uwka, 
            strm.uwka_kw, 
            strm.ETL_SEQUENCE_NUMBER,
            strm.ETL_DELETED,
            strm.etl_load_datetime,
            strm.etl_load_metadatafilename,
            ROW_NUMBER() OVER (PARTITION BY 
            strm.compnr,
            strm.indt ORDER BY strm.ETL_SEQUENCE_NUMBER desc,IFNULL(TRY_TO_TIMESTAMP(replace(right(replace(lower(etl_load_metadatafilename),'.json'),23),'_','-'), 'yyyy-mm-dd-HH-MI-SS-FF') ,etl_load_datetime) desc) as ROWNUMBER
        FROM DATAHUB_INTEGRATION.VW_STREAM_LN_TPPDM000 as  strm
        WHERE strm.ETL_DELETED=TRUE
                    )   
            WHERE ROWNUMBER=1  
            
                    ) as src on
            ((target.compnr=src.compnr) OR (target.compnr IS NULL AND src.compnr IS NULL)) AND
            ((target.indt=src.indt) OR (target.indt IS NULL AND src.indt IS NULL)) 
                when matched then update set
                    target.achs=src.achs, 
                    target.achs_kw=src.achs_kw, 
                    target.acus=src.acus, 
                    target.acus_kw=src.acus_kw, 
                    target.bghi=src.bghi, 
                    target.bghi_kw=src.bghi_kw, 
                    target.bgnw=src.bgnw, 
                    target.bgnw_kw=src.bgnw_kw, 
                    target.cacc=src.cacc, 
                    target.cacc_kw=src.cacc_kw, 
                    target.cact=src.cact, 
                    target.cact_kw=src.cact_kw, 
                    target.cacu=src.cacu, 
                    target.cacu_kw=src.cacu_kw, 
                    target.capp=src.capp, 
                    target.capp_ref_compnr=src.capp_ref_compnr, 
                    target.ccpr=src.ccpr, 
                    target.ccpr_kw=src.ccpr_kw, 
                    target.ccus=src.ccus, 
                    target.ccus_kw=src.ccus_kw, 
                    target.cdf_acnl=src.cdf_acnl, 
                    target.cdf_acnl_kw=src.cdf_acnl_kw, 
                    target.cdf_ocrl=src.cdf_ocrl, 
                    target.cdf_ocrl_kw=src.cdf_ocrl_kw, 
                    target.cdf_scrl=src.cdf_scrl, 
                    target.cdf_scrl_kw=src.cdf_scrl_kw, 
                    target.cgch=src.cgch, 
                    target.cgch_kw=src.cgch_kw, 
                    target.citg=src.citg, 
                    target.citg_ref_compnr=src.citg_ref_compnr, 
                    target.citt=src.citt, 
                    target.citt_ref_compnr=src.citt_ref_compnr, 
                    target.compnr=src.compnr, 
                    target.cpac=src.cpac, 
                    target.cpac_kw=src.cpac_kw, 
                    target.cprc=src.cprc, 
                    target.cprc_kw=src.cprc_kw, 
                    target.cprt=src.cprt, 
                    target.cprt_kw=src.cprt_kw, 
                    target.cpru=src.cpru, 
                    target.cpru_kw=src.cpru_kw, 
                    target.cpsp=src.cpsp, 
                    target.cpsp_kw=src.cpsp_kw, 
                    target.cpst=src.cpst, 
                    target.cpst_kw=src.cpst_kw, 
                    target.crtp=src.crtp, 
                    target.crtp_ref_compnr=src.crtp_ref_compnr, 
                    target.cspc=src.cspc, 
                    target.cspc_kw=src.cspc_kw, 
                    target.cspt=src.cspt, 
                    target.cspt_kw=src.cspt_kw, 
                    target.cspu=src.cspu, 
                    target.cspu_kw=src.cspu_kw, 
                    target.cstc=src.cstc, 
                    target.cstc_kw=src.cstc_kw, 
                    target.cstt=src.cstt, 
                    target.cstt_kw=src.cstt_kw, 
                    target.cstu=src.cstu, 
                    target.cstu_kw=src.cstu_kw, 
                    target.ctut=src.ctut, 
                    target.ctut_ref_compnr=src.ctut_ref_compnr, 
                    target.deleted=src.deleted, 
                    target.dpca=src.dpca, 
                    target.dpca_ref_compnr=src.dpca_ref_compnr, 
                    target.dpch=src.dpch, 
                    target.dpch_ref_compnr=src.dpch_ref_compnr, 
                    target.dpci=src.dpci, 
                    target.dpci_ref_compnr=src.dpci_ref_compnr, 
                    target.dsca=src.dsca, 
                    target.egrp=src.egrp, 
                    target.egrp_essr_ref_compnr=src.egrp_essr_ref_compnr, 
                    target.elhs=src.elhs, 
                    target.elhs_kw=src.elhs_kw, 
                    target.elus=src.elus, 
                    target.elus_kw=src.elus_kw, 
                    target.essr=src.essr, 
                    target.ests=src.ests, 
                    target.exus=src.exus, 
                    target.exus_kw=src.exus_kw, 
                    target.frvt=src.frvt, 
                    target.indt=src.indt, 
                    target.lccc=src.lccc, 
                    target.lccc_kw=src.lccc_kw, 
                    target.lexp=src.lexp, 
                    target.lexp_kw=src.lexp_kw, 
                    target.ngrp=src.ngrp, 
                    target.ngrp_ests_ref_compnr=src.ngrp_ests_ref_compnr, 
                    target.ngrp_prsr_ref_compnr=src.ngrp_prsr_ref_compnr, 
                    target.ngrp_ref_compnr=src.ngrp_ref_compnr, 
                    target.nlci=src.nlci, 
                    target.nleq=src.nleq, 
                    target.nlit=src.nlit, 
                    target.nlsb=src.nlsb, 
                    target.nlta=src.nlta, 
                    target.ohac=src.ohac, 
                    target.ohac_kw=src.ohac_kw, 
                    target.ohhc=src.ohhc, 
                    target.ohhc_kw=src.ohhc_kw, 
                    target.ohim=src.ohim, 
                    target.ohim_kw=src.ohim_kw, 
                    target.pcmp=src.pcmp, 
                    target.pcmp_kw=src.pcmp_kw, 
                    target.pcsp=src.pcsp, 
                    target.pcsp_kw=src.pcsp_kw, 
                    target.plmc=src.plmc, 
                    target.plmc_ref_compnr=src.plmc_ref_compnr, 
                    target.plmi=src.plmi, 
                    target.plmi_kw=src.plmi_kw, 
                    target.prbs=src.prbs, 
                    target.prbs_kw=src.prbs_kw, 
                    target.prhs=src.prhs, 
                    target.prhs_kw=src.prhs_kw, 
                    target.prsr=src.prsr, 
                    target.pwar=src.pwar, 
                    target.pwar_ref_compnr=src.pwar_ref_compnr, 
                    target.rcap=src.rcap, 
                    target.rcap_ref_compnr=src.rcap_ref_compnr, 
                    target.rcfe=src.rcfe, 
                    target.rcfe_ref_compnr=src.rcfe_ref_compnr, 
                    target.rcpp=src.rcpp, 
                    target.rcpp_ref_compnr=src.rcpp_ref_compnr, 
                    target.rcpt=src.rcpt, 
                    target.rcpt_ref_compnr=src.rcpt_ref_compnr, 
                    target.rrtp=src.rrtp, 
                    target.rrtp_ref_compnr=src.rrtp_ref_compnr, 
                    target.rscs=src.rscs, 
                    target.rtus=src.rtus, 
                    target.rtus_kw=src.rtus_kw, 
                    target.rtyp=src.rtyp, 
                    target.rtyp_ref_compnr=src.rtyp_ref_compnr, 
                    target.sequencenumber=src.sequencenumber, 
                    target.serr=src.serr, 
                    target.text=src.text, 
                    target.text_ref_compnr=src.text_ref_compnr, 
                    target.tgrp=src.tgrp, 
                    target.tgrp_ref_compnr=src.tgrp_ref_compnr, 
                    target.tgrp_tpsr_ref_compnr=src.tgrp_tpsr_ref_compnr, 
                    target.timestamp=src.timestamp, 
                    target.tpsr=src.tpsr, 
                    target.tpte=src.tpte, 
                    target.tpte_ref_compnr=src.tpte_ref_compnr, 
                    target.upra=src.upra, 
                    target.upra_kw=src.upra_kw, 
                    target.username=src.username, 
                    target.uset=src.uset, 
                    target.uset_ref_compnr=src.uset_ref_compnr, 
                    target.usev=src.usev, 
                    target.usev_kw=src.usev_kw, 
                    target.uwka=src.uwka, 
                    target.uwka_kw=src.uwka_kw, 
                    target.ETL_SEQUENCE_NUMBER=src.ETL_SEQUENCE_NUMBER,
                    target.etl_load_datetime=CURRENT_TIMESTAMP,
                    target.etl_load_metadatafilename=src.etl_load_metadatafilename,
                    target.ETL_DELETED=src.ETL_DELETED
        when not matched   then insert ( achs, achs_kw, acus, acus_kw, bghi, bghi_kw, bgnw, bgnw_kw, cacc, cacc_kw, cact, cact_kw, cacu, cacu_kw, capp, capp_ref_compnr, ccpr, ccpr_kw, ccus, ccus_kw, cdf_acnl, cdf_acnl_kw, cdf_ocrl, cdf_ocrl_kw, cdf_scrl, cdf_scrl_kw, cgch, cgch_kw, citg, citg_ref_compnr, citt, citt_ref_compnr, compnr, cpac, cpac_kw, cprc, cprc_kw, cprt, cprt_kw, cpru, cpru_kw, cpsp, cpsp_kw, cpst, cpst_kw, crtp, crtp_ref_compnr, cspc, cspc_kw, cspt, cspt_kw, cspu, cspu_kw, cstc, cstc_kw, cstt, cstt_kw, cstu, cstu_kw, ctut, ctut_ref_compnr, deleted, dpca, dpca_ref_compnr, dpch, dpch_ref_compnr, dpci, dpci_ref_compnr, dsca, egrp, egrp_essr_ref_compnr, elhs, elhs_kw, elus, elus_kw, essr, ests, exus, exus_kw, frvt, indt, lccc, lccc_kw, lexp, lexp_kw, ngrp, ngrp_ests_ref_compnr, ngrp_prsr_ref_compnr, ngrp_ref_compnr, nlci, nleq, nlit, nlsb, nlta, ohac, ohac_kw, ohhc, ohhc_kw, ohim, ohim_kw, pcmp, pcmp_kw, pcsp, pcsp_kw, plmc, plmc_ref_compnr, plmi, plmi_kw, prbs, prbs_kw, prhs, prhs_kw, prsr, pwar, pwar_ref_compnr, rcap, rcap_ref_compnr, rcfe, rcfe_ref_compnr, rcpp, rcpp_ref_compnr, rcpt, rcpt_ref_compnr, rrtp, rrtp_ref_compnr, rscs, rtus, rtus_kw, rtyp, rtyp_ref_compnr, sequencenumber, serr, text, text_ref_compnr, tgrp, tgrp_ref_compnr, tgrp_tpsr_ref_compnr, timestamp, tpsr, tpte, tpte_ref_compnr, upra, upra_kw, username, uset, uset_ref_compnr, usev, usev_kw, uwka, uwka_kw, 
                    ETL_SEQUENCE_NUMBER,                       
                    etl_load_datetime,
                    etl_load_metadatafilename,
                    etl_is_deleted,
                    ETL_DELETED) 
            values (
                    src.achs, 
                    src.achs_kw, 
                    src.acus, 
                    src.acus_kw, 
                    src.bghi, 
                    src.bghi_kw, 
                    src.bgnw, 
                    src.bgnw_kw, 
                    src.cacc, 
                    src.cacc_kw, 
                    src.cact, 
                    src.cact_kw, 
                    src.cacu, 
                    src.cacu_kw, 
                    src.capp, 
                    src.capp_ref_compnr, 
                    src.ccpr, 
                    src.ccpr_kw, 
                    src.ccus, 
                    src.ccus_kw, 
                    src.cdf_acnl, 
                    src.cdf_acnl_kw, 
                    src.cdf_ocrl, 
                    src.cdf_ocrl_kw, 
                    src.cdf_scrl, 
                    src.cdf_scrl_kw, 
                    src.cgch, 
                    src.cgch_kw, 
                    src.citg, 
                    src.citg_ref_compnr, 
                    src.citt, 
                    src.citt_ref_compnr, 
                    src.compnr, 
                    src.cpac, 
                    src.cpac_kw, 
                    src.cprc, 
                    src.cprc_kw, 
                    src.cprt, 
                    src.cprt_kw, 
                    src.cpru, 
                    src.cpru_kw, 
                    src.cpsp, 
                    src.cpsp_kw, 
                    src.cpst, 
                    src.cpst_kw, 
                    src.crtp, 
                    src.crtp_ref_compnr, 
                    src.cspc, 
                    src.cspc_kw, 
                    src.cspt, 
                    src.cspt_kw, 
                    src.cspu, 
                    src.cspu_kw, 
                    src.cstc, 
                    src.cstc_kw, 
                    src.cstt, 
                    src.cstt_kw, 
                    src.cstu, 
                    src.cstu_kw, 
                    src.ctut, 
                    src.ctut_ref_compnr, 
                    src.deleted, 
                    src.dpca, 
                    src.dpca_ref_compnr, 
                    src.dpch, 
                    src.dpch_ref_compnr, 
                    src.dpci, 
                    src.dpci_ref_compnr, 
                    src.dsca, 
                    src.egrp, 
                    src.egrp_essr_ref_compnr, 
                    src.elhs, 
                    src.elhs_kw, 
                    src.elus, 
                    src.elus_kw, 
                    src.essr, 
                    src.ests, 
                    src.exus, 
                    src.exus_kw, 
                    src.frvt, 
                    src.indt, 
                    src.lccc, 
                    src.lccc_kw, 
                    src.lexp, 
                    src.lexp_kw, 
                    src.ngrp, 
                    src.ngrp_ests_ref_compnr, 
                    src.ngrp_prsr_ref_compnr, 
                    src.ngrp_ref_compnr, 
                    src.nlci, 
                    src.nleq, 
                    src.nlit, 
                    src.nlsb, 
                    src.nlta, 
                    src.ohac, 
                    src.ohac_kw, 
                    src.ohhc, 
                    src.ohhc_kw, 
                    src.ohim, 
                    src.ohim_kw, 
                    src.pcmp, 
                    src.pcmp_kw, 
                    src.pcsp, 
                    src.pcsp_kw, 
                    src.plmc, 
                    src.plmc_ref_compnr, 
                    src.plmi, 
                    src.plmi_kw, 
                    src.prbs, 
                    src.prbs_kw, 
                    src.prhs, 
                    src.prhs_kw, 
                    src.prsr, 
                    src.pwar, 
                    src.pwar_ref_compnr, 
                    src.rcap, 
                    src.rcap_ref_compnr, 
                    src.rcfe, 
                    src.rcfe_ref_compnr, 
                    src.rcpp, 
                    src.rcpp_ref_compnr, 
                    src.rcpt, 
                    src.rcpt_ref_compnr, 
                    src.rrtp, 
                    src.rrtp_ref_compnr, 
                    src.rscs, 
                    src.rtus, 
                    src.rtus_kw, 
                    src.rtyp, 
                    src.rtyp_ref_compnr, 
                    src.sequencenumber, 
                    src.serr, 
                    src.text, 
                    src.text_ref_compnr, 
                    src.tgrp, 
                    src.tgrp_ref_compnr, 
                    src.tgrp_tpsr_ref_compnr, 
                    src.timestamp, 
                    src.tpsr, 
                    src.tpte, 
                    src.tpte_ref_compnr, 
                    src.upra, 
                    src.upra_kw, 
                    src.username, 
                    src.uset, 
                    src.uset_ref_compnr, 
                    src.usev, 
                    src.usev_kw, 
                    src.uwka, 
                    src.uwka_kw,     
                    src.ETL_SEQUENCE_NUMBER,
                    CURRENT_TIMESTAMP,
                    src.etl_load_metadatafilename,
                    case when ETL_DELETED=TRUE then TRUE else FALSE end,
                    ETL_DELETED);
    `
} );

                    
//  Get number of rows inserted
        
        var sqlStmt = snowflake.createStatement( {sqlText:  sql_command} );
        var rs = sqlStmt.execute();
        var number_of_rows_inserted = sqlStmt.getNumRowsInserted();
        var number_of_rows_updated =  sqlStmt.getNumRowsUpdated();
                    

        
    snowflake.execute ({sqlText: "commit"});

    log_sql_command = "call datahub_logging.sp_etl_log_ingestion_process('UpdateEnd','" + process_name + "','Success','Completed process execution.', 0 ," + number_of_rows_inserted.toString()+ "," +  number_of_rows_updated.toString() + ");";
    snowflake.execute({sqlText: log_sql_command});

    result = "Success"; 

    }       

    catch (err)  {
        snowflake.execute( {sqlText: "rollback;"} )
        var clean_error_msg = err.message.replace(/[^\w\s]/gi, '');
    //  Create a log entry to say INSERT STATEMENT failed
    
    log_sql_command = "call datahub_logging.sp_etl_log_ingestion_process('UpdateEnd','" + process_name + "','Failed','MERGE Failed. Error:" + err.code.toString()+" : "+ clean_error_msg  + "', 0 ,0,0);";
    snowflake.execute({sqlText: log_sql_command});
        ;
        throw "Failed: " + err.message;   // Return a success/error indicator.
        }
    return result;
    $$;