create or replace procedure DATAHUB_INTEGRATION.SP_LN_TPPTC050()
    returns varchar not null
                language javascript
                as
                $$

//  Variables

var result = "";                                    // return status of this proc call
const process_name = Object.keys(this)[0];          // name of currently executing process
var number_of_rows_inserted = 0;                             // track number of rows we have inserted
var number_of_rows_updated = 0;                             // track number of rows we have updated


//  Step 1.

//  Start execution - log start

log_sql_command = "call datahub_logging.sp_etl_log_ingestion_process('Insert','" + process_name + "','Running','Started process execution.', 0,0,0);";
snowflake.execute({sqlText: log_sql_command});

snowflake.execute( {sqlText: "begin transaction;"} );
try
    {
        var sql_command = `
                            INSERT INTO LANDING_ERROR.LN_RAW_ERROR
                            SELECT * FROM LANDING_ERROR.VW_STREAM_LN_TPPTC050_ERROR`;
    var sqlStmt = snowflake.createStatement( {sqlText:  sql_command} );
    var rs = sqlStmt.execute();
        
        var sql_command = ` 
                            merge into  TARGET_LN.LN_TPPTC050 as target using (SELECT * FROM (SELECT 
            strm.acgm, 
            strm.acgm_kw, 
            strm.aerf, 
            strm.aprp, 
            strm.arpc, 
            strm.arrl, 
            strm.arrm, 
            strm.arrm_kw, 
            strm.arrt, 
            strm.ascd, 
            strm.cadc, 
            strm.cadc_ref_compnr, 
            strm.cbrn, 
            strm.cbrn_ref_compnr, 
            strm.ccam, 
            strm.ccam_ref_compnr, 
            strm.ccat, 
            strm.ccat_ref_compnr, 
            strm.ceil, 
            strm.ceil_kw, 
            strm.cfac, 
            strm.cfac_ref_compnr, 
            strm.chic, 
            strm.chic_kw, 
            strm.codt, 
            strm.cogs, 
            strm.cogs_kw, 
            strm.compnr, 
            strm.copr, 
            strm.copr_cntc, 
            strm.copr_dwhc, 
            strm.copr_homc, 
            strm.copr_prjc, 
            strm.copr_refc, 
            strm.copr_rpc1, 
            strm.copr_rpc2, 
            strm.cpcu, 
            strm.cpcu_ref_compnr, 
            strm.cprj, 
            strm.cprj_ref_compnr, 
            strm.creg, 
            strm.creg_ref_compnr, 
            strm.cres, 
            strm.cres_ref_compnr, 
            strm.csec, 
            strm.csec_ref_compnr, 
            strm.csst, 
            strm.csst_kw, 
            strm.cstg, 
            strm.cstg_ref_compnr, 
            strm.cstl, 
            strm.cstv, 
            strm.cuvc, 
            strm.cuvc_ref_compnr, 
            strm.deleted, 
            strm.desc, 
            strm.earf, 
            strm.emno, 
            strm.emno_ref_compnr, 
            strm.esam, 
            strm.esam_cntc, 
            strm.esam_dwhc, 
            strm.esam_homc, 
            strm.esam_prjc, 
            strm.esam_refc, 
            strm.esam_rpc1, 
            strm.esam_rpc2, 
            strm.escu, 
            strm.escu_ref_compnr, 
            strm.excc, 
            strm.excc_kw, 
            strm.fcmp, 
            strm.fidt, 
            strm.hbnr, 
            strm.hbyn, 
            strm.hbyn_kw, 
            strm.idoc, 
            strm.ityp, 
            strm.ivam, 
            strm.ivam_cntc, 
            strm.ivam_dwhc, 
            strm.ivam_homc, 
            strm.ivam_prjc, 
            strm.ivam_refc, 
            strm.ivam_rpc1, 
            strm.ivam_rpc2, 
            strm.lpsl, 
            strm.lpsl_kw, 
            strm.njsp, 
            strm.ofbp, 
            strm.ofbp_ref_compnr, 
            strm.pacu, 
            strm.pacu_ref_compnr, 
            strm.pcmp, 
            strm.prpc, 
            strm.prva, 
            strm.prva_cntc, 
            strm.prva_dwhc, 
            strm.prva_homc, 
            strm.prva_prjc, 
            strm.prva_refc, 
            strm.prva_rpc1, 
            strm.prva_rpc2, 
            strm.pscd, 
            strm.rdap, 
            strm.rdat, 
            strm.revl, 
            strm.revr, 
            strm.revr_kw, 
            strm.revt, 
            strm.rtcc_1, 
            strm.rtcc_2, 
            strm.rtcc_3, 
            strm.rtcp_1, 
            strm.rtcp_2, 
            strm.rtcp_3, 
            strm.rtfc_1, 
            strm.rtfc_2, 
            strm.rtfc_3, 
            strm.rtfp_1, 
            strm.rtfp_2, 
            strm.rtfp_3, 
            strm.sadr, 
            strm.sadr_ref_compnr, 
            strm.seak, 
            strm.sequencenumber, 
            strm.stdt, 
            strm.stlm, 
            strm.stlm_kw, 
            strm.stls, 
            strm.stls_kw, 
            strm.stlt, 
            strm.stlt_kw, 
            strm.styp, 
            strm.styp_ref_compnr, 
            strm.timestamp, 
            strm.trsl, 
            strm.trsl_kw, 
            strm.txta, 
            strm.txta_ref_compnr, 
            strm.username, 
            strm.ETL_SEQUENCE_NUMBER,
            strm.ETL_DELETED,
            strm.etl_load_datetime,
            strm.etl_load_metadatafilename,
            ROW_NUMBER() OVER (PARTITION BY 
            strm.compnr,
            strm.cprj,
            strm.cstl ORDER BY strm.ETL_SEQUENCE_NUMBER desc,IFNULL(TRY_TO_TIMESTAMP(replace(right(replace(lower(etl_load_metadatafilename),'.json'),23),'_','-'), 'yyyy-mm-dd-HH-MI-SS-FF') ,etl_load_datetime) desc) as ROWNUMBER
        FROM DATAHUB_INTEGRATION.VW_STREAM_LN_TPPTC050 as  strm
                    )   
            WHERE ROWNUMBER=1  
            
                    ) as src on
            ((target.compnr=src.compnr) OR (target.compnr IS NULL AND src.compnr IS NULL)) AND
            ((target.cprj=src.cprj) OR (target.cprj IS NULL AND src.cprj IS NULL)) AND
            ((target.cstl=src.cstl) OR (target.cstl IS NULL AND src.cstl IS NULL)) 
                when matched and src.ETL_DELETED=TRUE THEN DELETE
                when matched then update set
                    target.acgm=src.acgm, 
                    target.acgm_kw=src.acgm_kw, 
                    target.aerf=src.aerf, 
                    target.aprp=src.aprp, 
                    target.arpc=src.arpc, 
                    target.arrl=src.arrl, 
                    target.arrm=src.arrm, 
                    target.arrm_kw=src.arrm_kw, 
                    target.arrt=src.arrt, 
                    target.ascd=src.ascd, 
                    target.cadc=src.cadc, 
                    target.cadc_ref_compnr=src.cadc_ref_compnr, 
                    target.cbrn=src.cbrn, 
                    target.cbrn_ref_compnr=src.cbrn_ref_compnr, 
                    target.ccam=src.ccam, 
                    target.ccam_ref_compnr=src.ccam_ref_compnr, 
                    target.ccat=src.ccat, 
                    target.ccat_ref_compnr=src.ccat_ref_compnr, 
                    target.ceil=src.ceil, 
                    target.ceil_kw=src.ceil_kw, 
                    target.cfac=src.cfac, 
                    target.cfac_ref_compnr=src.cfac_ref_compnr, 
                    target.chic=src.chic, 
                    target.chic_kw=src.chic_kw, 
                    target.codt=src.codt, 
                    target.cogs=src.cogs, 
                    target.cogs_kw=src.cogs_kw, 
                    target.compnr=src.compnr, 
                    target.copr=src.copr, 
                    target.copr_cntc=src.copr_cntc, 
                    target.copr_dwhc=src.copr_dwhc, 
                    target.copr_homc=src.copr_homc, 
                    target.copr_prjc=src.copr_prjc, 
                    target.copr_refc=src.copr_refc, 
                    target.copr_rpc1=src.copr_rpc1, 
                    target.copr_rpc2=src.copr_rpc2, 
                    target.cpcu=src.cpcu, 
                    target.cpcu_ref_compnr=src.cpcu_ref_compnr, 
                    target.cprj=src.cprj, 
                    target.cprj_ref_compnr=src.cprj_ref_compnr, 
                    target.creg=src.creg, 
                    target.creg_ref_compnr=src.creg_ref_compnr, 
                    target.cres=src.cres, 
                    target.cres_ref_compnr=src.cres_ref_compnr, 
                    target.csec=src.csec, 
                    target.csec_ref_compnr=src.csec_ref_compnr, 
                    target.csst=src.csst, 
                    target.csst_kw=src.csst_kw, 
                    target.cstg=src.cstg, 
                    target.cstg_ref_compnr=src.cstg_ref_compnr, 
                    target.cstl=src.cstl, 
                    target.cstv=src.cstv, 
                    target.cuvc=src.cuvc, 
                    target.cuvc_ref_compnr=src.cuvc_ref_compnr, 
                    target.deleted=src.deleted, 
                    target.desc=src.desc, 
                    target.earf=src.earf, 
                    target.emno=src.emno, 
                    target.emno_ref_compnr=src.emno_ref_compnr, 
                    target.esam=src.esam, 
                    target.esam_cntc=src.esam_cntc, 
                    target.esam_dwhc=src.esam_dwhc, 
                    target.esam_homc=src.esam_homc, 
                    target.esam_prjc=src.esam_prjc, 
                    target.esam_refc=src.esam_refc, 
                    target.esam_rpc1=src.esam_rpc1, 
                    target.esam_rpc2=src.esam_rpc2, 
                    target.escu=src.escu, 
                    target.escu_ref_compnr=src.escu_ref_compnr, 
                    target.excc=src.excc, 
                    target.excc_kw=src.excc_kw, 
                    target.fcmp=src.fcmp, 
                    target.fidt=src.fidt, 
                    target.hbnr=src.hbnr, 
                    target.hbyn=src.hbyn, 
                    target.hbyn_kw=src.hbyn_kw, 
                    target.idoc=src.idoc, 
                    target.ityp=src.ityp, 
                    target.ivam=src.ivam, 
                    target.ivam_cntc=src.ivam_cntc, 
                    target.ivam_dwhc=src.ivam_dwhc, 
                    target.ivam_homc=src.ivam_homc, 
                    target.ivam_prjc=src.ivam_prjc, 
                    target.ivam_refc=src.ivam_refc, 
                    target.ivam_rpc1=src.ivam_rpc1, 
                    target.ivam_rpc2=src.ivam_rpc2, 
                    target.lpsl=src.lpsl, 
                    target.lpsl_kw=src.lpsl_kw, 
                    target.njsp=src.njsp, 
                    target.ofbp=src.ofbp, 
                    target.ofbp_ref_compnr=src.ofbp_ref_compnr, 
                    target.pacu=src.pacu, 
                    target.pacu_ref_compnr=src.pacu_ref_compnr, 
                    target.pcmp=src.pcmp, 
                    target.prpc=src.prpc, 
                    target.prva=src.prva, 
                    target.prva_cntc=src.prva_cntc, 
                    target.prva_dwhc=src.prva_dwhc, 
                    target.prva_homc=src.prva_homc, 
                    target.prva_prjc=src.prva_prjc, 
                    target.prva_refc=src.prva_refc, 
                    target.prva_rpc1=src.prva_rpc1, 
                    target.prva_rpc2=src.prva_rpc2, 
                    target.pscd=src.pscd, 
                    target.rdap=src.rdap, 
                    target.rdat=src.rdat, 
                    target.revl=src.revl, 
                    target.revr=src.revr, 
                    target.revr_kw=src.revr_kw, 
                    target.revt=src.revt, 
                    target.rtcc_1=src.rtcc_1, 
                    target.rtcc_2=src.rtcc_2, 
                    target.rtcc_3=src.rtcc_3, 
                    target.rtcp_1=src.rtcp_1, 
                    target.rtcp_2=src.rtcp_2, 
                    target.rtcp_3=src.rtcp_3, 
                    target.rtfc_1=src.rtfc_1, 
                    target.rtfc_2=src.rtfc_2, 
                    target.rtfc_3=src.rtfc_3, 
                    target.rtfp_1=src.rtfp_1, 
                    target.rtfp_2=src.rtfp_2, 
                    target.rtfp_3=src.rtfp_3, 
                    target.sadr=src.sadr, 
                    target.sadr_ref_compnr=src.sadr_ref_compnr, 
                    target.seak=src.seak, 
                    target.sequencenumber=src.sequencenumber, 
                    target.stdt=src.stdt, 
                    target.stlm=src.stlm, 
                    target.stlm_kw=src.stlm_kw, 
                    target.stls=src.stls, 
                    target.stls_kw=src.stls_kw, 
                    target.stlt=src.stlt, 
                    target.stlt_kw=src.stlt_kw, 
                    target.styp=src.styp, 
                    target.styp_ref_compnr=src.styp_ref_compnr, 
                    target.timestamp=src.timestamp, 
                    target.trsl=src.trsl, 
                    target.trsl_kw=src.trsl_kw, 
                    target.txta=src.txta, 
                    target.txta_ref_compnr=src.txta_ref_compnr, 
                    target.username=src.username, 
                    target.ETL_SEQUENCE_NUMBER=src.ETL_SEQUENCE_NUMBER,
                    target.etl_load_datetime=CURRENT_TIMESTAMP,
                    target.etl_load_metadatafilename=src.etl_load_metadatafilename
        when not matched and (src.ETL_DELETED=FALSE OR src.ETL_DELETED IS NULL)  then insert ( 
                    acgm, 
                    acgm_kw, 
                    aerf, 
                    aprp, 
                    arpc, 
                    arrl, 
                    arrm, 
                    arrm_kw, 
                    arrt, 
                    ascd, 
                    cadc, 
                    cadc_ref_compnr, 
                    cbrn, 
                    cbrn_ref_compnr, 
                    ccam, 
                    ccam_ref_compnr, 
                    ccat, 
                    ccat_ref_compnr, 
                    ceil, 
                    ceil_kw, 
                    cfac, 
                    cfac_ref_compnr, 
                    chic, 
                    chic_kw, 
                    codt, 
                    cogs, 
                    cogs_kw, 
                    compnr, 
                    copr, 
                    copr_cntc, 
                    copr_dwhc, 
                    copr_homc, 
                    copr_prjc, 
                    copr_refc, 
                    copr_rpc1, 
                    copr_rpc2, 
                    cpcu, 
                    cpcu_ref_compnr, 
                    cprj, 
                    cprj_ref_compnr, 
                    creg, 
                    creg_ref_compnr, 
                    cres, 
                    cres_ref_compnr, 
                    csec, 
                    csec_ref_compnr, 
                    csst, 
                    csst_kw, 
                    cstg, 
                    cstg_ref_compnr, 
                    cstl, 
                    cstv, 
                    cuvc, 
                    cuvc_ref_compnr, 
                    deleted, 
                    desc, 
                    earf, 
                    emno, 
                    emno_ref_compnr, 
                    esam, 
                    esam_cntc, 
                    esam_dwhc, 
                    esam_homc, 
                    esam_prjc, 
                    esam_refc, 
                    esam_rpc1, 
                    esam_rpc2, 
                    escu, 
                    escu_ref_compnr, 
                    excc, 
                    excc_kw, 
                    fcmp, 
                    fidt, 
                    hbnr, 
                    hbyn, 
                    hbyn_kw, 
                    idoc, 
                    ityp, 
                    ivam, 
                    ivam_cntc, 
                    ivam_dwhc, 
                    ivam_homc, 
                    ivam_prjc, 
                    ivam_refc, 
                    ivam_rpc1, 
                    ivam_rpc2, 
                    lpsl, 
                    lpsl_kw, 
                    njsp, 
                    ofbp, 
                    ofbp_ref_compnr, 
                    pacu, 
                    pacu_ref_compnr, 
                    pcmp, 
                    prpc, 
                    prva, 
                    prva_cntc, 
                    prva_dwhc, 
                    prva_homc, 
                    prva_prjc, 
                    prva_refc, 
                    prva_rpc1, 
                    prva_rpc2, 
                    pscd, 
                    rdap, 
                    rdat, 
                    revl, 
                    revr, 
                    revr_kw, 
                    revt, 
                    rtcc_1, 
                    rtcc_2, 
                    rtcc_3, 
                    rtcp_1, 
                    rtcp_2, 
                    rtcp_3, 
                    rtfc_1, 
                    rtfc_2, 
                    rtfc_3, 
                    rtfp_1, 
                    rtfp_2, 
                    rtfp_3, 
                    sadr, 
                    sadr_ref_compnr, 
                    seak, 
                    sequencenumber, 
                    stdt, 
                    stlm, 
                    stlm_kw, 
                    stls, 
                    stls_kw, 
                    stlt, 
                    stlt_kw, 
                    styp, 
                    styp_ref_compnr, 
                    timestamp, 
                    trsl, 
                    trsl_kw, 
                    txta, 
                    txta_ref_compnr, 
                    username, 
                    ETL_SEQUENCE_NUMBER,                       
                    etl_load_datetime,
                    etl_load_metadatafilename) 
            values (
                    src.acgm, 
                    src.acgm_kw, 
                    src.aerf, 
                    src.aprp, 
                    src.arpc, 
                    src.arrl, 
                    src.arrm, 
                    src.arrm_kw, 
                    src.arrt, 
                    src.ascd, 
                    src.cadc, 
                    src.cadc_ref_compnr, 
                    src.cbrn, 
                    src.cbrn_ref_compnr, 
                    src.ccam, 
                    src.ccam_ref_compnr, 
                    src.ccat, 
                    src.ccat_ref_compnr, 
                    src.ceil, 
                    src.ceil_kw, 
                    src.cfac, 
                    src.cfac_ref_compnr, 
                    src.chic, 
                    src.chic_kw, 
                    src.codt, 
                    src.cogs, 
                    src.cogs_kw, 
                    src.compnr, 
                    src.copr, 
                    src.copr_cntc, 
                    src.copr_dwhc, 
                    src.copr_homc, 
                    src.copr_prjc, 
                    src.copr_refc, 
                    src.copr_rpc1, 
                    src.copr_rpc2, 
                    src.cpcu, 
                    src.cpcu_ref_compnr, 
                    src.cprj, 
                    src.cprj_ref_compnr, 
                    src.creg, 
                    src.creg_ref_compnr, 
                    src.cres, 
                    src.cres_ref_compnr, 
                    src.csec, 
                    src.csec_ref_compnr, 
                    src.csst, 
                    src.csst_kw, 
                    src.cstg, 
                    src.cstg_ref_compnr, 
                    src.cstl, 
                    src.cstv, 
                    src.cuvc, 
                    src.cuvc_ref_compnr, 
                    src.deleted, 
                    src.desc, 
                    src.earf, 
                    src.emno, 
                    src.emno_ref_compnr, 
                    src.esam, 
                    src.esam_cntc, 
                    src.esam_dwhc, 
                    src.esam_homc, 
                    src.esam_prjc, 
                    src.esam_refc, 
                    src.esam_rpc1, 
                    src.esam_rpc2, 
                    src.escu, 
                    src.escu_ref_compnr, 
                    src.excc, 
                    src.excc_kw, 
                    src.fcmp, 
                    src.fidt, 
                    src.hbnr, 
                    src.hbyn, 
                    src.hbyn_kw, 
                    src.idoc, 
                    src.ityp, 
                    src.ivam, 
                    src.ivam_cntc, 
                    src.ivam_dwhc, 
                    src.ivam_homc, 
                    src.ivam_prjc, 
                    src.ivam_refc, 
                    src.ivam_rpc1, 
                    src.ivam_rpc2, 
                    src.lpsl, 
                    src.lpsl_kw, 
                    src.njsp, 
                    src.ofbp, 
                    src.ofbp_ref_compnr, 
                    src.pacu, 
                    src.pacu_ref_compnr, 
                    src.pcmp, 
                    src.prpc, 
                    src.prva, 
                    src.prva_cntc, 
                    src.prva_dwhc, 
                    src.prva_homc, 
                    src.prva_prjc, 
                    src.prva_refc, 
                    src.prva_rpc1, 
                    src.prva_rpc2, 
                    src.pscd, 
                    src.rdap, 
                    src.rdat, 
                    src.revl, 
                    src.revr, 
                    src.revr_kw, 
                    src.revt, 
                    src.rtcc_1, 
                    src.rtcc_2, 
                    src.rtcc_3, 
                    src.rtcp_1, 
                    src.rtcp_2, 
                    src.rtcp_3, 
                    src.rtfc_1, 
                    src.rtfc_2, 
                    src.rtfc_3, 
                    src.rtfp_1, 
                    src.rtfp_2, 
                    src.rtfp_3, 
                    src.sadr, 
                    src.sadr_ref_compnr, 
                    src.seak, 
                    src.sequencenumber, 
                    src.stdt, 
                    src.stlm, 
                    src.stlm_kw, 
                    src.stls, 
                    src.stls_kw, 
                    src.stlt, 
                    src.stlt_kw, 
                    src.styp, 
                    src.styp_ref_compnr, 
                    src.timestamp, 
                    src.trsl, 
                    src.trsl_kw, 
                    src.txta, 
                    src.txta_ref_compnr, 
                    src.username,     
                    src.ETL_SEQUENCE_NUMBER,
                    CURRENT_TIMESTAMP,
                    src.etl_load_metadatafilename);`;

    var sqlStmt = snowflake.createStatement( {sqlText:  sql_command} );
    var rs = sqlStmt.execute();

    snowflake.execute( {sqlText: `merge into TARGET_HISTORY_LN.LN_TPPTC050_DELETED as target using (
                SELECT * FROM (SELECT 
            strm.acgm, 
            strm.acgm_kw, 
            strm.aerf, 
            strm.aprp, 
            strm.arpc, 
            strm.arrl, 
            strm.arrm, 
            strm.arrm_kw, 
            strm.arrt, 
            strm.ascd, 
            strm.cadc, 
            strm.cadc_ref_compnr, 
            strm.cbrn, 
            strm.cbrn_ref_compnr, 
            strm.ccam, 
            strm.ccam_ref_compnr, 
            strm.ccat, 
            strm.ccat_ref_compnr, 
            strm.ceil, 
            strm.ceil_kw, 
            strm.cfac, 
            strm.cfac_ref_compnr, 
            strm.chic, 
            strm.chic_kw, 
            strm.codt, 
            strm.cogs, 
            strm.cogs_kw, 
            strm.compnr, 
            strm.copr, 
            strm.copr_cntc, 
            strm.copr_dwhc, 
            strm.copr_homc, 
            strm.copr_prjc, 
            strm.copr_refc, 
            strm.copr_rpc1, 
            strm.copr_rpc2, 
            strm.cpcu, 
            strm.cpcu_ref_compnr, 
            strm.cprj, 
            strm.cprj_ref_compnr, 
            strm.creg, 
            strm.creg_ref_compnr, 
            strm.cres, 
            strm.cres_ref_compnr, 
            strm.csec, 
            strm.csec_ref_compnr, 
            strm.csst, 
            strm.csst_kw, 
            strm.cstg, 
            strm.cstg_ref_compnr, 
            strm.cstl, 
            strm.cstv, 
            strm.cuvc, 
            strm.cuvc_ref_compnr, 
            strm.deleted, 
            strm.desc, 
            strm.earf, 
            strm.emno, 
            strm.emno_ref_compnr, 
            strm.esam, 
            strm.esam_cntc, 
            strm.esam_dwhc, 
            strm.esam_homc, 
            strm.esam_prjc, 
            strm.esam_refc, 
            strm.esam_rpc1, 
            strm.esam_rpc2, 
            strm.escu, 
            strm.escu_ref_compnr, 
            strm.excc, 
            strm.excc_kw, 
            strm.fcmp, 
            strm.fidt, 
            strm.hbnr, 
            strm.hbyn, 
            strm.hbyn_kw, 
            strm.idoc, 
            strm.ityp, 
            strm.ivam, 
            strm.ivam_cntc, 
            strm.ivam_dwhc, 
            strm.ivam_homc, 
            strm.ivam_prjc, 
            strm.ivam_refc, 
            strm.ivam_rpc1, 
            strm.ivam_rpc2, 
            strm.lpsl, 
            strm.lpsl_kw, 
            strm.njsp, 
            strm.ofbp, 
            strm.ofbp_ref_compnr, 
            strm.pacu, 
            strm.pacu_ref_compnr, 
            strm.pcmp, 
            strm.prpc, 
            strm.prva, 
            strm.prva_cntc, 
            strm.prva_dwhc, 
            strm.prva_homc, 
            strm.prva_prjc, 
            strm.prva_refc, 
            strm.prva_rpc1, 
            strm.prva_rpc2, 
            strm.pscd, 
            strm.rdap, 
            strm.rdat, 
            strm.revl, 
            strm.revr, 
            strm.revr_kw, 
            strm.revt, 
            strm.rtcc_1, 
            strm.rtcc_2, 
            strm.rtcc_3, 
            strm.rtcp_1, 
            strm.rtcp_2, 
            strm.rtcp_3, 
            strm.rtfc_1, 
            strm.rtfc_2, 
            strm.rtfc_3, 
            strm.rtfp_1, 
            strm.rtfp_2, 
            strm.rtfp_3, 
            strm.sadr, 
            strm.sadr_ref_compnr, 
            strm.seak, 
            strm.sequencenumber, 
            strm.stdt, 
            strm.stlm, 
            strm.stlm_kw, 
            strm.stls, 
            strm.stls_kw, 
            strm.stlt, 
            strm.stlt_kw, 
            strm.styp, 
            strm.styp_ref_compnr, 
            strm.timestamp, 
            strm.trsl, 
            strm.trsl_kw, 
            strm.txta, 
            strm.txta_ref_compnr, 
            strm.username, 
            strm.ETL_SEQUENCE_NUMBER,
            strm.ETL_DELETED,
            strm.etl_load_datetime,
            strm.etl_load_metadatafilename,
            ROW_NUMBER() OVER (PARTITION BY 
            strm.compnr,
            strm.cprj,
            strm.cstl ORDER BY strm.ETL_SEQUENCE_NUMBER desc,IFNULL(TRY_TO_TIMESTAMP(replace(right(replace(lower(etl_load_metadatafilename),'.json'),23),'_','-'), 'yyyy-mm-dd-HH-MI-SS-FF') ,etl_load_datetime) desc) as ROWNUMBER
        FROM DATAHUB_INTEGRATION.VW_STREAM_LN_TPPTC050 as  strm
        WHERE strm.ETL_DELETED=TRUE
                    )   
            WHERE ROWNUMBER=1  
            
                    ) as src on
            ((target.compnr=src.compnr) OR (target.compnr IS NULL AND src.compnr IS NULL)) AND
            ((target.cprj=src.cprj) OR (target.cprj IS NULL AND src.cprj IS NULL)) AND
            ((target.cstl=src.cstl) OR (target.cstl IS NULL AND src.cstl IS NULL)) 
                when matched then update set
                    target.acgm=src.acgm, 
                    target.acgm_kw=src.acgm_kw, 
                    target.aerf=src.aerf, 
                    target.aprp=src.aprp, 
                    target.arpc=src.arpc, 
                    target.arrl=src.arrl, 
                    target.arrm=src.arrm, 
                    target.arrm_kw=src.arrm_kw, 
                    target.arrt=src.arrt, 
                    target.ascd=src.ascd, 
                    target.cadc=src.cadc, 
                    target.cadc_ref_compnr=src.cadc_ref_compnr, 
                    target.cbrn=src.cbrn, 
                    target.cbrn_ref_compnr=src.cbrn_ref_compnr, 
                    target.ccam=src.ccam, 
                    target.ccam_ref_compnr=src.ccam_ref_compnr, 
                    target.ccat=src.ccat, 
                    target.ccat_ref_compnr=src.ccat_ref_compnr, 
                    target.ceil=src.ceil, 
                    target.ceil_kw=src.ceil_kw, 
                    target.cfac=src.cfac, 
                    target.cfac_ref_compnr=src.cfac_ref_compnr, 
                    target.chic=src.chic, 
                    target.chic_kw=src.chic_kw, 
                    target.codt=src.codt, 
                    target.cogs=src.cogs, 
                    target.cogs_kw=src.cogs_kw, 
                    target.compnr=src.compnr, 
                    target.copr=src.copr, 
                    target.copr_cntc=src.copr_cntc, 
                    target.copr_dwhc=src.copr_dwhc, 
                    target.copr_homc=src.copr_homc, 
                    target.copr_prjc=src.copr_prjc, 
                    target.copr_refc=src.copr_refc, 
                    target.copr_rpc1=src.copr_rpc1, 
                    target.copr_rpc2=src.copr_rpc2, 
                    target.cpcu=src.cpcu, 
                    target.cpcu_ref_compnr=src.cpcu_ref_compnr, 
                    target.cprj=src.cprj, 
                    target.cprj_ref_compnr=src.cprj_ref_compnr, 
                    target.creg=src.creg, 
                    target.creg_ref_compnr=src.creg_ref_compnr, 
                    target.cres=src.cres, 
                    target.cres_ref_compnr=src.cres_ref_compnr, 
                    target.csec=src.csec, 
                    target.csec_ref_compnr=src.csec_ref_compnr, 
                    target.csst=src.csst, 
                    target.csst_kw=src.csst_kw, 
                    target.cstg=src.cstg, 
                    target.cstg_ref_compnr=src.cstg_ref_compnr, 
                    target.cstl=src.cstl, 
                    target.cstv=src.cstv, 
                    target.cuvc=src.cuvc, 
                    target.cuvc_ref_compnr=src.cuvc_ref_compnr, 
                    target.deleted=src.deleted, 
                    target.desc=src.desc, 
                    target.earf=src.earf, 
                    target.emno=src.emno, 
                    target.emno_ref_compnr=src.emno_ref_compnr, 
                    target.esam=src.esam, 
                    target.esam_cntc=src.esam_cntc, 
                    target.esam_dwhc=src.esam_dwhc, 
                    target.esam_homc=src.esam_homc, 
                    target.esam_prjc=src.esam_prjc, 
                    target.esam_refc=src.esam_refc, 
                    target.esam_rpc1=src.esam_rpc1, 
                    target.esam_rpc2=src.esam_rpc2, 
                    target.escu=src.escu, 
                    target.escu_ref_compnr=src.escu_ref_compnr, 
                    target.excc=src.excc, 
                    target.excc_kw=src.excc_kw, 
                    target.fcmp=src.fcmp, 
                    target.fidt=src.fidt, 
                    target.hbnr=src.hbnr, 
                    target.hbyn=src.hbyn, 
                    target.hbyn_kw=src.hbyn_kw, 
                    target.idoc=src.idoc, 
                    target.ityp=src.ityp, 
                    target.ivam=src.ivam, 
                    target.ivam_cntc=src.ivam_cntc, 
                    target.ivam_dwhc=src.ivam_dwhc, 
                    target.ivam_homc=src.ivam_homc, 
                    target.ivam_prjc=src.ivam_prjc, 
                    target.ivam_refc=src.ivam_refc, 
                    target.ivam_rpc1=src.ivam_rpc1, 
                    target.ivam_rpc2=src.ivam_rpc2, 
                    target.lpsl=src.lpsl, 
                    target.lpsl_kw=src.lpsl_kw, 
                    target.njsp=src.njsp, 
                    target.ofbp=src.ofbp, 
                    target.ofbp_ref_compnr=src.ofbp_ref_compnr, 
                    target.pacu=src.pacu, 
                    target.pacu_ref_compnr=src.pacu_ref_compnr, 
                    target.pcmp=src.pcmp, 
                    target.prpc=src.prpc, 
                    target.prva=src.prva, 
                    target.prva_cntc=src.prva_cntc, 
                    target.prva_dwhc=src.prva_dwhc, 
                    target.prva_homc=src.prva_homc, 
                    target.prva_prjc=src.prva_prjc, 
                    target.prva_refc=src.prva_refc, 
                    target.prva_rpc1=src.prva_rpc1, 
                    target.prva_rpc2=src.prva_rpc2, 
                    target.pscd=src.pscd, 
                    target.rdap=src.rdap, 
                    target.rdat=src.rdat, 
                    target.revl=src.revl, 
                    target.revr=src.revr, 
                    target.revr_kw=src.revr_kw, 
                    target.revt=src.revt, 
                    target.rtcc_1=src.rtcc_1, 
                    target.rtcc_2=src.rtcc_2, 
                    target.rtcc_3=src.rtcc_3, 
                    target.rtcp_1=src.rtcp_1, 
                    target.rtcp_2=src.rtcp_2, 
                    target.rtcp_3=src.rtcp_3, 
                    target.rtfc_1=src.rtfc_1, 
                    target.rtfc_2=src.rtfc_2, 
                    target.rtfc_3=src.rtfc_3, 
                    target.rtfp_1=src.rtfp_1, 
                    target.rtfp_2=src.rtfp_2, 
                    target.rtfp_3=src.rtfp_3, 
                    target.sadr=src.sadr, 
                    target.sadr_ref_compnr=src.sadr_ref_compnr, 
                    target.seak=src.seak, 
                    target.sequencenumber=src.sequencenumber, 
                    target.stdt=src.stdt, 
                    target.stlm=src.stlm, 
                    target.stlm_kw=src.stlm_kw, 
                    target.stls=src.stls, 
                    target.stls_kw=src.stls_kw, 
                    target.stlt=src.stlt, 
                    target.stlt_kw=src.stlt_kw, 
                    target.styp=src.styp, 
                    target.styp_ref_compnr=src.styp_ref_compnr, 
                    target.timestamp=src.timestamp, 
                    target.trsl=src.trsl, 
                    target.trsl_kw=src.trsl_kw, 
                    target.txta=src.txta, 
                    target.txta_ref_compnr=src.txta_ref_compnr, 
                    target.username=src.username, 
                    target.ETL_SEQUENCE_NUMBER=src.ETL_SEQUENCE_NUMBER,
                    target.etl_load_datetime=CURRENT_TIMESTAMP,
                    target.etl_load_metadatafilename=src.etl_load_metadatafilename,
                    target.ETL_DELETED=src.ETL_DELETED
        when not matched   then insert ( acgm, acgm_kw, aerf, aprp, arpc, arrl, arrm, arrm_kw, arrt, ascd, cadc, cadc_ref_compnr, cbrn, cbrn_ref_compnr, ccam, ccam_ref_compnr, ccat, ccat_ref_compnr, ceil, ceil_kw, cfac, cfac_ref_compnr, chic, chic_kw, codt, cogs, cogs_kw, compnr, copr, copr_cntc, copr_dwhc, copr_homc, copr_prjc, copr_refc, copr_rpc1, copr_rpc2, cpcu, cpcu_ref_compnr, cprj, cprj_ref_compnr, creg, creg_ref_compnr, cres, cres_ref_compnr, csec, csec_ref_compnr, csst, csst_kw, cstg, cstg_ref_compnr, cstl, cstv, cuvc, cuvc_ref_compnr, deleted, desc, earf, emno, emno_ref_compnr, esam, esam_cntc, esam_dwhc, esam_homc, esam_prjc, esam_refc, esam_rpc1, esam_rpc2, escu, escu_ref_compnr, excc, excc_kw, fcmp, fidt, hbnr, hbyn, hbyn_kw, idoc, ityp, ivam, ivam_cntc, ivam_dwhc, ivam_homc, ivam_prjc, ivam_refc, ivam_rpc1, ivam_rpc2, lpsl, lpsl_kw, njsp, ofbp, ofbp_ref_compnr, pacu, pacu_ref_compnr, pcmp, prpc, prva, prva_cntc, prva_dwhc, prva_homc, prva_prjc, prva_refc, prva_rpc1, prva_rpc2, pscd, rdap, rdat, revl, revr, revr_kw, revt, rtcc_1, rtcc_2, rtcc_3, rtcp_1, rtcp_2, rtcp_3, rtfc_1, rtfc_2, rtfc_3, rtfp_1, rtfp_2, rtfp_3, sadr, sadr_ref_compnr, seak, sequencenumber, stdt, stlm, stlm_kw, stls, stls_kw, stlt, stlt_kw, styp, styp_ref_compnr, timestamp, trsl, trsl_kw, txta, txta_ref_compnr, username, 
                    ETL_SEQUENCE_NUMBER,                       
                    etl_load_datetime,
                    etl_load_metadatafilename,
                    etl_is_deleted,
                    ETL_DELETED) 
            values (
                    src.acgm, 
                    src.acgm_kw, 
                    src.aerf, 
                    src.aprp, 
                    src.arpc, 
                    src.arrl, 
                    src.arrm, 
                    src.arrm_kw, 
                    src.arrt, 
                    src.ascd, 
                    src.cadc, 
                    src.cadc_ref_compnr, 
                    src.cbrn, 
                    src.cbrn_ref_compnr, 
                    src.ccam, 
                    src.ccam_ref_compnr, 
                    src.ccat, 
                    src.ccat_ref_compnr, 
                    src.ceil, 
                    src.ceil_kw, 
                    src.cfac, 
                    src.cfac_ref_compnr, 
                    src.chic, 
                    src.chic_kw, 
                    src.codt, 
                    src.cogs, 
                    src.cogs_kw, 
                    src.compnr, 
                    src.copr, 
                    src.copr_cntc, 
                    src.copr_dwhc, 
                    src.copr_homc, 
                    src.copr_prjc, 
                    src.copr_refc, 
                    src.copr_rpc1, 
                    src.copr_rpc2, 
                    src.cpcu, 
                    src.cpcu_ref_compnr, 
                    src.cprj, 
                    src.cprj_ref_compnr, 
                    src.creg, 
                    src.creg_ref_compnr, 
                    src.cres, 
                    src.cres_ref_compnr, 
                    src.csec, 
                    src.csec_ref_compnr, 
                    src.csst, 
                    src.csst_kw, 
                    src.cstg, 
                    src.cstg_ref_compnr, 
                    src.cstl, 
                    src.cstv, 
                    src.cuvc, 
                    src.cuvc_ref_compnr, 
                    src.deleted, 
                    src.desc, 
                    src.earf, 
                    src.emno, 
                    src.emno_ref_compnr, 
                    src.esam, 
                    src.esam_cntc, 
                    src.esam_dwhc, 
                    src.esam_homc, 
                    src.esam_prjc, 
                    src.esam_refc, 
                    src.esam_rpc1, 
                    src.esam_rpc2, 
                    src.escu, 
                    src.escu_ref_compnr, 
                    src.excc, 
                    src.excc_kw, 
                    src.fcmp, 
                    src.fidt, 
                    src.hbnr, 
                    src.hbyn, 
                    src.hbyn_kw, 
                    src.idoc, 
                    src.ityp, 
                    src.ivam, 
                    src.ivam_cntc, 
                    src.ivam_dwhc, 
                    src.ivam_homc, 
                    src.ivam_prjc, 
                    src.ivam_refc, 
                    src.ivam_rpc1, 
                    src.ivam_rpc2, 
                    src.lpsl, 
                    src.lpsl_kw, 
                    src.njsp, 
                    src.ofbp, 
                    src.ofbp_ref_compnr, 
                    src.pacu, 
                    src.pacu_ref_compnr, 
                    src.pcmp, 
                    src.prpc, 
                    src.prva, 
                    src.prva_cntc, 
                    src.prva_dwhc, 
                    src.prva_homc, 
                    src.prva_prjc, 
                    src.prva_refc, 
                    src.prva_rpc1, 
                    src.prva_rpc2, 
                    src.pscd, 
                    src.rdap, 
                    src.rdat, 
                    src.revl, 
                    src.revr, 
                    src.revr_kw, 
                    src.revt, 
                    src.rtcc_1, 
                    src.rtcc_2, 
                    src.rtcc_3, 
                    src.rtcp_1, 
                    src.rtcp_2, 
                    src.rtcp_3, 
                    src.rtfc_1, 
                    src.rtfc_2, 
                    src.rtfc_3, 
                    src.rtfp_1, 
                    src.rtfp_2, 
                    src.rtfp_3, 
                    src.sadr, 
                    src.sadr_ref_compnr, 
                    src.seak, 
                    src.sequencenumber, 
                    src.stdt, 
                    src.stlm, 
                    src.stlm_kw, 
                    src.stls, 
                    src.stls_kw, 
                    src.stlt, 
                    src.stlt_kw, 
                    src.styp, 
                    src.styp_ref_compnr, 
                    src.timestamp, 
                    src.trsl, 
                    src.trsl_kw, 
                    src.txta, 
                    src.txta_ref_compnr, 
                    src.username,     
                    src.ETL_SEQUENCE_NUMBER,
                    CURRENT_TIMESTAMP,
                    src.etl_load_metadatafilename,
                    case when ETL_DELETED=TRUE then TRUE else FALSE end,
                    ETL_DELETED);
    `
} );

                    
//  Get number of rows inserted
        
        var sqlStmt = snowflake.createStatement( {sqlText:  sql_command} );
        var rs = sqlStmt.execute();
        var number_of_rows_inserted = sqlStmt.getNumRowsInserted();
        var number_of_rows_updated =  sqlStmt.getNumRowsUpdated();
                    

        
    snowflake.execute ({sqlText: "commit"});

    log_sql_command = "call datahub_logging.sp_etl_log_ingestion_process('UpdateEnd','" + process_name + "','Success','Completed process execution.', 0 ," + number_of_rows_inserted.toString()+ "," +  number_of_rows_updated.toString() + ");";
    snowflake.execute({sqlText: log_sql_command});

    result = "Success"; 

    }       

    catch (err)  {
        snowflake.execute( {sqlText: "rollback;"} )
        var clean_error_msg = err.message.replace(/[^\w\s]/gi, '');
    //  Create a log entry to say INSERT STATEMENT failed
    
    log_sql_command = "call datahub_logging.sp_etl_log_ingestion_process('UpdateEnd','" + process_name + "','Failed','MERGE Failed. Error:" + err.code.toString()+" : "+ clean_error_msg  + "', 0 ,0,0);";
    snowflake.execute({sqlText: log_sql_command});
        ;
        throw "Failed: " + err.message;   // Return a success/error indicator.
        }
    return result;
    $$;