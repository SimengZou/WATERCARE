create or replace procedure DATAHUB_INTEGRATION.SP_LN_TICST002()
    returns varchar not null
                language javascript
                as
                $$

//  Variables

var result = "";                                    // return status of this proc call
const process_name = Object.keys(this)[0];          // name of currently executing process
var number_of_rows_inserted = 0;                             // track number of rows we have inserted
var number_of_rows_updated = 0;                             // track number of rows we have updated


//  Step 1.

//  Start execution - log start

log_sql_command = "call datahub_logging.sp_etl_log_ingestion_process('Insert','" + process_name + "','Running','Started process execution.', 0,0,0);";
snowflake.execute({sqlText: log_sql_command});

snowflake.execute( {sqlText: "begin transaction;"} );
try
    {
        var sql_command = `
                            INSERT INTO LANDING_ERROR.LN_RAW_ERROR
                            SELECT * FROM LANDING_ERROR.VW_STREAM_LN_TICST002_ERROR`;
    var sqlStmt = snowflake.createStatement( {sqlText:  sql_command} );
    var rs = sqlStmt.execute();
        
        var sql_command = ` 
                            merge into  TARGET_LN.LN_TICST002 as target using (SELECT * FROM (SELECT 
            strm.ahma, 
            strm.ahmc, 
            strm.ahmq, 
            strm.ahms, 
            strm.ahwq, 
            strm.ahws, 
            strm.amcc_1, 
            strm.amcc_2, 
            strm.amcc_3, 
            strm.amcc_dwhc, 
            strm.amcc_lclc, 
            strm.amcc_refc, 
            strm.amcc_rpc1, 
            strm.amcc_rpc2, 
            strm.aohc_1, 
            strm.aohc_2, 
            strm.aohc_3, 
            strm.aohc_dwhc, 
            strm.aohc_lclc, 
            strm.aohc_refc, 
            strm.aohc_rpc1, 
            strm.aohc_rpc2, 
            strm.ascc_1, 
            strm.ascc_2, 
            strm.ascc_3, 
            strm.ascc_dwhc, 
            strm.ascc_lclc, 
            strm.ascc_refc, 
            strm.ascc_rpc1, 
            strm.ascc_rpc2, 
            strm.ascq_1, 
            strm.ascq_2, 
            strm.ascq_3, 
            strm.ascq_dwhc, 
            strm.ascq_lclc, 
            strm.ascq_refc, 
            strm.ascq_rpc1, 
            strm.ascq_rpc2, 
            strm.ashc, 
            strm.ashm, 
            strm.ashq, 
            strm.ashs, 
            strm.asmq, 
            strm.asms, 
            strm.awgc_1, 
            strm.awgc_2, 
            strm.awgc_3, 
            strm.awgc_dwhc, 
            strm.awgc_lclc, 
            strm.awgc_refc, 
            strm.awgc_rpc1, 
            strm.awgc_rpc2, 
            strm.bpid, 
            strm.bpid_ref_compnr, 
            strm.ccur, 
            strm.ccur_ref_compnr, 
            strm.cmdt, 
            strm.compnr, 
            strm.cowc, 
            strm.cums, 
            strm.cwoc, 
            strm.cwoc_ref_compnr, 
            strm.deleted, 
            strm.dptm_fcmp, 
            strm.eshc, 
            strm.eshm, 
            strm.fdur, 
            strm.fdur_kw, 
            strm.frso, 
            strm.frso_kw, 
            strm.hrem, 
            strm.hrmc, 
            strm.mccs_1, 
            strm.mccs_2, 
            strm.mccs_3, 
            strm.mccs_dwhc, 
            strm.mccs_lclc, 
            strm.mccs_refc, 
            strm.mccs_rpc1, 
            strm.mccs_rpc2, 
            strm.mcno, 
            strm.mcno_ref_compnr, 
            strm.mcoc, 
            strm.mopr, 
            strm.most, 
            strm.nomc, 
            strm.ohcs_1, 
            strm.ohcs_2, 
            strm.ohcs_3, 
            strm.ohcs_dwhc, 
            strm.ohcs_lclc, 
            strm.ohcs_refc, 
            strm.ohcs_rpc1, 
            strm.ohcs_rpc2, 
            strm.opno, 
            strm.oprc, 
            strm.oprc_ref_compnr, 
            strm.pcdt, 
            strm.pdno, 
            strm.pdno_ref_compnr, 
            strm.prte, 
            strm.qcmp, 
            strm.qpln, 
            strm.qqar, 
            strm.qqar_buar, 
            strm.qqar_buln, 
            strm.qqar_bupc, 
            strm.qqar_butm, 
            strm.qqar_buvl, 
            strm.qqar_buwg, 
            strm.qrjc, 
            strm.qrjc_buar, 
            strm.qrjc_buln, 
            strm.qrjc_bupc, 
            strm.qrjc_butm, 
            strm.qrjc_buvl, 
            strm.qrjc_buwg, 
            strm.runi, 
            strm.rutm, 
            strm.sccs_1, 
            strm.sccs_2, 
            strm.sccs_3, 
            strm.sccs_dwhc, 
            strm.sccs_lclc, 
            strm.sccs_refc, 
            strm.sccs_rpc1, 
            strm.sccs_rpc2, 
            strm.scpq, 
            strm.scpq_buar, 
            strm.scpq_buln, 
            strm.scpq_bupc, 
            strm.scpq_butm, 
            strm.scpq_buvl, 
            strm.scpq_buwg, 
            strm.sequencenumber, 
            strm.subr, 
            strm.sutm, 
            strm.tano, 
            strm.timestamp, 
            strm.username, 
            strm.wgcs_1, 
            strm.wgcs_2, 
            strm.wgcs_3, 
            strm.wgcs_dwhc, 
            strm.wgcs_lclc, 
            strm.wgcs_refc, 
            strm.wgcs_rpc1, 
            strm.wgcs_rpc2, 
            strm.yldp, 
            strm.ETL_SEQUENCE_NUMBER,
            strm.ETL_DELETED,
            strm.etl_load_datetime,
            strm.etl_load_metadatafilename,
            ROW_NUMBER() OVER (PARTITION BY 
            strm.compnr,
            strm.pdno,
            strm.opno ORDER BY strm.ETL_SEQUENCE_NUMBER desc,IFNULL(TRY_TO_TIMESTAMP(replace(right(replace(lower(etl_load_metadatafilename),'.json'),23),'_','-'), 'yyyy-mm-dd-HH-MI-SS-FF') ,etl_load_datetime) desc) as ROWNUMBER
        FROM DATAHUB_INTEGRATION.VW_STREAM_LN_TICST002 as  strm
                    )   
            WHERE ROWNUMBER=1  
            
                    ) as src on
            ((target.compnr=src.compnr) OR (target.compnr IS NULL AND src.compnr IS NULL)) AND
            ((target.pdno=src.pdno) OR (target.pdno IS NULL AND src.pdno IS NULL)) AND
            ((target.opno=src.opno) OR (target.opno IS NULL AND src.opno IS NULL)) 
                when matched and src.ETL_DELETED=TRUE THEN DELETE
                when matched then update set
                    target.ahma=src.ahma, 
                    target.ahmc=src.ahmc, 
                    target.ahmq=src.ahmq, 
                    target.ahms=src.ahms, 
                    target.ahwq=src.ahwq, 
                    target.ahws=src.ahws, 
                    target.amcc_1=src.amcc_1, 
                    target.amcc_2=src.amcc_2, 
                    target.amcc_3=src.amcc_3, 
                    target.amcc_dwhc=src.amcc_dwhc, 
                    target.amcc_lclc=src.amcc_lclc, 
                    target.amcc_refc=src.amcc_refc, 
                    target.amcc_rpc1=src.amcc_rpc1, 
                    target.amcc_rpc2=src.amcc_rpc2, 
                    target.aohc_1=src.aohc_1, 
                    target.aohc_2=src.aohc_2, 
                    target.aohc_3=src.aohc_3, 
                    target.aohc_dwhc=src.aohc_dwhc, 
                    target.aohc_lclc=src.aohc_lclc, 
                    target.aohc_refc=src.aohc_refc, 
                    target.aohc_rpc1=src.aohc_rpc1, 
                    target.aohc_rpc2=src.aohc_rpc2, 
                    target.ascc_1=src.ascc_1, 
                    target.ascc_2=src.ascc_2, 
                    target.ascc_3=src.ascc_3, 
                    target.ascc_dwhc=src.ascc_dwhc, 
                    target.ascc_lclc=src.ascc_lclc, 
                    target.ascc_refc=src.ascc_refc, 
                    target.ascc_rpc1=src.ascc_rpc1, 
                    target.ascc_rpc2=src.ascc_rpc2, 
                    target.ascq_1=src.ascq_1, 
                    target.ascq_2=src.ascq_2, 
                    target.ascq_3=src.ascq_3, 
                    target.ascq_dwhc=src.ascq_dwhc, 
                    target.ascq_lclc=src.ascq_lclc, 
                    target.ascq_refc=src.ascq_refc, 
                    target.ascq_rpc1=src.ascq_rpc1, 
                    target.ascq_rpc2=src.ascq_rpc2, 
                    target.ashc=src.ashc, 
                    target.ashm=src.ashm, 
                    target.ashq=src.ashq, 
                    target.ashs=src.ashs, 
                    target.asmq=src.asmq, 
                    target.asms=src.asms, 
                    target.awgc_1=src.awgc_1, 
                    target.awgc_2=src.awgc_2, 
                    target.awgc_3=src.awgc_3, 
                    target.awgc_dwhc=src.awgc_dwhc, 
                    target.awgc_lclc=src.awgc_lclc, 
                    target.awgc_refc=src.awgc_refc, 
                    target.awgc_rpc1=src.awgc_rpc1, 
                    target.awgc_rpc2=src.awgc_rpc2, 
                    target.bpid=src.bpid, 
                    target.bpid_ref_compnr=src.bpid_ref_compnr, 
                    target.ccur=src.ccur, 
                    target.ccur_ref_compnr=src.ccur_ref_compnr, 
                    target.cmdt=src.cmdt, 
                    target.compnr=src.compnr, 
                    target.cowc=src.cowc, 
                    target.cums=src.cums, 
                    target.cwoc=src.cwoc, 
                    target.cwoc_ref_compnr=src.cwoc_ref_compnr, 
                    target.deleted=src.deleted, 
                    target.dptm_fcmp=src.dptm_fcmp, 
                    target.eshc=src.eshc, 
                    target.eshm=src.eshm, 
                    target.fdur=src.fdur, 
                    target.fdur_kw=src.fdur_kw, 
                    target.frso=src.frso, 
                    target.frso_kw=src.frso_kw, 
                    target.hrem=src.hrem, 
                    target.hrmc=src.hrmc, 
                    target.mccs_1=src.mccs_1, 
                    target.mccs_2=src.mccs_2, 
                    target.mccs_3=src.mccs_3, 
                    target.mccs_dwhc=src.mccs_dwhc, 
                    target.mccs_lclc=src.mccs_lclc, 
                    target.mccs_refc=src.mccs_refc, 
                    target.mccs_rpc1=src.mccs_rpc1, 
                    target.mccs_rpc2=src.mccs_rpc2, 
                    target.mcno=src.mcno, 
                    target.mcno_ref_compnr=src.mcno_ref_compnr, 
                    target.mcoc=src.mcoc, 
                    target.mopr=src.mopr, 
                    target.most=src.most, 
                    target.nomc=src.nomc, 
                    target.ohcs_1=src.ohcs_1, 
                    target.ohcs_2=src.ohcs_2, 
                    target.ohcs_3=src.ohcs_3, 
                    target.ohcs_dwhc=src.ohcs_dwhc, 
                    target.ohcs_lclc=src.ohcs_lclc, 
                    target.ohcs_refc=src.ohcs_refc, 
                    target.ohcs_rpc1=src.ohcs_rpc1, 
                    target.ohcs_rpc2=src.ohcs_rpc2, 
                    target.opno=src.opno, 
                    target.oprc=src.oprc, 
                    target.oprc_ref_compnr=src.oprc_ref_compnr, 
                    target.pcdt=src.pcdt, 
                    target.pdno=src.pdno, 
                    target.pdno_ref_compnr=src.pdno_ref_compnr, 
                    target.prte=src.prte, 
                    target.qcmp=src.qcmp, 
                    target.qpln=src.qpln, 
                    target.qqar=src.qqar, 
                    target.qqar_buar=src.qqar_buar, 
                    target.qqar_buln=src.qqar_buln, 
                    target.qqar_bupc=src.qqar_bupc, 
                    target.qqar_butm=src.qqar_butm, 
                    target.qqar_buvl=src.qqar_buvl, 
                    target.qqar_buwg=src.qqar_buwg, 
                    target.qrjc=src.qrjc, 
                    target.qrjc_buar=src.qrjc_buar, 
                    target.qrjc_buln=src.qrjc_buln, 
                    target.qrjc_bupc=src.qrjc_bupc, 
                    target.qrjc_butm=src.qrjc_butm, 
                    target.qrjc_buvl=src.qrjc_buvl, 
                    target.qrjc_buwg=src.qrjc_buwg, 
                    target.runi=src.runi, 
                    target.rutm=src.rutm, 
                    target.sccs_1=src.sccs_1, 
                    target.sccs_2=src.sccs_2, 
                    target.sccs_3=src.sccs_3, 
                    target.sccs_dwhc=src.sccs_dwhc, 
                    target.sccs_lclc=src.sccs_lclc, 
                    target.sccs_refc=src.sccs_refc, 
                    target.sccs_rpc1=src.sccs_rpc1, 
                    target.sccs_rpc2=src.sccs_rpc2, 
                    target.scpq=src.scpq, 
                    target.scpq_buar=src.scpq_buar, 
                    target.scpq_buln=src.scpq_buln, 
                    target.scpq_bupc=src.scpq_bupc, 
                    target.scpq_butm=src.scpq_butm, 
                    target.scpq_buvl=src.scpq_buvl, 
                    target.scpq_buwg=src.scpq_buwg, 
                    target.sequencenumber=src.sequencenumber, 
                    target.subr=src.subr, 
                    target.sutm=src.sutm, 
                    target.tano=src.tano, 
                    target.timestamp=src.timestamp, 
                    target.username=src.username, 
                    target.wgcs_1=src.wgcs_1, 
                    target.wgcs_2=src.wgcs_2, 
                    target.wgcs_3=src.wgcs_3, 
                    target.wgcs_dwhc=src.wgcs_dwhc, 
                    target.wgcs_lclc=src.wgcs_lclc, 
                    target.wgcs_refc=src.wgcs_refc, 
                    target.wgcs_rpc1=src.wgcs_rpc1, 
                    target.wgcs_rpc2=src.wgcs_rpc2, 
                    target.yldp=src.yldp, 
                    target.ETL_SEQUENCE_NUMBER=src.ETL_SEQUENCE_NUMBER,
                    target.etl_load_datetime=CURRENT_TIMESTAMP,
                    target.etl_load_metadatafilename=src.etl_load_metadatafilename
        when not matched and (src.ETL_DELETED=FALSE OR src.ETL_DELETED IS NULL)  then insert ( 
                    ahma, 
                    ahmc, 
                    ahmq, 
                    ahms, 
                    ahwq, 
                    ahws, 
                    amcc_1, 
                    amcc_2, 
                    amcc_3, 
                    amcc_dwhc, 
                    amcc_lclc, 
                    amcc_refc, 
                    amcc_rpc1, 
                    amcc_rpc2, 
                    aohc_1, 
                    aohc_2, 
                    aohc_3, 
                    aohc_dwhc, 
                    aohc_lclc, 
                    aohc_refc, 
                    aohc_rpc1, 
                    aohc_rpc2, 
                    ascc_1, 
                    ascc_2, 
                    ascc_3, 
                    ascc_dwhc, 
                    ascc_lclc, 
                    ascc_refc, 
                    ascc_rpc1, 
                    ascc_rpc2, 
                    ascq_1, 
                    ascq_2, 
                    ascq_3, 
                    ascq_dwhc, 
                    ascq_lclc, 
                    ascq_refc, 
                    ascq_rpc1, 
                    ascq_rpc2, 
                    ashc, 
                    ashm, 
                    ashq, 
                    ashs, 
                    asmq, 
                    asms, 
                    awgc_1, 
                    awgc_2, 
                    awgc_3, 
                    awgc_dwhc, 
                    awgc_lclc, 
                    awgc_refc, 
                    awgc_rpc1, 
                    awgc_rpc2, 
                    bpid, 
                    bpid_ref_compnr, 
                    ccur, 
                    ccur_ref_compnr, 
                    cmdt, 
                    compnr, 
                    cowc, 
                    cums, 
                    cwoc, 
                    cwoc_ref_compnr, 
                    deleted, 
                    dptm_fcmp, 
                    eshc, 
                    eshm, 
                    fdur, 
                    fdur_kw, 
                    frso, 
                    frso_kw, 
                    hrem, 
                    hrmc, 
                    mccs_1, 
                    mccs_2, 
                    mccs_3, 
                    mccs_dwhc, 
                    mccs_lclc, 
                    mccs_refc, 
                    mccs_rpc1, 
                    mccs_rpc2, 
                    mcno, 
                    mcno_ref_compnr, 
                    mcoc, 
                    mopr, 
                    most, 
                    nomc, 
                    ohcs_1, 
                    ohcs_2, 
                    ohcs_3, 
                    ohcs_dwhc, 
                    ohcs_lclc, 
                    ohcs_refc, 
                    ohcs_rpc1, 
                    ohcs_rpc2, 
                    opno, 
                    oprc, 
                    oprc_ref_compnr, 
                    pcdt, 
                    pdno, 
                    pdno_ref_compnr, 
                    prte, 
                    qcmp, 
                    qpln, 
                    qqar, 
                    qqar_buar, 
                    qqar_buln, 
                    qqar_bupc, 
                    qqar_butm, 
                    qqar_buvl, 
                    qqar_buwg, 
                    qrjc, 
                    qrjc_buar, 
                    qrjc_buln, 
                    qrjc_bupc, 
                    qrjc_butm, 
                    qrjc_buvl, 
                    qrjc_buwg, 
                    runi, 
                    rutm, 
                    sccs_1, 
                    sccs_2, 
                    sccs_3, 
                    sccs_dwhc, 
                    sccs_lclc, 
                    sccs_refc, 
                    sccs_rpc1, 
                    sccs_rpc2, 
                    scpq, 
                    scpq_buar, 
                    scpq_buln, 
                    scpq_bupc, 
                    scpq_butm, 
                    scpq_buvl, 
                    scpq_buwg, 
                    sequencenumber, 
                    subr, 
                    sutm, 
                    tano, 
                    timestamp, 
                    username, 
                    wgcs_1, 
                    wgcs_2, 
                    wgcs_3, 
                    wgcs_dwhc, 
                    wgcs_lclc, 
                    wgcs_refc, 
                    wgcs_rpc1, 
                    wgcs_rpc2, 
                    yldp, 
                    ETL_SEQUENCE_NUMBER,                       
                    etl_load_datetime,
                    etl_load_metadatafilename) 
            values (
                    src.ahma, 
                    src.ahmc, 
                    src.ahmq, 
                    src.ahms, 
                    src.ahwq, 
                    src.ahws, 
                    src.amcc_1, 
                    src.amcc_2, 
                    src.amcc_3, 
                    src.amcc_dwhc, 
                    src.amcc_lclc, 
                    src.amcc_refc, 
                    src.amcc_rpc1, 
                    src.amcc_rpc2, 
                    src.aohc_1, 
                    src.aohc_2, 
                    src.aohc_3, 
                    src.aohc_dwhc, 
                    src.aohc_lclc, 
                    src.aohc_refc, 
                    src.aohc_rpc1, 
                    src.aohc_rpc2, 
                    src.ascc_1, 
                    src.ascc_2, 
                    src.ascc_3, 
                    src.ascc_dwhc, 
                    src.ascc_lclc, 
                    src.ascc_refc, 
                    src.ascc_rpc1, 
                    src.ascc_rpc2, 
                    src.ascq_1, 
                    src.ascq_2, 
                    src.ascq_3, 
                    src.ascq_dwhc, 
                    src.ascq_lclc, 
                    src.ascq_refc, 
                    src.ascq_rpc1, 
                    src.ascq_rpc2, 
                    src.ashc, 
                    src.ashm, 
                    src.ashq, 
                    src.ashs, 
                    src.asmq, 
                    src.asms, 
                    src.awgc_1, 
                    src.awgc_2, 
                    src.awgc_3, 
                    src.awgc_dwhc, 
                    src.awgc_lclc, 
                    src.awgc_refc, 
                    src.awgc_rpc1, 
                    src.awgc_rpc2, 
                    src.bpid, 
                    src.bpid_ref_compnr, 
                    src.ccur, 
                    src.ccur_ref_compnr, 
                    src.cmdt, 
                    src.compnr, 
                    src.cowc, 
                    src.cums, 
                    src.cwoc, 
                    src.cwoc_ref_compnr, 
                    src.deleted, 
                    src.dptm_fcmp, 
                    src.eshc, 
                    src.eshm, 
                    src.fdur, 
                    src.fdur_kw, 
                    src.frso, 
                    src.frso_kw, 
                    src.hrem, 
                    src.hrmc, 
                    src.mccs_1, 
                    src.mccs_2, 
                    src.mccs_3, 
                    src.mccs_dwhc, 
                    src.mccs_lclc, 
                    src.mccs_refc, 
                    src.mccs_rpc1, 
                    src.mccs_rpc2, 
                    src.mcno, 
                    src.mcno_ref_compnr, 
                    src.mcoc, 
                    src.mopr, 
                    src.most, 
                    src.nomc, 
                    src.ohcs_1, 
                    src.ohcs_2, 
                    src.ohcs_3, 
                    src.ohcs_dwhc, 
                    src.ohcs_lclc, 
                    src.ohcs_refc, 
                    src.ohcs_rpc1, 
                    src.ohcs_rpc2, 
                    src.opno, 
                    src.oprc, 
                    src.oprc_ref_compnr, 
                    src.pcdt, 
                    src.pdno, 
                    src.pdno_ref_compnr, 
                    src.prte, 
                    src.qcmp, 
                    src.qpln, 
                    src.qqar, 
                    src.qqar_buar, 
                    src.qqar_buln, 
                    src.qqar_bupc, 
                    src.qqar_butm, 
                    src.qqar_buvl, 
                    src.qqar_buwg, 
                    src.qrjc, 
                    src.qrjc_buar, 
                    src.qrjc_buln, 
                    src.qrjc_bupc, 
                    src.qrjc_butm, 
                    src.qrjc_buvl, 
                    src.qrjc_buwg, 
                    src.runi, 
                    src.rutm, 
                    src.sccs_1, 
                    src.sccs_2, 
                    src.sccs_3, 
                    src.sccs_dwhc, 
                    src.sccs_lclc, 
                    src.sccs_refc, 
                    src.sccs_rpc1, 
                    src.sccs_rpc2, 
                    src.scpq, 
                    src.scpq_buar, 
                    src.scpq_buln, 
                    src.scpq_bupc, 
                    src.scpq_butm, 
                    src.scpq_buvl, 
                    src.scpq_buwg, 
                    src.sequencenumber, 
                    src.subr, 
                    src.sutm, 
                    src.tano, 
                    src.timestamp, 
                    src.username, 
                    src.wgcs_1, 
                    src.wgcs_2, 
                    src.wgcs_3, 
                    src.wgcs_dwhc, 
                    src.wgcs_lclc, 
                    src.wgcs_refc, 
                    src.wgcs_rpc1, 
                    src.wgcs_rpc2, 
                    src.yldp,     
                    src.ETL_SEQUENCE_NUMBER,
                    CURRENT_TIMESTAMP,
                    src.etl_load_metadatafilename);`;

    var sqlStmt = snowflake.createStatement( {sqlText:  sql_command} );
    var rs = sqlStmt.execute();

    snowflake.execute( {sqlText: `merge into TARGET_HISTORY_LN.LN_TICST002_DELETED as target using (
                SELECT * FROM (SELECT 
            strm.ahma, 
            strm.ahmc, 
            strm.ahmq, 
            strm.ahms, 
            strm.ahwq, 
            strm.ahws, 
            strm.amcc_1, 
            strm.amcc_2, 
            strm.amcc_3, 
            strm.amcc_dwhc, 
            strm.amcc_lclc, 
            strm.amcc_refc, 
            strm.amcc_rpc1, 
            strm.amcc_rpc2, 
            strm.aohc_1, 
            strm.aohc_2, 
            strm.aohc_3, 
            strm.aohc_dwhc, 
            strm.aohc_lclc, 
            strm.aohc_refc, 
            strm.aohc_rpc1, 
            strm.aohc_rpc2, 
            strm.ascc_1, 
            strm.ascc_2, 
            strm.ascc_3, 
            strm.ascc_dwhc, 
            strm.ascc_lclc, 
            strm.ascc_refc, 
            strm.ascc_rpc1, 
            strm.ascc_rpc2, 
            strm.ascq_1, 
            strm.ascq_2, 
            strm.ascq_3, 
            strm.ascq_dwhc, 
            strm.ascq_lclc, 
            strm.ascq_refc, 
            strm.ascq_rpc1, 
            strm.ascq_rpc2, 
            strm.ashc, 
            strm.ashm, 
            strm.ashq, 
            strm.ashs, 
            strm.asmq, 
            strm.asms, 
            strm.awgc_1, 
            strm.awgc_2, 
            strm.awgc_3, 
            strm.awgc_dwhc, 
            strm.awgc_lclc, 
            strm.awgc_refc, 
            strm.awgc_rpc1, 
            strm.awgc_rpc2, 
            strm.bpid, 
            strm.bpid_ref_compnr, 
            strm.ccur, 
            strm.ccur_ref_compnr, 
            strm.cmdt, 
            strm.compnr, 
            strm.cowc, 
            strm.cums, 
            strm.cwoc, 
            strm.cwoc_ref_compnr, 
            strm.deleted, 
            strm.dptm_fcmp, 
            strm.eshc, 
            strm.eshm, 
            strm.fdur, 
            strm.fdur_kw, 
            strm.frso, 
            strm.frso_kw, 
            strm.hrem, 
            strm.hrmc, 
            strm.mccs_1, 
            strm.mccs_2, 
            strm.mccs_3, 
            strm.mccs_dwhc, 
            strm.mccs_lclc, 
            strm.mccs_refc, 
            strm.mccs_rpc1, 
            strm.mccs_rpc2, 
            strm.mcno, 
            strm.mcno_ref_compnr, 
            strm.mcoc, 
            strm.mopr, 
            strm.most, 
            strm.nomc, 
            strm.ohcs_1, 
            strm.ohcs_2, 
            strm.ohcs_3, 
            strm.ohcs_dwhc, 
            strm.ohcs_lclc, 
            strm.ohcs_refc, 
            strm.ohcs_rpc1, 
            strm.ohcs_rpc2, 
            strm.opno, 
            strm.oprc, 
            strm.oprc_ref_compnr, 
            strm.pcdt, 
            strm.pdno, 
            strm.pdno_ref_compnr, 
            strm.prte, 
            strm.qcmp, 
            strm.qpln, 
            strm.qqar, 
            strm.qqar_buar, 
            strm.qqar_buln, 
            strm.qqar_bupc, 
            strm.qqar_butm, 
            strm.qqar_buvl, 
            strm.qqar_buwg, 
            strm.qrjc, 
            strm.qrjc_buar, 
            strm.qrjc_buln, 
            strm.qrjc_bupc, 
            strm.qrjc_butm, 
            strm.qrjc_buvl, 
            strm.qrjc_buwg, 
            strm.runi, 
            strm.rutm, 
            strm.sccs_1, 
            strm.sccs_2, 
            strm.sccs_3, 
            strm.sccs_dwhc, 
            strm.sccs_lclc, 
            strm.sccs_refc, 
            strm.sccs_rpc1, 
            strm.sccs_rpc2, 
            strm.scpq, 
            strm.scpq_buar, 
            strm.scpq_buln, 
            strm.scpq_bupc, 
            strm.scpq_butm, 
            strm.scpq_buvl, 
            strm.scpq_buwg, 
            strm.sequencenumber, 
            strm.subr, 
            strm.sutm, 
            strm.tano, 
            strm.timestamp, 
            strm.username, 
            strm.wgcs_1, 
            strm.wgcs_2, 
            strm.wgcs_3, 
            strm.wgcs_dwhc, 
            strm.wgcs_lclc, 
            strm.wgcs_refc, 
            strm.wgcs_rpc1, 
            strm.wgcs_rpc2, 
            strm.yldp, 
            strm.ETL_SEQUENCE_NUMBER,
            strm.ETL_DELETED,
            strm.etl_load_datetime,
            strm.etl_load_metadatafilename,
            ROW_NUMBER() OVER (PARTITION BY 
            strm.compnr,
            strm.pdno,
            strm.opno ORDER BY strm.ETL_SEQUENCE_NUMBER desc,IFNULL(TRY_TO_TIMESTAMP(replace(right(replace(lower(etl_load_metadatafilename),'.json'),23),'_','-'), 'yyyy-mm-dd-HH-MI-SS-FF') ,etl_load_datetime) desc) as ROWNUMBER
        FROM DATAHUB_INTEGRATION.VW_STREAM_LN_TICST002 as  strm
        WHERE strm.ETL_DELETED=TRUE
                    )   
            WHERE ROWNUMBER=1  
            
                    ) as src on
            ((target.compnr=src.compnr) OR (target.compnr IS NULL AND src.compnr IS NULL)) AND
            ((target.pdno=src.pdno) OR (target.pdno IS NULL AND src.pdno IS NULL)) AND
            ((target.opno=src.opno) OR (target.opno IS NULL AND src.opno IS NULL)) 
                when matched then update set
                    target.ahma=src.ahma, 
                    target.ahmc=src.ahmc, 
                    target.ahmq=src.ahmq, 
                    target.ahms=src.ahms, 
                    target.ahwq=src.ahwq, 
                    target.ahws=src.ahws, 
                    target.amcc_1=src.amcc_1, 
                    target.amcc_2=src.amcc_2, 
                    target.amcc_3=src.amcc_3, 
                    target.amcc_dwhc=src.amcc_dwhc, 
                    target.amcc_lclc=src.amcc_lclc, 
                    target.amcc_refc=src.amcc_refc, 
                    target.amcc_rpc1=src.amcc_rpc1, 
                    target.amcc_rpc2=src.amcc_rpc2, 
                    target.aohc_1=src.aohc_1, 
                    target.aohc_2=src.aohc_2, 
                    target.aohc_3=src.aohc_3, 
                    target.aohc_dwhc=src.aohc_dwhc, 
                    target.aohc_lclc=src.aohc_lclc, 
                    target.aohc_refc=src.aohc_refc, 
                    target.aohc_rpc1=src.aohc_rpc1, 
                    target.aohc_rpc2=src.aohc_rpc2, 
                    target.ascc_1=src.ascc_1, 
                    target.ascc_2=src.ascc_2, 
                    target.ascc_3=src.ascc_3, 
                    target.ascc_dwhc=src.ascc_dwhc, 
                    target.ascc_lclc=src.ascc_lclc, 
                    target.ascc_refc=src.ascc_refc, 
                    target.ascc_rpc1=src.ascc_rpc1, 
                    target.ascc_rpc2=src.ascc_rpc2, 
                    target.ascq_1=src.ascq_1, 
                    target.ascq_2=src.ascq_2, 
                    target.ascq_3=src.ascq_3, 
                    target.ascq_dwhc=src.ascq_dwhc, 
                    target.ascq_lclc=src.ascq_lclc, 
                    target.ascq_refc=src.ascq_refc, 
                    target.ascq_rpc1=src.ascq_rpc1, 
                    target.ascq_rpc2=src.ascq_rpc2, 
                    target.ashc=src.ashc, 
                    target.ashm=src.ashm, 
                    target.ashq=src.ashq, 
                    target.ashs=src.ashs, 
                    target.asmq=src.asmq, 
                    target.asms=src.asms, 
                    target.awgc_1=src.awgc_1, 
                    target.awgc_2=src.awgc_2, 
                    target.awgc_3=src.awgc_3, 
                    target.awgc_dwhc=src.awgc_dwhc, 
                    target.awgc_lclc=src.awgc_lclc, 
                    target.awgc_refc=src.awgc_refc, 
                    target.awgc_rpc1=src.awgc_rpc1, 
                    target.awgc_rpc2=src.awgc_rpc2, 
                    target.bpid=src.bpid, 
                    target.bpid_ref_compnr=src.bpid_ref_compnr, 
                    target.ccur=src.ccur, 
                    target.ccur_ref_compnr=src.ccur_ref_compnr, 
                    target.cmdt=src.cmdt, 
                    target.compnr=src.compnr, 
                    target.cowc=src.cowc, 
                    target.cums=src.cums, 
                    target.cwoc=src.cwoc, 
                    target.cwoc_ref_compnr=src.cwoc_ref_compnr, 
                    target.deleted=src.deleted, 
                    target.dptm_fcmp=src.dptm_fcmp, 
                    target.eshc=src.eshc, 
                    target.eshm=src.eshm, 
                    target.fdur=src.fdur, 
                    target.fdur_kw=src.fdur_kw, 
                    target.frso=src.frso, 
                    target.frso_kw=src.frso_kw, 
                    target.hrem=src.hrem, 
                    target.hrmc=src.hrmc, 
                    target.mccs_1=src.mccs_1, 
                    target.mccs_2=src.mccs_2, 
                    target.mccs_3=src.mccs_3, 
                    target.mccs_dwhc=src.mccs_dwhc, 
                    target.mccs_lclc=src.mccs_lclc, 
                    target.mccs_refc=src.mccs_refc, 
                    target.mccs_rpc1=src.mccs_rpc1, 
                    target.mccs_rpc2=src.mccs_rpc2, 
                    target.mcno=src.mcno, 
                    target.mcno_ref_compnr=src.mcno_ref_compnr, 
                    target.mcoc=src.mcoc, 
                    target.mopr=src.mopr, 
                    target.most=src.most, 
                    target.nomc=src.nomc, 
                    target.ohcs_1=src.ohcs_1, 
                    target.ohcs_2=src.ohcs_2, 
                    target.ohcs_3=src.ohcs_3, 
                    target.ohcs_dwhc=src.ohcs_dwhc, 
                    target.ohcs_lclc=src.ohcs_lclc, 
                    target.ohcs_refc=src.ohcs_refc, 
                    target.ohcs_rpc1=src.ohcs_rpc1, 
                    target.ohcs_rpc2=src.ohcs_rpc2, 
                    target.opno=src.opno, 
                    target.oprc=src.oprc, 
                    target.oprc_ref_compnr=src.oprc_ref_compnr, 
                    target.pcdt=src.pcdt, 
                    target.pdno=src.pdno, 
                    target.pdno_ref_compnr=src.pdno_ref_compnr, 
                    target.prte=src.prte, 
                    target.qcmp=src.qcmp, 
                    target.qpln=src.qpln, 
                    target.qqar=src.qqar, 
                    target.qqar_buar=src.qqar_buar, 
                    target.qqar_buln=src.qqar_buln, 
                    target.qqar_bupc=src.qqar_bupc, 
                    target.qqar_butm=src.qqar_butm, 
                    target.qqar_buvl=src.qqar_buvl, 
                    target.qqar_buwg=src.qqar_buwg, 
                    target.qrjc=src.qrjc, 
                    target.qrjc_buar=src.qrjc_buar, 
                    target.qrjc_buln=src.qrjc_buln, 
                    target.qrjc_bupc=src.qrjc_bupc, 
                    target.qrjc_butm=src.qrjc_butm, 
                    target.qrjc_buvl=src.qrjc_buvl, 
                    target.qrjc_buwg=src.qrjc_buwg, 
                    target.runi=src.runi, 
                    target.rutm=src.rutm, 
                    target.sccs_1=src.sccs_1, 
                    target.sccs_2=src.sccs_2, 
                    target.sccs_3=src.sccs_3, 
                    target.sccs_dwhc=src.sccs_dwhc, 
                    target.sccs_lclc=src.sccs_lclc, 
                    target.sccs_refc=src.sccs_refc, 
                    target.sccs_rpc1=src.sccs_rpc1, 
                    target.sccs_rpc2=src.sccs_rpc2, 
                    target.scpq=src.scpq, 
                    target.scpq_buar=src.scpq_buar, 
                    target.scpq_buln=src.scpq_buln, 
                    target.scpq_bupc=src.scpq_bupc, 
                    target.scpq_butm=src.scpq_butm, 
                    target.scpq_buvl=src.scpq_buvl, 
                    target.scpq_buwg=src.scpq_buwg, 
                    target.sequencenumber=src.sequencenumber, 
                    target.subr=src.subr, 
                    target.sutm=src.sutm, 
                    target.tano=src.tano, 
                    target.timestamp=src.timestamp, 
                    target.username=src.username, 
                    target.wgcs_1=src.wgcs_1, 
                    target.wgcs_2=src.wgcs_2, 
                    target.wgcs_3=src.wgcs_3, 
                    target.wgcs_dwhc=src.wgcs_dwhc, 
                    target.wgcs_lclc=src.wgcs_lclc, 
                    target.wgcs_refc=src.wgcs_refc, 
                    target.wgcs_rpc1=src.wgcs_rpc1, 
                    target.wgcs_rpc2=src.wgcs_rpc2, 
                    target.yldp=src.yldp, 
                    target.ETL_SEQUENCE_NUMBER=src.ETL_SEQUENCE_NUMBER,
                    target.etl_load_datetime=CURRENT_TIMESTAMP,
                    target.etl_load_metadatafilename=src.etl_load_metadatafilename,
                    target.ETL_DELETED=src.ETL_DELETED
        when not matched   then insert ( ahma, ahmc, ahmq, ahms, ahwq, ahws, amcc_1, amcc_2, amcc_3, amcc_dwhc, amcc_lclc, amcc_refc, amcc_rpc1, amcc_rpc2, aohc_1, aohc_2, aohc_3, aohc_dwhc, aohc_lclc, aohc_refc, aohc_rpc1, aohc_rpc2, ascc_1, ascc_2, ascc_3, ascc_dwhc, ascc_lclc, ascc_refc, ascc_rpc1, ascc_rpc2, ascq_1, ascq_2, ascq_3, ascq_dwhc, ascq_lclc, ascq_refc, ascq_rpc1, ascq_rpc2, ashc, ashm, ashq, ashs, asmq, asms, awgc_1, awgc_2, awgc_3, awgc_dwhc, awgc_lclc, awgc_refc, awgc_rpc1, awgc_rpc2, bpid, bpid_ref_compnr, ccur, ccur_ref_compnr, cmdt, compnr, cowc, cums, cwoc, cwoc_ref_compnr, deleted, dptm_fcmp, eshc, eshm, fdur, fdur_kw, frso, frso_kw, hrem, hrmc, mccs_1, mccs_2, mccs_3, mccs_dwhc, mccs_lclc, mccs_refc, mccs_rpc1, mccs_rpc2, mcno, mcno_ref_compnr, mcoc, mopr, most, nomc, ohcs_1, ohcs_2, ohcs_3, ohcs_dwhc, ohcs_lclc, ohcs_refc, ohcs_rpc1, ohcs_rpc2, opno, oprc, oprc_ref_compnr, pcdt, pdno, pdno_ref_compnr, prte, qcmp, qpln, qqar, qqar_buar, qqar_buln, qqar_bupc, qqar_butm, qqar_buvl, qqar_buwg, qrjc, qrjc_buar, qrjc_buln, qrjc_bupc, qrjc_butm, qrjc_buvl, qrjc_buwg, runi, rutm, sccs_1, sccs_2, sccs_3, sccs_dwhc, sccs_lclc, sccs_refc, sccs_rpc1, sccs_rpc2, scpq, scpq_buar, scpq_buln, scpq_bupc, scpq_butm, scpq_buvl, scpq_buwg, sequencenumber, subr, sutm, tano, timestamp, username, wgcs_1, wgcs_2, wgcs_3, wgcs_dwhc, wgcs_lclc, wgcs_refc, wgcs_rpc1, wgcs_rpc2, yldp, 
                    ETL_SEQUENCE_NUMBER,                       
                    etl_load_datetime,
                    etl_load_metadatafilename,
                    etl_is_deleted,
                    ETL_DELETED) 
            values (
                    src.ahma, 
                    src.ahmc, 
                    src.ahmq, 
                    src.ahms, 
                    src.ahwq, 
                    src.ahws, 
                    src.amcc_1, 
                    src.amcc_2, 
                    src.amcc_3, 
                    src.amcc_dwhc, 
                    src.amcc_lclc, 
                    src.amcc_refc, 
                    src.amcc_rpc1, 
                    src.amcc_rpc2, 
                    src.aohc_1, 
                    src.aohc_2, 
                    src.aohc_3, 
                    src.aohc_dwhc, 
                    src.aohc_lclc, 
                    src.aohc_refc, 
                    src.aohc_rpc1, 
                    src.aohc_rpc2, 
                    src.ascc_1, 
                    src.ascc_2, 
                    src.ascc_3, 
                    src.ascc_dwhc, 
                    src.ascc_lclc, 
                    src.ascc_refc, 
                    src.ascc_rpc1, 
                    src.ascc_rpc2, 
                    src.ascq_1, 
                    src.ascq_2, 
                    src.ascq_3, 
                    src.ascq_dwhc, 
                    src.ascq_lclc, 
                    src.ascq_refc, 
                    src.ascq_rpc1, 
                    src.ascq_rpc2, 
                    src.ashc, 
                    src.ashm, 
                    src.ashq, 
                    src.ashs, 
                    src.asmq, 
                    src.asms, 
                    src.awgc_1, 
                    src.awgc_2, 
                    src.awgc_3, 
                    src.awgc_dwhc, 
                    src.awgc_lclc, 
                    src.awgc_refc, 
                    src.awgc_rpc1, 
                    src.awgc_rpc2, 
                    src.bpid, 
                    src.bpid_ref_compnr, 
                    src.ccur, 
                    src.ccur_ref_compnr, 
                    src.cmdt, 
                    src.compnr, 
                    src.cowc, 
                    src.cums, 
                    src.cwoc, 
                    src.cwoc_ref_compnr, 
                    src.deleted, 
                    src.dptm_fcmp, 
                    src.eshc, 
                    src.eshm, 
                    src.fdur, 
                    src.fdur_kw, 
                    src.frso, 
                    src.frso_kw, 
                    src.hrem, 
                    src.hrmc, 
                    src.mccs_1, 
                    src.mccs_2, 
                    src.mccs_3, 
                    src.mccs_dwhc, 
                    src.mccs_lclc, 
                    src.mccs_refc, 
                    src.mccs_rpc1, 
                    src.mccs_rpc2, 
                    src.mcno, 
                    src.mcno_ref_compnr, 
                    src.mcoc, 
                    src.mopr, 
                    src.most, 
                    src.nomc, 
                    src.ohcs_1, 
                    src.ohcs_2, 
                    src.ohcs_3, 
                    src.ohcs_dwhc, 
                    src.ohcs_lclc, 
                    src.ohcs_refc, 
                    src.ohcs_rpc1, 
                    src.ohcs_rpc2, 
                    src.opno, 
                    src.oprc, 
                    src.oprc_ref_compnr, 
                    src.pcdt, 
                    src.pdno, 
                    src.pdno_ref_compnr, 
                    src.prte, 
                    src.qcmp, 
                    src.qpln, 
                    src.qqar, 
                    src.qqar_buar, 
                    src.qqar_buln, 
                    src.qqar_bupc, 
                    src.qqar_butm, 
                    src.qqar_buvl, 
                    src.qqar_buwg, 
                    src.qrjc, 
                    src.qrjc_buar, 
                    src.qrjc_buln, 
                    src.qrjc_bupc, 
                    src.qrjc_butm, 
                    src.qrjc_buvl, 
                    src.qrjc_buwg, 
                    src.runi, 
                    src.rutm, 
                    src.sccs_1, 
                    src.sccs_2, 
                    src.sccs_3, 
                    src.sccs_dwhc, 
                    src.sccs_lclc, 
                    src.sccs_refc, 
                    src.sccs_rpc1, 
                    src.sccs_rpc2, 
                    src.scpq, 
                    src.scpq_buar, 
                    src.scpq_buln, 
                    src.scpq_bupc, 
                    src.scpq_butm, 
                    src.scpq_buvl, 
                    src.scpq_buwg, 
                    src.sequencenumber, 
                    src.subr, 
                    src.sutm, 
                    src.tano, 
                    src.timestamp, 
                    src.username, 
                    src.wgcs_1, 
                    src.wgcs_2, 
                    src.wgcs_3, 
                    src.wgcs_dwhc, 
                    src.wgcs_lclc, 
                    src.wgcs_refc, 
                    src.wgcs_rpc1, 
                    src.wgcs_rpc2, 
                    src.yldp,     
                    src.ETL_SEQUENCE_NUMBER,
                    CURRENT_TIMESTAMP,
                    src.etl_load_metadatafilename,
                    case when ETL_DELETED=TRUE then TRUE else FALSE end,
                    ETL_DELETED);
    `
} );

                    
//  Get number of rows inserted
        
        var sqlStmt = snowflake.createStatement( {sqlText:  sql_command} );
        var rs = sqlStmt.execute();
        var number_of_rows_inserted = sqlStmt.getNumRowsInserted();
        var number_of_rows_updated =  sqlStmt.getNumRowsUpdated();
                    

        
    snowflake.execute ({sqlText: "commit"});

    log_sql_command = "call datahub_logging.sp_etl_log_ingestion_process('UpdateEnd','" + process_name + "','Success','Completed process execution.', 0 ," + number_of_rows_inserted.toString()+ "," +  number_of_rows_updated.toString() + ");";
    snowflake.execute({sqlText: log_sql_command});

    result = "Success"; 

    }       

    catch (err)  {
        snowflake.execute( {sqlText: "rollback;"} )
        var clean_error_msg = err.message.replace(/[^\w\s]/gi, '');
    //  Create a log entry to say INSERT STATEMENT failed
    
    log_sql_command = "call datahub_logging.sp_etl_log_ingestion_process('UpdateEnd','" + process_name + "','Failed','MERGE Failed. Error:" + err.code.toString()+" : "+ clean_error_msg  + "', 0 ,0,0);";
    snowflake.execute({sqlText: log_sql_command});
        ;
        throw "Failed: " + err.message;   // Return a success/error indicator.
        }
    return result;
    $$;