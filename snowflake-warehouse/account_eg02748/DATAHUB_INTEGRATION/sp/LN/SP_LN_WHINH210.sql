create or replace procedure DATAHUB_INTEGRATION.SP_LN_WHINH210()
    returns varchar not null
                language javascript
                as
                $$

//  Variables

var result = "";                                    // return status of this proc call
const process_name = Object.keys(this)[0];          // name of currently executing process
var number_of_rows_inserted = 0;                             // track number of rows we have inserted
var number_of_rows_updated = 0;                             // track number of rows we have updated


//  Step 1.

//  Start execution - log start

log_sql_command = "call datahub_logging.sp_etl_log_ingestion_process('Insert','" + process_name + "','Running','Started process execution.', 0,0,0);";
snowflake.execute({sqlText: log_sql_command});

snowflake.execute( {sqlText: "begin transaction;"} );
try
    {
        var sql_command = `
                            INSERT INTO LANDING_ERROR.LN_RAW_ERROR
                            SELECT * FROM LANDING_ERROR.VW_STREAM_LN_WHINH210_ERROR`;
    var sqlStmt = snowflake.createStatement( {sqlText:  sql_command} );
    var rs = sqlStmt.execute();
        
        var sql_command = ` 
                            merge into  TARGET_LN.LN_WHINH210 as target using (SELECT * FROM (SELECT 
            strm.acti, 
            strm.acvt, 
            strm.acvt_kw, 
            strm.adin, 
            strm.atse, 
            strm.atse_ref_compnr, 
            strm.bflh, 
            strm.bflh_kw, 
            strm.bgxc, 
            strm.bgxc_kw, 
            strm.blck, 
            strm.blck_kw, 
            strm.bpit, 
            strm.casi, 
            strm.casi_ref_compnr, 
            strm.cdck, 
            strm.cdck_kw, 
            strm.clot, 
            strm.cmnf, 
            strm.cmnf_ref_compnr, 
            strm.comp, 
            strm.compnr, 
            strm.csvc, 
            strm.csvc_ref_compnr, 
            strm.csvl, 
            strm.cwar, 
            strm.cwar_ref_compnr, 
            strm.deleted, 
            strm.dslo, 
            strm.effn, 
            strm.effn_ref_compnr, 
            strm.fact, 
            strm.fcco, 
            strm.fcco_ref_compnr, 
            strm.fire, 
            strm.fire_kw, 
            strm.fmln, 
            strm.fmor, 
            strm.fprj, 
            strm.fprj_ref_compnr, 
            strm.fshl, 
            strm.fshn, 
            strm.fspa, 
            strm.fstl, 
            strm.gefo, 
            strm.gefo_kw, 
            strm.gnld, 
            strm.hstd, 
            strm.hstd_kw, 
            strm.hstq, 
            strm.hstq_kw, 
            strm.insp, 
            strm.insp_kw, 
            strm.inup, 
            strm.inup_kw, 
            strm.ipay, 
            strm.ipay_kw, 
            strm.item, 
            strm.item_atse_ref_compnr, 
            strm.item_clot_ref_compnr, 
            strm.item_pkdf_ref_compnr, 
            strm.item_ref_compnr, 
            strm.iubw, 
            strm.iubw_kw, 
            strm.kbpr, 
            strm.kbpr_kw, 
            strm.lccl, 
            strm.lccl_ref_compnr, 
            strm.lsel, 
            strm.lsel_kw, 
            strm.lsta, 
            strm.lsta_kw, 
            strm.mpnr, 
            strm.ocur, 
            strm.ocur_ref_compnr, 
            strm.oorg, 
            strm.oorg_kw, 
            strm.oorg_orno_oset_ref_compnr, 
            strm.orno, 
            strm.orpr, 
            strm.orun, 
            strm.orun_ref_compnr, 
            strm.oset, 
            strm.ownr, 
            strm.ownr_ref_compnr, 
            strm.owns, 
            strm.owns_kw, 
            strm.paym, 
            strm.paym_kw, 
            strm.pkdf, 
            strm.pkdf_ref_compnr, 
            strm.pmsk, 
            strm.pono, 
            strm.prdt, 
            strm.prjp, 
            strm.prjp_kw, 
            strm.psqp, 
            strm.psqu, 
            strm.qadi, 
            strm.qadp, 
            strm.qadv, 
            strm.qapp, 
            strm.qapr, 
            strm.qapu, 
            strm.qdep, 
            strm.qdes, 
            strm.qgip, 
            strm.qgit, 
            strm.qiip, 
            strm.qiit, 
            strm.qopu, 
            strm.qorc, 
            strm.qord, 
            strm.qoro, 
            strm.qorp, 
            strm.qppu, 
            strm.qpui, 
            strm.qpup, 
            strm.qput, 
            strm.qrec, 
            strm.qrej, 
            strm.qrep, 
            strm.qrpu, 
            strm.qrsc, 
            strm.qrsp, 
            strm.qtbp, 
            strm.qtbr, 
            strm.rclo, 
            strm.refe, 
            strm.revi, 
            strm.rorg, 
            strm.rorg_kw, 
            strm.rorn, 
            strm.rowc, 
            strm.rowc_ref_compnr, 
            strm.rown, 
            strm.rown_ref_compnr, 
            strm.rpon, 
            strm.rseq, 
            strm.seqn, 
            strm.sequencenumber, 
            strm.serl, 
            strm.sfbp, 
            strm.sfbp_ref_compnr, 
            strm.spcn, 
            strm.stag, 
            strm.tact, 
            strm.tcco, 
            strm.tcco_ref_compnr, 
            strm.timestamp, 
            strm.tlot, 
            strm.tprj, 
            strm.tprj_ref_compnr, 
            strm.tspa, 
            strm.tsrl, 
            strm.tstl, 
            strm.txtn, 
            strm.txtn_ref_compnr, 
            strm.username, 
            strm.uwop, 
            strm.uwop_kw, 
            strm.wmss, 
            strm.wmss_kw, 
            strm.ETL_SEQUENCE_NUMBER,
            strm.ETL_DELETED,
            strm.etl_load_datetime,
            strm.etl_load_metadatafilename,
            ROW_NUMBER() OVER (PARTITION BY 
            strm.compnr,
            strm.oorg,
            strm.orno,
            strm.pono,
            strm.seqn ORDER BY strm.ETL_SEQUENCE_NUMBER desc,IFNULL(TRY_TO_TIMESTAMP(replace(right(replace(lower(etl_load_metadatafilename),'.json'),23),'_','-'), 'yyyy-mm-dd-HH-MI-SS-FF') ,etl_load_datetime) desc) as ROWNUMBER
        FROM DATAHUB_INTEGRATION.VW_STREAM_LN_WHINH210 as  strm
                    )   
            WHERE ROWNUMBER=1  
            
                    ) as src on
            ((target.compnr=src.compnr) OR (target.compnr IS NULL AND src.compnr IS NULL)) AND
            ((target.oorg=src.oorg) OR (target.oorg IS NULL AND src.oorg IS NULL)) AND
            ((target.orno=src.orno) OR (target.orno IS NULL AND src.orno IS NULL)) AND
            ((target.pono=src.pono) OR (target.pono IS NULL AND src.pono IS NULL)) AND
            ((target.seqn=src.seqn) OR (target.seqn IS NULL AND src.seqn IS NULL)) 
                when matched and src.ETL_DELETED=TRUE THEN DELETE
                when matched then update set
                    target.acti=src.acti, 
                    target.acvt=src.acvt, 
                    target.acvt_kw=src.acvt_kw, 
                    target.adin=src.adin, 
                    target.atse=src.atse, 
                    target.atse_ref_compnr=src.atse_ref_compnr, 
                    target.bflh=src.bflh, 
                    target.bflh_kw=src.bflh_kw, 
                    target.bgxc=src.bgxc, 
                    target.bgxc_kw=src.bgxc_kw, 
                    target.blck=src.blck, 
                    target.blck_kw=src.blck_kw, 
                    target.bpit=src.bpit, 
                    target.casi=src.casi, 
                    target.casi_ref_compnr=src.casi_ref_compnr, 
                    target.cdck=src.cdck, 
                    target.cdck_kw=src.cdck_kw, 
                    target.clot=src.clot, 
                    target.cmnf=src.cmnf, 
                    target.cmnf_ref_compnr=src.cmnf_ref_compnr, 
                    target.comp=src.comp, 
                    target.compnr=src.compnr, 
                    target.csvc=src.csvc, 
                    target.csvc_ref_compnr=src.csvc_ref_compnr, 
                    target.csvl=src.csvl, 
                    target.cwar=src.cwar, 
                    target.cwar_ref_compnr=src.cwar_ref_compnr, 
                    target.deleted=src.deleted, 
                    target.dslo=src.dslo, 
                    target.effn=src.effn, 
                    target.effn_ref_compnr=src.effn_ref_compnr, 
                    target.fact=src.fact, 
                    target.fcco=src.fcco, 
                    target.fcco_ref_compnr=src.fcco_ref_compnr, 
                    target.fire=src.fire, 
                    target.fire_kw=src.fire_kw, 
                    target.fmln=src.fmln, 
                    target.fmor=src.fmor, 
                    target.fprj=src.fprj, 
                    target.fprj_ref_compnr=src.fprj_ref_compnr, 
                    target.fshl=src.fshl, 
                    target.fshn=src.fshn, 
                    target.fspa=src.fspa, 
                    target.fstl=src.fstl, 
                    target.gefo=src.gefo, 
                    target.gefo_kw=src.gefo_kw, 
                    target.gnld=src.gnld, 
                    target.hstd=src.hstd, 
                    target.hstd_kw=src.hstd_kw, 
                    target.hstq=src.hstq, 
                    target.hstq_kw=src.hstq_kw, 
                    target.insp=src.insp, 
                    target.insp_kw=src.insp_kw, 
                    target.inup=src.inup, 
                    target.inup_kw=src.inup_kw, 
                    target.ipay=src.ipay, 
                    target.ipay_kw=src.ipay_kw, 
                    target.item=src.item, 
                    target.item_atse_ref_compnr=src.item_atse_ref_compnr, 
                    target.item_clot_ref_compnr=src.item_clot_ref_compnr, 
                    target.item_pkdf_ref_compnr=src.item_pkdf_ref_compnr, 
                    target.item_ref_compnr=src.item_ref_compnr, 
                    target.iubw=src.iubw, 
                    target.iubw_kw=src.iubw_kw, 
                    target.kbpr=src.kbpr, 
                    target.kbpr_kw=src.kbpr_kw, 
                    target.lccl=src.lccl, 
                    target.lccl_ref_compnr=src.lccl_ref_compnr, 
                    target.lsel=src.lsel, 
                    target.lsel_kw=src.lsel_kw, 
                    target.lsta=src.lsta, 
                    target.lsta_kw=src.lsta_kw, 
                    target.mpnr=src.mpnr, 
                    target.ocur=src.ocur, 
                    target.ocur_ref_compnr=src.ocur_ref_compnr, 
                    target.oorg=src.oorg, 
                    target.oorg_kw=src.oorg_kw, 
                    target.oorg_orno_oset_ref_compnr=src.oorg_orno_oset_ref_compnr, 
                    target.orno=src.orno, 
                    target.orpr=src.orpr, 
                    target.orun=src.orun, 
                    target.orun_ref_compnr=src.orun_ref_compnr, 
                    target.oset=src.oset, 
                    target.ownr=src.ownr, 
                    target.ownr_ref_compnr=src.ownr_ref_compnr, 
                    target.owns=src.owns, 
                    target.owns_kw=src.owns_kw, 
                    target.paym=src.paym, 
                    target.paym_kw=src.paym_kw, 
                    target.pkdf=src.pkdf, 
                    target.pkdf_ref_compnr=src.pkdf_ref_compnr, 
                    target.pmsk=src.pmsk, 
                    target.pono=src.pono, 
                    target.prdt=src.prdt, 
                    target.prjp=src.prjp, 
                    target.prjp_kw=src.prjp_kw, 
                    target.psqp=src.psqp, 
                    target.psqu=src.psqu, 
                    target.qadi=src.qadi, 
                    target.qadp=src.qadp, 
                    target.qadv=src.qadv, 
                    target.qapp=src.qapp, 
                    target.qapr=src.qapr, 
                    target.qapu=src.qapu, 
                    target.qdep=src.qdep, 
                    target.qdes=src.qdes, 
                    target.qgip=src.qgip, 
                    target.qgit=src.qgit, 
                    target.qiip=src.qiip, 
                    target.qiit=src.qiit, 
                    target.qopu=src.qopu, 
                    target.qorc=src.qorc, 
                    target.qord=src.qord, 
                    target.qoro=src.qoro, 
                    target.qorp=src.qorp, 
                    target.qppu=src.qppu, 
                    target.qpui=src.qpui, 
                    target.qpup=src.qpup, 
                    target.qput=src.qput, 
                    target.qrec=src.qrec, 
                    target.qrej=src.qrej, 
                    target.qrep=src.qrep, 
                    target.qrpu=src.qrpu, 
                    target.qrsc=src.qrsc, 
                    target.qrsp=src.qrsp, 
                    target.qtbp=src.qtbp, 
                    target.qtbr=src.qtbr, 
                    target.rclo=src.rclo, 
                    target.refe=src.refe, 
                    target.revi=src.revi, 
                    target.rorg=src.rorg, 
                    target.rorg_kw=src.rorg_kw, 
                    target.rorn=src.rorn, 
                    target.rowc=src.rowc, 
                    target.rowc_ref_compnr=src.rowc_ref_compnr, 
                    target.rown=src.rown, 
                    target.rown_ref_compnr=src.rown_ref_compnr, 
                    target.rpon=src.rpon, 
                    target.rseq=src.rseq, 
                    target.seqn=src.seqn, 
                    target.sequencenumber=src.sequencenumber, 
                    target.serl=src.serl, 
                    target.sfbp=src.sfbp, 
                    target.sfbp_ref_compnr=src.sfbp_ref_compnr, 
                    target.spcn=src.spcn, 
                    target.stag=src.stag, 
                    target.tact=src.tact, 
                    target.tcco=src.tcco, 
                    target.tcco_ref_compnr=src.tcco_ref_compnr, 
                    target.timestamp=src.timestamp, 
                    target.tlot=src.tlot, 
                    target.tprj=src.tprj, 
                    target.tprj_ref_compnr=src.tprj_ref_compnr, 
                    target.tspa=src.tspa, 
                    target.tsrl=src.tsrl, 
                    target.tstl=src.tstl, 
                    target.txtn=src.txtn, 
                    target.txtn_ref_compnr=src.txtn_ref_compnr, 
                    target.username=src.username, 
                    target.uwop=src.uwop, 
                    target.uwop_kw=src.uwop_kw, 
                    target.wmss=src.wmss, 
                    target.wmss_kw=src.wmss_kw, 
                    target.ETL_SEQUENCE_NUMBER=src.ETL_SEQUENCE_NUMBER,
                    target.etl_load_datetime=CURRENT_TIMESTAMP,
                    target.etl_load_metadatafilename=src.etl_load_metadatafilename
        when not matched and (src.ETL_DELETED=FALSE OR src.ETL_DELETED IS NULL)  then insert ( 
                    acti, 
                    acvt, 
                    acvt_kw, 
                    adin, 
                    atse, 
                    atse_ref_compnr, 
                    bflh, 
                    bflh_kw, 
                    bgxc, 
                    bgxc_kw, 
                    blck, 
                    blck_kw, 
                    bpit, 
                    casi, 
                    casi_ref_compnr, 
                    cdck, 
                    cdck_kw, 
                    clot, 
                    cmnf, 
                    cmnf_ref_compnr, 
                    comp, 
                    compnr, 
                    csvc, 
                    csvc_ref_compnr, 
                    csvl, 
                    cwar, 
                    cwar_ref_compnr, 
                    deleted, 
                    dslo, 
                    effn, 
                    effn_ref_compnr, 
                    fact, 
                    fcco, 
                    fcco_ref_compnr, 
                    fire, 
                    fire_kw, 
                    fmln, 
                    fmor, 
                    fprj, 
                    fprj_ref_compnr, 
                    fshl, 
                    fshn, 
                    fspa, 
                    fstl, 
                    gefo, 
                    gefo_kw, 
                    gnld, 
                    hstd, 
                    hstd_kw, 
                    hstq, 
                    hstq_kw, 
                    insp, 
                    insp_kw, 
                    inup, 
                    inup_kw, 
                    ipay, 
                    ipay_kw, 
                    item, 
                    item_atse_ref_compnr, 
                    item_clot_ref_compnr, 
                    item_pkdf_ref_compnr, 
                    item_ref_compnr, 
                    iubw, 
                    iubw_kw, 
                    kbpr, 
                    kbpr_kw, 
                    lccl, 
                    lccl_ref_compnr, 
                    lsel, 
                    lsel_kw, 
                    lsta, 
                    lsta_kw, 
                    mpnr, 
                    ocur, 
                    ocur_ref_compnr, 
                    oorg, 
                    oorg_kw, 
                    oorg_orno_oset_ref_compnr, 
                    orno, 
                    orpr, 
                    orun, 
                    orun_ref_compnr, 
                    oset, 
                    ownr, 
                    ownr_ref_compnr, 
                    owns, 
                    owns_kw, 
                    paym, 
                    paym_kw, 
                    pkdf, 
                    pkdf_ref_compnr, 
                    pmsk, 
                    pono, 
                    prdt, 
                    prjp, 
                    prjp_kw, 
                    psqp, 
                    psqu, 
                    qadi, 
                    qadp, 
                    qadv, 
                    qapp, 
                    qapr, 
                    qapu, 
                    qdep, 
                    qdes, 
                    qgip, 
                    qgit, 
                    qiip, 
                    qiit, 
                    qopu, 
                    qorc, 
                    qord, 
                    qoro, 
                    qorp, 
                    qppu, 
                    qpui, 
                    qpup, 
                    qput, 
                    qrec, 
                    qrej, 
                    qrep, 
                    qrpu, 
                    qrsc, 
                    qrsp, 
                    qtbp, 
                    qtbr, 
                    rclo, 
                    refe, 
                    revi, 
                    rorg, 
                    rorg_kw, 
                    rorn, 
                    rowc, 
                    rowc_ref_compnr, 
                    rown, 
                    rown_ref_compnr, 
                    rpon, 
                    rseq, 
                    seqn, 
                    sequencenumber, 
                    serl, 
                    sfbp, 
                    sfbp_ref_compnr, 
                    spcn, 
                    stag, 
                    tact, 
                    tcco, 
                    tcco_ref_compnr, 
                    timestamp, 
                    tlot, 
                    tprj, 
                    tprj_ref_compnr, 
                    tspa, 
                    tsrl, 
                    tstl, 
                    txtn, 
                    txtn_ref_compnr, 
                    username, 
                    uwop, 
                    uwop_kw, 
                    wmss, 
                    wmss_kw, 
                    ETL_SEQUENCE_NUMBER,                       
                    etl_load_datetime,
                    etl_load_metadatafilename) 
            values (
                    src.acti, 
                    src.acvt, 
                    src.acvt_kw, 
                    src.adin, 
                    src.atse, 
                    src.atse_ref_compnr, 
                    src.bflh, 
                    src.bflh_kw, 
                    src.bgxc, 
                    src.bgxc_kw, 
                    src.blck, 
                    src.blck_kw, 
                    src.bpit, 
                    src.casi, 
                    src.casi_ref_compnr, 
                    src.cdck, 
                    src.cdck_kw, 
                    src.clot, 
                    src.cmnf, 
                    src.cmnf_ref_compnr, 
                    src.comp, 
                    src.compnr, 
                    src.csvc, 
                    src.csvc_ref_compnr, 
                    src.csvl, 
                    src.cwar, 
                    src.cwar_ref_compnr, 
                    src.deleted, 
                    src.dslo, 
                    src.effn, 
                    src.effn_ref_compnr, 
                    src.fact, 
                    src.fcco, 
                    src.fcco_ref_compnr, 
                    src.fire, 
                    src.fire_kw, 
                    src.fmln, 
                    src.fmor, 
                    src.fprj, 
                    src.fprj_ref_compnr, 
                    src.fshl, 
                    src.fshn, 
                    src.fspa, 
                    src.fstl, 
                    src.gefo, 
                    src.gefo_kw, 
                    src.gnld, 
                    src.hstd, 
                    src.hstd_kw, 
                    src.hstq, 
                    src.hstq_kw, 
                    src.insp, 
                    src.insp_kw, 
                    src.inup, 
                    src.inup_kw, 
                    src.ipay, 
                    src.ipay_kw, 
                    src.item, 
                    src.item_atse_ref_compnr, 
                    src.item_clot_ref_compnr, 
                    src.item_pkdf_ref_compnr, 
                    src.item_ref_compnr, 
                    src.iubw, 
                    src.iubw_kw, 
                    src.kbpr, 
                    src.kbpr_kw, 
                    src.lccl, 
                    src.lccl_ref_compnr, 
                    src.lsel, 
                    src.lsel_kw, 
                    src.lsta, 
                    src.lsta_kw, 
                    src.mpnr, 
                    src.ocur, 
                    src.ocur_ref_compnr, 
                    src.oorg, 
                    src.oorg_kw, 
                    src.oorg_orno_oset_ref_compnr, 
                    src.orno, 
                    src.orpr, 
                    src.orun, 
                    src.orun_ref_compnr, 
                    src.oset, 
                    src.ownr, 
                    src.ownr_ref_compnr, 
                    src.owns, 
                    src.owns_kw, 
                    src.paym, 
                    src.paym_kw, 
                    src.pkdf, 
                    src.pkdf_ref_compnr, 
                    src.pmsk, 
                    src.pono, 
                    src.prdt, 
                    src.prjp, 
                    src.prjp_kw, 
                    src.psqp, 
                    src.psqu, 
                    src.qadi, 
                    src.qadp, 
                    src.qadv, 
                    src.qapp, 
                    src.qapr, 
                    src.qapu, 
                    src.qdep, 
                    src.qdes, 
                    src.qgip, 
                    src.qgit, 
                    src.qiip, 
                    src.qiit, 
                    src.qopu, 
                    src.qorc, 
                    src.qord, 
                    src.qoro, 
                    src.qorp, 
                    src.qppu, 
                    src.qpui, 
                    src.qpup, 
                    src.qput, 
                    src.qrec, 
                    src.qrej, 
                    src.qrep, 
                    src.qrpu, 
                    src.qrsc, 
                    src.qrsp, 
                    src.qtbp, 
                    src.qtbr, 
                    src.rclo, 
                    src.refe, 
                    src.revi, 
                    src.rorg, 
                    src.rorg_kw, 
                    src.rorn, 
                    src.rowc, 
                    src.rowc_ref_compnr, 
                    src.rown, 
                    src.rown_ref_compnr, 
                    src.rpon, 
                    src.rseq, 
                    src.seqn, 
                    src.sequencenumber, 
                    src.serl, 
                    src.sfbp, 
                    src.sfbp_ref_compnr, 
                    src.spcn, 
                    src.stag, 
                    src.tact, 
                    src.tcco, 
                    src.tcco_ref_compnr, 
                    src.timestamp, 
                    src.tlot, 
                    src.tprj, 
                    src.tprj_ref_compnr, 
                    src.tspa, 
                    src.tsrl, 
                    src.tstl, 
                    src.txtn, 
                    src.txtn_ref_compnr, 
                    src.username, 
                    src.uwop, 
                    src.uwop_kw, 
                    src.wmss, 
                    src.wmss_kw,     
                    src.ETL_SEQUENCE_NUMBER,
                    CURRENT_TIMESTAMP,
                    src.etl_load_metadatafilename);`;

    var sqlStmt = snowflake.createStatement( {sqlText:  sql_command} );
    var rs = sqlStmt.execute();

    snowflake.execute( {sqlText: `merge into TARGET_HISTORY_LN.LN_WHINH210_DELETED as target using (
                SELECT * FROM (SELECT 
            strm.acti, 
            strm.acvt, 
            strm.acvt_kw, 
            strm.adin, 
            strm.atse, 
            strm.atse_ref_compnr, 
            strm.bflh, 
            strm.bflh_kw, 
            strm.bgxc, 
            strm.bgxc_kw, 
            strm.blck, 
            strm.blck_kw, 
            strm.bpit, 
            strm.casi, 
            strm.casi_ref_compnr, 
            strm.cdck, 
            strm.cdck_kw, 
            strm.clot, 
            strm.cmnf, 
            strm.cmnf_ref_compnr, 
            strm.comp, 
            strm.compnr, 
            strm.csvc, 
            strm.csvc_ref_compnr, 
            strm.csvl, 
            strm.cwar, 
            strm.cwar_ref_compnr, 
            strm.deleted, 
            strm.dslo, 
            strm.effn, 
            strm.effn_ref_compnr, 
            strm.fact, 
            strm.fcco, 
            strm.fcco_ref_compnr, 
            strm.fire, 
            strm.fire_kw, 
            strm.fmln, 
            strm.fmor, 
            strm.fprj, 
            strm.fprj_ref_compnr, 
            strm.fshl, 
            strm.fshn, 
            strm.fspa, 
            strm.fstl, 
            strm.gefo, 
            strm.gefo_kw, 
            strm.gnld, 
            strm.hstd, 
            strm.hstd_kw, 
            strm.hstq, 
            strm.hstq_kw, 
            strm.insp, 
            strm.insp_kw, 
            strm.inup, 
            strm.inup_kw, 
            strm.ipay, 
            strm.ipay_kw, 
            strm.item, 
            strm.item_atse_ref_compnr, 
            strm.item_clot_ref_compnr, 
            strm.item_pkdf_ref_compnr, 
            strm.item_ref_compnr, 
            strm.iubw, 
            strm.iubw_kw, 
            strm.kbpr, 
            strm.kbpr_kw, 
            strm.lccl, 
            strm.lccl_ref_compnr, 
            strm.lsel, 
            strm.lsel_kw, 
            strm.lsta, 
            strm.lsta_kw, 
            strm.mpnr, 
            strm.ocur, 
            strm.ocur_ref_compnr, 
            strm.oorg, 
            strm.oorg_kw, 
            strm.oorg_orno_oset_ref_compnr, 
            strm.orno, 
            strm.orpr, 
            strm.orun, 
            strm.orun_ref_compnr, 
            strm.oset, 
            strm.ownr, 
            strm.ownr_ref_compnr, 
            strm.owns, 
            strm.owns_kw, 
            strm.paym, 
            strm.paym_kw, 
            strm.pkdf, 
            strm.pkdf_ref_compnr, 
            strm.pmsk, 
            strm.pono, 
            strm.prdt, 
            strm.prjp, 
            strm.prjp_kw, 
            strm.psqp, 
            strm.psqu, 
            strm.qadi, 
            strm.qadp, 
            strm.qadv, 
            strm.qapp, 
            strm.qapr, 
            strm.qapu, 
            strm.qdep, 
            strm.qdes, 
            strm.qgip, 
            strm.qgit, 
            strm.qiip, 
            strm.qiit, 
            strm.qopu, 
            strm.qorc, 
            strm.qord, 
            strm.qoro, 
            strm.qorp, 
            strm.qppu, 
            strm.qpui, 
            strm.qpup, 
            strm.qput, 
            strm.qrec, 
            strm.qrej, 
            strm.qrep, 
            strm.qrpu, 
            strm.qrsc, 
            strm.qrsp, 
            strm.qtbp, 
            strm.qtbr, 
            strm.rclo, 
            strm.refe, 
            strm.revi, 
            strm.rorg, 
            strm.rorg_kw, 
            strm.rorn, 
            strm.rowc, 
            strm.rowc_ref_compnr, 
            strm.rown, 
            strm.rown_ref_compnr, 
            strm.rpon, 
            strm.rseq, 
            strm.seqn, 
            strm.sequencenumber, 
            strm.serl, 
            strm.sfbp, 
            strm.sfbp_ref_compnr, 
            strm.spcn, 
            strm.stag, 
            strm.tact, 
            strm.tcco, 
            strm.tcco_ref_compnr, 
            strm.timestamp, 
            strm.tlot, 
            strm.tprj, 
            strm.tprj_ref_compnr, 
            strm.tspa, 
            strm.tsrl, 
            strm.tstl, 
            strm.txtn, 
            strm.txtn_ref_compnr, 
            strm.username, 
            strm.uwop, 
            strm.uwop_kw, 
            strm.wmss, 
            strm.wmss_kw, 
            strm.ETL_SEQUENCE_NUMBER,
            strm.ETL_DELETED,
            strm.etl_load_datetime,
            strm.etl_load_metadatafilename,
            ROW_NUMBER() OVER (PARTITION BY 
            strm.compnr,
            strm.oorg,
            strm.orno,
            strm.pono,
            strm.seqn ORDER BY strm.ETL_SEQUENCE_NUMBER desc,IFNULL(TRY_TO_TIMESTAMP(replace(right(replace(lower(etl_load_metadatafilename),'.json'),23),'_','-'), 'yyyy-mm-dd-HH-MI-SS-FF') ,etl_load_datetime) desc) as ROWNUMBER
        FROM DATAHUB_INTEGRATION.VW_STREAM_LN_WHINH210 as  strm
        WHERE strm.ETL_DELETED=TRUE
                    )   
            WHERE ROWNUMBER=1  
            
                    ) as src on
            ((target.compnr=src.compnr) OR (target.compnr IS NULL AND src.compnr IS NULL)) AND
            ((target.oorg=src.oorg) OR (target.oorg IS NULL AND src.oorg IS NULL)) AND
            ((target.orno=src.orno) OR (target.orno IS NULL AND src.orno IS NULL)) AND
            ((target.pono=src.pono) OR (target.pono IS NULL AND src.pono IS NULL)) AND
            ((target.seqn=src.seqn) OR (target.seqn IS NULL AND src.seqn IS NULL)) 
                when matched then update set
                    target.acti=src.acti, 
                    target.acvt=src.acvt, 
                    target.acvt_kw=src.acvt_kw, 
                    target.adin=src.adin, 
                    target.atse=src.atse, 
                    target.atse_ref_compnr=src.atse_ref_compnr, 
                    target.bflh=src.bflh, 
                    target.bflh_kw=src.bflh_kw, 
                    target.bgxc=src.bgxc, 
                    target.bgxc_kw=src.bgxc_kw, 
                    target.blck=src.blck, 
                    target.blck_kw=src.blck_kw, 
                    target.bpit=src.bpit, 
                    target.casi=src.casi, 
                    target.casi_ref_compnr=src.casi_ref_compnr, 
                    target.cdck=src.cdck, 
                    target.cdck_kw=src.cdck_kw, 
                    target.clot=src.clot, 
                    target.cmnf=src.cmnf, 
                    target.cmnf_ref_compnr=src.cmnf_ref_compnr, 
                    target.comp=src.comp, 
                    target.compnr=src.compnr, 
                    target.csvc=src.csvc, 
                    target.csvc_ref_compnr=src.csvc_ref_compnr, 
                    target.csvl=src.csvl, 
                    target.cwar=src.cwar, 
                    target.cwar_ref_compnr=src.cwar_ref_compnr, 
                    target.deleted=src.deleted, 
                    target.dslo=src.dslo, 
                    target.effn=src.effn, 
                    target.effn_ref_compnr=src.effn_ref_compnr, 
                    target.fact=src.fact, 
                    target.fcco=src.fcco, 
                    target.fcco_ref_compnr=src.fcco_ref_compnr, 
                    target.fire=src.fire, 
                    target.fire_kw=src.fire_kw, 
                    target.fmln=src.fmln, 
                    target.fmor=src.fmor, 
                    target.fprj=src.fprj, 
                    target.fprj_ref_compnr=src.fprj_ref_compnr, 
                    target.fshl=src.fshl, 
                    target.fshn=src.fshn, 
                    target.fspa=src.fspa, 
                    target.fstl=src.fstl, 
                    target.gefo=src.gefo, 
                    target.gefo_kw=src.gefo_kw, 
                    target.gnld=src.gnld, 
                    target.hstd=src.hstd, 
                    target.hstd_kw=src.hstd_kw, 
                    target.hstq=src.hstq, 
                    target.hstq_kw=src.hstq_kw, 
                    target.insp=src.insp, 
                    target.insp_kw=src.insp_kw, 
                    target.inup=src.inup, 
                    target.inup_kw=src.inup_kw, 
                    target.ipay=src.ipay, 
                    target.ipay_kw=src.ipay_kw, 
                    target.item=src.item, 
                    target.item_atse_ref_compnr=src.item_atse_ref_compnr, 
                    target.item_clot_ref_compnr=src.item_clot_ref_compnr, 
                    target.item_pkdf_ref_compnr=src.item_pkdf_ref_compnr, 
                    target.item_ref_compnr=src.item_ref_compnr, 
                    target.iubw=src.iubw, 
                    target.iubw_kw=src.iubw_kw, 
                    target.kbpr=src.kbpr, 
                    target.kbpr_kw=src.kbpr_kw, 
                    target.lccl=src.lccl, 
                    target.lccl_ref_compnr=src.lccl_ref_compnr, 
                    target.lsel=src.lsel, 
                    target.lsel_kw=src.lsel_kw, 
                    target.lsta=src.lsta, 
                    target.lsta_kw=src.lsta_kw, 
                    target.mpnr=src.mpnr, 
                    target.ocur=src.ocur, 
                    target.ocur_ref_compnr=src.ocur_ref_compnr, 
                    target.oorg=src.oorg, 
                    target.oorg_kw=src.oorg_kw, 
                    target.oorg_orno_oset_ref_compnr=src.oorg_orno_oset_ref_compnr, 
                    target.orno=src.orno, 
                    target.orpr=src.orpr, 
                    target.orun=src.orun, 
                    target.orun_ref_compnr=src.orun_ref_compnr, 
                    target.oset=src.oset, 
                    target.ownr=src.ownr, 
                    target.ownr_ref_compnr=src.ownr_ref_compnr, 
                    target.owns=src.owns, 
                    target.owns_kw=src.owns_kw, 
                    target.paym=src.paym, 
                    target.paym_kw=src.paym_kw, 
                    target.pkdf=src.pkdf, 
                    target.pkdf_ref_compnr=src.pkdf_ref_compnr, 
                    target.pmsk=src.pmsk, 
                    target.pono=src.pono, 
                    target.prdt=src.prdt, 
                    target.prjp=src.prjp, 
                    target.prjp_kw=src.prjp_kw, 
                    target.psqp=src.psqp, 
                    target.psqu=src.psqu, 
                    target.qadi=src.qadi, 
                    target.qadp=src.qadp, 
                    target.qadv=src.qadv, 
                    target.qapp=src.qapp, 
                    target.qapr=src.qapr, 
                    target.qapu=src.qapu, 
                    target.qdep=src.qdep, 
                    target.qdes=src.qdes, 
                    target.qgip=src.qgip, 
                    target.qgit=src.qgit, 
                    target.qiip=src.qiip, 
                    target.qiit=src.qiit, 
                    target.qopu=src.qopu, 
                    target.qorc=src.qorc, 
                    target.qord=src.qord, 
                    target.qoro=src.qoro, 
                    target.qorp=src.qorp, 
                    target.qppu=src.qppu, 
                    target.qpui=src.qpui, 
                    target.qpup=src.qpup, 
                    target.qput=src.qput, 
                    target.qrec=src.qrec, 
                    target.qrej=src.qrej, 
                    target.qrep=src.qrep, 
                    target.qrpu=src.qrpu, 
                    target.qrsc=src.qrsc, 
                    target.qrsp=src.qrsp, 
                    target.qtbp=src.qtbp, 
                    target.qtbr=src.qtbr, 
                    target.rclo=src.rclo, 
                    target.refe=src.refe, 
                    target.revi=src.revi, 
                    target.rorg=src.rorg, 
                    target.rorg_kw=src.rorg_kw, 
                    target.rorn=src.rorn, 
                    target.rowc=src.rowc, 
                    target.rowc_ref_compnr=src.rowc_ref_compnr, 
                    target.rown=src.rown, 
                    target.rown_ref_compnr=src.rown_ref_compnr, 
                    target.rpon=src.rpon, 
                    target.rseq=src.rseq, 
                    target.seqn=src.seqn, 
                    target.sequencenumber=src.sequencenumber, 
                    target.serl=src.serl, 
                    target.sfbp=src.sfbp, 
                    target.sfbp_ref_compnr=src.sfbp_ref_compnr, 
                    target.spcn=src.spcn, 
                    target.stag=src.stag, 
                    target.tact=src.tact, 
                    target.tcco=src.tcco, 
                    target.tcco_ref_compnr=src.tcco_ref_compnr, 
                    target.timestamp=src.timestamp, 
                    target.tlot=src.tlot, 
                    target.tprj=src.tprj, 
                    target.tprj_ref_compnr=src.tprj_ref_compnr, 
                    target.tspa=src.tspa, 
                    target.tsrl=src.tsrl, 
                    target.tstl=src.tstl, 
                    target.txtn=src.txtn, 
                    target.txtn_ref_compnr=src.txtn_ref_compnr, 
                    target.username=src.username, 
                    target.uwop=src.uwop, 
                    target.uwop_kw=src.uwop_kw, 
                    target.wmss=src.wmss, 
                    target.wmss_kw=src.wmss_kw, 
                    target.ETL_SEQUENCE_NUMBER=src.ETL_SEQUENCE_NUMBER,
                    target.etl_load_datetime=CURRENT_TIMESTAMP,
                    target.etl_load_metadatafilename=src.etl_load_metadatafilename,
                    target.ETL_DELETED=src.ETL_DELETED
        when not matched   then insert ( acti, acvt, acvt_kw, adin, atse, atse_ref_compnr, bflh, bflh_kw, bgxc, bgxc_kw, blck, blck_kw, bpit, casi, casi_ref_compnr, cdck, cdck_kw, clot, cmnf, cmnf_ref_compnr, comp, compnr, csvc, csvc_ref_compnr, csvl, cwar, cwar_ref_compnr, deleted, dslo, effn, effn_ref_compnr, fact, fcco, fcco_ref_compnr, fire, fire_kw, fmln, fmor, fprj, fprj_ref_compnr, fshl, fshn, fspa, fstl, gefo, gefo_kw, gnld, hstd, hstd_kw, hstq, hstq_kw, insp, insp_kw, inup, inup_kw, ipay, ipay_kw, item, item_atse_ref_compnr, item_clot_ref_compnr, item_pkdf_ref_compnr, item_ref_compnr, iubw, iubw_kw, kbpr, kbpr_kw, lccl, lccl_ref_compnr, lsel, lsel_kw, lsta, lsta_kw, mpnr, ocur, ocur_ref_compnr, oorg, oorg_kw, oorg_orno_oset_ref_compnr, orno, orpr, orun, orun_ref_compnr, oset, ownr, ownr_ref_compnr, owns, owns_kw, paym, paym_kw, pkdf, pkdf_ref_compnr, pmsk, pono, prdt, prjp, prjp_kw, psqp, psqu, qadi, qadp, qadv, qapp, qapr, qapu, qdep, qdes, qgip, qgit, qiip, qiit, qopu, qorc, qord, qoro, qorp, qppu, qpui, qpup, qput, qrec, qrej, qrep, qrpu, qrsc, qrsp, qtbp, qtbr, rclo, refe, revi, rorg, rorg_kw, rorn, rowc, rowc_ref_compnr, rown, rown_ref_compnr, rpon, rseq, seqn, sequencenumber, serl, sfbp, sfbp_ref_compnr, spcn, stag, tact, tcco, tcco_ref_compnr, timestamp, tlot, tprj, tprj_ref_compnr, tspa, tsrl, tstl, txtn, txtn_ref_compnr, username, uwop, uwop_kw, wmss, wmss_kw, 
                    ETL_SEQUENCE_NUMBER,                       
                    etl_load_datetime,
                    etl_load_metadatafilename,
                    etl_is_deleted,
                    ETL_DELETED) 
            values (
                    src.acti, 
                    src.acvt, 
                    src.acvt_kw, 
                    src.adin, 
                    src.atse, 
                    src.atse_ref_compnr, 
                    src.bflh, 
                    src.bflh_kw, 
                    src.bgxc, 
                    src.bgxc_kw, 
                    src.blck, 
                    src.blck_kw, 
                    src.bpit, 
                    src.casi, 
                    src.casi_ref_compnr, 
                    src.cdck, 
                    src.cdck_kw, 
                    src.clot, 
                    src.cmnf, 
                    src.cmnf_ref_compnr, 
                    src.comp, 
                    src.compnr, 
                    src.csvc, 
                    src.csvc_ref_compnr, 
                    src.csvl, 
                    src.cwar, 
                    src.cwar_ref_compnr, 
                    src.deleted, 
                    src.dslo, 
                    src.effn, 
                    src.effn_ref_compnr, 
                    src.fact, 
                    src.fcco, 
                    src.fcco_ref_compnr, 
                    src.fire, 
                    src.fire_kw, 
                    src.fmln, 
                    src.fmor, 
                    src.fprj, 
                    src.fprj_ref_compnr, 
                    src.fshl, 
                    src.fshn, 
                    src.fspa, 
                    src.fstl, 
                    src.gefo, 
                    src.gefo_kw, 
                    src.gnld, 
                    src.hstd, 
                    src.hstd_kw, 
                    src.hstq, 
                    src.hstq_kw, 
                    src.insp, 
                    src.insp_kw, 
                    src.inup, 
                    src.inup_kw, 
                    src.ipay, 
                    src.ipay_kw, 
                    src.item, 
                    src.item_atse_ref_compnr, 
                    src.item_clot_ref_compnr, 
                    src.item_pkdf_ref_compnr, 
                    src.item_ref_compnr, 
                    src.iubw, 
                    src.iubw_kw, 
                    src.kbpr, 
                    src.kbpr_kw, 
                    src.lccl, 
                    src.lccl_ref_compnr, 
                    src.lsel, 
                    src.lsel_kw, 
                    src.lsta, 
                    src.lsta_kw, 
                    src.mpnr, 
                    src.ocur, 
                    src.ocur_ref_compnr, 
                    src.oorg, 
                    src.oorg_kw, 
                    src.oorg_orno_oset_ref_compnr, 
                    src.orno, 
                    src.orpr, 
                    src.orun, 
                    src.orun_ref_compnr, 
                    src.oset, 
                    src.ownr, 
                    src.ownr_ref_compnr, 
                    src.owns, 
                    src.owns_kw, 
                    src.paym, 
                    src.paym_kw, 
                    src.pkdf, 
                    src.pkdf_ref_compnr, 
                    src.pmsk, 
                    src.pono, 
                    src.prdt, 
                    src.prjp, 
                    src.prjp_kw, 
                    src.psqp, 
                    src.psqu, 
                    src.qadi, 
                    src.qadp, 
                    src.qadv, 
                    src.qapp, 
                    src.qapr, 
                    src.qapu, 
                    src.qdep, 
                    src.qdes, 
                    src.qgip, 
                    src.qgit, 
                    src.qiip, 
                    src.qiit, 
                    src.qopu, 
                    src.qorc, 
                    src.qord, 
                    src.qoro, 
                    src.qorp, 
                    src.qppu, 
                    src.qpui, 
                    src.qpup, 
                    src.qput, 
                    src.qrec, 
                    src.qrej, 
                    src.qrep, 
                    src.qrpu, 
                    src.qrsc, 
                    src.qrsp, 
                    src.qtbp, 
                    src.qtbr, 
                    src.rclo, 
                    src.refe, 
                    src.revi, 
                    src.rorg, 
                    src.rorg_kw, 
                    src.rorn, 
                    src.rowc, 
                    src.rowc_ref_compnr, 
                    src.rown, 
                    src.rown_ref_compnr, 
                    src.rpon, 
                    src.rseq, 
                    src.seqn, 
                    src.sequencenumber, 
                    src.serl, 
                    src.sfbp, 
                    src.sfbp_ref_compnr, 
                    src.spcn, 
                    src.stag, 
                    src.tact, 
                    src.tcco, 
                    src.tcco_ref_compnr, 
                    src.timestamp, 
                    src.tlot, 
                    src.tprj, 
                    src.tprj_ref_compnr, 
                    src.tspa, 
                    src.tsrl, 
                    src.tstl, 
                    src.txtn, 
                    src.txtn_ref_compnr, 
                    src.username, 
                    src.uwop, 
                    src.uwop_kw, 
                    src.wmss, 
                    src.wmss_kw,     
                    src.ETL_SEQUENCE_NUMBER,
                    CURRENT_TIMESTAMP,
                    src.etl_load_metadatafilename,
                    case when ETL_DELETED=TRUE then TRUE else FALSE end,
                    ETL_DELETED);
    `
} );

                    
//  Get number of rows inserted
        
        var sqlStmt = snowflake.createStatement( {sqlText:  sql_command} );
        var rs = sqlStmt.execute();
        var number_of_rows_inserted = sqlStmt.getNumRowsInserted();
        var number_of_rows_updated =  sqlStmt.getNumRowsUpdated();
                    

        
    snowflake.execute ({sqlText: "commit"});

    log_sql_command = "call datahub_logging.sp_etl_log_ingestion_process('UpdateEnd','" + process_name + "','Success','Completed process execution.', 0 ," + number_of_rows_inserted.toString()+ "," +  number_of_rows_updated.toString() + ");";
    snowflake.execute({sqlText: log_sql_command});

    result = "Success"; 

    }       

    catch (err)  {
        snowflake.execute( {sqlText: "rollback;"} )
        var clean_error_msg = err.message.replace(/[^\w\s]/gi, '');
    //  Create a log entry to say INSERT STATEMENT failed
    
    log_sql_command = "call datahub_logging.sp_etl_log_ingestion_process('UpdateEnd','" + process_name + "','Failed','MERGE Failed. Error:" + err.code.toString()+" : "+ clean_error_msg  + "', 0 ,0,0);";
    snowflake.execute({sqlText: log_sql_command});
        ;
        throw "Failed: " + err.message;   // Return a success/error indicator.
        }
    return result;
    $$;