create or replace procedure DATAHUB_INTEGRATION.SP_IPS_WORKMANAGEMENT_HISTORY()
    returns varchar not null
                language javascript
                as
                $$

//  Variables

var result = "";                                    // return status of this proc call
const process_name = Object.keys(this)[0];          // name of currently executing process
var number_of_rows_inserted = 0;                             // track number of rows we have inserted
var number_of_rows_updated = 0;                             // track number of rows we have updated


//  Step 1.

//  Start execution - log start

log_sql_command = "call datahub_logging.sp_etl_log_ingestion_process('Insert','" + process_name + "','Running','Started process execution.', 0,0,0);";
snowflake.execute({sqlText: log_sql_command});

snowflake.execute( {sqlText: "begin transaction;"} );
try
    {
        var sql_command = `
                            INSERT INTO LANDING_ERROR.IPS_RAW_ERROR
                            SELECT * FROM LANDING_ERROR.VW_STREAM_IPS_WORKMANAGEMENT_HISTORY_ERROR`;
    var sqlStmt = snowflake.createStatement( {sqlText:  sql_command} );
    var rs = sqlStmt.execute();
        
        var sql_command = ` 
                            merge into  DATAHUB_TARGET.IPS_WORKMANAGEMENT_HISTORY as target using (SELECT * FROM (SELECT 
            strm.ACTKEY, 
            strm.ACTUALQTY, 
            strm.ADDBY, 
            strm.ADDDTTM, 
            strm.ADDRKEY, 
            strm.ASGNFLAG, 
            strm.ASSETINSPECTIONKEY, 
            strm.ASSIGNED, 
            strm.ASSVALTYPE, 
            strm.AUTH, 
            strm.BGTNO, 
            strm.BLDGFLOOR, 
            strm.BLDGROOM, 
            strm.BUDGETKEY, 
            strm.CANCELWORKORDER, 
            strm.CMPLKEY, 
            strm.COMMENTS, 
            strm.COMPBY, 
            strm.COMPDTTM, 
            strm.COMPFLAG, 
            strm.COMPKEY, 
            strm.COMPTYPE, 
            strm.COND, 
            strm.DATAGRP, 
            strm.DATALAKE_DELETED, 
            strm.DIST, 
            strm.DOWNTIME, 
            strm.ESTIMATEDCOST, 
            strm.FAILFLAG, 
            strm.FLOWDPTH, 
            strm.FRREF, 
            strm.GRPMAINTSCHD, 
            strm.GRPPROJKEY, 
            strm.HISTKEY, 
            strm.HRS, 
            strm.INCIDENT, 
            strm.INITBY, 
            strm.INITDTTM, 
            strm.LINEARFROMFT, 
            strm.LINEARFROMM, 
            strm.LINEARTOFT, 
            strm.LINEARTOM, 
            strm.LOCATION, 
            strm.MAINTSCHED, 
            strm.MAINTTYPE, 
            strm.MEASFLOW, 
            strm.MILESTONE, 
            strm.MOBILE, 
            strm.MOBILEDTTM, 
            strm.MOBILEEMP, 
            strm.MODBY, 
            strm.MODDTTM, 
            strm.NEXTSCHEDFLAG, 
            strm.OUTOFSERV, 
            strm.OWNKEY, 
            strm.PLANKEY, 
            strm.PLANNEDQTY, 
            strm.POTSERVREQ, 
            strm.PRCLKEY, 
            strm.PRES, 
            strm.PRI, 
            strm.PROB, 
            strm.PROJ, 
            strm.REFNO, 
            strm.RES, 
            strm.RESP, 
            strm.RESPONSIBILITY, 
            strm.RWATTRKEY, 
            strm.RWATTRTYPE, 
            strm.RWXSP, 
            strm.SCHEDDTTM, 
            strm.SCHEDFINISH, 
            strm.SCHEDFINISHFLAG, 
            strm.SCHEDFLAG, 
            strm.SRC, 
            strm.STARTDTTM, 
            strm.STARTFLAG, 
            strm.STDACTFLAG, 
            strm.STOPPAGE, 
            strm.SUSPDTTM, 
            strm.TOREF, 
            strm.UM, 
            strm.USG, 
            strm.VARIATION_ID, 
            strm.WOLINKKEY, 
            strm.WOTYPE, 
            strm.XCOORDINATE, 
            strm.YCOORDINATE, 
            strm.ZCOORDINATE, 
            strm.ETL_SEQUENCE_NUMBER,
            strm.ETL_DELETED,
            strm.etl_load_datetime,
            strm.etl_load_metadatafilename,
            ROW_NUMBER() OVER (PARTITION BY 
            strm.HISTKEY ORDER BY strm.ETL_SEQUENCE_NUMBER desc,IFNULL(TRY_TO_TIMESTAMP(replace(right(replace(lower(etl_load_metadatafilename),'.json'),23),'_','-'), 'yyyy-mm-dd-HH-MI-SS-FF') ,etl_load_datetime) desc) as ROWNUMBER
        FROM DATAHUB_INTEGRATION.VW_STREAM_IPS_WORKMANAGEMENT_HISTORY as  strm
                    )   
            WHERE ROWNUMBER=1  
            
                    ) as src on
            ((target.HISTKEY=src.HISTKEY) OR (target.HISTKEY IS NULL AND src.HISTKEY IS NULL)) 
                when matched and src.ETL_DELETED=TRUE THEN DELETE
                when matched then update set
                    target.ACTKEY=src.ACTKEY, 
                    target.ACTUALQTY=src.ACTUALQTY, 
                    target.ADDBY=src.ADDBY, 
                    target.ADDDTTM=src.ADDDTTM, 
                    target.ADDRKEY=src.ADDRKEY, 
                    target.ASGNFLAG=src.ASGNFLAG, 
                    target.ASSETINSPECTIONKEY=src.ASSETINSPECTIONKEY, 
                    target.ASSIGNED=src.ASSIGNED, 
                    target.ASSVALTYPE=src.ASSVALTYPE, 
                    target.AUTH=src.AUTH, 
                    target.BGTNO=src.BGTNO, 
                    target.BLDGFLOOR=src.BLDGFLOOR, 
                    target.BLDGROOM=src.BLDGROOM, 
                    target.BUDGETKEY=src.BUDGETKEY, 
                    target.CANCELWORKORDER=src.CANCELWORKORDER, 
                    target.CMPLKEY=src.CMPLKEY, 
                    target.COMMENTS=src.COMMENTS, 
                    target.COMPBY=src.COMPBY, 
                    target.COMPDTTM=src.COMPDTTM, 
                    target.COMPFLAG=src.COMPFLAG, 
                    target.COMPKEY=src.COMPKEY, 
                    target.COMPTYPE=src.COMPTYPE, 
                    target.COND=src.COND, 
                    target.DATAGRP=src.DATAGRP, 
                    target.DATALAKE_DELETED=src.DATALAKE_DELETED, 
                    target.DIST=src.DIST, 
                    target.DOWNTIME=src.DOWNTIME, 
                    target.ESTIMATEDCOST=src.ESTIMATEDCOST, 
                    target.FAILFLAG=src.FAILFLAG, 
                    target.FLOWDPTH=src.FLOWDPTH, 
                    target.FRREF=src.FRREF, 
                    target.GRPMAINTSCHD=src.GRPMAINTSCHD, 
                    target.GRPPROJKEY=src.GRPPROJKEY, 
                    target.HISTKEY=src.HISTKEY, 
                    target.HRS=src.HRS, 
                    target.INCIDENT=src.INCIDENT, 
                    target.INITBY=src.INITBY, 
                    target.INITDTTM=src.INITDTTM, 
                    target.LINEARFROMFT=src.LINEARFROMFT, 
                    target.LINEARFROMM=src.LINEARFROMM, 
                    target.LINEARTOFT=src.LINEARTOFT, 
                    target.LINEARTOM=src.LINEARTOM, 
                    target.LOCATION=src.LOCATION, 
                    target.MAINTSCHED=src.MAINTSCHED, 
                    target.MAINTTYPE=src.MAINTTYPE, 
                    target.MEASFLOW=src.MEASFLOW, 
                    target.MILESTONE=src.MILESTONE, 
                    target.MOBILE=src.MOBILE, 
                    target.MOBILEDTTM=src.MOBILEDTTM, 
                    target.MOBILEEMP=src.MOBILEEMP, 
                    target.MODBY=src.MODBY, 
                    target.MODDTTM=src.MODDTTM, 
                    target.NEXTSCHEDFLAG=src.NEXTSCHEDFLAG, 
                    target.OUTOFSERV=src.OUTOFSERV, 
                    target.OWNKEY=src.OWNKEY, 
                    target.PLANKEY=src.PLANKEY, 
                    target.PLANNEDQTY=src.PLANNEDQTY, 
                    target.POTSERVREQ=src.POTSERVREQ, 
                    target.PRCLKEY=src.PRCLKEY, 
                    target.PRES=src.PRES, 
                    target.PRI=src.PRI, 
                    target.PROB=src.PROB, 
                    target.PROJ=src.PROJ, 
                    target.REFNO=src.REFNO, 
                    target.RES=src.RES, 
                    target.RESP=src.RESP, 
                    target.RESPONSIBILITY=src.RESPONSIBILITY, 
                    target.RWATTRKEY=src.RWATTRKEY, 
                    target.RWATTRTYPE=src.RWATTRTYPE, 
                    target.RWXSP=src.RWXSP, 
                    target.SCHEDDTTM=src.SCHEDDTTM, 
                    target.SCHEDFINISH=src.SCHEDFINISH, 
                    target.SCHEDFINISHFLAG=src.SCHEDFINISHFLAG, 
                    target.SCHEDFLAG=src.SCHEDFLAG, 
                    target.SRC=src.SRC, 
                    target.STARTDTTM=src.STARTDTTM, 
                    target.STARTFLAG=src.STARTFLAG, 
                    target.STDACTFLAG=src.STDACTFLAG, 
                    target.STOPPAGE=src.STOPPAGE, 
                    target.SUSPDTTM=src.SUSPDTTM, 
                    target.TOREF=src.TOREF, 
                    target.UM=src.UM, 
                    target.USG=src.USG, 
                    target.VARIATION_ID=src.VARIATION_ID, 
                    target.WOLINKKEY=src.WOLINKKEY, 
                    target.WOTYPE=src.WOTYPE, 
                    target.XCOORDINATE=src.XCOORDINATE, 
                    target.YCOORDINATE=src.YCOORDINATE, 
                    target.ZCOORDINATE=src.ZCOORDINATE, 
                    target.ETL_SEQUENCE_NUMBER=src.ETL_SEQUENCE_NUMBER,
                    target.etl_load_datetime=CURRENT_TIMESTAMP,
                    target.etl_load_metadatafilename=src.etl_load_metadatafilename
        when not matched and (src.ETL_DELETED=FALSE OR src.ETL_DELETED IS NULL)  then insert ( 
                    ACTKEY, 
                    ACTUALQTY, 
                    ADDBY, 
                    ADDDTTM, 
                    ADDRKEY, 
                    ASGNFLAG, 
                    ASSETINSPECTIONKEY, 
                    ASSIGNED, 
                    ASSVALTYPE, 
                    AUTH, 
                    BGTNO, 
                    BLDGFLOOR, 
                    BLDGROOM, 
                    BUDGETKEY, 
                    CANCELWORKORDER, 
                    CMPLKEY, 
                    COMMENTS, 
                    COMPBY, 
                    COMPDTTM, 
                    COMPFLAG, 
                    COMPKEY, 
                    COMPTYPE, 
                    COND, 
                    DATAGRP, 
                    DATALAKE_DELETED, 
                    DIST, 
                    DOWNTIME, 
                    ESTIMATEDCOST, 
                    FAILFLAG, 
                    FLOWDPTH, 
                    FRREF, 
                    GRPMAINTSCHD, 
                    GRPPROJKEY, 
                    HISTKEY, 
                    HRS, 
                    INCIDENT, 
                    INITBY, 
                    INITDTTM, 
                    LINEARFROMFT, 
                    LINEARFROMM, 
                    LINEARTOFT, 
                    LINEARTOM, 
                    LOCATION, 
                    MAINTSCHED, 
                    MAINTTYPE, 
                    MEASFLOW, 
                    MILESTONE, 
                    MOBILE, 
                    MOBILEDTTM, 
                    MOBILEEMP, 
                    MODBY, 
                    MODDTTM, 
                    NEXTSCHEDFLAG, 
                    OUTOFSERV, 
                    OWNKEY, 
                    PLANKEY, 
                    PLANNEDQTY, 
                    POTSERVREQ, 
                    PRCLKEY, 
                    PRES, 
                    PRI, 
                    PROB, 
                    PROJ, 
                    REFNO, 
                    RES, 
                    RESP, 
                    RESPONSIBILITY, 
                    RWATTRKEY, 
                    RWATTRTYPE, 
                    RWXSP, 
                    SCHEDDTTM, 
                    SCHEDFINISH, 
                    SCHEDFINISHFLAG, 
                    SCHEDFLAG, 
                    SRC, 
                    STARTDTTM, 
                    STARTFLAG, 
                    STDACTFLAG, 
                    STOPPAGE, 
                    SUSPDTTM, 
                    TOREF, 
                    UM, 
                    USG, 
                    VARIATION_ID, 
                    WOLINKKEY, 
                    WOTYPE, 
                    XCOORDINATE, 
                    YCOORDINATE, 
                    ZCOORDINATE, 
                    ETL_SEQUENCE_NUMBER,                       
                    etl_load_datetime,
                    etl_load_metadatafilename) 
            values (
                    src.ACTKEY, 
                    src.ACTUALQTY, 
                    src.ADDBY, 
                    src.ADDDTTM, 
                    src.ADDRKEY, 
                    src.ASGNFLAG, 
                    src.ASSETINSPECTIONKEY, 
                    src.ASSIGNED, 
                    src.ASSVALTYPE, 
                    src.AUTH, 
                    src.BGTNO, 
                    src.BLDGFLOOR, 
                    src.BLDGROOM, 
                    src.BUDGETKEY, 
                    src.CANCELWORKORDER, 
                    src.CMPLKEY, 
                    src.COMMENTS, 
                    src.COMPBY, 
                    src.COMPDTTM, 
                    src.COMPFLAG, 
                    src.COMPKEY, 
                    src.COMPTYPE, 
                    src.COND, 
                    src.DATAGRP, 
                    src.DATALAKE_DELETED, 
                    src.DIST, 
                    src.DOWNTIME, 
                    src.ESTIMATEDCOST, 
                    src.FAILFLAG, 
                    src.FLOWDPTH, 
                    src.FRREF, 
                    src.GRPMAINTSCHD, 
                    src.GRPPROJKEY, 
                    src.HISTKEY, 
                    src.HRS, 
                    src.INCIDENT, 
                    src.INITBY, 
                    src.INITDTTM, 
                    src.LINEARFROMFT, 
                    src.LINEARFROMM, 
                    src.LINEARTOFT, 
                    src.LINEARTOM, 
                    src.LOCATION, 
                    src.MAINTSCHED, 
                    src.MAINTTYPE, 
                    src.MEASFLOW, 
                    src.MILESTONE, 
                    src.MOBILE, 
                    src.MOBILEDTTM, 
                    src.MOBILEEMP, 
                    src.MODBY, 
                    src.MODDTTM, 
                    src.NEXTSCHEDFLAG, 
                    src.OUTOFSERV, 
                    src.OWNKEY, 
                    src.PLANKEY, 
                    src.PLANNEDQTY, 
                    src.POTSERVREQ, 
                    src.PRCLKEY, 
                    src.PRES, 
                    src.PRI, 
                    src.PROB, 
                    src.PROJ, 
                    src.REFNO, 
                    src.RES, 
                    src.RESP, 
                    src.RESPONSIBILITY, 
                    src.RWATTRKEY, 
                    src.RWATTRTYPE, 
                    src.RWXSP, 
                    src.SCHEDDTTM, 
                    src.SCHEDFINISH, 
                    src.SCHEDFINISHFLAG, 
                    src.SCHEDFLAG, 
                    src.SRC, 
                    src.STARTDTTM, 
                    src.STARTFLAG, 
                    src.STDACTFLAG, 
                    src.STOPPAGE, 
                    src.SUSPDTTM, 
                    src.TOREF, 
                    src.UM, 
                    src.USG, 
                    src.VARIATION_ID, 
                    src.WOLINKKEY, 
                    src.WOTYPE, 
                    src.XCOORDINATE, 
                    src.YCOORDINATE, 
                    src.ZCOORDINATE,     
                    src.ETL_SEQUENCE_NUMBER,
                    CURRENT_TIMESTAMP,
                    src.etl_load_metadatafilename);`;

    var sqlStmt = snowflake.createStatement( {sqlText:  sql_command} );
    var rs = sqlStmt.execute();

    snowflake.execute( {sqlText: `merge into DATAHUB_TARGET_HISTORY.IPS_DELETED_WORKMANAGEMENT_HISTORY as target using (
                SELECT * FROM (SELECT 
            strm.ACTKEY, 
            strm.ACTUALQTY, 
            strm.ADDBY, 
            strm.ADDDTTM, 
            strm.ADDRKEY, 
            strm.ASGNFLAG, 
            strm.ASSETINSPECTIONKEY, 
            strm.ASSIGNED, 
            strm.ASSVALTYPE, 
            strm.AUTH, 
            strm.BGTNO, 
            strm.BLDGFLOOR, 
            strm.BLDGROOM, 
            strm.BUDGETKEY, 
            strm.CANCELWORKORDER, 
            strm.CMPLKEY, 
            strm.COMMENTS, 
            strm.COMPBY, 
            strm.COMPDTTM, 
            strm.COMPFLAG, 
            strm.COMPKEY, 
            strm.COMPTYPE, 
            strm.COND, 
            strm.DATAGRP, 
            strm.DATALAKE_DELETED, 
            strm.DIST, 
            strm.DOWNTIME, 
            strm.ESTIMATEDCOST, 
            strm.FAILFLAG, 
            strm.FLOWDPTH, 
            strm.FRREF, 
            strm.GRPMAINTSCHD, 
            strm.GRPPROJKEY, 
            strm.HISTKEY, 
            strm.HRS, 
            strm.INCIDENT, 
            strm.INITBY, 
            strm.INITDTTM, 
            strm.LINEARFROMFT, 
            strm.LINEARFROMM, 
            strm.LINEARTOFT, 
            strm.LINEARTOM, 
            strm.LOCATION, 
            strm.MAINTSCHED, 
            strm.MAINTTYPE, 
            strm.MEASFLOW, 
            strm.MILESTONE, 
            strm.MOBILE, 
            strm.MOBILEDTTM, 
            strm.MOBILEEMP, 
            strm.MODBY, 
            strm.MODDTTM, 
            strm.NEXTSCHEDFLAG, 
            strm.OUTOFSERV, 
            strm.OWNKEY, 
            strm.PLANKEY, 
            strm.PLANNEDQTY, 
            strm.POTSERVREQ, 
            strm.PRCLKEY, 
            strm.PRES, 
            strm.PRI, 
            strm.PROB, 
            strm.PROJ, 
            strm.REFNO, 
            strm.RES, 
            strm.RESP, 
            strm.RESPONSIBILITY, 
            strm.RWATTRKEY, 
            strm.RWATTRTYPE, 
            strm.RWXSP, 
            strm.SCHEDDTTM, 
            strm.SCHEDFINISH, 
            strm.SCHEDFINISHFLAG, 
            strm.SCHEDFLAG, 
            strm.SRC, 
            strm.STARTDTTM, 
            strm.STARTFLAG, 
            strm.STDACTFLAG, 
            strm.STOPPAGE, 
            strm.SUSPDTTM, 
            strm.TOREF, 
            strm.UM, 
            strm.USG, 
            strm.VARIATION_ID, 
            strm.WOLINKKEY, 
            strm.WOTYPE, 
            strm.XCOORDINATE, 
            strm.YCOORDINATE, 
            strm.ZCOORDINATE, 
            strm.ETL_SEQUENCE_NUMBER,
            strm.ETL_DELETED,
            strm.etl_load_datetime,
            strm.etl_load_metadatafilename,
            ROW_NUMBER() OVER (PARTITION BY 
            strm.HISTKEY ORDER BY strm.ETL_SEQUENCE_NUMBER desc,IFNULL(TRY_TO_TIMESTAMP(replace(right(replace(lower(etl_load_metadatafilename),'.json'),23),'_','-'), 'yyyy-mm-dd-HH-MI-SS-FF') ,etl_load_datetime) desc) as ROWNUMBER
        FROM DATAHUB_INTEGRATION.VW_STREAM_IPS_WORKMANAGEMENT_HISTORY as  strm
        WHERE strm.ETL_DELETED=TRUE
                    )   
            WHERE ROWNUMBER=1  
            
                    ) as src on
            ((target.HISTKEY=src.HISTKEY) OR (target.HISTKEY IS NULL AND src.HISTKEY IS NULL)) 
                when matched then update set
                    target.ACTKEY=src.ACTKEY, 
                    target.ACTUALQTY=src.ACTUALQTY, 
                    target.ADDBY=src.ADDBY, 
                    target.ADDDTTM=src.ADDDTTM, 
                    target.ADDRKEY=src.ADDRKEY, 
                    target.ASGNFLAG=src.ASGNFLAG, 
                    target.ASSETINSPECTIONKEY=src.ASSETINSPECTIONKEY, 
                    target.ASSIGNED=src.ASSIGNED, 
                    target.ASSVALTYPE=src.ASSVALTYPE, 
                    target.AUTH=src.AUTH, 
                    target.BGTNO=src.BGTNO, 
                    target.BLDGFLOOR=src.BLDGFLOOR, 
                    target.BLDGROOM=src.BLDGROOM, 
                    target.BUDGETKEY=src.BUDGETKEY, 
                    target.CANCELWORKORDER=src.CANCELWORKORDER, 
                    target.CMPLKEY=src.CMPLKEY, 
                    target.COMMENTS=src.COMMENTS, 
                    target.COMPBY=src.COMPBY, 
                    target.COMPDTTM=src.COMPDTTM, 
                    target.COMPFLAG=src.COMPFLAG, 
                    target.COMPKEY=src.COMPKEY, 
                    target.COMPTYPE=src.COMPTYPE, 
                    target.COND=src.COND, 
                    target.DATAGRP=src.DATAGRP, 
                    target.DATALAKE_DELETED=src.DATALAKE_DELETED, 
                    target.DIST=src.DIST, 
                    target.DOWNTIME=src.DOWNTIME, 
                    target.ESTIMATEDCOST=src.ESTIMATEDCOST, 
                    target.FAILFLAG=src.FAILFLAG, 
                    target.FLOWDPTH=src.FLOWDPTH, 
                    target.FRREF=src.FRREF, 
                    target.GRPMAINTSCHD=src.GRPMAINTSCHD, 
                    target.GRPPROJKEY=src.GRPPROJKEY, 
                    target.HISTKEY=src.HISTKEY, 
                    target.HRS=src.HRS, 
                    target.INCIDENT=src.INCIDENT, 
                    target.INITBY=src.INITBY, 
                    target.INITDTTM=src.INITDTTM, 
                    target.LINEARFROMFT=src.LINEARFROMFT, 
                    target.LINEARFROMM=src.LINEARFROMM, 
                    target.LINEARTOFT=src.LINEARTOFT, 
                    target.LINEARTOM=src.LINEARTOM, 
                    target.LOCATION=src.LOCATION, 
                    target.MAINTSCHED=src.MAINTSCHED, 
                    target.MAINTTYPE=src.MAINTTYPE, 
                    target.MEASFLOW=src.MEASFLOW, 
                    target.MILESTONE=src.MILESTONE, 
                    target.MOBILE=src.MOBILE, 
                    target.MOBILEDTTM=src.MOBILEDTTM, 
                    target.MOBILEEMP=src.MOBILEEMP, 
                    target.MODBY=src.MODBY, 
                    target.MODDTTM=src.MODDTTM, 
                    target.NEXTSCHEDFLAG=src.NEXTSCHEDFLAG, 
                    target.OUTOFSERV=src.OUTOFSERV, 
                    target.OWNKEY=src.OWNKEY, 
                    target.PLANKEY=src.PLANKEY, 
                    target.PLANNEDQTY=src.PLANNEDQTY, 
                    target.POTSERVREQ=src.POTSERVREQ, 
                    target.PRCLKEY=src.PRCLKEY, 
                    target.PRES=src.PRES, 
                    target.PRI=src.PRI, 
                    target.PROB=src.PROB, 
                    target.PROJ=src.PROJ, 
                    target.REFNO=src.REFNO, 
                    target.RES=src.RES, 
                    target.RESP=src.RESP, 
                    target.RESPONSIBILITY=src.RESPONSIBILITY, 
                    target.RWATTRKEY=src.RWATTRKEY, 
                    target.RWATTRTYPE=src.RWATTRTYPE, 
                    target.RWXSP=src.RWXSP, 
                    target.SCHEDDTTM=src.SCHEDDTTM, 
                    target.SCHEDFINISH=src.SCHEDFINISH, 
                    target.SCHEDFINISHFLAG=src.SCHEDFINISHFLAG, 
                    target.SCHEDFLAG=src.SCHEDFLAG, 
                    target.SRC=src.SRC, 
                    target.STARTDTTM=src.STARTDTTM, 
                    target.STARTFLAG=src.STARTFLAG, 
                    target.STDACTFLAG=src.STDACTFLAG, 
                    target.STOPPAGE=src.STOPPAGE, 
                    target.SUSPDTTM=src.SUSPDTTM, 
                    target.TOREF=src.TOREF, 
                    target.UM=src.UM, 
                    target.USG=src.USG, 
                    target.VARIATION_ID=src.VARIATION_ID, 
                    target.WOLINKKEY=src.WOLINKKEY, 
                    target.WOTYPE=src.WOTYPE, 
                    target.XCOORDINATE=src.XCOORDINATE, 
                    target.YCOORDINATE=src.YCOORDINATE, 
                    target.ZCOORDINATE=src.ZCOORDINATE, 
                    target.ETL_SEQUENCE_NUMBER=src.ETL_SEQUENCE_NUMBER,
                    target.etl_load_datetime=CURRENT_TIMESTAMP,
                    target.etl_load_metadatafilename=src.etl_load_metadatafilename,
                    target.ETL_DELETED=src.ETL_DELETED
        when not matched   then insert ( ACTKEY, ACTUALQTY, ADDBY, ADDDTTM, ADDRKEY, ASGNFLAG, ASSETINSPECTIONKEY, ASSIGNED, ASSVALTYPE, AUTH, BGTNO, BLDGFLOOR, BLDGROOM, BUDGETKEY, CANCELWORKORDER, CMPLKEY, COMMENTS, COMPBY, COMPDTTM, COMPFLAG, COMPKEY, COMPTYPE, COND, DATAGRP, DATALAKE_DELETED, DIST, DOWNTIME, ESTIMATEDCOST, FAILFLAG, FLOWDPTH, FRREF, GRPMAINTSCHD, GRPPROJKEY, HISTKEY, HRS, INCIDENT, INITBY, INITDTTM, LINEARFROMFT, LINEARFROMM, LINEARTOFT, LINEARTOM, LOCATION, MAINTSCHED, MAINTTYPE, MEASFLOW, MILESTONE, MOBILE, MOBILEDTTM, MOBILEEMP, MODBY, MODDTTM, NEXTSCHEDFLAG, OUTOFSERV, OWNKEY, PLANKEY, PLANNEDQTY, POTSERVREQ, PRCLKEY, PRES, PRI, PROB, PROJ, REFNO, RES, RESP, RESPONSIBILITY, RWATTRKEY, RWATTRTYPE, RWXSP, SCHEDDTTM, SCHEDFINISH, SCHEDFINISHFLAG, SCHEDFLAG, SRC, STARTDTTM, STARTFLAG, STDACTFLAG, STOPPAGE, SUSPDTTM, TOREF, UM, USG, VARIATION_ID, WOLINKKEY, WOTYPE, XCOORDINATE, YCOORDINATE, ZCOORDINATE, 
                    ETL_SEQUENCE_NUMBER,                       
                    etl_load_datetime,
                    etl_load_metadatafilename,
                    etl_is_deleted,
                    ETL_DELETED) 
            values (
                    src.ACTKEY, 
                    src.ACTUALQTY, 
                    src.ADDBY, 
                    src.ADDDTTM, 
                    src.ADDRKEY, 
                    src.ASGNFLAG, 
                    src.ASSETINSPECTIONKEY, 
                    src.ASSIGNED, 
                    src.ASSVALTYPE, 
                    src.AUTH, 
                    src.BGTNO, 
                    src.BLDGFLOOR, 
                    src.BLDGROOM, 
                    src.BUDGETKEY, 
                    src.CANCELWORKORDER, 
                    src.CMPLKEY, 
                    src.COMMENTS, 
                    src.COMPBY, 
                    src.COMPDTTM, 
                    src.COMPFLAG, 
                    src.COMPKEY, 
                    src.COMPTYPE, 
                    src.COND, 
                    src.DATAGRP, 
                    src.DATALAKE_DELETED, 
                    src.DIST, 
                    src.DOWNTIME, 
                    src.ESTIMATEDCOST, 
                    src.FAILFLAG, 
                    src.FLOWDPTH, 
                    src.FRREF, 
                    src.GRPMAINTSCHD, 
                    src.GRPPROJKEY, 
                    src.HISTKEY, 
                    src.HRS, 
                    src.INCIDENT, 
                    src.INITBY, 
                    src.INITDTTM, 
                    src.LINEARFROMFT, 
                    src.LINEARFROMM, 
                    src.LINEARTOFT, 
                    src.LINEARTOM, 
                    src.LOCATION, 
                    src.MAINTSCHED, 
                    src.MAINTTYPE, 
                    src.MEASFLOW, 
                    src.MILESTONE, 
                    src.MOBILE, 
                    src.MOBILEDTTM, 
                    src.MOBILEEMP, 
                    src.MODBY, 
                    src.MODDTTM, 
                    src.NEXTSCHEDFLAG, 
                    src.OUTOFSERV, 
                    src.OWNKEY, 
                    src.PLANKEY, 
                    src.PLANNEDQTY, 
                    src.POTSERVREQ, 
                    src.PRCLKEY, 
                    src.PRES, 
                    src.PRI, 
                    src.PROB, 
                    src.PROJ, 
                    src.REFNO, 
                    src.RES, 
                    src.RESP, 
                    src.RESPONSIBILITY, 
                    src.RWATTRKEY, 
                    src.RWATTRTYPE, 
                    src.RWXSP, 
                    src.SCHEDDTTM, 
                    src.SCHEDFINISH, 
                    src.SCHEDFINISHFLAG, 
                    src.SCHEDFLAG, 
                    src.SRC, 
                    src.STARTDTTM, 
                    src.STARTFLAG, 
                    src.STDACTFLAG, 
                    src.STOPPAGE, 
                    src.SUSPDTTM, 
                    src.TOREF, 
                    src.UM, 
                    src.USG, 
                    src.VARIATION_ID, 
                    src.WOLINKKEY, 
                    src.WOTYPE, 
                    src.XCOORDINATE, 
                    src.YCOORDINATE, 
                    src.ZCOORDINATE,     
                    src.ETL_SEQUENCE_NUMBER,
                    CURRENT_TIMESTAMP,
                    src.etl_load_metadatafilename,
                    case when ETL_DELETED=TRUE then TRUE else FALSE end,
                    ETL_DELETED);
    `
} );

                    
//  Get number of rows inserted
        
        var sqlStmt = snowflake.createStatement( {sqlText:  sql_command} );
        var rs = sqlStmt.execute();
        var number_of_rows_inserted = sqlStmt.getNumRowsInserted();
        var number_of_rows_updated =  sqlStmt.getNumRowsUpdated();
                    

        
    snowflake.execute ({sqlText: "commit"});

    log_sql_command = "call datahub_logging.sp_etl_log_ingestion_process('UpdateEnd','" + process_name + "','Success','Completed process execution.', 0 ," + number_of_rows_inserted.toString()+ "," +  number_of_rows_updated.toString() + ");";
    snowflake.execute({sqlText: log_sql_command});

    result = "Success"; 

    }       

    catch (err)  {
        snowflake.execute( {sqlText: "rollback;"} )
        var clean_error_msg = err.message.replace(/[^\w\s]/gi, '');
    //  Create a log entry to say INSERT STATEMENT failed
    
    log_sql_command = "call datahub_logging.sp_etl_log_ingestion_process('UpdateEnd','" + process_name + "','Failed','MERGE Failed. Error:" + err.code.toString()+" : "+ clean_error_msg  + "', 0 ,0,0);";
    snowflake.execute({sqlText: log_sql_command});
        ;
        throw "Failed: " + err.message;   // Return a success/error indicator.
        }
    return result;
    $$;