create or replace view VW_SM_TARGET_PORTAL_DIFFERENTIAL_S3(
	IPS_ACCOUNTNUMBER,
	M_METER_TIME,
	M_VALUE,
	IPS_CONSUMPTIONPERCENTAGE
) as
          			SELECT 

			I.IPS_ACCOUNTNUMBER

			,concat(to_varchar(dateadd('m',-30,dateadd('ms',s.M_METER_TIME/1000,'1970-01-01')), 'YYYY-MM-DD"T"HH24:MI:SS"Z"') ,'#',s.M_UNIT_ID) AS M_METER_TIME

			,M_VALUE*IPS_CONSUMPTIONPERCENTAGE AS M_VALUE

			,IPS_CONSUMPTIONPERCENTAGE

			FROM 

			( SELECT DISTINCT

			  M_UNIT_ID

			  ,M_METER_TIME

			  ,M_VALUE

			 FROM 

			 DATAHUB_TARGET.SM_APSY_SMINF_CUR

			 WHERE M_RESOURCE_TYPE ='Water_Flow_Readings_30min'

			 ) S JOIN DATAHUB_TARGET.VW_IPS_SM_ACCOUNT_UNITID I ON I.IPS_UNITID=S.M_UNIT_ID   

			 INNER JOIN (select distinct SMARTMETERID from DATAHUB_EXTRACT.SM_APSY_SMINF_PILOT) PILOT ON PILOT.SMARTMETERID=S.M_UNIT_ID  ;