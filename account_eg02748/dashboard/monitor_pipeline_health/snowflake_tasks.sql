SELECT REGEXP_REPLACE(REGEXP_REPLACE(REGEXP_REPLACE(REGEXP_REPLACE(REGEXP_REPLACE(
    REGEXP_REPLACE(NAME,'^${var.ENVIRONMENT}_',''),'^TASK_',''),'^TARGET_',''),'^LANDING_CLEAN_',''),'^LANDING_RAW_',''),'_.*','') AS "SOURCE",
    DATABASE_NAME AS "DATABASE", 
    SCHEMA_NAME AS "SCHEMA", 
    NAME  AS "OBJECT",
    STATE,
    CASE WHEN STATE = 'SUCCEEDED' THEN 1 ELSE 0 END AS "SUCCCESS",
    CASE WHEN STATE = 'FAILED' THEN 1 ELSE 0 END AS "FAILED",
    ERROR_MESSAGE AS "ERROR MESSAGE",
    COUNT(*) AS "TOTAL"
FROM SNOWFLAKE.ACCOUNT_USAGE.TASK_HISTORY 
WHERE DATABASE_NAME IN ('${var.ENVIRONMENT}_WCC_DATAWAREHOUSE', 'WATERLAKE_${var.ENVIRONMENT}')
    AND STATE NOT IN ('SKIPPED', 'CANCELLED')
    AND SCHEMA_NAME NOT IN ('DATAHUB_EXTRACT', 'DATAHUB_ANALYTICS')
    AND "SOURCE" = :source_system
    AND COMPLETED_TIME = :daterange  
GROUP BY "SOURCE",
    "DATABASE",
    "SCHEMA",
    "OBJECT",
    "STATE", 
    "ERROR MESSAGE"
UNION ALL
SELECT DISTINCT REGEXP_REPLACE(REGEXP_REPLACE(REGEXP_REPLACE(REGEXP_REPLACE(REGEXP_REPLACE(
    REGEXP_REPLACE(NAME,'^${var.ENVIRONMENT}_',''),'^TASK_',''),'^TARGET_',''),'^LANDING_CLEAN_',''),'^LANDING_RAW_',''),'_.*','') AS "SOURCE",
    DATABASE_NAME AS "DATABASE", 
    SCHEMA_NAME AS "SCHEMA", 
    '' AS "OBJECT",
    'FAILED' AS "STATE",
    0 AS "SUCCCESS",
    0 AS "FAILED",
    '' AS "ERROR MESSAGE",
    0 AS "TOTAL"
FROM SNOWFLAKE.ACCOUNT_USAGE.TASK_HISTORY 
WHERE DATABASE_NAME IN ('${var.ENVIRONMENT}_WCC_DATAWAREHOUSE', 'WATERLAKE_${var.ENVIRONMENT}')
    AND STATE <>'SKIPPED'
    AND SCHEMA_NAME NOT IN ('DATAHUB_EXTRACT', 'DATAHUB_ANALYTICS')
    AND "SOURCE" = :source_system
    AND COMPLETED_TIME = :daterange  
;