SELECT
    CASE
        WHEN TABLE_SCHEMA = 'DATAHUB_TARGET' THEN 'IPS'
        ELSE REPLACE(TABLE_SCHEMA, 'TARGET_', '')
    END SOURCE,
    :datebucket(TO_DATE(T.CREATED)) AS "DATE",
    COUNT(P.PIPE_NAME) AS "PIPE COUNT"
FROM ${var.ENVIRONMENT}_WCC_DATAWAREHOUSE.INFORMATION_SCHEMA.TABLES T
    INNER JOIN ${var.ENVIRONMENT}_WCC_DATAWAREHOUSE.INFORMATION_SCHEMA.PIPES P ON PIPE_NAME LIKE '%' || T.TABLE_NAME
WHERE
    TABLE_TYPE = 'BASE TABLE'
    AND (
        TABLE_SCHEMA LIKE 'TARGET_%'
        OR TABLE_SCHEMA = 'DATAHUB_TARGET'
    )
    AND TABLE_SCHEMA NOT LIKE '%HISTORY%'
    AND SOURCE = :source_system
    AND TO_DATE(T.CREATED) = :daterange
GROUP BY
    CASE
        WHEN TABLE_SCHEMA = 'DATAHUB_TARGET' THEN 'IPS'
        ELSE REPLACE(TABLE_SCHEMA, 'TARGET_', '')
    END,
    T.CREATED
UNION ALL
SELECT
    CASE
        WHEN TABLE_SCHEMA = 'DATAHUB_TARGET' THEN 'IPS'
        ELSE REPLACE(TABLE_SCHEMA, 'TARGET_', '')
    END SOURCE,
    :datebucket(TO_DATE(T.CREATED)) AS "DATE",
    COUNT(P.PIPE_NAME) AS "PIPE COUNT"
FROM WATERLAKE_${var.ENVIRONMENT}.INFORMATION_SCHEMA.TABLES T
    INNER JOIN WATERLAKE_${var.ENVIRONMENT}.INFORMATION_SCHEMA.PIPES P ON PIPE_NAME LIKE '%' || T.TABLE_NAME
WHERE
    TABLE_TYPE = 'BASE TABLE'
    AND (
        TABLE_SCHEMA LIKE 'TARGET_%'
        OR TABLE_SCHEMA = 'DATAHUB_TARGET'
    )
    AND TABLE_SCHEMA NOT LIKE '%HISTORY%'
    AND SOURCE = :source_system
    AND TO_DATE(T.CREATED) = :daterange
GROUP BY
    CASE
        WHEN TABLE_SCHEMA = 'DATAHUB_TARGET' THEN 'IPS'
        ELSE REPLACE(TABLE_SCHEMA, 'TARGET_', '')
    END,
    :datebucket(TO_DATE(T.CREATED))