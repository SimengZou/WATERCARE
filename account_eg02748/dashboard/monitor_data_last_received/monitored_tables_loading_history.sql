SELECT R.SOURCE AS "SOURCE",
        U.TABLE_NAME AS "TABLE",
        :datebucket(U.LAST_LOAD_TIME) as "LOAD TIME",
        SUM(U.ROW_COUNT) AS "LOAD COUNT"
FROM SNOWFLAKE.ACCOUNT_USAGE.COPY_HISTORY U
INNER JOIN ${var.ENVIRONMENT}_WCC_DATAWAREHOUSE.DATAHUB_SOURCE_METADATA.MONITORING_REQUIRED_TABLES R ON
    regexp_replace(U.TABLE_NAME, '_.*', '') = R.SOURCE AND
    U.TABLE_NAME = R.TABLE_NAME
WHERE U.TABLE_CATALOG_NAME = '${var.ENVIRONMENT}_WCC_DATAWAREHOUSE' AND 
    R.SOURCE = :source_system AND
    TO_TIMESTAMP_NTZ(U.LAST_LOAD_TIME)= :daterange AND
    U.TABLE_NAME = :monitored_table
GROUP BY "SOURCE", 
    "TABLE",
    :datebucket(U.LAST_LOAD_TIME)
UNION ALL
SELECT R.SOURCE AS "SOURCE",
    U.TABLE_NAME AS "TABLE",
    :datebucket(U.LAST_LOAD_TIME) as "LOAD TIME",
    SUM(U.ROW_COUNT) AS "LOAD COUNT"
FROM SNOWFLAKE.ACCOUNT_USAGE.COPY_HISTORY U
INNER JOIN ${var.ENVIRONMENT}_WCC_DATAWAREHOUSE.DATAHUB_SOURCE_METADATA.MONITORING_REQUIRED_TABLES R ON
    regexp_replace(U.TABLE_SCHEMA_NAME, '^.*_', '') = R.SOURCE AND
    U.TABLE_NAME = R.TABLE_NAME
WHERE  U.TABLE_CATALOG_NAME = 'WATERLAKE_${var.ENVIRONMENT}' AND
    R.SOURCE = :source_system AND
    TO_TIMESTAMP_NTZ(U.LAST_LOAD_TIME)= :daterange AND
    U.TABLE_NAME = :monitored_table
GROUP BY "SOURCE", 
    "TABLE",
    :datebucket(U.LAST_LOAD_TIME)
ORDER BY "SOURCE",
    "LOAD TIME" DESC,
    "TABLE";