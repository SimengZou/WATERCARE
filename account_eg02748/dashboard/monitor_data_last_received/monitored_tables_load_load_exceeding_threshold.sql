SELECT R.SOURCE AS "SOURCE",
    U.TABLE_NAME AS "TABLE",
    R.TABLE_DESCRIPTION AS "DESCRIPTION",
    R.FREQUENCY_DAYS AS "THRESHOLD DAYS",
    DATEDIFF('DAY', MAX(TO_TIMESTAMP_NTZ(U.LAST_LOAD_TIME)), CURRENT_DATE) AS "DAYS SINCE LAST LOAD",
    TO_NUMBER(DATEDIFF('DAY', MAX(TO_TIMESTAMP_NTZ(U.LAST_LOAD_TIME)), CURRENT_DATE) - R.FREQUENCY_DAYS,4,0) AS "DAYS OVER THRESHOLD",
    ROUND((TO_NUMBER(DATEDIFF('DAY', MAX(TO_TIMESTAMP_NTZ(U.LAST_LOAD_TIME)), CURRENT_DATE) - R.FREQUENCY_DAYS,4,0) * 100 / R.FREQUENCY_DAYS),0) AS "% OVER THRESHOLD",
    MAX(TO_TIMESTAMP_NTZ(U.LAST_LOAD_TIME)) as "LAST LOAD TIME",
    MAX_BY(U.ROW_COUNT,U.LAST_LOAD_TIME)  AS "LAST LOAD COUNT"  
FROM SNOWFLAKE.ACCOUNT_USAGE.COPY_HISTORY U
INNER JOIN ${var.ENVIRONMENT}_WCC_DATAWAREHOUSE.DATAHUB_SOURCE_METADATA.MONITORING_REQUIRED_TABLES R ON
    regexp_replace(U.TABLE_NAME, '_.*', '') = R.SOURCE AND
    U.TABLE_NAME = R.TABLE_NAME
INNER JOIN ${var.ENVIRONMENT}_WCC_DATAWAREHOUSE.INFORMATION_SCHEMA.TABLES T ON
    CASE WHEN T.TABLE_SCHEMA = 'DATAHUB_TARGET' THEN 'IPS' ELSE REPLACE(T.TABLE_SCHEMA, 'TARGET_', '') END = R.SOURCE AND
    T.TABLE_NAME = R.TABLE_NAME
WHERE  U.TABLE_CATALOG_NAME = '${var.ENVIRONMENT}_WCC_DATAWAREHOUSE' AND
    T.TABLE_TYPE = 'BASE TABLE' AND
    (T.TABLE_SCHEMA = 'DATAHUB_TARGET' OR T.TABLE_SCHEMA LIKE 'TARGET_%') AND
    T.TABLE_SCHEMA NOT LIKE '%HISTORY%' AND
    R.SOURCE = :source_system AND
    U.TABLE_NAME = :monitored_table
GROUP BY "SOURCE", 
    "TABLE",
    "THRESHOLD DAYS",
    "DESCRIPTION"
HAVING "DAYS SINCE LAST LOAD" > "THRESHOLD DAYS"
UNION ALL
SELECT R.SOURCE AS "SOURCE",
    U.TABLE_NAME AS "TABLE",
    R.TABLE_DESCRIPTION AS "DESCRIPTION", 
    R.FREQUENCY_DAYS AS "THRESHOLD DAYS",
    DATEDIFF('DAY', MAX(TO_TIMESTAMP_NTZ(U.LAST_LOAD_TIME)), CURRENT_DATE) AS "DAYS SINCE LAST LOAD",
    TO_NUMBER(DATEDIFF('DAY', MAX(TO_TIMESTAMP_NTZ(U.LAST_LOAD_TIME)), CURRENT_DATE) - R.FREQUENCY_DAYS,4,0) AS "DAYS OVER THRESHOLD",
    ROUND((TO_NUMBER(DATEDIFF('DAY', MAX(TO_TIMESTAMP_NTZ(U.LAST_LOAD_TIME)), CURRENT_DATE) - R.FREQUENCY_DAYS,4,0) * 100 / R.FREQUENCY_DAYS),0) AS "% OVER THRESHOLD",
    MAX(TO_TIMESTAMP_NTZ(U.LAST_LOAD_TIME)) as "LAST LOAD TIME",
    MAX_BY(U.ROW_COUNT,U.LAST_LOAD_TIME)  AS "LAST LOAD COUNT"  
FROM SNOWFLAKE.ACCOUNT_USAGE.COPY_HISTORY U
INNER JOIN ${var.ENVIRONMENT}_WCC_DATAWAREHOUSE.DATAHUB_SOURCE_METADATA.MONITORING_REQUIRED_TABLES R ON
    regexp_replace(U.TABLE_SCHEMA_NAME, '^.*_', '') = R.SOURCE AND
    U.TABLE_NAME = R.TABLE_NAME
INNER JOIN WATERLAKE_${var.ENVIRONMENT}.INFORMATION_SCHEMA.TABLES T ON
    REPLACE(T.TABLE_SCHEMA, 'TARGET_', '') = R.SOURCE AND
    T.TABLE_NAME = R.TABLE_NAME
WHERE  U.TABLE_CATALOG_NAME = 'WATERLAKE_${var.ENVIRONMENT}' AND
    T.TABLE_TYPE = 'BASE TABLE' AND
    T.TABLE_SCHEMA LIKE 'TARGET_%' AND
    T.TABLE_SCHEMA NOT LIKE '%HISTORY%' AND
    R.SOURCE = :source_system AND
    U.TABLE_NAME = :monitored_table
GROUP BY "SOURCE", 
    "TABLE",
    "THRESHOLD DAYS",
    "DESCRIPTION"
HAVING "DAYS SINCE LAST LOAD" > "THRESHOLD DAYS"
ORDER BY "% OVER THRESHOLD" DESC;