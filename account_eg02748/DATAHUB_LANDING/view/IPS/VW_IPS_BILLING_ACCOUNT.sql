CREATE OR REPLACE VIEW DATAHUB_LANDING.VW_IPS_BILLING_ACCOUNT AS SELECT
                        src:ACCEPTCHECKSFLAG::varchar AS ACCEPTCHECKSFLAG, 
                        src:ACCOUNTKEY::integer AS ACCOUNTKEY, 
                        src:ACCOUNTNUMBER::varchar AS ACCOUNTNUMBER, 
                        src:ACCOUNTSTATUS::varchar AS ACCOUNTSTATUS, 
                        src:ACCOUNTTYPE::integer AS ACCOUNTTYPE, 
                        src:ACCTCLASS::varchar AS ACCTCLASS, 
                        src:ACCTGRP::varchar AS ACCTGRP, 
                        src:ACCTSUBGRP::varchar AS ACCTSUBGRP, 
                        src:ADDBY::varchar AS ADDBY, 
                        src:ADDDTTM::datetime AS ADDDTTM, 
                        src:ADDRKEY::integer AS ADDRKEY, 
                        src:AGGREGATEFLAG::varchar AS AGGREGATEFLAG, 
                        src:AGGREGATEKEY::integer AS AGGREGATEKEY, 
                        src:ALLOWARCHIVEFLAG::varchar AS ALLOWARCHIVEFLAG, 
                        src:ALLOWCHECKOVERRIDESFLAG::varchar AS ALLOWCHECKOVERRIDESFLAG, 
                        src:ARCHIVETHROUGHDATE::datetime AS ARCHIVETHROUGHDATE, 
                        src:AREA::varchar AS AREA, 
                        src:ARRANGEDFLAG::varchar AS ARRANGEDFLAG, 
                        src:ASSIGNED::varchar AS ASSIGNED, 
                        src:BANKRUPTFLAG::varchar AS BANKRUPTFLAG, 
                        src:BILLINGCYCLE::varchar AS BILLINGCYCLE, 
                        src:BILLPRINTEXCEPTION::varchar AS BILLPRINTEXCEPTION, 
                        src:BLNGSTAT::varchar AS BLNGSTAT, 
                        src:BLNGSTDTTM::datetime AS BLNGSTDTTM, 
                        src:BUDGETBILLINGDISALLOWED::varchar AS BUDGETBILLINGDISALLOWED, 
                        src:BUDGETBILLINGFLAG::varchar AS BUDGETBILLINGFLAG, 
                        src:BUSINESSTYPE::varchar AS BUSINESSTYPE, 
                        src:CHARCONSVAL1::varchar AS CHARCONSVAL1, 
                        src:CHARCONSVAL2::varchar AS CHARCONSVAL2, 
                        src:CHARCONSVAL3::varchar AS CHARCONSVAL3, 
                        src:CHARCONSVAL4::varchar AS CHARCONSVAL4, 
                        src:CHARCONSVAL5::varchar AS CHARCONSVAL5, 
                        src:CHARCONSVAL6::varchar AS CHARCONSVAL6, 
                        src:CHARCONSVAL7::varchar AS CHARCONSVAL7, 
                        src:CHARCONSVAL8::varchar AS CHARCONSVAL8, 
                        src:CLOSEDATE::datetime AS CLOSEDATE, 
                        src:COLLECTIONSELIGIBLEFLAG::varchar AS COLLECTIONSELIGIBLEFLAG, 
                        src:COLLECTIONSFLAG::varchar AS COLLECTIONSFLAG, 
                        src:COLLEXEMPT::varchar AS COLLEXEMPT, 
                        src:COMMENTSKEY::integer AS COMMENTSKEY, 
                        src:CREDFLAG::varchar AS CREDFLAG, 
                        src:CUSTDESC::varchar AS CUSTDESC, 
                        src:DELETED::boolean AS DELETED, 
                        src:DELINQUENCYEXEMPT::varchar AS DELINQUENCYEXEMPT, 
                        src:DELINQUENCYEXEMPTFLAG::varchar AS DELINQUENCYEXEMPTFLAG, 
                        src:DELINQUENCYFLAG::varchar AS DELINQUENCYFLAG, 
                        src:DEPPDDATE::datetime AS DEPPDDATE, 
                        src:DONOTDIRECTDEBIT::varchar AS DONOTDIRECTDEBIT, 
                        src:ELIGIBLEFORREFUNDFLAG::varchar AS ELIGIBLEFORREFUNDFLAG, 
                        src:FINALBILLFLAG::varchar AS FINALBILLFLAG, 
                        src:FREQUENCY::varchar AS FREQUENCY, 
                        src:IDKEY::integer AS IDKEY, 
                        src:INITIATEDBY::varchar AS INITIATEDBY, 
                        src:INITIATEDDTTM::datetime AS INITIATEDDTTM, 
                        src:LEGACYACCOUNTNUMBER::varchar AS LEGACYACCOUNTNUMBER, 
                        src:LIENELIGIBLEFLAG::varchar AS LIENELIGIBLEFLAG, 
                        src:LIENEXEMPT::varchar AS LIENEXEMPT, 
                        src:LIENFLAG::varchar AS LIENFLAG, 
                        src:MODBY::varchar AS MODBY, 
                        src:MODDTTM::datetime AS MODDTTM, 
                        src:MOVEDOUTACCOUNTKEY::integer AS MOVEDOUTACCOUNTKEY, 
                        src:MOVEINADMINHOLDBY::varchar AS MOVEINADMINHOLDBY, 
                        src:MOVEINADMINHOLDDTTM::datetime AS MOVEINADMINHOLDDTTM, 
                        src:MOVEINADMINHOLDREASON::varchar AS MOVEINADMINHOLDREASON, 
                        src:MOVEINDATE::datetime AS MOVEINDATE, 
                        src:MOVEINEXCEPTION::integer AS MOVEINEXCEPTION, 
                        src:MOVEINSTATUS::integer AS MOVEINSTATUS, 
                        src:MOVEOUTADMINHOLDBY::varchar AS MOVEOUTADMINHOLDBY, 
                        src:MOVEOUTADMINHOLDDTTM::datetime AS MOVEOUTADMINHOLDDTTM, 
                        src:MOVEOUTADMINHOLDREASON::varchar AS MOVEOUTADMINHOLDREASON, 
                        src:MOVEOUTDATE::datetime AS MOVEOUTDATE, 
                        src:MOVEOUTEXCEPTION::integer AS MOVEOUTEXCEPTION, 
                        src:MOVEOUTSTATUS::integer AS MOVEOUTSTATUS, 
                        src:NOARNG::varchar AS NOARNG, 
                        src:NOBILL::varchar AS NOBILL, 
                        src:NODISCONN::varchar AS NODISCONN, 
                        src:NONOTICE::varchar AS NONOTICE, 
                        src:NOTICEDTTM::datetime AS NOTICEDTTM, 
                        src:NUMERICCONSVAL1::numeric(38, 10) AS NUMERICCONSVAL1, 
                        src:NUMERICCONSVAL2::numeric(38, 10) AS NUMERICCONSVAL2, 
                        src:NUMERICCONSVAL3::numeric(38, 10) AS NUMERICCONSVAL3, 
                        src:NUMERICCONSVAL4::numeric(38, 10) AS NUMERICCONSVAL4, 
                        src:NUMERICCONSVAL5::numeric(38, 10) AS NUMERICCONSVAL5, 
                        src:NUMERICCONSVAL6::numeric(38, 10) AS NUMERICCONSVAL6, 
                        src:NUMERICCONSVAL7::numeric(38, 10) AS NUMERICCONSVAL7, 
                        src:NUMERICCONSVAL8::numeric(38, 10) AS NUMERICCONSVAL8, 
                        src:OCCUPANT::varchar AS OCCUPANT, 
                        src:ONEOFFCHARGEFLAG::varchar AS ONEOFFCHARGEFLAG, 
                        src:OPENDATE::datetime AS OPENDATE, 
                        src:PARCELKEY::integer AS PARCELKEY, 
                        src:PENEXEMPT::varchar AS PENEXEMPT, 
                        src:PRESELECTEDFORBILLRUN::varchar AS PRESELECTEDFORBILLRUN, 
                        src:PRESELECTEDFORINTERIMBILL::varchar AS PRESELECTEDFORINTERIMBILL, 
                        src:PROPERTYKEY::integer AS PROPERTYKEY, 
                        src:RESPONSIBILITY::varchar AS RESPONSIBILITY, 
                        src:STATBY::varchar AS STATBY, 
                        src:STATDTTM::datetime AS STATDTTM, 
                        src:SUSPENDBY::varchar AS SUSPENDBY, 
                        src:SUSPENDDTTM::datetime AS SUSPENDDTTM, 
                        src:SUSPENDFLAG::varchar AS SUSPENDFLAG, 
                        src:TAXEXEMPTFALG::varchar AS TAXEXEMPTFALG, 
                        src:TRANSFERREDTO::integer AS TRANSFERREDTO, 
                        src:VARIATION_ID::integer AS VARIATION_ID, 
                        src:WRITEOFFELIGIBLEFLAG::varchar AS WRITEOFFELIGIBLEFLAG, 
            CASE
                WHEN 'IPS' = 'LN'
                THEN src:"deleted"::BOOLEAN
                WHEN 'IPS' = 'IPS'
                THEN src:"DATALAKE_DELETED"::BOOLEAN
                ELSE src:"_DELETED"::BOOLEAN
            END as ETL_DELETED,
            etl_load_datetime,
            etl_load_metadatafilename,
            ETL_RANK,
            IFNULL(TRY_TO_TIMESTAMP(replace(right(replace(lower(etl_load_metadatafilename),'.json'),23),'_','-'), 'yyyy-mm-dd-HH-MI-SS-FF') ,etl_load_datetime) as ETL_RANK_TIMESTAMP
            FROM 
            (
            select 
                src,
                etl_load_datetime,
                etl_load_metadatafilename,
                ROWNUMBER as ETL_RANK
                from
                (
                    SELECT
    
                        
                src:ACCOUNTKEY,
            src:VARIATION_ID
                ,src,
                etl_load_datetime,
                etl_load_metadatafilename,
                ROW_NUMBER() OVER (PARTITION BY 
                                        
                src:ACCOUNTKEY  ORDER BY 
            src:VARIATION_ID desc,IFNULL(TRY_TO_TIMESTAMP(replace(right(replace(lower(etl_load_metadatafilename),'.json'),23),'_','-'), 'yyyy-mm-dd-HH-MI-SS-FF') ,etl_load_datetime) desc) as ROWNUMBER
                FROM DATAHUB_LANDING.IPS_BILLING_ACCOUNT as strm))