create or replace procedure DATAHUB_INTEGRATION.SP_LN_WHINA124()
    returns varchar not null
                language javascript
                as
                $$

//  Variables

var result = "";                                    // return status of this proc call
const process_name = Object.keys(this)[0];          // name of currently executing process
var number_of_rows_inserted = 0;                             // track number of rows we have inserted
var number_of_rows_updated = 0;                             // track number of rows we have updated


//  Step 1.

//  Start execution - log start

log_sql_command = "call datahub_logging.sp_etl_log_ingestion_process('Insert','" + process_name + "','Running','Started process execution.', 0,0,0);";
snowflake.execute({sqlText: log_sql_command});

snowflake.execute( {sqlText: "begin transaction;"} );
try
    {
        var sql_command = `
                            INSERT INTO LANDING_ERROR.LN_RAW_ERROR
                            SELECT * FROM LANDING_ERROR.VW_STREAM_LN_WHINA124_ERROR`;
    var sqlStmt = snowflake.createStatement( {sqlText:  sql_command} );
    var rs = sqlStmt.execute();
        
        var sql_command = ` 
                            merge into  TARGET_LN.LN_WHINA124 as target using (SELECT * FROM (SELECT 
            strm.amnt_dtwc, 
            strm.amnt_lclc, 
            strm.amnt_rfrc, 
            strm.amnt_rpc1, 
            strm.amnt_rpc2, 
            strm.amtf_1, 
            strm.amtf_2, 
            strm.amtf_3, 
            strm.amtt_1, 
            strm.amtt_2, 
            strm.amtt_3, 
            strm.atsf, 
            strm.atsf_ref_compnr, 
            strm.atst, 
            strm.atst_ref_compnr, 
            strm.boml, 
            strm.ccpf, 
            strm.ccpf_cpcp, 
            strm.ccpf_ref_compnr, 
            strm.ccpt, 
            strm.ccpt_ref_compnr, 
            strm.codf, 
            strm.codf_cwar, 
            strm.codt, 
            strm.compnr, 
            strm.crdt, 
            strm.cuso, 
            strm.cuso_kw, 
            strm.deleted, 
            strm.dlin, 
            strm.expt, 
            strm.expt_kw, 
            strm.fitr, 
            strm.fitr_kw, 
            strm.guid, 
            strm.houf, 
            strm.houf_hour, 
            strm.hout, 
            strm.itid, 
            strm.itmf, 
            strm.itmf_item, 
            strm.itmf_ref_compnr, 
            strm.itmt, 
            strm.itmt_ref_compnr, 
            strm.itse, 
            strm.ivsq, 
            strm.koor, 
            strm.koor_kw, 
            strm.lcln, 
            strm.logf, 
            strm.logt, 
            strm.ocmp, 
            strm.ocmp_ref_compnr, 
            strm.orno, 
            strm.pono, 
            strm.quaf, 
            strm.quan_buar, 
            strm.quan_buln, 
            strm.quan_buvl, 
            strm.quan_buwg, 
            strm.quan_invu, 
            strm.quat, 
            strm.rcln, 
            strm.rcno, 
            strm.rorg, 
            strm.rorg_kw, 
            strm.rorn, 
            strm.rseq, 
            strm.seqn, 
            strm.sequencenumber, 
            strm.timestamp, 
            strm.trdt, 
            strm.tror, 
            strm.tror_kw, 
            strm.typf, 
            strm.typf_kw, 
            strm.typt, 
            strm.typt_kw, 
            strm.unif, 
            strm.unif_ref_compnr, 
            strm.unit, 
            strm.unit_ref_compnr, 
            strm.username, 
            strm.ETL_SEQUENCE_NUMBER,
            strm.ETL_DELETED,
            strm.etl_load_datetime,
            strm.etl_load_metadatafilename,
            ROW_NUMBER() OVER (PARTITION BY 
            strm.compnr,
            strm.guid ORDER BY strm.ETL_SEQUENCE_NUMBER desc,IFNULL(TRY_TO_TIMESTAMP(replace(right(replace(lower(etl_load_metadatafilename),'.json'),23),'_','-'), 'yyyy-mm-dd-HH-MI-SS-FF') ,etl_load_datetime) desc) as ROWNUMBER
        FROM DATAHUB_INTEGRATION.VW_STREAM_LN_WHINA124 as  strm
                    )   
            WHERE ROWNUMBER=1  
            
                    ) as src on
            ((target.compnr=src.compnr) OR (target.compnr IS NULL AND src.compnr IS NULL)) AND
            ((target.guid=src.guid) OR (target.guid IS NULL AND src.guid IS NULL)) 
                when matched and src.ETL_DELETED=TRUE THEN DELETE
                when matched then update set
                    target.amnt_dtwc=src.amnt_dtwc, 
                    target.amnt_lclc=src.amnt_lclc, 
                    target.amnt_rfrc=src.amnt_rfrc, 
                    target.amnt_rpc1=src.amnt_rpc1, 
                    target.amnt_rpc2=src.amnt_rpc2, 
                    target.amtf_1=src.amtf_1, 
                    target.amtf_2=src.amtf_2, 
                    target.amtf_3=src.amtf_3, 
                    target.amtt_1=src.amtt_1, 
                    target.amtt_2=src.amtt_2, 
                    target.amtt_3=src.amtt_3, 
                    target.atsf=src.atsf, 
                    target.atsf_ref_compnr=src.atsf_ref_compnr, 
                    target.atst=src.atst, 
                    target.atst_ref_compnr=src.atst_ref_compnr, 
                    target.boml=src.boml, 
                    target.ccpf=src.ccpf, 
                    target.ccpf_cpcp=src.ccpf_cpcp, 
                    target.ccpf_ref_compnr=src.ccpf_ref_compnr, 
                    target.ccpt=src.ccpt, 
                    target.ccpt_ref_compnr=src.ccpt_ref_compnr, 
                    target.codf=src.codf, 
                    target.codf_cwar=src.codf_cwar, 
                    target.codt=src.codt, 
                    target.compnr=src.compnr, 
                    target.crdt=src.crdt, 
                    target.cuso=src.cuso, 
                    target.cuso_kw=src.cuso_kw, 
                    target.deleted=src.deleted, 
                    target.dlin=src.dlin, 
                    target.expt=src.expt, 
                    target.expt_kw=src.expt_kw, 
                    target.fitr=src.fitr, 
                    target.fitr_kw=src.fitr_kw, 
                    target.guid=src.guid, 
                    target.houf=src.houf, 
                    target.houf_hour=src.houf_hour, 
                    target.hout=src.hout, 
                    target.itid=src.itid, 
                    target.itmf=src.itmf, 
                    target.itmf_item=src.itmf_item, 
                    target.itmf_ref_compnr=src.itmf_ref_compnr, 
                    target.itmt=src.itmt, 
                    target.itmt_ref_compnr=src.itmt_ref_compnr, 
                    target.itse=src.itse, 
                    target.ivsq=src.ivsq, 
                    target.koor=src.koor, 
                    target.koor_kw=src.koor_kw, 
                    target.lcln=src.lcln, 
                    target.logf=src.logf, 
                    target.logt=src.logt, 
                    target.ocmp=src.ocmp, 
                    target.ocmp_ref_compnr=src.ocmp_ref_compnr, 
                    target.orno=src.orno, 
                    target.pono=src.pono, 
                    target.quaf=src.quaf, 
                    target.quan_buar=src.quan_buar, 
                    target.quan_buln=src.quan_buln, 
                    target.quan_buvl=src.quan_buvl, 
                    target.quan_buwg=src.quan_buwg, 
                    target.quan_invu=src.quan_invu, 
                    target.quat=src.quat, 
                    target.rcln=src.rcln, 
                    target.rcno=src.rcno, 
                    target.rorg=src.rorg, 
                    target.rorg_kw=src.rorg_kw, 
                    target.rorn=src.rorn, 
                    target.rseq=src.rseq, 
                    target.seqn=src.seqn, 
                    target.sequencenumber=src.sequencenumber, 
                    target.timestamp=src.timestamp, 
                    target.trdt=src.trdt, 
                    target.tror=src.tror, 
                    target.tror_kw=src.tror_kw, 
                    target.typf=src.typf, 
                    target.typf_kw=src.typf_kw, 
                    target.typt=src.typt, 
                    target.typt_kw=src.typt_kw, 
                    target.unif=src.unif, 
                    target.unif_ref_compnr=src.unif_ref_compnr, 
                    target.unit=src.unit, 
                    target.unit_ref_compnr=src.unit_ref_compnr, 
                    target.username=src.username, 
                    target.ETL_SEQUENCE_NUMBER=src.ETL_SEQUENCE_NUMBER,
                    target.etl_load_datetime=CURRENT_TIMESTAMP,
                    target.etl_load_metadatafilename=src.etl_load_metadatafilename
        when not matched and (src.ETL_DELETED=FALSE OR src.ETL_DELETED IS NULL)  then insert ( 
                    amnt_dtwc, 
                    amnt_lclc, 
                    amnt_rfrc, 
                    amnt_rpc1, 
                    amnt_rpc2, 
                    amtf_1, 
                    amtf_2, 
                    amtf_3, 
                    amtt_1, 
                    amtt_2, 
                    amtt_3, 
                    atsf, 
                    atsf_ref_compnr, 
                    atst, 
                    atst_ref_compnr, 
                    boml, 
                    ccpf, 
                    ccpf_cpcp, 
                    ccpf_ref_compnr, 
                    ccpt, 
                    ccpt_ref_compnr, 
                    codf, 
                    codf_cwar, 
                    codt, 
                    compnr, 
                    crdt, 
                    cuso, 
                    cuso_kw, 
                    deleted, 
                    dlin, 
                    expt, 
                    expt_kw, 
                    fitr, 
                    fitr_kw, 
                    guid, 
                    houf, 
                    houf_hour, 
                    hout, 
                    itid, 
                    itmf, 
                    itmf_item, 
                    itmf_ref_compnr, 
                    itmt, 
                    itmt_ref_compnr, 
                    itse, 
                    ivsq, 
                    koor, 
                    koor_kw, 
                    lcln, 
                    logf, 
                    logt, 
                    ocmp, 
                    ocmp_ref_compnr, 
                    orno, 
                    pono, 
                    quaf, 
                    quan_buar, 
                    quan_buln, 
                    quan_buvl, 
                    quan_buwg, 
                    quan_invu, 
                    quat, 
                    rcln, 
                    rcno, 
                    rorg, 
                    rorg_kw, 
                    rorn, 
                    rseq, 
                    seqn, 
                    sequencenumber, 
                    timestamp, 
                    trdt, 
                    tror, 
                    tror_kw, 
                    typf, 
                    typf_kw, 
                    typt, 
                    typt_kw, 
                    unif, 
                    unif_ref_compnr, 
                    unit, 
                    unit_ref_compnr, 
                    username, 
                    ETL_SEQUENCE_NUMBER,                       
                    etl_load_datetime,
                    etl_load_metadatafilename) 
            values (
                    src.amnt_dtwc, 
                    src.amnt_lclc, 
                    src.amnt_rfrc, 
                    src.amnt_rpc1, 
                    src.amnt_rpc2, 
                    src.amtf_1, 
                    src.amtf_2, 
                    src.amtf_3, 
                    src.amtt_1, 
                    src.amtt_2, 
                    src.amtt_3, 
                    src.atsf, 
                    src.atsf_ref_compnr, 
                    src.atst, 
                    src.atst_ref_compnr, 
                    src.boml, 
                    src.ccpf, 
                    src.ccpf_cpcp, 
                    src.ccpf_ref_compnr, 
                    src.ccpt, 
                    src.ccpt_ref_compnr, 
                    src.codf, 
                    src.codf_cwar, 
                    src.codt, 
                    src.compnr, 
                    src.crdt, 
                    src.cuso, 
                    src.cuso_kw, 
                    src.deleted, 
                    src.dlin, 
                    src.expt, 
                    src.expt_kw, 
                    src.fitr, 
                    src.fitr_kw, 
                    src.guid, 
                    src.houf, 
                    src.houf_hour, 
                    src.hout, 
                    src.itid, 
                    src.itmf, 
                    src.itmf_item, 
                    src.itmf_ref_compnr, 
                    src.itmt, 
                    src.itmt_ref_compnr, 
                    src.itse, 
                    src.ivsq, 
                    src.koor, 
                    src.koor_kw, 
                    src.lcln, 
                    src.logf, 
                    src.logt, 
                    src.ocmp, 
                    src.ocmp_ref_compnr, 
                    src.orno, 
                    src.pono, 
                    src.quaf, 
                    src.quan_buar, 
                    src.quan_buln, 
                    src.quan_buvl, 
                    src.quan_buwg, 
                    src.quan_invu, 
                    src.quat, 
                    src.rcln, 
                    src.rcno, 
                    src.rorg, 
                    src.rorg_kw, 
                    src.rorn, 
                    src.rseq, 
                    src.seqn, 
                    src.sequencenumber, 
                    src.timestamp, 
                    src.trdt, 
                    src.tror, 
                    src.tror_kw, 
                    src.typf, 
                    src.typf_kw, 
                    src.typt, 
                    src.typt_kw, 
                    src.unif, 
                    src.unif_ref_compnr, 
                    src.unit, 
                    src.unit_ref_compnr, 
                    src.username,     
                    src.ETL_SEQUENCE_NUMBER,
                    CURRENT_TIMESTAMP,
                    src.etl_load_metadatafilename);`;

    var sqlStmt = snowflake.createStatement( {sqlText:  sql_command} );
    var rs = sqlStmt.execute();

    snowflake.execute( {sqlText: `merge into TARGET_HISTORY_LN.LN_WHINA124_DELETED as target using (
                SELECT * FROM (SELECT 
            strm.amnt_dtwc, 
            strm.amnt_lclc, 
            strm.amnt_rfrc, 
            strm.amnt_rpc1, 
            strm.amnt_rpc2, 
            strm.amtf_1, 
            strm.amtf_2, 
            strm.amtf_3, 
            strm.amtt_1, 
            strm.amtt_2, 
            strm.amtt_3, 
            strm.atsf, 
            strm.atsf_ref_compnr, 
            strm.atst, 
            strm.atst_ref_compnr, 
            strm.boml, 
            strm.ccpf, 
            strm.ccpf_cpcp, 
            strm.ccpf_ref_compnr, 
            strm.ccpt, 
            strm.ccpt_ref_compnr, 
            strm.codf, 
            strm.codf_cwar, 
            strm.codt, 
            strm.compnr, 
            strm.crdt, 
            strm.cuso, 
            strm.cuso_kw, 
            strm.deleted, 
            strm.dlin, 
            strm.expt, 
            strm.expt_kw, 
            strm.fitr, 
            strm.fitr_kw, 
            strm.guid, 
            strm.houf, 
            strm.houf_hour, 
            strm.hout, 
            strm.itid, 
            strm.itmf, 
            strm.itmf_item, 
            strm.itmf_ref_compnr, 
            strm.itmt, 
            strm.itmt_ref_compnr, 
            strm.itse, 
            strm.ivsq, 
            strm.koor, 
            strm.koor_kw, 
            strm.lcln, 
            strm.logf, 
            strm.logt, 
            strm.ocmp, 
            strm.ocmp_ref_compnr, 
            strm.orno, 
            strm.pono, 
            strm.quaf, 
            strm.quan_buar, 
            strm.quan_buln, 
            strm.quan_buvl, 
            strm.quan_buwg, 
            strm.quan_invu, 
            strm.quat, 
            strm.rcln, 
            strm.rcno, 
            strm.rorg, 
            strm.rorg_kw, 
            strm.rorn, 
            strm.rseq, 
            strm.seqn, 
            strm.sequencenumber, 
            strm.timestamp, 
            strm.trdt, 
            strm.tror, 
            strm.tror_kw, 
            strm.typf, 
            strm.typf_kw, 
            strm.typt, 
            strm.typt_kw, 
            strm.unif, 
            strm.unif_ref_compnr, 
            strm.unit, 
            strm.unit_ref_compnr, 
            strm.username, 
            strm.ETL_SEQUENCE_NUMBER,
            strm.ETL_DELETED,
            strm.etl_load_datetime,
            strm.etl_load_metadatafilename,
            ROW_NUMBER() OVER (PARTITION BY 
            strm.compnr,
            strm.guid ORDER BY strm.ETL_SEQUENCE_NUMBER desc,IFNULL(TRY_TO_TIMESTAMP(replace(right(replace(lower(etl_load_metadatafilename),'.json'),23),'_','-'), 'yyyy-mm-dd-HH-MI-SS-FF') ,etl_load_datetime) desc) as ROWNUMBER
        FROM DATAHUB_INTEGRATION.VW_STREAM_LN_WHINA124 as  strm
        WHERE strm.ETL_DELETED=TRUE
                    )   
            WHERE ROWNUMBER=1  
            
                    ) as src on
            ((target.compnr=src.compnr) OR (target.compnr IS NULL AND src.compnr IS NULL)) AND
            ((target.guid=src.guid) OR (target.guid IS NULL AND src.guid IS NULL)) 
                when matched then update set
                    target.amnt_dtwc=src.amnt_dtwc, 
                    target.amnt_lclc=src.amnt_lclc, 
                    target.amnt_rfrc=src.amnt_rfrc, 
                    target.amnt_rpc1=src.amnt_rpc1, 
                    target.amnt_rpc2=src.amnt_rpc2, 
                    target.amtf_1=src.amtf_1, 
                    target.amtf_2=src.amtf_2, 
                    target.amtf_3=src.amtf_3, 
                    target.amtt_1=src.amtt_1, 
                    target.amtt_2=src.amtt_2, 
                    target.amtt_3=src.amtt_3, 
                    target.atsf=src.atsf, 
                    target.atsf_ref_compnr=src.atsf_ref_compnr, 
                    target.atst=src.atst, 
                    target.atst_ref_compnr=src.atst_ref_compnr, 
                    target.boml=src.boml, 
                    target.ccpf=src.ccpf, 
                    target.ccpf_cpcp=src.ccpf_cpcp, 
                    target.ccpf_ref_compnr=src.ccpf_ref_compnr, 
                    target.ccpt=src.ccpt, 
                    target.ccpt_ref_compnr=src.ccpt_ref_compnr, 
                    target.codf=src.codf, 
                    target.codf_cwar=src.codf_cwar, 
                    target.codt=src.codt, 
                    target.compnr=src.compnr, 
                    target.crdt=src.crdt, 
                    target.cuso=src.cuso, 
                    target.cuso_kw=src.cuso_kw, 
                    target.deleted=src.deleted, 
                    target.dlin=src.dlin, 
                    target.expt=src.expt, 
                    target.expt_kw=src.expt_kw, 
                    target.fitr=src.fitr, 
                    target.fitr_kw=src.fitr_kw, 
                    target.guid=src.guid, 
                    target.houf=src.houf, 
                    target.houf_hour=src.houf_hour, 
                    target.hout=src.hout, 
                    target.itid=src.itid, 
                    target.itmf=src.itmf, 
                    target.itmf_item=src.itmf_item, 
                    target.itmf_ref_compnr=src.itmf_ref_compnr, 
                    target.itmt=src.itmt, 
                    target.itmt_ref_compnr=src.itmt_ref_compnr, 
                    target.itse=src.itse, 
                    target.ivsq=src.ivsq, 
                    target.koor=src.koor, 
                    target.koor_kw=src.koor_kw, 
                    target.lcln=src.lcln, 
                    target.logf=src.logf, 
                    target.logt=src.logt, 
                    target.ocmp=src.ocmp, 
                    target.ocmp_ref_compnr=src.ocmp_ref_compnr, 
                    target.orno=src.orno, 
                    target.pono=src.pono, 
                    target.quaf=src.quaf, 
                    target.quan_buar=src.quan_buar, 
                    target.quan_buln=src.quan_buln, 
                    target.quan_buvl=src.quan_buvl, 
                    target.quan_buwg=src.quan_buwg, 
                    target.quan_invu=src.quan_invu, 
                    target.quat=src.quat, 
                    target.rcln=src.rcln, 
                    target.rcno=src.rcno, 
                    target.rorg=src.rorg, 
                    target.rorg_kw=src.rorg_kw, 
                    target.rorn=src.rorn, 
                    target.rseq=src.rseq, 
                    target.seqn=src.seqn, 
                    target.sequencenumber=src.sequencenumber, 
                    target.timestamp=src.timestamp, 
                    target.trdt=src.trdt, 
                    target.tror=src.tror, 
                    target.tror_kw=src.tror_kw, 
                    target.typf=src.typf, 
                    target.typf_kw=src.typf_kw, 
                    target.typt=src.typt, 
                    target.typt_kw=src.typt_kw, 
                    target.unif=src.unif, 
                    target.unif_ref_compnr=src.unif_ref_compnr, 
                    target.unit=src.unit, 
                    target.unit_ref_compnr=src.unit_ref_compnr, 
                    target.username=src.username, 
                    target.ETL_SEQUENCE_NUMBER=src.ETL_SEQUENCE_NUMBER,
                    target.etl_load_datetime=CURRENT_TIMESTAMP,
                    target.etl_load_metadatafilename=src.etl_load_metadatafilename,
                    target.ETL_DELETED=src.ETL_DELETED
        when not matched   then insert ( amnt_dtwc, amnt_lclc, amnt_rfrc, amnt_rpc1, amnt_rpc2, amtf_1, amtf_2, amtf_3, amtt_1, amtt_2, amtt_3, atsf, atsf_ref_compnr, atst, atst_ref_compnr, boml, ccpf, ccpf_cpcp, ccpf_ref_compnr, ccpt, ccpt_ref_compnr, codf, codf_cwar, codt, compnr, crdt, cuso, cuso_kw, deleted, dlin, expt, expt_kw, fitr, fitr_kw, guid, houf, houf_hour, hout, itid, itmf, itmf_item, itmf_ref_compnr, itmt, itmt_ref_compnr, itse, ivsq, koor, koor_kw, lcln, logf, logt, ocmp, ocmp_ref_compnr, orno, pono, quaf, quan_buar, quan_buln, quan_buvl, quan_buwg, quan_invu, quat, rcln, rcno, rorg, rorg_kw, rorn, rseq, seqn, sequencenumber, timestamp, trdt, tror, tror_kw, typf, typf_kw, typt, typt_kw, unif, unif_ref_compnr, unit, unit_ref_compnr, username, 
                    ETL_SEQUENCE_NUMBER,                       
                    etl_load_datetime,
                    etl_load_metadatafilename,
                    etl_is_deleted,
                    ETL_DELETED) 
            values (
                    src.amnt_dtwc, 
                    src.amnt_lclc, 
                    src.amnt_rfrc, 
                    src.amnt_rpc1, 
                    src.amnt_rpc2, 
                    src.amtf_1, 
                    src.amtf_2, 
                    src.amtf_3, 
                    src.amtt_1, 
                    src.amtt_2, 
                    src.amtt_3, 
                    src.atsf, 
                    src.atsf_ref_compnr, 
                    src.atst, 
                    src.atst_ref_compnr, 
                    src.boml, 
                    src.ccpf, 
                    src.ccpf_cpcp, 
                    src.ccpf_ref_compnr, 
                    src.ccpt, 
                    src.ccpt_ref_compnr, 
                    src.codf, 
                    src.codf_cwar, 
                    src.codt, 
                    src.compnr, 
                    src.crdt, 
                    src.cuso, 
                    src.cuso_kw, 
                    src.deleted, 
                    src.dlin, 
                    src.expt, 
                    src.expt_kw, 
                    src.fitr, 
                    src.fitr_kw, 
                    src.guid, 
                    src.houf, 
                    src.houf_hour, 
                    src.hout, 
                    src.itid, 
                    src.itmf, 
                    src.itmf_item, 
                    src.itmf_ref_compnr, 
                    src.itmt, 
                    src.itmt_ref_compnr, 
                    src.itse, 
                    src.ivsq, 
                    src.koor, 
                    src.koor_kw, 
                    src.lcln, 
                    src.logf, 
                    src.logt, 
                    src.ocmp, 
                    src.ocmp_ref_compnr, 
                    src.orno, 
                    src.pono, 
                    src.quaf, 
                    src.quan_buar, 
                    src.quan_buln, 
                    src.quan_buvl, 
                    src.quan_buwg, 
                    src.quan_invu, 
                    src.quat, 
                    src.rcln, 
                    src.rcno, 
                    src.rorg, 
                    src.rorg_kw, 
                    src.rorn, 
                    src.rseq, 
                    src.seqn, 
                    src.sequencenumber, 
                    src.timestamp, 
                    src.trdt, 
                    src.tror, 
                    src.tror_kw, 
                    src.typf, 
                    src.typf_kw, 
                    src.typt, 
                    src.typt_kw, 
                    src.unif, 
                    src.unif_ref_compnr, 
                    src.unit, 
                    src.unit_ref_compnr, 
                    src.username,     
                    src.ETL_SEQUENCE_NUMBER,
                    CURRENT_TIMESTAMP,
                    src.etl_load_metadatafilename,
                    case when ETL_DELETED=TRUE then TRUE else FALSE end,
                    ETL_DELETED);
    `
} );

                    
//  Get number of rows inserted
        
        var sqlStmt = snowflake.createStatement( {sqlText:  sql_command} );
        var rs = sqlStmt.execute();
        var number_of_rows_inserted = sqlStmt.getNumRowsInserted();
        var number_of_rows_updated =  sqlStmt.getNumRowsUpdated();
                    

        
    snowflake.execute ({sqlText: "commit"});

    log_sql_command = "call datahub_logging.sp_etl_log_ingestion_process('UpdateEnd','" + process_name + "','Success','Completed process execution.', 0 ," + number_of_rows_inserted.toString()+ "," +  number_of_rows_updated.toString() + ");";
    snowflake.execute({sqlText: log_sql_command});

    result = "Success"; 

    }       

    catch (err)  {
        snowflake.execute( {sqlText: "rollback;"} )
        var clean_error_msg = err.message.replace(/[^\w\s]/gi, '');
    //  Create a log entry to say INSERT STATEMENT failed
    
    log_sql_command = "call datahub_logging.sp_etl_log_ingestion_process('UpdateEnd','" + process_name + "','Failed','MERGE Failed. Error:" + err.code.toString()+" : "+ clean_error_msg  + "', 0 ,0,0);";
    snowflake.execute({sqlText: log_sql_command});
        ;
        throw "Failed: " + err.message;   // Return a success/error indicator.
        }
    return result;
    $$;