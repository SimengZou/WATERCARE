create or replace procedure DATAHUB_INTEGRATION.SP_LN_TPPTC311()
    returns varchar not null
                language javascript
                as
                $$

//  Variables

var result = "";                                    // return status of this proc call
const process_name = Object.keys(this)[0];          // name of currently executing process
var number_of_rows_inserted = 0;                             // track number of rows we have inserted
var number_of_rows_updated = 0;                             // track number of rows we have updated


//  Step 1.

//  Start execution - log start

log_sql_command = "call datahub_logging.sp_etl_log_ingestion_process('Insert','" + process_name + "','Running','Started process execution.', 0,0,0);";
snowflake.execute({sqlText: log_sql_command});

snowflake.execute( {sqlText: "begin transaction;"} );
try
    {
        var sql_command = `
                            INSERT INTO LANDING_ERROR.LN_RAW_ERROR
                            SELECT * FROM LANDING_ERROR.VW_STREAM_LN_TPPTC311_ERROR`;
    var sqlStmt = snowflake.createStatement( {sqlText:  sql_command} );
    var rs = sqlStmt.execute();
        
        var sql_command = ` 
                            merge into  TARGET_LN.LN_TPPTC311 as target using (SELECT * FROM (SELECT 
            strm.aaoc_1, 
            strm.aaoc_2, 
            strm.aaoc_3, 
            strm.aaoc_4, 
            strm.aaos_1, 
            strm.aaos_2, 
            strm.aaos_3, 
            strm.aaos_4, 
            strm.adjm, 
            strm.adjm_kw, 
            strm.amoc, 
            strm.amoc_cntc, 
            strm.amoc_dwhc, 
            strm.amoc_prjc, 
            strm.amoc_refc, 
            strm.amos, 
            strm.amos_cntc, 
            strm.amos_dwhc, 
            strm.amos_prjc, 
            strm.amos_refc, 
            strm.basn, 
            strm.btdt, 
            strm.cact, 
            strm.ccal, 
            strm.ccco, 
            strm.ccco_ref_compnr, 
            strm.cico, 
            strm.cico_rcmp, 
            strm.clas, 
            strm.clas_ref_compnr, 
            strm.cocu, 
            strm.cocu_ref_compnr, 
            strm.cohc_1, 
            strm.cohc_2, 
            strm.cohc_3, 
            strm.cohc_4, 
            strm.compnr, 
            strm.cona, 
            strm.cona_cntc, 
            strm.cona_dwhc, 
            strm.cona_prjc, 
            strm.cona_refc, 
            strm.cotp, 
            strm.cotp_kw, 
            strm.cpla, 
            strm.cprj, 
            strm.cprj_basn_ref_compnr, 
            strm.cprj_ccal_ref_compnr, 
            strm.cprj_cico, 
            strm.cprj_cpla_cact_ref_compnr, 
            strm.cprj_cpla_ref_compnr, 
            strm.cprj_cspa_ref_compnr, 
            strm.cprj_fcmp, 
            strm.cprj_ref_compnr, 
            strm.cprj_task, 
            strm.cptc, 
            strm.cptc_ref_compnr, 
            strm.cptc_year_peri_ref_compnr, 
            strm.cspa, 
            strm.cstl, 
            strm.cuni, 
            strm.cuni_ref_compnr, 
            strm.cuti, 
            strm.cuti_ref_compnr, 
            strm.deleted, 
            strm.dura, 
            strm.emno, 
            strm.emno_ref_compnr, 
            strm.exeq, 
            strm.exeq_kw, 
            strm.item, 
            strm.item_ref_compnr, 
            strm.lcaa_1, 
            strm.lcaa_2, 
            strm.lcaa_3, 
            strm.lcaa_4, 
            strm.lcos_cntc, 
            strm.lcos_dwhc, 
            strm.lcos_prjc, 
            strm.lcos_refc, 
            strm.lcta, 
            strm.norm, 
            strm.peri, 
            strm.prca_1, 
            strm.prca_2, 
            strm.prca_3, 
            strm.prca_4, 
            strm.pric, 
            strm.pric_cntc, 
            strm.pric_dwhc, 
            strm.pric_prjc, 
            strm.pric_refc, 
            strm.pris, 
            strm.pris_cntc, 
            strm.pris_dwhc, 
            strm.pris_prjc, 
            strm.pris_refc, 
            strm.prsa_1, 
            strm.prsa_2, 
            strm.prsa_3, 
            strm.prsa_4, 
            strm.quan, 
            strm.quan_base_time, 
            strm.quan_buar, 
            strm.quan_buln, 
            strm.quan_bupc, 
            strm.quan_buvl, 
            strm.quan_buwg, 
            strm.quan_ctut, 
            strm.qutm, 
            strm.ratc, 
            strm.rats, 
            strm.refr, 
            strm.rfin, 
            strm.rsta, 
            strm.rtca_1, 
            strm.rtca_2, 
            strm.rtca_3, 
            strm.rtca_4, 
            strm.rtsa_1, 
            strm.rtsa_2, 
            strm.rtsa_3, 
            strm.rtsa_4, 
            strm.sacu, 
            strm.sacu_ref_compnr, 
            strm.scpf, 
            strm.sequencenumber, 
            strm.sern, 
            strm.stat, 
            strm.stat_kw, 
            strm.task, 
            strm.task_rcmp, 
            strm.timestamp, 
            strm.tmud, 
            strm.tmud_ref_compnr, 
            strm.unrt, 
            strm.unrt_ref_compnr, 
            strm.user, 
            strm.username, 
            strm.year, 
            strm.ETL_SEQUENCE_NUMBER,
            strm.ETL_DELETED,
            strm.etl_load_datetime,
            strm.etl_load_metadatafilename,
            ROW_NUMBER() OVER (PARTITION BY 
            strm.compnr,
            strm.ccal,
            strm.cptc,
            strm.cprj,
            strm.sern,
            strm.year,
            strm.peri ORDER BY strm.ETL_SEQUENCE_NUMBER desc,IFNULL(TRY_TO_TIMESTAMP(replace(right(replace(lower(etl_load_metadatafilename),'.json'),23),'_','-'), 'yyyy-mm-dd-HH-MI-SS-FF') ,etl_load_datetime) desc) as ROWNUMBER
        FROM DATAHUB_INTEGRATION.VW_STREAM_LN_TPPTC311 as  strm
                    )   
            WHERE ROWNUMBER=1  
            
                    ) as src on
            ((target.compnr=src.compnr) OR (target.compnr IS NULL AND src.compnr IS NULL)) AND
            ((target.ccal=src.ccal) OR (target.ccal IS NULL AND src.ccal IS NULL)) AND
            ((target.cptc=src.cptc) OR (target.cptc IS NULL AND src.cptc IS NULL)) AND
            ((target.cprj=src.cprj) OR (target.cprj IS NULL AND src.cprj IS NULL)) AND
            ((target.sern=src.sern) OR (target.sern IS NULL AND src.sern IS NULL)) AND
            ((target.year=src.year) OR (target.year IS NULL AND src.year IS NULL)) AND
            ((target.peri=src.peri) OR (target.peri IS NULL AND src.peri IS NULL)) 
                when matched and src.ETL_DELETED=TRUE THEN DELETE
                when matched then update set
                    target.aaoc_1=src.aaoc_1, 
                    target.aaoc_2=src.aaoc_2, 
                    target.aaoc_3=src.aaoc_3, 
                    target.aaoc_4=src.aaoc_4, 
                    target.aaos_1=src.aaos_1, 
                    target.aaos_2=src.aaos_2, 
                    target.aaos_3=src.aaos_3, 
                    target.aaos_4=src.aaos_4, 
                    target.adjm=src.adjm, 
                    target.adjm_kw=src.adjm_kw, 
                    target.amoc=src.amoc, 
                    target.amoc_cntc=src.amoc_cntc, 
                    target.amoc_dwhc=src.amoc_dwhc, 
                    target.amoc_prjc=src.amoc_prjc, 
                    target.amoc_refc=src.amoc_refc, 
                    target.amos=src.amos, 
                    target.amos_cntc=src.amos_cntc, 
                    target.amos_dwhc=src.amos_dwhc, 
                    target.amos_prjc=src.amos_prjc, 
                    target.amos_refc=src.amos_refc, 
                    target.basn=src.basn, 
                    target.btdt=src.btdt, 
                    target.cact=src.cact, 
                    target.ccal=src.ccal, 
                    target.ccco=src.ccco, 
                    target.ccco_ref_compnr=src.ccco_ref_compnr, 
                    target.cico=src.cico, 
                    target.cico_rcmp=src.cico_rcmp, 
                    target.clas=src.clas, 
                    target.clas_ref_compnr=src.clas_ref_compnr, 
                    target.cocu=src.cocu, 
                    target.cocu_ref_compnr=src.cocu_ref_compnr, 
                    target.cohc_1=src.cohc_1, 
                    target.cohc_2=src.cohc_2, 
                    target.cohc_3=src.cohc_3, 
                    target.cohc_4=src.cohc_4, 
                    target.compnr=src.compnr, 
                    target.cona=src.cona, 
                    target.cona_cntc=src.cona_cntc, 
                    target.cona_dwhc=src.cona_dwhc, 
                    target.cona_prjc=src.cona_prjc, 
                    target.cona_refc=src.cona_refc, 
                    target.cotp=src.cotp, 
                    target.cotp_kw=src.cotp_kw, 
                    target.cpla=src.cpla, 
                    target.cprj=src.cprj, 
                    target.cprj_basn_ref_compnr=src.cprj_basn_ref_compnr, 
                    target.cprj_ccal_ref_compnr=src.cprj_ccal_ref_compnr, 
                    target.cprj_cico=src.cprj_cico, 
                    target.cprj_cpla_cact_ref_compnr=src.cprj_cpla_cact_ref_compnr, 
                    target.cprj_cpla_ref_compnr=src.cprj_cpla_ref_compnr, 
                    target.cprj_cspa_ref_compnr=src.cprj_cspa_ref_compnr, 
                    target.cprj_fcmp=src.cprj_fcmp, 
                    target.cprj_ref_compnr=src.cprj_ref_compnr, 
                    target.cprj_task=src.cprj_task, 
                    target.cptc=src.cptc, 
                    target.cptc_ref_compnr=src.cptc_ref_compnr, 
                    target.cptc_year_peri_ref_compnr=src.cptc_year_peri_ref_compnr, 
                    target.cspa=src.cspa, 
                    target.cstl=src.cstl, 
                    target.cuni=src.cuni, 
                    target.cuni_ref_compnr=src.cuni_ref_compnr, 
                    target.cuti=src.cuti, 
                    target.cuti_ref_compnr=src.cuti_ref_compnr, 
                    target.deleted=src.deleted, 
                    target.dura=src.dura, 
                    target.emno=src.emno, 
                    target.emno_ref_compnr=src.emno_ref_compnr, 
                    target.exeq=src.exeq, 
                    target.exeq_kw=src.exeq_kw, 
                    target.item=src.item, 
                    target.item_ref_compnr=src.item_ref_compnr, 
                    target.lcaa_1=src.lcaa_1, 
                    target.lcaa_2=src.lcaa_2, 
                    target.lcaa_3=src.lcaa_3, 
                    target.lcaa_4=src.lcaa_4, 
                    target.lcos_cntc=src.lcos_cntc, 
                    target.lcos_dwhc=src.lcos_dwhc, 
                    target.lcos_prjc=src.lcos_prjc, 
                    target.lcos_refc=src.lcos_refc, 
                    target.lcta=src.lcta, 
                    target.norm=src.norm, 
                    target.peri=src.peri, 
                    target.prca_1=src.prca_1, 
                    target.prca_2=src.prca_2, 
                    target.prca_3=src.prca_3, 
                    target.prca_4=src.prca_4, 
                    target.pric=src.pric, 
                    target.pric_cntc=src.pric_cntc, 
                    target.pric_dwhc=src.pric_dwhc, 
                    target.pric_prjc=src.pric_prjc, 
                    target.pric_refc=src.pric_refc, 
                    target.pris=src.pris, 
                    target.pris_cntc=src.pris_cntc, 
                    target.pris_dwhc=src.pris_dwhc, 
                    target.pris_prjc=src.pris_prjc, 
                    target.pris_refc=src.pris_refc, 
                    target.prsa_1=src.prsa_1, 
                    target.prsa_2=src.prsa_2, 
                    target.prsa_3=src.prsa_3, 
                    target.prsa_4=src.prsa_4, 
                    target.quan=src.quan, 
                    target.quan_base_time=src.quan_base_time, 
                    target.quan_buar=src.quan_buar, 
                    target.quan_buln=src.quan_buln, 
                    target.quan_bupc=src.quan_bupc, 
                    target.quan_buvl=src.quan_buvl, 
                    target.quan_buwg=src.quan_buwg, 
                    target.quan_ctut=src.quan_ctut, 
                    target.qutm=src.qutm, 
                    target.ratc=src.ratc, 
                    target.rats=src.rats, 
                    target.refr=src.refr, 
                    target.rfin=src.rfin, 
                    target.rsta=src.rsta, 
                    target.rtca_1=src.rtca_1, 
                    target.rtca_2=src.rtca_2, 
                    target.rtca_3=src.rtca_3, 
                    target.rtca_4=src.rtca_4, 
                    target.rtsa_1=src.rtsa_1, 
                    target.rtsa_2=src.rtsa_2, 
                    target.rtsa_3=src.rtsa_3, 
                    target.rtsa_4=src.rtsa_4, 
                    target.sacu=src.sacu, 
                    target.sacu_ref_compnr=src.sacu_ref_compnr, 
                    target.scpf=src.scpf, 
                    target.sequencenumber=src.sequencenumber, 
                    target.sern=src.sern, 
                    target.stat=src.stat, 
                    target.stat_kw=src.stat_kw, 
                    target.task=src.task, 
                    target.task_rcmp=src.task_rcmp, 
                    target.timestamp=src.timestamp, 
                    target.tmud=src.tmud, 
                    target.tmud_ref_compnr=src.tmud_ref_compnr, 
                    target.unrt=src.unrt, 
                    target.unrt_ref_compnr=src.unrt_ref_compnr, 
                    target.user=src.user, 
                    target.username=src.username, 
                    target.year=src.year, 
                    target.ETL_SEQUENCE_NUMBER=src.ETL_SEQUENCE_NUMBER,
                    target.etl_load_datetime=CURRENT_TIMESTAMP,
                    target.etl_load_metadatafilename=src.etl_load_metadatafilename
        when not matched and (src.ETL_DELETED=FALSE OR src.ETL_DELETED IS NULL)  then insert ( 
                    aaoc_1, 
                    aaoc_2, 
                    aaoc_3, 
                    aaoc_4, 
                    aaos_1, 
                    aaos_2, 
                    aaos_3, 
                    aaos_4, 
                    adjm, 
                    adjm_kw, 
                    amoc, 
                    amoc_cntc, 
                    amoc_dwhc, 
                    amoc_prjc, 
                    amoc_refc, 
                    amos, 
                    amos_cntc, 
                    amos_dwhc, 
                    amos_prjc, 
                    amos_refc, 
                    basn, 
                    btdt, 
                    cact, 
                    ccal, 
                    ccco, 
                    ccco_ref_compnr, 
                    cico, 
                    cico_rcmp, 
                    clas, 
                    clas_ref_compnr, 
                    cocu, 
                    cocu_ref_compnr, 
                    cohc_1, 
                    cohc_2, 
                    cohc_3, 
                    cohc_4, 
                    compnr, 
                    cona, 
                    cona_cntc, 
                    cona_dwhc, 
                    cona_prjc, 
                    cona_refc, 
                    cotp, 
                    cotp_kw, 
                    cpla, 
                    cprj, 
                    cprj_basn_ref_compnr, 
                    cprj_ccal_ref_compnr, 
                    cprj_cico, 
                    cprj_cpla_cact_ref_compnr, 
                    cprj_cpla_ref_compnr, 
                    cprj_cspa_ref_compnr, 
                    cprj_fcmp, 
                    cprj_ref_compnr, 
                    cprj_task, 
                    cptc, 
                    cptc_ref_compnr, 
                    cptc_year_peri_ref_compnr, 
                    cspa, 
                    cstl, 
                    cuni, 
                    cuni_ref_compnr, 
                    cuti, 
                    cuti_ref_compnr, 
                    deleted, 
                    dura, 
                    emno, 
                    emno_ref_compnr, 
                    exeq, 
                    exeq_kw, 
                    item, 
                    item_ref_compnr, 
                    lcaa_1, 
                    lcaa_2, 
                    lcaa_3, 
                    lcaa_4, 
                    lcos_cntc, 
                    lcos_dwhc, 
                    lcos_prjc, 
                    lcos_refc, 
                    lcta, 
                    norm, 
                    peri, 
                    prca_1, 
                    prca_2, 
                    prca_3, 
                    prca_4, 
                    pric, 
                    pric_cntc, 
                    pric_dwhc, 
                    pric_prjc, 
                    pric_refc, 
                    pris, 
                    pris_cntc, 
                    pris_dwhc, 
                    pris_prjc, 
                    pris_refc, 
                    prsa_1, 
                    prsa_2, 
                    prsa_3, 
                    prsa_4, 
                    quan, 
                    quan_base_time, 
                    quan_buar, 
                    quan_buln, 
                    quan_bupc, 
                    quan_buvl, 
                    quan_buwg, 
                    quan_ctut, 
                    qutm, 
                    ratc, 
                    rats, 
                    refr, 
                    rfin, 
                    rsta, 
                    rtca_1, 
                    rtca_2, 
                    rtca_3, 
                    rtca_4, 
                    rtsa_1, 
                    rtsa_2, 
                    rtsa_3, 
                    rtsa_4, 
                    sacu, 
                    sacu_ref_compnr, 
                    scpf, 
                    sequencenumber, 
                    sern, 
                    stat, 
                    stat_kw, 
                    task, 
                    task_rcmp, 
                    timestamp, 
                    tmud, 
                    tmud_ref_compnr, 
                    unrt, 
                    unrt_ref_compnr, 
                    user, 
                    username, 
                    year, 
                    ETL_SEQUENCE_NUMBER,                       
                    etl_load_datetime,
                    etl_load_metadatafilename) 
            values (
                    src.aaoc_1, 
                    src.aaoc_2, 
                    src.aaoc_3, 
                    src.aaoc_4, 
                    src.aaos_1, 
                    src.aaos_2, 
                    src.aaos_3, 
                    src.aaos_4, 
                    src.adjm, 
                    src.adjm_kw, 
                    src.amoc, 
                    src.amoc_cntc, 
                    src.amoc_dwhc, 
                    src.amoc_prjc, 
                    src.amoc_refc, 
                    src.amos, 
                    src.amos_cntc, 
                    src.amos_dwhc, 
                    src.amos_prjc, 
                    src.amos_refc, 
                    src.basn, 
                    src.btdt, 
                    src.cact, 
                    src.ccal, 
                    src.ccco, 
                    src.ccco_ref_compnr, 
                    src.cico, 
                    src.cico_rcmp, 
                    src.clas, 
                    src.clas_ref_compnr, 
                    src.cocu, 
                    src.cocu_ref_compnr, 
                    src.cohc_1, 
                    src.cohc_2, 
                    src.cohc_3, 
                    src.cohc_4, 
                    src.compnr, 
                    src.cona, 
                    src.cona_cntc, 
                    src.cona_dwhc, 
                    src.cona_prjc, 
                    src.cona_refc, 
                    src.cotp, 
                    src.cotp_kw, 
                    src.cpla, 
                    src.cprj, 
                    src.cprj_basn_ref_compnr, 
                    src.cprj_ccal_ref_compnr, 
                    src.cprj_cico, 
                    src.cprj_cpla_cact_ref_compnr, 
                    src.cprj_cpla_ref_compnr, 
                    src.cprj_cspa_ref_compnr, 
                    src.cprj_fcmp, 
                    src.cprj_ref_compnr, 
                    src.cprj_task, 
                    src.cptc, 
                    src.cptc_ref_compnr, 
                    src.cptc_year_peri_ref_compnr, 
                    src.cspa, 
                    src.cstl, 
                    src.cuni, 
                    src.cuni_ref_compnr, 
                    src.cuti, 
                    src.cuti_ref_compnr, 
                    src.deleted, 
                    src.dura, 
                    src.emno, 
                    src.emno_ref_compnr, 
                    src.exeq, 
                    src.exeq_kw, 
                    src.item, 
                    src.item_ref_compnr, 
                    src.lcaa_1, 
                    src.lcaa_2, 
                    src.lcaa_3, 
                    src.lcaa_4, 
                    src.lcos_cntc, 
                    src.lcos_dwhc, 
                    src.lcos_prjc, 
                    src.lcos_refc, 
                    src.lcta, 
                    src.norm, 
                    src.peri, 
                    src.prca_1, 
                    src.prca_2, 
                    src.prca_3, 
                    src.prca_4, 
                    src.pric, 
                    src.pric_cntc, 
                    src.pric_dwhc, 
                    src.pric_prjc, 
                    src.pric_refc, 
                    src.pris, 
                    src.pris_cntc, 
                    src.pris_dwhc, 
                    src.pris_prjc, 
                    src.pris_refc, 
                    src.prsa_1, 
                    src.prsa_2, 
                    src.prsa_3, 
                    src.prsa_4, 
                    src.quan, 
                    src.quan_base_time, 
                    src.quan_buar, 
                    src.quan_buln, 
                    src.quan_bupc, 
                    src.quan_buvl, 
                    src.quan_buwg, 
                    src.quan_ctut, 
                    src.qutm, 
                    src.ratc, 
                    src.rats, 
                    src.refr, 
                    src.rfin, 
                    src.rsta, 
                    src.rtca_1, 
                    src.rtca_2, 
                    src.rtca_3, 
                    src.rtca_4, 
                    src.rtsa_1, 
                    src.rtsa_2, 
                    src.rtsa_3, 
                    src.rtsa_4, 
                    src.sacu, 
                    src.sacu_ref_compnr, 
                    src.scpf, 
                    src.sequencenumber, 
                    src.sern, 
                    src.stat, 
                    src.stat_kw, 
                    src.task, 
                    src.task_rcmp, 
                    src.timestamp, 
                    src.tmud, 
                    src.tmud_ref_compnr, 
                    src.unrt, 
                    src.unrt_ref_compnr, 
                    src.user, 
                    src.username, 
                    src.year,     
                    src.ETL_SEQUENCE_NUMBER,
                    CURRENT_TIMESTAMP,
                    src.etl_load_metadatafilename);`;

    var sqlStmt = snowflake.createStatement( {sqlText:  sql_command} );
    var rs = sqlStmt.execute();

    snowflake.execute( {sqlText: `merge into TARGET_HISTORY_LN.LN_TPPTC311_DELETED as target using (
                SELECT * FROM (SELECT 
            strm.aaoc_1, 
            strm.aaoc_2, 
            strm.aaoc_3, 
            strm.aaoc_4, 
            strm.aaos_1, 
            strm.aaos_2, 
            strm.aaos_3, 
            strm.aaos_4, 
            strm.adjm, 
            strm.adjm_kw, 
            strm.amoc, 
            strm.amoc_cntc, 
            strm.amoc_dwhc, 
            strm.amoc_prjc, 
            strm.amoc_refc, 
            strm.amos, 
            strm.amos_cntc, 
            strm.amos_dwhc, 
            strm.amos_prjc, 
            strm.amos_refc, 
            strm.basn, 
            strm.btdt, 
            strm.cact, 
            strm.ccal, 
            strm.ccco, 
            strm.ccco_ref_compnr, 
            strm.cico, 
            strm.cico_rcmp, 
            strm.clas, 
            strm.clas_ref_compnr, 
            strm.cocu, 
            strm.cocu_ref_compnr, 
            strm.cohc_1, 
            strm.cohc_2, 
            strm.cohc_3, 
            strm.cohc_4, 
            strm.compnr, 
            strm.cona, 
            strm.cona_cntc, 
            strm.cona_dwhc, 
            strm.cona_prjc, 
            strm.cona_refc, 
            strm.cotp, 
            strm.cotp_kw, 
            strm.cpla, 
            strm.cprj, 
            strm.cprj_basn_ref_compnr, 
            strm.cprj_ccal_ref_compnr, 
            strm.cprj_cico, 
            strm.cprj_cpla_cact_ref_compnr, 
            strm.cprj_cpla_ref_compnr, 
            strm.cprj_cspa_ref_compnr, 
            strm.cprj_fcmp, 
            strm.cprj_ref_compnr, 
            strm.cprj_task, 
            strm.cptc, 
            strm.cptc_ref_compnr, 
            strm.cptc_year_peri_ref_compnr, 
            strm.cspa, 
            strm.cstl, 
            strm.cuni, 
            strm.cuni_ref_compnr, 
            strm.cuti, 
            strm.cuti_ref_compnr, 
            strm.deleted, 
            strm.dura, 
            strm.emno, 
            strm.emno_ref_compnr, 
            strm.exeq, 
            strm.exeq_kw, 
            strm.item, 
            strm.item_ref_compnr, 
            strm.lcaa_1, 
            strm.lcaa_2, 
            strm.lcaa_3, 
            strm.lcaa_4, 
            strm.lcos_cntc, 
            strm.lcos_dwhc, 
            strm.lcos_prjc, 
            strm.lcos_refc, 
            strm.lcta, 
            strm.norm, 
            strm.peri, 
            strm.prca_1, 
            strm.prca_2, 
            strm.prca_3, 
            strm.prca_4, 
            strm.pric, 
            strm.pric_cntc, 
            strm.pric_dwhc, 
            strm.pric_prjc, 
            strm.pric_refc, 
            strm.pris, 
            strm.pris_cntc, 
            strm.pris_dwhc, 
            strm.pris_prjc, 
            strm.pris_refc, 
            strm.prsa_1, 
            strm.prsa_2, 
            strm.prsa_3, 
            strm.prsa_4, 
            strm.quan, 
            strm.quan_base_time, 
            strm.quan_buar, 
            strm.quan_buln, 
            strm.quan_bupc, 
            strm.quan_buvl, 
            strm.quan_buwg, 
            strm.quan_ctut, 
            strm.qutm, 
            strm.ratc, 
            strm.rats, 
            strm.refr, 
            strm.rfin, 
            strm.rsta, 
            strm.rtca_1, 
            strm.rtca_2, 
            strm.rtca_3, 
            strm.rtca_4, 
            strm.rtsa_1, 
            strm.rtsa_2, 
            strm.rtsa_3, 
            strm.rtsa_4, 
            strm.sacu, 
            strm.sacu_ref_compnr, 
            strm.scpf, 
            strm.sequencenumber, 
            strm.sern, 
            strm.stat, 
            strm.stat_kw, 
            strm.task, 
            strm.task_rcmp, 
            strm.timestamp, 
            strm.tmud, 
            strm.tmud_ref_compnr, 
            strm.unrt, 
            strm.unrt_ref_compnr, 
            strm.user, 
            strm.username, 
            strm.year, 
            strm.ETL_SEQUENCE_NUMBER,
            strm.ETL_DELETED,
            strm.etl_load_datetime,
            strm.etl_load_metadatafilename,
            ROW_NUMBER() OVER (PARTITION BY 
            strm.compnr,
            strm.ccal,
            strm.cptc,
            strm.cprj,
            strm.sern,
            strm.year,
            strm.peri ORDER BY strm.ETL_SEQUENCE_NUMBER desc,IFNULL(TRY_TO_TIMESTAMP(replace(right(replace(lower(etl_load_metadatafilename),'.json'),23),'_','-'), 'yyyy-mm-dd-HH-MI-SS-FF') ,etl_load_datetime) desc) as ROWNUMBER
        FROM DATAHUB_INTEGRATION.VW_STREAM_LN_TPPTC311 as  strm
        WHERE strm.ETL_DELETED=TRUE
                    )   
            WHERE ROWNUMBER=1  
            
                    ) as src on
            ((target.compnr=src.compnr) OR (target.compnr IS NULL AND src.compnr IS NULL)) AND
            ((target.ccal=src.ccal) OR (target.ccal IS NULL AND src.ccal IS NULL)) AND
            ((target.cptc=src.cptc) OR (target.cptc IS NULL AND src.cptc IS NULL)) AND
            ((target.cprj=src.cprj) OR (target.cprj IS NULL AND src.cprj IS NULL)) AND
            ((target.sern=src.sern) OR (target.sern IS NULL AND src.sern IS NULL)) AND
            ((target.year=src.year) OR (target.year IS NULL AND src.year IS NULL)) AND
            ((target.peri=src.peri) OR (target.peri IS NULL AND src.peri IS NULL)) 
                when matched then update set
                    target.aaoc_1=src.aaoc_1, 
                    target.aaoc_2=src.aaoc_2, 
                    target.aaoc_3=src.aaoc_3, 
                    target.aaoc_4=src.aaoc_4, 
                    target.aaos_1=src.aaos_1, 
                    target.aaos_2=src.aaos_2, 
                    target.aaos_3=src.aaos_3, 
                    target.aaos_4=src.aaos_4, 
                    target.adjm=src.adjm, 
                    target.adjm_kw=src.adjm_kw, 
                    target.amoc=src.amoc, 
                    target.amoc_cntc=src.amoc_cntc, 
                    target.amoc_dwhc=src.amoc_dwhc, 
                    target.amoc_prjc=src.amoc_prjc, 
                    target.amoc_refc=src.amoc_refc, 
                    target.amos=src.amos, 
                    target.amos_cntc=src.amos_cntc, 
                    target.amos_dwhc=src.amos_dwhc, 
                    target.amos_prjc=src.amos_prjc, 
                    target.amos_refc=src.amos_refc, 
                    target.basn=src.basn, 
                    target.btdt=src.btdt, 
                    target.cact=src.cact, 
                    target.ccal=src.ccal, 
                    target.ccco=src.ccco, 
                    target.ccco_ref_compnr=src.ccco_ref_compnr, 
                    target.cico=src.cico, 
                    target.cico_rcmp=src.cico_rcmp, 
                    target.clas=src.clas, 
                    target.clas_ref_compnr=src.clas_ref_compnr, 
                    target.cocu=src.cocu, 
                    target.cocu_ref_compnr=src.cocu_ref_compnr, 
                    target.cohc_1=src.cohc_1, 
                    target.cohc_2=src.cohc_2, 
                    target.cohc_3=src.cohc_3, 
                    target.cohc_4=src.cohc_4, 
                    target.compnr=src.compnr, 
                    target.cona=src.cona, 
                    target.cona_cntc=src.cona_cntc, 
                    target.cona_dwhc=src.cona_dwhc, 
                    target.cona_prjc=src.cona_prjc, 
                    target.cona_refc=src.cona_refc, 
                    target.cotp=src.cotp, 
                    target.cotp_kw=src.cotp_kw, 
                    target.cpla=src.cpla, 
                    target.cprj=src.cprj, 
                    target.cprj_basn_ref_compnr=src.cprj_basn_ref_compnr, 
                    target.cprj_ccal_ref_compnr=src.cprj_ccal_ref_compnr, 
                    target.cprj_cico=src.cprj_cico, 
                    target.cprj_cpla_cact_ref_compnr=src.cprj_cpla_cact_ref_compnr, 
                    target.cprj_cpla_ref_compnr=src.cprj_cpla_ref_compnr, 
                    target.cprj_cspa_ref_compnr=src.cprj_cspa_ref_compnr, 
                    target.cprj_fcmp=src.cprj_fcmp, 
                    target.cprj_ref_compnr=src.cprj_ref_compnr, 
                    target.cprj_task=src.cprj_task, 
                    target.cptc=src.cptc, 
                    target.cptc_ref_compnr=src.cptc_ref_compnr, 
                    target.cptc_year_peri_ref_compnr=src.cptc_year_peri_ref_compnr, 
                    target.cspa=src.cspa, 
                    target.cstl=src.cstl, 
                    target.cuni=src.cuni, 
                    target.cuni_ref_compnr=src.cuni_ref_compnr, 
                    target.cuti=src.cuti, 
                    target.cuti_ref_compnr=src.cuti_ref_compnr, 
                    target.deleted=src.deleted, 
                    target.dura=src.dura, 
                    target.emno=src.emno, 
                    target.emno_ref_compnr=src.emno_ref_compnr, 
                    target.exeq=src.exeq, 
                    target.exeq_kw=src.exeq_kw, 
                    target.item=src.item, 
                    target.item_ref_compnr=src.item_ref_compnr, 
                    target.lcaa_1=src.lcaa_1, 
                    target.lcaa_2=src.lcaa_2, 
                    target.lcaa_3=src.lcaa_3, 
                    target.lcaa_4=src.lcaa_4, 
                    target.lcos_cntc=src.lcos_cntc, 
                    target.lcos_dwhc=src.lcos_dwhc, 
                    target.lcos_prjc=src.lcos_prjc, 
                    target.lcos_refc=src.lcos_refc, 
                    target.lcta=src.lcta, 
                    target.norm=src.norm, 
                    target.peri=src.peri, 
                    target.prca_1=src.prca_1, 
                    target.prca_2=src.prca_2, 
                    target.prca_3=src.prca_3, 
                    target.prca_4=src.prca_4, 
                    target.pric=src.pric, 
                    target.pric_cntc=src.pric_cntc, 
                    target.pric_dwhc=src.pric_dwhc, 
                    target.pric_prjc=src.pric_prjc, 
                    target.pric_refc=src.pric_refc, 
                    target.pris=src.pris, 
                    target.pris_cntc=src.pris_cntc, 
                    target.pris_dwhc=src.pris_dwhc, 
                    target.pris_prjc=src.pris_prjc, 
                    target.pris_refc=src.pris_refc, 
                    target.prsa_1=src.prsa_1, 
                    target.prsa_2=src.prsa_2, 
                    target.prsa_3=src.prsa_3, 
                    target.prsa_4=src.prsa_4, 
                    target.quan=src.quan, 
                    target.quan_base_time=src.quan_base_time, 
                    target.quan_buar=src.quan_buar, 
                    target.quan_buln=src.quan_buln, 
                    target.quan_bupc=src.quan_bupc, 
                    target.quan_buvl=src.quan_buvl, 
                    target.quan_buwg=src.quan_buwg, 
                    target.quan_ctut=src.quan_ctut, 
                    target.qutm=src.qutm, 
                    target.ratc=src.ratc, 
                    target.rats=src.rats, 
                    target.refr=src.refr, 
                    target.rfin=src.rfin, 
                    target.rsta=src.rsta, 
                    target.rtca_1=src.rtca_1, 
                    target.rtca_2=src.rtca_2, 
                    target.rtca_3=src.rtca_3, 
                    target.rtca_4=src.rtca_4, 
                    target.rtsa_1=src.rtsa_1, 
                    target.rtsa_2=src.rtsa_2, 
                    target.rtsa_3=src.rtsa_3, 
                    target.rtsa_4=src.rtsa_4, 
                    target.sacu=src.sacu, 
                    target.sacu_ref_compnr=src.sacu_ref_compnr, 
                    target.scpf=src.scpf, 
                    target.sequencenumber=src.sequencenumber, 
                    target.sern=src.sern, 
                    target.stat=src.stat, 
                    target.stat_kw=src.stat_kw, 
                    target.task=src.task, 
                    target.task_rcmp=src.task_rcmp, 
                    target.timestamp=src.timestamp, 
                    target.tmud=src.tmud, 
                    target.tmud_ref_compnr=src.tmud_ref_compnr, 
                    target.unrt=src.unrt, 
                    target.unrt_ref_compnr=src.unrt_ref_compnr, 
                    target.user=src.user, 
                    target.username=src.username, 
                    target.year=src.year, 
                    target.ETL_SEQUENCE_NUMBER=src.ETL_SEQUENCE_NUMBER,
                    target.etl_load_datetime=CURRENT_TIMESTAMP,
                    target.etl_load_metadatafilename=src.etl_load_metadatafilename,
                    target.ETL_DELETED=src.ETL_DELETED
        when not matched   then insert ( aaoc_1, aaoc_2, aaoc_3, aaoc_4, aaos_1, aaos_2, aaos_3, aaos_4, adjm, adjm_kw, amoc, amoc_cntc, amoc_dwhc, amoc_prjc, amoc_refc, amos, amos_cntc, amos_dwhc, amos_prjc, amos_refc, basn, btdt, cact, ccal, ccco, ccco_ref_compnr, cico, cico_rcmp, clas, clas_ref_compnr, cocu, cocu_ref_compnr, cohc_1, cohc_2, cohc_3, cohc_4, compnr, cona, cona_cntc, cona_dwhc, cona_prjc, cona_refc, cotp, cotp_kw, cpla, cprj, cprj_basn_ref_compnr, cprj_ccal_ref_compnr, cprj_cico, cprj_cpla_cact_ref_compnr, cprj_cpla_ref_compnr, cprj_cspa_ref_compnr, cprj_fcmp, cprj_ref_compnr, cprj_task, cptc, cptc_ref_compnr, cptc_year_peri_ref_compnr, cspa, cstl, cuni, cuni_ref_compnr, cuti, cuti_ref_compnr, deleted, dura, emno, emno_ref_compnr, exeq, exeq_kw, item, item_ref_compnr, lcaa_1, lcaa_2, lcaa_3, lcaa_4, lcos_cntc, lcos_dwhc, lcos_prjc, lcos_refc, lcta, norm, peri, prca_1, prca_2, prca_3, prca_4, pric, pric_cntc, pric_dwhc, pric_prjc, pric_refc, pris, pris_cntc, pris_dwhc, pris_prjc, pris_refc, prsa_1, prsa_2, prsa_3, prsa_4, quan, quan_base_time, quan_buar, quan_buln, quan_bupc, quan_buvl, quan_buwg, quan_ctut, qutm, ratc, rats, refr, rfin, rsta, rtca_1, rtca_2, rtca_3, rtca_4, rtsa_1, rtsa_2, rtsa_3, rtsa_4, sacu, sacu_ref_compnr, scpf, sequencenumber, sern, stat, stat_kw, task, task_rcmp, timestamp, tmud, tmud_ref_compnr, unrt, unrt_ref_compnr, user, username, year, 
                    ETL_SEQUENCE_NUMBER,                       
                    etl_load_datetime,
                    etl_load_metadatafilename,
                    etl_is_deleted,
                    ETL_DELETED) 
            values (
                    src.aaoc_1, 
                    src.aaoc_2, 
                    src.aaoc_3, 
                    src.aaoc_4, 
                    src.aaos_1, 
                    src.aaos_2, 
                    src.aaos_3, 
                    src.aaos_4, 
                    src.adjm, 
                    src.adjm_kw, 
                    src.amoc, 
                    src.amoc_cntc, 
                    src.amoc_dwhc, 
                    src.amoc_prjc, 
                    src.amoc_refc, 
                    src.amos, 
                    src.amos_cntc, 
                    src.amos_dwhc, 
                    src.amos_prjc, 
                    src.amos_refc, 
                    src.basn, 
                    src.btdt, 
                    src.cact, 
                    src.ccal, 
                    src.ccco, 
                    src.ccco_ref_compnr, 
                    src.cico, 
                    src.cico_rcmp, 
                    src.clas, 
                    src.clas_ref_compnr, 
                    src.cocu, 
                    src.cocu_ref_compnr, 
                    src.cohc_1, 
                    src.cohc_2, 
                    src.cohc_3, 
                    src.cohc_4, 
                    src.compnr, 
                    src.cona, 
                    src.cona_cntc, 
                    src.cona_dwhc, 
                    src.cona_prjc, 
                    src.cona_refc, 
                    src.cotp, 
                    src.cotp_kw, 
                    src.cpla, 
                    src.cprj, 
                    src.cprj_basn_ref_compnr, 
                    src.cprj_ccal_ref_compnr, 
                    src.cprj_cico, 
                    src.cprj_cpla_cact_ref_compnr, 
                    src.cprj_cpla_ref_compnr, 
                    src.cprj_cspa_ref_compnr, 
                    src.cprj_fcmp, 
                    src.cprj_ref_compnr, 
                    src.cprj_task, 
                    src.cptc, 
                    src.cptc_ref_compnr, 
                    src.cptc_year_peri_ref_compnr, 
                    src.cspa, 
                    src.cstl, 
                    src.cuni, 
                    src.cuni_ref_compnr, 
                    src.cuti, 
                    src.cuti_ref_compnr, 
                    src.deleted, 
                    src.dura, 
                    src.emno, 
                    src.emno_ref_compnr, 
                    src.exeq, 
                    src.exeq_kw, 
                    src.item, 
                    src.item_ref_compnr, 
                    src.lcaa_1, 
                    src.lcaa_2, 
                    src.lcaa_3, 
                    src.lcaa_4, 
                    src.lcos_cntc, 
                    src.lcos_dwhc, 
                    src.lcos_prjc, 
                    src.lcos_refc, 
                    src.lcta, 
                    src.norm, 
                    src.peri, 
                    src.prca_1, 
                    src.prca_2, 
                    src.prca_3, 
                    src.prca_4, 
                    src.pric, 
                    src.pric_cntc, 
                    src.pric_dwhc, 
                    src.pric_prjc, 
                    src.pric_refc, 
                    src.pris, 
                    src.pris_cntc, 
                    src.pris_dwhc, 
                    src.pris_prjc, 
                    src.pris_refc, 
                    src.prsa_1, 
                    src.prsa_2, 
                    src.prsa_3, 
                    src.prsa_4, 
                    src.quan, 
                    src.quan_base_time, 
                    src.quan_buar, 
                    src.quan_buln, 
                    src.quan_bupc, 
                    src.quan_buvl, 
                    src.quan_buwg, 
                    src.quan_ctut, 
                    src.qutm, 
                    src.ratc, 
                    src.rats, 
                    src.refr, 
                    src.rfin, 
                    src.rsta, 
                    src.rtca_1, 
                    src.rtca_2, 
                    src.rtca_3, 
                    src.rtca_4, 
                    src.rtsa_1, 
                    src.rtsa_2, 
                    src.rtsa_3, 
                    src.rtsa_4, 
                    src.sacu, 
                    src.sacu_ref_compnr, 
                    src.scpf, 
                    src.sequencenumber, 
                    src.sern, 
                    src.stat, 
                    src.stat_kw, 
                    src.task, 
                    src.task_rcmp, 
                    src.timestamp, 
                    src.tmud, 
                    src.tmud_ref_compnr, 
                    src.unrt, 
                    src.unrt_ref_compnr, 
                    src.user, 
                    src.username, 
                    src.year,     
                    src.ETL_SEQUENCE_NUMBER,
                    CURRENT_TIMESTAMP,
                    src.etl_load_metadatafilename,
                    case when ETL_DELETED=TRUE then TRUE else FALSE end,
                    ETL_DELETED);
    `
} );

                    
//  Get number of rows inserted
        
        var sqlStmt = snowflake.createStatement( {sqlText:  sql_command} );
        var rs = sqlStmt.execute();
        var number_of_rows_inserted = sqlStmt.getNumRowsInserted();
        var number_of_rows_updated =  sqlStmt.getNumRowsUpdated();
                    

        
    snowflake.execute ({sqlText: "commit"});

    log_sql_command = "call datahub_logging.sp_etl_log_ingestion_process('UpdateEnd','" + process_name + "','Success','Completed process execution.', 0 ," + number_of_rows_inserted.toString()+ "," +  number_of_rows_updated.toString() + ");";
    snowflake.execute({sqlText: log_sql_command});

    result = "Success"; 

    }       

    catch (err)  {
        snowflake.execute( {sqlText: "rollback;"} )
        var clean_error_msg = err.message.replace(/[^\w\s]/gi, '');
    //  Create a log entry to say INSERT STATEMENT failed
    
    log_sql_command = "call datahub_logging.sp_etl_log_ingestion_process('UpdateEnd','" + process_name + "','Failed','MERGE Failed. Error:" + err.code.toString()+" : "+ clean_error_msg  + "', 0 ,0,0);";
    snowflake.execute({sqlText: log_sql_command});
        ;
        throw "Failed: " + err.message;   // Return a success/error indicator.
        }
    return result;
    $$;