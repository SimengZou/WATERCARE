create or replace procedure DATAHUB_INTEGRATION.SP_LN_TPPIN060()
    returns varchar not null
                language javascript
                as
                $$

//  Variables

var result = "";                                    // return status of this proc call
const process_name = Object.keys(this)[0];          // name of currently executing process
var number_of_rows_inserted = 0;                             // track number of rows we have inserted
var number_of_rows_updated = 0;                             // track number of rows we have updated


//  Step 1.

//  Start execution - log start

log_sql_command = "call datahub_logging.sp_etl_log_ingestion_process('Insert','" + process_name + "','Running','Started process execution.', 0,0,0);";
snowflake.execute({sqlText: log_sql_command});

snowflake.execute( {sqlText: "begin transaction;"} );
try
    {
        var sql_command = `
                            INSERT INTO LANDING_ERROR.LN_RAW_ERROR
                            SELECT * FROM LANDING_ERROR.VW_STREAM_LN_TPPIN060_ERROR`;
    var sqlStmt = snowflake.createStatement( {sqlText:  sql_command} );
    var rs = sqlStmt.execute();
        
        var sql_command = ` 
                            merge into  TARGET_LN.LN_TPPIN060 as target using (SELECT * FROM (SELECT 
            strm.addt, 
            strm.adin, 
            strm.cact, 
            strm.carr, 
            strm.carr_ref_compnr, 
            strm.cdec, 
            strm.cdec_ref_compnr, 
            strm.citt, 
            strm.citt_ref_compnr, 
            strm.cnln, 
            strm.compnr, 
            strm.cono, 
            strm.cono_cnln_ref_compnr, 
            strm.cono_ref_compnr, 
            strm.cpla, 
            strm.cprj, 
            strm.cprj_cpla_cact_ref_compnr, 
            strm.cprj_cpla_ref_compnr, 
            strm.cprj_cspa_ref_compnr, 
            strm.cprj_cstl_ref_compnr, 
            strm.cprj_ref_compnr, 
            strm.cspa, 
            strm.cstl, 
            strm.cstv, 
            strm.cuvc, 
            strm.cuvc_ref_compnr, 
            strm.cwar, 
            strm.cwar_ref_compnr, 
            strm.cwun, 
            strm.cwun_ref_compnr, 
            strm.deleted, 
            strm.disc, 
            strm.dlld, 
            strm.dlnt, 
            strm.dlor, 
            strm.dlor_kw, 
            strm.dlvr, 
            strm.dorg, 
            strm.dorg_kw, 
            strm.effn, 
            strm.effn_ref_compnr, 
            strm.fcmp, 
            strm.icmp, 
            strm.idln, 
            strm.idoc, 
            strm.inst, 
            strm.item, 
            strm.item_ref_compnr, 
            strm.ityp, 
            strm.ldam, 
            strm.link, 
            strm.link_kw, 
            strm.lssn, 
            strm.lssn_ref_compnr, 
            strm.nins, 
            strm.ofbp, 
            strm.ofbp_ref_compnr, 
            strm.pcad, 
            strm.pcad_kw, 
            strm.pono, 
            strm.porg, 
            strm.porg_kw, 
            strm.pris, 
            strm.prsg, 
            strm.ptpa, 
            strm.ptpa_ref_compnr, 
            strm.puni, 
            strm.pupd, 
            strm.pupd_kw, 
            strm.qshp, 
            strm.rcln, 
            strm.rcno, 
            strm.rtor, 
            strm.rtor_kw, 
            strm.sacu, 
            strm.samt, 
            strm.samt_cntc, 
            strm.samt_dwhc, 
            strm.samt_homc, 
            strm.samt_prjc, 
            strm.samt_refc, 
            strm.samt_rpc1, 
            strm.samt_rpc2, 
            strm.schd, 
            strm.sequencenumber, 
            strm.sern, 
            strm.sfbp, 
            strm.sfbp_ref_compnr, 
            strm.shpm, 
            strm.srvc, 
            strm.srvc_kw, 
            strm.stad, 
            strm.stad_ref_compnr, 
            strm.stbp, 
            strm.stbp_ref_compnr, 
            strm.suni, 
            strm.timestamp, 
            strm.twar, 
            strm.twar_ref_compnr, 
            strm.username, 
            strm.wght, 
            strm.ETL_SEQUENCE_NUMBER,
            strm.ETL_DELETED,
            strm.etl_load_datetime,
            strm.etl_load_metadatafilename,
            ROW_NUMBER() OVER (PARTITION BY 
            strm.compnr,
            strm.cono,
            strm.cnln,
            strm.dlvr,
            strm.schd,
            strm.cprj,
            strm.cspa,
            strm.cpla,
            strm.cact,
            strm.shpm,
            strm.pono,
            strm.rcno,
            strm.rcln,
            strm.sern ORDER BY strm.ETL_SEQUENCE_NUMBER desc,IFNULL(TRY_TO_TIMESTAMP(replace(right(replace(lower(etl_load_metadatafilename),'.json'),23),'_','-'), 'yyyy-mm-dd-HH-MI-SS-FF') ,etl_load_datetime) desc) as ROWNUMBER
        FROM DATAHUB_INTEGRATION.VW_STREAM_LN_TPPIN060 as  strm
                    )   
            WHERE ROWNUMBER=1  
            
                    ) as src on
            ((target.compnr=src.compnr) OR (target.compnr IS NULL AND src.compnr IS NULL)) AND
            ((target.cono=src.cono) OR (target.cono IS NULL AND src.cono IS NULL)) AND
            ((target.cnln=src.cnln) OR (target.cnln IS NULL AND src.cnln IS NULL)) AND
            ((target.dlvr=src.dlvr) OR (target.dlvr IS NULL AND src.dlvr IS NULL)) AND
            ((target.schd=src.schd) OR (target.schd IS NULL AND src.schd IS NULL)) AND
            ((target.cprj=src.cprj) OR (target.cprj IS NULL AND src.cprj IS NULL)) AND
            ((target.cspa=src.cspa) OR (target.cspa IS NULL AND src.cspa IS NULL)) AND
            ((target.cpla=src.cpla) OR (target.cpla IS NULL AND src.cpla IS NULL)) AND
            ((target.cact=src.cact) OR (target.cact IS NULL AND src.cact IS NULL)) AND
            ((target.shpm=src.shpm) OR (target.shpm IS NULL AND src.shpm IS NULL)) AND
            ((target.pono=src.pono) OR (target.pono IS NULL AND src.pono IS NULL)) AND
            ((target.rcno=src.rcno) OR (target.rcno IS NULL AND src.rcno IS NULL)) AND
            ((target.rcln=src.rcln) OR (target.rcln IS NULL AND src.rcln IS NULL)) AND
            ((target.sern=src.sern) OR (target.sern IS NULL AND src.sern IS NULL)) 
                when matched and src.ETL_DELETED=TRUE THEN DELETE
                when matched then update set
                    target.addt=src.addt, 
                    target.adin=src.adin, 
                    target.cact=src.cact, 
                    target.carr=src.carr, 
                    target.carr_ref_compnr=src.carr_ref_compnr, 
                    target.cdec=src.cdec, 
                    target.cdec_ref_compnr=src.cdec_ref_compnr, 
                    target.citt=src.citt, 
                    target.citt_ref_compnr=src.citt_ref_compnr, 
                    target.cnln=src.cnln, 
                    target.compnr=src.compnr, 
                    target.cono=src.cono, 
                    target.cono_cnln_ref_compnr=src.cono_cnln_ref_compnr, 
                    target.cono_ref_compnr=src.cono_ref_compnr, 
                    target.cpla=src.cpla, 
                    target.cprj=src.cprj, 
                    target.cprj_cpla_cact_ref_compnr=src.cprj_cpla_cact_ref_compnr, 
                    target.cprj_cpla_ref_compnr=src.cprj_cpla_ref_compnr, 
                    target.cprj_cspa_ref_compnr=src.cprj_cspa_ref_compnr, 
                    target.cprj_cstl_ref_compnr=src.cprj_cstl_ref_compnr, 
                    target.cprj_ref_compnr=src.cprj_ref_compnr, 
                    target.cspa=src.cspa, 
                    target.cstl=src.cstl, 
                    target.cstv=src.cstv, 
                    target.cuvc=src.cuvc, 
                    target.cuvc_ref_compnr=src.cuvc_ref_compnr, 
                    target.cwar=src.cwar, 
                    target.cwar_ref_compnr=src.cwar_ref_compnr, 
                    target.cwun=src.cwun, 
                    target.cwun_ref_compnr=src.cwun_ref_compnr, 
                    target.deleted=src.deleted, 
                    target.disc=src.disc, 
                    target.dlld=src.dlld, 
                    target.dlnt=src.dlnt, 
                    target.dlor=src.dlor, 
                    target.dlor_kw=src.dlor_kw, 
                    target.dlvr=src.dlvr, 
                    target.dorg=src.dorg, 
                    target.dorg_kw=src.dorg_kw, 
                    target.effn=src.effn, 
                    target.effn_ref_compnr=src.effn_ref_compnr, 
                    target.fcmp=src.fcmp, 
                    target.icmp=src.icmp, 
                    target.idln=src.idln, 
                    target.idoc=src.idoc, 
                    target.inst=src.inst, 
                    target.item=src.item, 
                    target.item_ref_compnr=src.item_ref_compnr, 
                    target.ityp=src.ityp, 
                    target.ldam=src.ldam, 
                    target.link=src.link, 
                    target.link_kw=src.link_kw, 
                    target.lssn=src.lssn, 
                    target.lssn_ref_compnr=src.lssn_ref_compnr, 
                    target.nins=src.nins, 
                    target.ofbp=src.ofbp, 
                    target.ofbp_ref_compnr=src.ofbp_ref_compnr, 
                    target.pcad=src.pcad, 
                    target.pcad_kw=src.pcad_kw, 
                    target.pono=src.pono, 
                    target.porg=src.porg, 
                    target.porg_kw=src.porg_kw, 
                    target.pris=src.pris, 
                    target.prsg=src.prsg, 
                    target.ptpa=src.ptpa, 
                    target.ptpa_ref_compnr=src.ptpa_ref_compnr, 
                    target.puni=src.puni, 
                    target.pupd=src.pupd, 
                    target.pupd_kw=src.pupd_kw, 
                    target.qshp=src.qshp, 
                    target.rcln=src.rcln, 
                    target.rcno=src.rcno, 
                    target.rtor=src.rtor, 
                    target.rtor_kw=src.rtor_kw, 
                    target.sacu=src.sacu, 
                    target.samt=src.samt, 
                    target.samt_cntc=src.samt_cntc, 
                    target.samt_dwhc=src.samt_dwhc, 
                    target.samt_homc=src.samt_homc, 
                    target.samt_prjc=src.samt_prjc, 
                    target.samt_refc=src.samt_refc, 
                    target.samt_rpc1=src.samt_rpc1, 
                    target.samt_rpc2=src.samt_rpc2, 
                    target.schd=src.schd, 
                    target.sequencenumber=src.sequencenumber, 
                    target.sern=src.sern, 
                    target.sfbp=src.sfbp, 
                    target.sfbp_ref_compnr=src.sfbp_ref_compnr, 
                    target.shpm=src.shpm, 
                    target.srvc=src.srvc, 
                    target.srvc_kw=src.srvc_kw, 
                    target.stad=src.stad, 
                    target.stad_ref_compnr=src.stad_ref_compnr, 
                    target.stbp=src.stbp, 
                    target.stbp_ref_compnr=src.stbp_ref_compnr, 
                    target.suni=src.suni, 
                    target.timestamp=src.timestamp, 
                    target.twar=src.twar, 
                    target.twar_ref_compnr=src.twar_ref_compnr, 
                    target.username=src.username, 
                    target.wght=src.wght, 
                    target.ETL_SEQUENCE_NUMBER=src.ETL_SEQUENCE_NUMBER,
                    target.etl_load_datetime=CURRENT_TIMESTAMP,
                    target.etl_load_metadatafilename=src.etl_load_metadatafilename
        when not matched and (src.ETL_DELETED=FALSE OR src.ETL_DELETED IS NULL)  then insert ( 
                    addt, 
                    adin, 
                    cact, 
                    carr, 
                    carr_ref_compnr, 
                    cdec, 
                    cdec_ref_compnr, 
                    citt, 
                    citt_ref_compnr, 
                    cnln, 
                    compnr, 
                    cono, 
                    cono_cnln_ref_compnr, 
                    cono_ref_compnr, 
                    cpla, 
                    cprj, 
                    cprj_cpla_cact_ref_compnr, 
                    cprj_cpla_ref_compnr, 
                    cprj_cspa_ref_compnr, 
                    cprj_cstl_ref_compnr, 
                    cprj_ref_compnr, 
                    cspa, 
                    cstl, 
                    cstv, 
                    cuvc, 
                    cuvc_ref_compnr, 
                    cwar, 
                    cwar_ref_compnr, 
                    cwun, 
                    cwun_ref_compnr, 
                    deleted, 
                    disc, 
                    dlld, 
                    dlnt, 
                    dlor, 
                    dlor_kw, 
                    dlvr, 
                    dorg, 
                    dorg_kw, 
                    effn, 
                    effn_ref_compnr, 
                    fcmp, 
                    icmp, 
                    idln, 
                    idoc, 
                    inst, 
                    item, 
                    item_ref_compnr, 
                    ityp, 
                    ldam, 
                    link, 
                    link_kw, 
                    lssn, 
                    lssn_ref_compnr, 
                    nins, 
                    ofbp, 
                    ofbp_ref_compnr, 
                    pcad, 
                    pcad_kw, 
                    pono, 
                    porg, 
                    porg_kw, 
                    pris, 
                    prsg, 
                    ptpa, 
                    ptpa_ref_compnr, 
                    puni, 
                    pupd, 
                    pupd_kw, 
                    qshp, 
                    rcln, 
                    rcno, 
                    rtor, 
                    rtor_kw, 
                    sacu, 
                    samt, 
                    samt_cntc, 
                    samt_dwhc, 
                    samt_homc, 
                    samt_prjc, 
                    samt_refc, 
                    samt_rpc1, 
                    samt_rpc2, 
                    schd, 
                    sequencenumber, 
                    sern, 
                    sfbp, 
                    sfbp_ref_compnr, 
                    shpm, 
                    srvc, 
                    srvc_kw, 
                    stad, 
                    stad_ref_compnr, 
                    stbp, 
                    stbp_ref_compnr, 
                    suni, 
                    timestamp, 
                    twar, 
                    twar_ref_compnr, 
                    username, 
                    wght, 
                    ETL_SEQUENCE_NUMBER,                       
                    etl_load_datetime,
                    etl_load_metadatafilename) 
            values (
                    src.addt, 
                    src.adin, 
                    src.cact, 
                    src.carr, 
                    src.carr_ref_compnr, 
                    src.cdec, 
                    src.cdec_ref_compnr, 
                    src.citt, 
                    src.citt_ref_compnr, 
                    src.cnln, 
                    src.compnr, 
                    src.cono, 
                    src.cono_cnln_ref_compnr, 
                    src.cono_ref_compnr, 
                    src.cpla, 
                    src.cprj, 
                    src.cprj_cpla_cact_ref_compnr, 
                    src.cprj_cpla_ref_compnr, 
                    src.cprj_cspa_ref_compnr, 
                    src.cprj_cstl_ref_compnr, 
                    src.cprj_ref_compnr, 
                    src.cspa, 
                    src.cstl, 
                    src.cstv, 
                    src.cuvc, 
                    src.cuvc_ref_compnr, 
                    src.cwar, 
                    src.cwar_ref_compnr, 
                    src.cwun, 
                    src.cwun_ref_compnr, 
                    src.deleted, 
                    src.disc, 
                    src.dlld, 
                    src.dlnt, 
                    src.dlor, 
                    src.dlor_kw, 
                    src.dlvr, 
                    src.dorg, 
                    src.dorg_kw, 
                    src.effn, 
                    src.effn_ref_compnr, 
                    src.fcmp, 
                    src.icmp, 
                    src.idln, 
                    src.idoc, 
                    src.inst, 
                    src.item, 
                    src.item_ref_compnr, 
                    src.ityp, 
                    src.ldam, 
                    src.link, 
                    src.link_kw, 
                    src.lssn, 
                    src.lssn_ref_compnr, 
                    src.nins, 
                    src.ofbp, 
                    src.ofbp_ref_compnr, 
                    src.pcad, 
                    src.pcad_kw, 
                    src.pono, 
                    src.porg, 
                    src.porg_kw, 
                    src.pris, 
                    src.prsg, 
                    src.ptpa, 
                    src.ptpa_ref_compnr, 
                    src.puni, 
                    src.pupd, 
                    src.pupd_kw, 
                    src.qshp, 
                    src.rcln, 
                    src.rcno, 
                    src.rtor, 
                    src.rtor_kw, 
                    src.sacu, 
                    src.samt, 
                    src.samt_cntc, 
                    src.samt_dwhc, 
                    src.samt_homc, 
                    src.samt_prjc, 
                    src.samt_refc, 
                    src.samt_rpc1, 
                    src.samt_rpc2, 
                    src.schd, 
                    src.sequencenumber, 
                    src.sern, 
                    src.sfbp, 
                    src.sfbp_ref_compnr, 
                    src.shpm, 
                    src.srvc, 
                    src.srvc_kw, 
                    src.stad, 
                    src.stad_ref_compnr, 
                    src.stbp, 
                    src.stbp_ref_compnr, 
                    src.suni, 
                    src.timestamp, 
                    src.twar, 
                    src.twar_ref_compnr, 
                    src.username, 
                    src.wght,     
                    src.ETL_SEQUENCE_NUMBER,
                    CURRENT_TIMESTAMP,
                    src.etl_load_metadatafilename);`;

    var sqlStmt = snowflake.createStatement( {sqlText:  sql_command} );
    var rs = sqlStmt.execute();

    snowflake.execute( {sqlText: `merge into TARGET_HISTORY_LN.LN_TPPIN060_DELETED as target using (
                SELECT * FROM (SELECT 
            strm.addt, 
            strm.adin, 
            strm.cact, 
            strm.carr, 
            strm.carr_ref_compnr, 
            strm.cdec, 
            strm.cdec_ref_compnr, 
            strm.citt, 
            strm.citt_ref_compnr, 
            strm.cnln, 
            strm.compnr, 
            strm.cono, 
            strm.cono_cnln_ref_compnr, 
            strm.cono_ref_compnr, 
            strm.cpla, 
            strm.cprj, 
            strm.cprj_cpla_cact_ref_compnr, 
            strm.cprj_cpla_ref_compnr, 
            strm.cprj_cspa_ref_compnr, 
            strm.cprj_cstl_ref_compnr, 
            strm.cprj_ref_compnr, 
            strm.cspa, 
            strm.cstl, 
            strm.cstv, 
            strm.cuvc, 
            strm.cuvc_ref_compnr, 
            strm.cwar, 
            strm.cwar_ref_compnr, 
            strm.cwun, 
            strm.cwun_ref_compnr, 
            strm.deleted, 
            strm.disc, 
            strm.dlld, 
            strm.dlnt, 
            strm.dlor, 
            strm.dlor_kw, 
            strm.dlvr, 
            strm.dorg, 
            strm.dorg_kw, 
            strm.effn, 
            strm.effn_ref_compnr, 
            strm.fcmp, 
            strm.icmp, 
            strm.idln, 
            strm.idoc, 
            strm.inst, 
            strm.item, 
            strm.item_ref_compnr, 
            strm.ityp, 
            strm.ldam, 
            strm.link, 
            strm.link_kw, 
            strm.lssn, 
            strm.lssn_ref_compnr, 
            strm.nins, 
            strm.ofbp, 
            strm.ofbp_ref_compnr, 
            strm.pcad, 
            strm.pcad_kw, 
            strm.pono, 
            strm.porg, 
            strm.porg_kw, 
            strm.pris, 
            strm.prsg, 
            strm.ptpa, 
            strm.ptpa_ref_compnr, 
            strm.puni, 
            strm.pupd, 
            strm.pupd_kw, 
            strm.qshp, 
            strm.rcln, 
            strm.rcno, 
            strm.rtor, 
            strm.rtor_kw, 
            strm.sacu, 
            strm.samt, 
            strm.samt_cntc, 
            strm.samt_dwhc, 
            strm.samt_homc, 
            strm.samt_prjc, 
            strm.samt_refc, 
            strm.samt_rpc1, 
            strm.samt_rpc2, 
            strm.schd, 
            strm.sequencenumber, 
            strm.sern, 
            strm.sfbp, 
            strm.sfbp_ref_compnr, 
            strm.shpm, 
            strm.srvc, 
            strm.srvc_kw, 
            strm.stad, 
            strm.stad_ref_compnr, 
            strm.stbp, 
            strm.stbp_ref_compnr, 
            strm.suni, 
            strm.timestamp, 
            strm.twar, 
            strm.twar_ref_compnr, 
            strm.username, 
            strm.wght, 
            strm.ETL_SEQUENCE_NUMBER,
            strm.ETL_DELETED,
            strm.etl_load_datetime,
            strm.etl_load_metadatafilename,
            ROW_NUMBER() OVER (PARTITION BY 
            strm.compnr,
            strm.cono,
            strm.cnln,
            strm.dlvr,
            strm.schd,
            strm.cprj,
            strm.cspa,
            strm.cpla,
            strm.cact,
            strm.shpm,
            strm.pono,
            strm.rcno,
            strm.rcln,
            strm.sern ORDER BY strm.ETL_SEQUENCE_NUMBER desc,IFNULL(TRY_TO_TIMESTAMP(replace(right(replace(lower(etl_load_metadatafilename),'.json'),23),'_','-'), 'yyyy-mm-dd-HH-MI-SS-FF') ,etl_load_datetime) desc) as ROWNUMBER
        FROM DATAHUB_INTEGRATION.VW_STREAM_LN_TPPIN060 as  strm
        WHERE strm.ETL_DELETED=TRUE
                    )   
            WHERE ROWNUMBER=1  
            
                    ) as src on
            ((target.compnr=src.compnr) OR (target.compnr IS NULL AND src.compnr IS NULL)) AND
            ((target.cono=src.cono) OR (target.cono IS NULL AND src.cono IS NULL)) AND
            ((target.cnln=src.cnln) OR (target.cnln IS NULL AND src.cnln IS NULL)) AND
            ((target.dlvr=src.dlvr) OR (target.dlvr IS NULL AND src.dlvr IS NULL)) AND
            ((target.schd=src.schd) OR (target.schd IS NULL AND src.schd IS NULL)) AND
            ((target.cprj=src.cprj) OR (target.cprj IS NULL AND src.cprj IS NULL)) AND
            ((target.cspa=src.cspa) OR (target.cspa IS NULL AND src.cspa IS NULL)) AND
            ((target.cpla=src.cpla) OR (target.cpla IS NULL AND src.cpla IS NULL)) AND
            ((target.cact=src.cact) OR (target.cact IS NULL AND src.cact IS NULL)) AND
            ((target.shpm=src.shpm) OR (target.shpm IS NULL AND src.shpm IS NULL)) AND
            ((target.pono=src.pono) OR (target.pono IS NULL AND src.pono IS NULL)) AND
            ((target.rcno=src.rcno) OR (target.rcno IS NULL AND src.rcno IS NULL)) AND
            ((target.rcln=src.rcln) OR (target.rcln IS NULL AND src.rcln IS NULL)) AND
            ((target.sern=src.sern) OR (target.sern IS NULL AND src.sern IS NULL)) 
                when matched then update set
                    target.addt=src.addt, 
                    target.adin=src.adin, 
                    target.cact=src.cact, 
                    target.carr=src.carr, 
                    target.carr_ref_compnr=src.carr_ref_compnr, 
                    target.cdec=src.cdec, 
                    target.cdec_ref_compnr=src.cdec_ref_compnr, 
                    target.citt=src.citt, 
                    target.citt_ref_compnr=src.citt_ref_compnr, 
                    target.cnln=src.cnln, 
                    target.compnr=src.compnr, 
                    target.cono=src.cono, 
                    target.cono_cnln_ref_compnr=src.cono_cnln_ref_compnr, 
                    target.cono_ref_compnr=src.cono_ref_compnr, 
                    target.cpla=src.cpla, 
                    target.cprj=src.cprj, 
                    target.cprj_cpla_cact_ref_compnr=src.cprj_cpla_cact_ref_compnr, 
                    target.cprj_cpla_ref_compnr=src.cprj_cpla_ref_compnr, 
                    target.cprj_cspa_ref_compnr=src.cprj_cspa_ref_compnr, 
                    target.cprj_cstl_ref_compnr=src.cprj_cstl_ref_compnr, 
                    target.cprj_ref_compnr=src.cprj_ref_compnr, 
                    target.cspa=src.cspa, 
                    target.cstl=src.cstl, 
                    target.cstv=src.cstv, 
                    target.cuvc=src.cuvc, 
                    target.cuvc_ref_compnr=src.cuvc_ref_compnr, 
                    target.cwar=src.cwar, 
                    target.cwar_ref_compnr=src.cwar_ref_compnr, 
                    target.cwun=src.cwun, 
                    target.cwun_ref_compnr=src.cwun_ref_compnr, 
                    target.deleted=src.deleted, 
                    target.disc=src.disc, 
                    target.dlld=src.dlld, 
                    target.dlnt=src.dlnt, 
                    target.dlor=src.dlor, 
                    target.dlor_kw=src.dlor_kw, 
                    target.dlvr=src.dlvr, 
                    target.dorg=src.dorg, 
                    target.dorg_kw=src.dorg_kw, 
                    target.effn=src.effn, 
                    target.effn_ref_compnr=src.effn_ref_compnr, 
                    target.fcmp=src.fcmp, 
                    target.icmp=src.icmp, 
                    target.idln=src.idln, 
                    target.idoc=src.idoc, 
                    target.inst=src.inst, 
                    target.item=src.item, 
                    target.item_ref_compnr=src.item_ref_compnr, 
                    target.ityp=src.ityp, 
                    target.ldam=src.ldam, 
                    target.link=src.link, 
                    target.link_kw=src.link_kw, 
                    target.lssn=src.lssn, 
                    target.lssn_ref_compnr=src.lssn_ref_compnr, 
                    target.nins=src.nins, 
                    target.ofbp=src.ofbp, 
                    target.ofbp_ref_compnr=src.ofbp_ref_compnr, 
                    target.pcad=src.pcad, 
                    target.pcad_kw=src.pcad_kw, 
                    target.pono=src.pono, 
                    target.porg=src.porg, 
                    target.porg_kw=src.porg_kw, 
                    target.pris=src.pris, 
                    target.prsg=src.prsg, 
                    target.ptpa=src.ptpa, 
                    target.ptpa_ref_compnr=src.ptpa_ref_compnr, 
                    target.puni=src.puni, 
                    target.pupd=src.pupd, 
                    target.pupd_kw=src.pupd_kw, 
                    target.qshp=src.qshp, 
                    target.rcln=src.rcln, 
                    target.rcno=src.rcno, 
                    target.rtor=src.rtor, 
                    target.rtor_kw=src.rtor_kw, 
                    target.sacu=src.sacu, 
                    target.samt=src.samt, 
                    target.samt_cntc=src.samt_cntc, 
                    target.samt_dwhc=src.samt_dwhc, 
                    target.samt_homc=src.samt_homc, 
                    target.samt_prjc=src.samt_prjc, 
                    target.samt_refc=src.samt_refc, 
                    target.samt_rpc1=src.samt_rpc1, 
                    target.samt_rpc2=src.samt_rpc2, 
                    target.schd=src.schd, 
                    target.sequencenumber=src.sequencenumber, 
                    target.sern=src.sern, 
                    target.sfbp=src.sfbp, 
                    target.sfbp_ref_compnr=src.sfbp_ref_compnr, 
                    target.shpm=src.shpm, 
                    target.srvc=src.srvc, 
                    target.srvc_kw=src.srvc_kw, 
                    target.stad=src.stad, 
                    target.stad_ref_compnr=src.stad_ref_compnr, 
                    target.stbp=src.stbp, 
                    target.stbp_ref_compnr=src.stbp_ref_compnr, 
                    target.suni=src.suni, 
                    target.timestamp=src.timestamp, 
                    target.twar=src.twar, 
                    target.twar_ref_compnr=src.twar_ref_compnr, 
                    target.username=src.username, 
                    target.wght=src.wght, 
                    target.ETL_SEQUENCE_NUMBER=src.ETL_SEQUENCE_NUMBER,
                    target.etl_load_datetime=CURRENT_TIMESTAMP,
                    target.etl_load_metadatafilename=src.etl_load_metadatafilename,
                    target.ETL_DELETED=src.ETL_DELETED
        when not matched   then insert ( addt, adin, cact, carr, carr_ref_compnr, cdec, cdec_ref_compnr, citt, citt_ref_compnr, cnln, compnr, cono, cono_cnln_ref_compnr, cono_ref_compnr, cpla, cprj, cprj_cpla_cact_ref_compnr, cprj_cpla_ref_compnr, cprj_cspa_ref_compnr, cprj_cstl_ref_compnr, cprj_ref_compnr, cspa, cstl, cstv, cuvc, cuvc_ref_compnr, cwar, cwar_ref_compnr, cwun, cwun_ref_compnr, deleted, disc, dlld, dlnt, dlor, dlor_kw, dlvr, dorg, dorg_kw, effn, effn_ref_compnr, fcmp, icmp, idln, idoc, inst, item, item_ref_compnr, ityp, ldam, link, link_kw, lssn, lssn_ref_compnr, nins, ofbp, ofbp_ref_compnr, pcad, pcad_kw, pono, porg, porg_kw, pris, prsg, ptpa, ptpa_ref_compnr, puni, pupd, pupd_kw, qshp, rcln, rcno, rtor, rtor_kw, sacu, samt, samt_cntc, samt_dwhc, samt_homc, samt_prjc, samt_refc, samt_rpc1, samt_rpc2, schd, sequencenumber, sern, sfbp, sfbp_ref_compnr, shpm, srvc, srvc_kw, stad, stad_ref_compnr, stbp, stbp_ref_compnr, suni, timestamp, twar, twar_ref_compnr, username, wght, 
                    ETL_SEQUENCE_NUMBER,                       
                    etl_load_datetime,
                    etl_load_metadatafilename,
                    etl_is_deleted,
                    ETL_DELETED) 
            values (
                    src.addt, 
                    src.adin, 
                    src.cact, 
                    src.carr, 
                    src.carr_ref_compnr, 
                    src.cdec, 
                    src.cdec_ref_compnr, 
                    src.citt, 
                    src.citt_ref_compnr, 
                    src.cnln, 
                    src.compnr, 
                    src.cono, 
                    src.cono_cnln_ref_compnr, 
                    src.cono_ref_compnr, 
                    src.cpla, 
                    src.cprj, 
                    src.cprj_cpla_cact_ref_compnr, 
                    src.cprj_cpla_ref_compnr, 
                    src.cprj_cspa_ref_compnr, 
                    src.cprj_cstl_ref_compnr, 
                    src.cprj_ref_compnr, 
                    src.cspa, 
                    src.cstl, 
                    src.cstv, 
                    src.cuvc, 
                    src.cuvc_ref_compnr, 
                    src.cwar, 
                    src.cwar_ref_compnr, 
                    src.cwun, 
                    src.cwun_ref_compnr, 
                    src.deleted, 
                    src.disc, 
                    src.dlld, 
                    src.dlnt, 
                    src.dlor, 
                    src.dlor_kw, 
                    src.dlvr, 
                    src.dorg, 
                    src.dorg_kw, 
                    src.effn, 
                    src.effn_ref_compnr, 
                    src.fcmp, 
                    src.icmp, 
                    src.idln, 
                    src.idoc, 
                    src.inst, 
                    src.item, 
                    src.item_ref_compnr, 
                    src.ityp, 
                    src.ldam, 
                    src.link, 
                    src.link_kw, 
                    src.lssn, 
                    src.lssn_ref_compnr, 
                    src.nins, 
                    src.ofbp, 
                    src.ofbp_ref_compnr, 
                    src.pcad, 
                    src.pcad_kw, 
                    src.pono, 
                    src.porg, 
                    src.porg_kw, 
                    src.pris, 
                    src.prsg, 
                    src.ptpa, 
                    src.ptpa_ref_compnr, 
                    src.puni, 
                    src.pupd, 
                    src.pupd_kw, 
                    src.qshp, 
                    src.rcln, 
                    src.rcno, 
                    src.rtor, 
                    src.rtor_kw, 
                    src.sacu, 
                    src.samt, 
                    src.samt_cntc, 
                    src.samt_dwhc, 
                    src.samt_homc, 
                    src.samt_prjc, 
                    src.samt_refc, 
                    src.samt_rpc1, 
                    src.samt_rpc2, 
                    src.schd, 
                    src.sequencenumber, 
                    src.sern, 
                    src.sfbp, 
                    src.sfbp_ref_compnr, 
                    src.shpm, 
                    src.srvc, 
                    src.srvc_kw, 
                    src.stad, 
                    src.stad_ref_compnr, 
                    src.stbp, 
                    src.stbp_ref_compnr, 
                    src.suni, 
                    src.timestamp, 
                    src.twar, 
                    src.twar_ref_compnr, 
                    src.username, 
                    src.wght,     
                    src.ETL_SEQUENCE_NUMBER,
                    CURRENT_TIMESTAMP,
                    src.etl_load_metadatafilename,
                    case when ETL_DELETED=TRUE then TRUE else FALSE end,
                    ETL_DELETED);
    `
} );

                    
//  Get number of rows inserted
        
        var sqlStmt = snowflake.createStatement( {sqlText:  sql_command} );
        var rs = sqlStmt.execute();
        var number_of_rows_inserted = sqlStmt.getNumRowsInserted();
        var number_of_rows_updated =  sqlStmt.getNumRowsUpdated();
                    

        
    snowflake.execute ({sqlText: "commit"});

    log_sql_command = "call datahub_logging.sp_etl_log_ingestion_process('UpdateEnd','" + process_name + "','Success','Completed process execution.', 0 ," + number_of_rows_inserted.toString()+ "," +  number_of_rows_updated.toString() + ");";
    snowflake.execute({sqlText: log_sql_command});

    result = "Success"; 

    }       

    catch (err)  {
        snowflake.execute( {sqlText: "rollback;"} )
        var clean_error_msg = err.message.replace(/[^\w\s]/gi, '');
    //  Create a log entry to say INSERT STATEMENT failed
    
    log_sql_command = "call datahub_logging.sp_etl_log_ingestion_process('UpdateEnd','" + process_name + "','Failed','MERGE Failed. Error:" + err.code.toString()+" : "+ clean_error_msg  + "', 0 ,0,0);";
    snowflake.execute({sqlText: log_sql_command});
        ;
        throw "Failed: " + err.message;   // Return a success/error indicator.
        }
    return result;
    $$;