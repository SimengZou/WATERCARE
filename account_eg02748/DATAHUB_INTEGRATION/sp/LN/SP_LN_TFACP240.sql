create or replace procedure DATAHUB_INTEGRATION.SP_LN_TFACP240()
    returns varchar not null
                language javascript
                as
                $$

//  Variables

var result = "";                                    // return status of this proc call
const process_name = Object.keys(this)[0];          // name of currently executing process
var number_of_rows_inserted = 0;                             // track number of rows we have inserted
var number_of_rows_updated = 0;                             // track number of rows we have updated


//  Step 1.

//  Start execution - log start

log_sql_command = "call datahub_logging.sp_etl_log_ingestion_process('Insert','" + process_name + "','Running','Started process execution.', 0,0,0);";
snowflake.execute({sqlText: log_sql_command});

snowflake.execute( {sqlText: "begin transaction;"} );
try
    {
        var sql_command = `
                            INSERT INTO LANDING_ERROR.LN_RAW_ERROR
                            SELECT * FROM LANDING_ERROR.VW_STREAM_LN_TFACP240_ERROR`;
    var sqlStmt = snowflake.createStatement( {sqlText:  sql_command} );
    var rs = sqlStmt.execute();
        
        var sql_command = ` 
                            merge into  TARGET_LN.LN_TFACP240 as target using (SELECT * FROM (SELECT 
            strm.amth_1, 
            strm.amth_2, 
            strm.amth_3, 
            strm.bppr, 
            strm.bppr_kw, 
            strm.bptc, 
            strm.bptc_ref_compnr, 
            strm.byer, 
            strm.cadr, 
            strm.ccur, 
            strm.ccur_ref_compnr, 
            strm.cdec, 
            strm.ceno, 
            strm.ciko, 
            strm.ciko_kw, 
            strm.cipo, 
            strm.cish, 
            strm.cisq, 
            strm.citt, 
            strm.clas, 
            strm.clas_ref_compnr, 
            strm.clsb, 
            strm.clsb_kw, 
            strm.clsc, 
            strm.cmnf, 
            strm.compnr, 
            strm.cpay, 
            strm.cpay_ref_compnr, 
            strm.crit, 
            strm.crrf, 
            strm.crrf_kw, 
            strm.cvat, 
            strm.cvlo, 
            strm.cvyn, 
            strm.cvyn_kw, 
            strm.cwar, 
            strm.damt, 
            strm.deleted, 
            strm.fcpo, 
            strm.fire, 
            strm.fire_kw, 
            strm.fsli, 
            strm.glco, 
            strm.ifbp, 
            strm.ifbp_ref_compnr, 
            strm.issp, 
            strm.issp_kw, 
            strm.item, 
            strm.itgr, 
            strm.itsc, 
            strm.itsc_kw, 
            strm.ityp, 
            strm.ityp_kw, 
            strm.iuni, 
            strm.iuni_ref_compnr, 
            strm.koor, 
            strm.koor_kw, 
            strm.ladt, 
            strm.lmat, 
            strm.lmat_kw, 
            strm.loco, 
            strm.maam, 
            strm.maqu, 
            strm.mcfr, 
            strm.mcfr_kw, 
            strm.mcpr, 
            strm.mcpr_kw, 
            strm.mpnr, 
            strm.mqpu, 
            strm.mtch, 
            strm.mtch_kw, 
            strm.oamt, 
            strm.odat, 
            strm.omti, 
            strm.omti_kw, 
            strm.oqan, 
            strm.oref, 
            strm.orno, 
            strm.ortp, 
            strm.ortp_kw, 
            strm.oset, 
            strm.otbp, 
            strm.otyp, 
            strm.otyp_kw, 
            strm.paft, 
            strm.paft_kw, 
            strm.paya, 
            strm.paya_ref_compnr, 
            strm.poff, 
            strm.pono, 
            strm.ppvp, 
            strm.ppvp_kw, 
            strm.proj, 
            strm.prrc, 
            strm.prrc_kw, 
            strm.ptyp, 
            strm.ptyp_ref_compnr, 
            strm.ratd, 
            strm.rate_1, 
            strm.rate_2, 
            strm.rate_3, 
            strm.ratf_1, 
            strm.ratf_2, 
            strm.ratf_3, 
            strm.rcod, 
            strm.rcod_ref_compnr, 
            strm.rqty, 
            strm.rtyp, 
            strm.sequencenumber, 
            strm.sfad, 
            strm.sfbl, 
            strm.sfbl_kw, 
            strm.sfbp, 
            strm.site, 
            strm.site_ref_compnr, 
            strm.slcp, 
            strm.slso, 
            strm.sorn, 
            strm.sqnb, 
            strm.srtp, 
            strm.srtp_kw, 
            strm.tapq, 
            strm.timestamp, 
            strm.toma, 
            strm.toma_kw, 
            strm.tref, 
            strm.trgu, 
            strm.trqu, 
            strm.unit, 
            strm.unit_ref_compnr, 
            strm.uppr, 
            strm.uppr_kw, 
            strm.username, 
            strm.vatc, 
            strm.ETL_SEQUENCE_NUMBER,
            strm.ETL_DELETED,
            strm.etl_load_datetime,
            strm.etl_load_metadatafilename,
            ROW_NUMBER() OVER (PARTITION BY 
            strm.compnr,
            strm.loco,
            strm.otyp,
            strm.orno,
            strm.pono,
            strm.sqnb ORDER BY strm.ETL_SEQUENCE_NUMBER desc,IFNULL(TRY_TO_TIMESTAMP(replace(right(replace(lower(etl_load_metadatafilename),'.json'),23),'_','-'), 'yyyy-mm-dd-HH-MI-SS-FF') ,etl_load_datetime) desc) as ROWNUMBER
        FROM DATAHUB_INTEGRATION.VW_STREAM_LN_TFACP240 as  strm
                    )   
            WHERE ROWNUMBER=1  
            
                    ) as src on
            ((target.compnr=src.compnr) OR (target.compnr IS NULL AND src.compnr IS NULL)) AND
            ((target.loco=src.loco) OR (target.loco IS NULL AND src.loco IS NULL)) AND
            ((target.otyp=src.otyp) OR (target.otyp IS NULL AND src.otyp IS NULL)) AND
            ((target.orno=src.orno) OR (target.orno IS NULL AND src.orno IS NULL)) AND
            ((target.pono=src.pono) OR (target.pono IS NULL AND src.pono IS NULL)) AND
            ((target.sqnb=src.sqnb) OR (target.sqnb IS NULL AND src.sqnb IS NULL)) 
                when matched and src.ETL_DELETED=TRUE THEN DELETE
                when matched then update set
                    target.amth_1=src.amth_1, 
                    target.amth_2=src.amth_2, 
                    target.amth_3=src.amth_3, 
                    target.bppr=src.bppr, 
                    target.bppr_kw=src.bppr_kw, 
                    target.bptc=src.bptc, 
                    target.bptc_ref_compnr=src.bptc_ref_compnr, 
                    target.byer=src.byer, 
                    target.cadr=src.cadr, 
                    target.ccur=src.ccur, 
                    target.ccur_ref_compnr=src.ccur_ref_compnr, 
                    target.cdec=src.cdec, 
                    target.ceno=src.ceno, 
                    target.ciko=src.ciko, 
                    target.ciko_kw=src.ciko_kw, 
                    target.cipo=src.cipo, 
                    target.cish=src.cish, 
                    target.cisq=src.cisq, 
                    target.citt=src.citt, 
                    target.clas=src.clas, 
                    target.clas_ref_compnr=src.clas_ref_compnr, 
                    target.clsb=src.clsb, 
                    target.clsb_kw=src.clsb_kw, 
                    target.clsc=src.clsc, 
                    target.cmnf=src.cmnf, 
                    target.compnr=src.compnr, 
                    target.cpay=src.cpay, 
                    target.cpay_ref_compnr=src.cpay_ref_compnr, 
                    target.crit=src.crit, 
                    target.crrf=src.crrf, 
                    target.crrf_kw=src.crrf_kw, 
                    target.cvat=src.cvat, 
                    target.cvlo=src.cvlo, 
                    target.cvyn=src.cvyn, 
                    target.cvyn_kw=src.cvyn_kw, 
                    target.cwar=src.cwar, 
                    target.damt=src.damt, 
                    target.deleted=src.deleted, 
                    target.fcpo=src.fcpo, 
                    target.fire=src.fire, 
                    target.fire_kw=src.fire_kw, 
                    target.fsli=src.fsli, 
                    target.glco=src.glco, 
                    target.ifbp=src.ifbp, 
                    target.ifbp_ref_compnr=src.ifbp_ref_compnr, 
                    target.issp=src.issp, 
                    target.issp_kw=src.issp_kw, 
                    target.item=src.item, 
                    target.itgr=src.itgr, 
                    target.itsc=src.itsc, 
                    target.itsc_kw=src.itsc_kw, 
                    target.ityp=src.ityp, 
                    target.ityp_kw=src.ityp_kw, 
                    target.iuni=src.iuni, 
                    target.iuni_ref_compnr=src.iuni_ref_compnr, 
                    target.koor=src.koor, 
                    target.koor_kw=src.koor_kw, 
                    target.ladt=src.ladt, 
                    target.lmat=src.lmat, 
                    target.lmat_kw=src.lmat_kw, 
                    target.loco=src.loco, 
                    target.maam=src.maam, 
                    target.maqu=src.maqu, 
                    target.mcfr=src.mcfr, 
                    target.mcfr_kw=src.mcfr_kw, 
                    target.mcpr=src.mcpr, 
                    target.mcpr_kw=src.mcpr_kw, 
                    target.mpnr=src.mpnr, 
                    target.mqpu=src.mqpu, 
                    target.mtch=src.mtch, 
                    target.mtch_kw=src.mtch_kw, 
                    target.oamt=src.oamt, 
                    target.odat=src.odat, 
                    target.omti=src.omti, 
                    target.omti_kw=src.omti_kw, 
                    target.oqan=src.oqan, 
                    target.oref=src.oref, 
                    target.orno=src.orno, 
                    target.ortp=src.ortp, 
                    target.ortp_kw=src.ortp_kw, 
                    target.oset=src.oset, 
                    target.otbp=src.otbp, 
                    target.otyp=src.otyp, 
                    target.otyp_kw=src.otyp_kw, 
                    target.paft=src.paft, 
                    target.paft_kw=src.paft_kw, 
                    target.paya=src.paya, 
                    target.paya_ref_compnr=src.paya_ref_compnr, 
                    target.poff=src.poff, 
                    target.pono=src.pono, 
                    target.ppvp=src.ppvp, 
                    target.ppvp_kw=src.ppvp_kw, 
                    target.proj=src.proj, 
                    target.prrc=src.prrc, 
                    target.prrc_kw=src.prrc_kw, 
                    target.ptyp=src.ptyp, 
                    target.ptyp_ref_compnr=src.ptyp_ref_compnr, 
                    target.ratd=src.ratd, 
                    target.rate_1=src.rate_1, 
                    target.rate_2=src.rate_2, 
                    target.rate_3=src.rate_3, 
                    target.ratf_1=src.ratf_1, 
                    target.ratf_2=src.ratf_2, 
                    target.ratf_3=src.ratf_3, 
                    target.rcod=src.rcod, 
                    target.rcod_ref_compnr=src.rcod_ref_compnr, 
                    target.rqty=src.rqty, 
                    target.rtyp=src.rtyp, 
                    target.sequencenumber=src.sequencenumber, 
                    target.sfad=src.sfad, 
                    target.sfbl=src.sfbl, 
                    target.sfbl_kw=src.sfbl_kw, 
                    target.sfbp=src.sfbp, 
                    target.site=src.site, 
                    target.site_ref_compnr=src.site_ref_compnr, 
                    target.slcp=src.slcp, 
                    target.slso=src.slso, 
                    target.sorn=src.sorn, 
                    target.sqnb=src.sqnb, 
                    target.srtp=src.srtp, 
                    target.srtp_kw=src.srtp_kw, 
                    target.tapq=src.tapq, 
                    target.timestamp=src.timestamp, 
                    target.toma=src.toma, 
                    target.toma_kw=src.toma_kw, 
                    target.tref=src.tref, 
                    target.trgu=src.trgu, 
                    target.trqu=src.trqu, 
                    target.unit=src.unit, 
                    target.unit_ref_compnr=src.unit_ref_compnr, 
                    target.uppr=src.uppr, 
                    target.uppr_kw=src.uppr_kw, 
                    target.username=src.username, 
                    target.vatc=src.vatc, 
                    target.ETL_SEQUENCE_NUMBER=src.ETL_SEQUENCE_NUMBER,
                    target.etl_load_datetime=CURRENT_TIMESTAMP,
                    target.etl_load_metadatafilename=src.etl_load_metadatafilename
        when not matched and (src.ETL_DELETED=FALSE OR src.ETL_DELETED IS NULL)  then insert ( 
                    amth_1, 
                    amth_2, 
                    amth_3, 
                    bppr, 
                    bppr_kw, 
                    bptc, 
                    bptc_ref_compnr, 
                    byer, 
                    cadr, 
                    ccur, 
                    ccur_ref_compnr, 
                    cdec, 
                    ceno, 
                    ciko, 
                    ciko_kw, 
                    cipo, 
                    cish, 
                    cisq, 
                    citt, 
                    clas, 
                    clas_ref_compnr, 
                    clsb, 
                    clsb_kw, 
                    clsc, 
                    cmnf, 
                    compnr, 
                    cpay, 
                    cpay_ref_compnr, 
                    crit, 
                    crrf, 
                    crrf_kw, 
                    cvat, 
                    cvlo, 
                    cvyn, 
                    cvyn_kw, 
                    cwar, 
                    damt, 
                    deleted, 
                    fcpo, 
                    fire, 
                    fire_kw, 
                    fsli, 
                    glco, 
                    ifbp, 
                    ifbp_ref_compnr, 
                    issp, 
                    issp_kw, 
                    item, 
                    itgr, 
                    itsc, 
                    itsc_kw, 
                    ityp, 
                    ityp_kw, 
                    iuni, 
                    iuni_ref_compnr, 
                    koor, 
                    koor_kw, 
                    ladt, 
                    lmat, 
                    lmat_kw, 
                    loco, 
                    maam, 
                    maqu, 
                    mcfr, 
                    mcfr_kw, 
                    mcpr, 
                    mcpr_kw, 
                    mpnr, 
                    mqpu, 
                    mtch, 
                    mtch_kw, 
                    oamt, 
                    odat, 
                    omti, 
                    omti_kw, 
                    oqan, 
                    oref, 
                    orno, 
                    ortp, 
                    ortp_kw, 
                    oset, 
                    otbp, 
                    otyp, 
                    otyp_kw, 
                    paft, 
                    paft_kw, 
                    paya, 
                    paya_ref_compnr, 
                    poff, 
                    pono, 
                    ppvp, 
                    ppvp_kw, 
                    proj, 
                    prrc, 
                    prrc_kw, 
                    ptyp, 
                    ptyp_ref_compnr, 
                    ratd, 
                    rate_1, 
                    rate_2, 
                    rate_3, 
                    ratf_1, 
                    ratf_2, 
                    ratf_3, 
                    rcod, 
                    rcod_ref_compnr, 
                    rqty, 
                    rtyp, 
                    sequencenumber, 
                    sfad, 
                    sfbl, 
                    sfbl_kw, 
                    sfbp, 
                    site, 
                    site_ref_compnr, 
                    slcp, 
                    slso, 
                    sorn, 
                    sqnb, 
                    srtp, 
                    srtp_kw, 
                    tapq, 
                    timestamp, 
                    toma, 
                    toma_kw, 
                    tref, 
                    trgu, 
                    trqu, 
                    unit, 
                    unit_ref_compnr, 
                    uppr, 
                    uppr_kw, 
                    username, 
                    vatc, 
                    ETL_SEQUENCE_NUMBER,                       
                    etl_load_datetime,
                    etl_load_metadatafilename) 
            values (
                    src.amth_1, 
                    src.amth_2, 
                    src.amth_3, 
                    src.bppr, 
                    src.bppr_kw, 
                    src.bptc, 
                    src.bptc_ref_compnr, 
                    src.byer, 
                    src.cadr, 
                    src.ccur, 
                    src.ccur_ref_compnr, 
                    src.cdec, 
                    src.ceno, 
                    src.ciko, 
                    src.ciko_kw, 
                    src.cipo, 
                    src.cish, 
                    src.cisq, 
                    src.citt, 
                    src.clas, 
                    src.clas_ref_compnr, 
                    src.clsb, 
                    src.clsb_kw, 
                    src.clsc, 
                    src.cmnf, 
                    src.compnr, 
                    src.cpay, 
                    src.cpay_ref_compnr, 
                    src.crit, 
                    src.crrf, 
                    src.crrf_kw, 
                    src.cvat, 
                    src.cvlo, 
                    src.cvyn, 
                    src.cvyn_kw, 
                    src.cwar, 
                    src.damt, 
                    src.deleted, 
                    src.fcpo, 
                    src.fire, 
                    src.fire_kw, 
                    src.fsli, 
                    src.glco, 
                    src.ifbp, 
                    src.ifbp_ref_compnr, 
                    src.issp, 
                    src.issp_kw, 
                    src.item, 
                    src.itgr, 
                    src.itsc, 
                    src.itsc_kw, 
                    src.ityp, 
                    src.ityp_kw, 
                    src.iuni, 
                    src.iuni_ref_compnr, 
                    src.koor, 
                    src.koor_kw, 
                    src.ladt, 
                    src.lmat, 
                    src.lmat_kw, 
                    src.loco, 
                    src.maam, 
                    src.maqu, 
                    src.mcfr, 
                    src.mcfr_kw, 
                    src.mcpr, 
                    src.mcpr_kw, 
                    src.mpnr, 
                    src.mqpu, 
                    src.mtch, 
                    src.mtch_kw, 
                    src.oamt, 
                    src.odat, 
                    src.omti, 
                    src.omti_kw, 
                    src.oqan, 
                    src.oref, 
                    src.orno, 
                    src.ortp, 
                    src.ortp_kw, 
                    src.oset, 
                    src.otbp, 
                    src.otyp, 
                    src.otyp_kw, 
                    src.paft, 
                    src.paft_kw, 
                    src.paya, 
                    src.paya_ref_compnr, 
                    src.poff, 
                    src.pono, 
                    src.ppvp, 
                    src.ppvp_kw, 
                    src.proj, 
                    src.prrc, 
                    src.prrc_kw, 
                    src.ptyp, 
                    src.ptyp_ref_compnr, 
                    src.ratd, 
                    src.rate_1, 
                    src.rate_2, 
                    src.rate_3, 
                    src.ratf_1, 
                    src.ratf_2, 
                    src.ratf_3, 
                    src.rcod, 
                    src.rcod_ref_compnr, 
                    src.rqty, 
                    src.rtyp, 
                    src.sequencenumber, 
                    src.sfad, 
                    src.sfbl, 
                    src.sfbl_kw, 
                    src.sfbp, 
                    src.site, 
                    src.site_ref_compnr, 
                    src.slcp, 
                    src.slso, 
                    src.sorn, 
                    src.sqnb, 
                    src.srtp, 
                    src.srtp_kw, 
                    src.tapq, 
                    src.timestamp, 
                    src.toma, 
                    src.toma_kw, 
                    src.tref, 
                    src.trgu, 
                    src.trqu, 
                    src.unit, 
                    src.unit_ref_compnr, 
                    src.uppr, 
                    src.uppr_kw, 
                    src.username, 
                    src.vatc,     
                    src.ETL_SEQUENCE_NUMBER,
                    CURRENT_TIMESTAMP,
                    src.etl_load_metadatafilename);`;

    var sqlStmt = snowflake.createStatement( {sqlText:  sql_command} );
    var rs = sqlStmt.execute();

    snowflake.execute( {sqlText: `merge into TARGET_HISTORY_LN.LN_TFACP240_DELETED as target using (
                SELECT * FROM (SELECT 
            strm.amth_1, 
            strm.amth_2, 
            strm.amth_3, 
            strm.bppr, 
            strm.bppr_kw, 
            strm.bptc, 
            strm.bptc_ref_compnr, 
            strm.byer, 
            strm.cadr, 
            strm.ccur, 
            strm.ccur_ref_compnr, 
            strm.cdec, 
            strm.ceno, 
            strm.ciko, 
            strm.ciko_kw, 
            strm.cipo, 
            strm.cish, 
            strm.cisq, 
            strm.citt, 
            strm.clas, 
            strm.clas_ref_compnr, 
            strm.clsb, 
            strm.clsb_kw, 
            strm.clsc, 
            strm.cmnf, 
            strm.compnr, 
            strm.cpay, 
            strm.cpay_ref_compnr, 
            strm.crit, 
            strm.crrf, 
            strm.crrf_kw, 
            strm.cvat, 
            strm.cvlo, 
            strm.cvyn, 
            strm.cvyn_kw, 
            strm.cwar, 
            strm.damt, 
            strm.deleted, 
            strm.fcpo, 
            strm.fire, 
            strm.fire_kw, 
            strm.fsli, 
            strm.glco, 
            strm.ifbp, 
            strm.ifbp_ref_compnr, 
            strm.issp, 
            strm.issp_kw, 
            strm.item, 
            strm.itgr, 
            strm.itsc, 
            strm.itsc_kw, 
            strm.ityp, 
            strm.ityp_kw, 
            strm.iuni, 
            strm.iuni_ref_compnr, 
            strm.koor, 
            strm.koor_kw, 
            strm.ladt, 
            strm.lmat, 
            strm.lmat_kw, 
            strm.loco, 
            strm.maam, 
            strm.maqu, 
            strm.mcfr, 
            strm.mcfr_kw, 
            strm.mcpr, 
            strm.mcpr_kw, 
            strm.mpnr, 
            strm.mqpu, 
            strm.mtch, 
            strm.mtch_kw, 
            strm.oamt, 
            strm.odat, 
            strm.omti, 
            strm.omti_kw, 
            strm.oqan, 
            strm.oref, 
            strm.orno, 
            strm.ortp, 
            strm.ortp_kw, 
            strm.oset, 
            strm.otbp, 
            strm.otyp, 
            strm.otyp_kw, 
            strm.paft, 
            strm.paft_kw, 
            strm.paya, 
            strm.paya_ref_compnr, 
            strm.poff, 
            strm.pono, 
            strm.ppvp, 
            strm.ppvp_kw, 
            strm.proj, 
            strm.prrc, 
            strm.prrc_kw, 
            strm.ptyp, 
            strm.ptyp_ref_compnr, 
            strm.ratd, 
            strm.rate_1, 
            strm.rate_2, 
            strm.rate_3, 
            strm.ratf_1, 
            strm.ratf_2, 
            strm.ratf_3, 
            strm.rcod, 
            strm.rcod_ref_compnr, 
            strm.rqty, 
            strm.rtyp, 
            strm.sequencenumber, 
            strm.sfad, 
            strm.sfbl, 
            strm.sfbl_kw, 
            strm.sfbp, 
            strm.site, 
            strm.site_ref_compnr, 
            strm.slcp, 
            strm.slso, 
            strm.sorn, 
            strm.sqnb, 
            strm.srtp, 
            strm.srtp_kw, 
            strm.tapq, 
            strm.timestamp, 
            strm.toma, 
            strm.toma_kw, 
            strm.tref, 
            strm.trgu, 
            strm.trqu, 
            strm.unit, 
            strm.unit_ref_compnr, 
            strm.uppr, 
            strm.uppr_kw, 
            strm.username, 
            strm.vatc, 
            strm.ETL_SEQUENCE_NUMBER,
            strm.ETL_DELETED,
            strm.etl_load_datetime,
            strm.etl_load_metadatafilename,
            ROW_NUMBER() OVER (PARTITION BY 
            strm.compnr,
            strm.loco,
            strm.otyp,
            strm.orno,
            strm.pono,
            strm.sqnb ORDER BY strm.ETL_SEQUENCE_NUMBER desc,IFNULL(TRY_TO_TIMESTAMP(replace(right(replace(lower(etl_load_metadatafilename),'.json'),23),'_','-'), 'yyyy-mm-dd-HH-MI-SS-FF') ,etl_load_datetime) desc) as ROWNUMBER
        FROM DATAHUB_INTEGRATION.VW_STREAM_LN_TFACP240 as  strm
        WHERE strm.ETL_DELETED=TRUE
                    )   
            WHERE ROWNUMBER=1  
            
                    ) as src on
            ((target.compnr=src.compnr) OR (target.compnr IS NULL AND src.compnr IS NULL)) AND
            ((target.loco=src.loco) OR (target.loco IS NULL AND src.loco IS NULL)) AND
            ((target.otyp=src.otyp) OR (target.otyp IS NULL AND src.otyp IS NULL)) AND
            ((target.orno=src.orno) OR (target.orno IS NULL AND src.orno IS NULL)) AND
            ((target.pono=src.pono) OR (target.pono IS NULL AND src.pono IS NULL)) AND
            ((target.sqnb=src.sqnb) OR (target.sqnb IS NULL AND src.sqnb IS NULL)) 
                when matched then update set
                    target.amth_1=src.amth_1, 
                    target.amth_2=src.amth_2, 
                    target.amth_3=src.amth_3, 
                    target.bppr=src.bppr, 
                    target.bppr_kw=src.bppr_kw, 
                    target.bptc=src.bptc, 
                    target.bptc_ref_compnr=src.bptc_ref_compnr, 
                    target.byer=src.byer, 
                    target.cadr=src.cadr, 
                    target.ccur=src.ccur, 
                    target.ccur_ref_compnr=src.ccur_ref_compnr, 
                    target.cdec=src.cdec, 
                    target.ceno=src.ceno, 
                    target.ciko=src.ciko, 
                    target.ciko_kw=src.ciko_kw, 
                    target.cipo=src.cipo, 
                    target.cish=src.cish, 
                    target.cisq=src.cisq, 
                    target.citt=src.citt, 
                    target.clas=src.clas, 
                    target.clas_ref_compnr=src.clas_ref_compnr, 
                    target.clsb=src.clsb, 
                    target.clsb_kw=src.clsb_kw, 
                    target.clsc=src.clsc, 
                    target.cmnf=src.cmnf, 
                    target.compnr=src.compnr, 
                    target.cpay=src.cpay, 
                    target.cpay_ref_compnr=src.cpay_ref_compnr, 
                    target.crit=src.crit, 
                    target.crrf=src.crrf, 
                    target.crrf_kw=src.crrf_kw, 
                    target.cvat=src.cvat, 
                    target.cvlo=src.cvlo, 
                    target.cvyn=src.cvyn, 
                    target.cvyn_kw=src.cvyn_kw, 
                    target.cwar=src.cwar, 
                    target.damt=src.damt, 
                    target.deleted=src.deleted, 
                    target.fcpo=src.fcpo, 
                    target.fire=src.fire, 
                    target.fire_kw=src.fire_kw, 
                    target.fsli=src.fsli, 
                    target.glco=src.glco, 
                    target.ifbp=src.ifbp, 
                    target.ifbp_ref_compnr=src.ifbp_ref_compnr, 
                    target.issp=src.issp, 
                    target.issp_kw=src.issp_kw, 
                    target.item=src.item, 
                    target.itgr=src.itgr, 
                    target.itsc=src.itsc, 
                    target.itsc_kw=src.itsc_kw, 
                    target.ityp=src.ityp, 
                    target.ityp_kw=src.ityp_kw, 
                    target.iuni=src.iuni, 
                    target.iuni_ref_compnr=src.iuni_ref_compnr, 
                    target.koor=src.koor, 
                    target.koor_kw=src.koor_kw, 
                    target.ladt=src.ladt, 
                    target.lmat=src.lmat, 
                    target.lmat_kw=src.lmat_kw, 
                    target.loco=src.loco, 
                    target.maam=src.maam, 
                    target.maqu=src.maqu, 
                    target.mcfr=src.mcfr, 
                    target.mcfr_kw=src.mcfr_kw, 
                    target.mcpr=src.mcpr, 
                    target.mcpr_kw=src.mcpr_kw, 
                    target.mpnr=src.mpnr, 
                    target.mqpu=src.mqpu, 
                    target.mtch=src.mtch, 
                    target.mtch_kw=src.mtch_kw, 
                    target.oamt=src.oamt, 
                    target.odat=src.odat, 
                    target.omti=src.omti, 
                    target.omti_kw=src.omti_kw, 
                    target.oqan=src.oqan, 
                    target.oref=src.oref, 
                    target.orno=src.orno, 
                    target.ortp=src.ortp, 
                    target.ortp_kw=src.ortp_kw, 
                    target.oset=src.oset, 
                    target.otbp=src.otbp, 
                    target.otyp=src.otyp, 
                    target.otyp_kw=src.otyp_kw, 
                    target.paft=src.paft, 
                    target.paft_kw=src.paft_kw, 
                    target.paya=src.paya, 
                    target.paya_ref_compnr=src.paya_ref_compnr, 
                    target.poff=src.poff, 
                    target.pono=src.pono, 
                    target.ppvp=src.ppvp, 
                    target.ppvp_kw=src.ppvp_kw, 
                    target.proj=src.proj, 
                    target.prrc=src.prrc, 
                    target.prrc_kw=src.prrc_kw, 
                    target.ptyp=src.ptyp, 
                    target.ptyp_ref_compnr=src.ptyp_ref_compnr, 
                    target.ratd=src.ratd, 
                    target.rate_1=src.rate_1, 
                    target.rate_2=src.rate_2, 
                    target.rate_3=src.rate_3, 
                    target.ratf_1=src.ratf_1, 
                    target.ratf_2=src.ratf_2, 
                    target.ratf_3=src.ratf_3, 
                    target.rcod=src.rcod, 
                    target.rcod_ref_compnr=src.rcod_ref_compnr, 
                    target.rqty=src.rqty, 
                    target.rtyp=src.rtyp, 
                    target.sequencenumber=src.sequencenumber, 
                    target.sfad=src.sfad, 
                    target.sfbl=src.sfbl, 
                    target.sfbl_kw=src.sfbl_kw, 
                    target.sfbp=src.sfbp, 
                    target.site=src.site, 
                    target.site_ref_compnr=src.site_ref_compnr, 
                    target.slcp=src.slcp, 
                    target.slso=src.slso, 
                    target.sorn=src.sorn, 
                    target.sqnb=src.sqnb, 
                    target.srtp=src.srtp, 
                    target.srtp_kw=src.srtp_kw, 
                    target.tapq=src.tapq, 
                    target.timestamp=src.timestamp, 
                    target.toma=src.toma, 
                    target.toma_kw=src.toma_kw, 
                    target.tref=src.tref, 
                    target.trgu=src.trgu, 
                    target.trqu=src.trqu, 
                    target.unit=src.unit, 
                    target.unit_ref_compnr=src.unit_ref_compnr, 
                    target.uppr=src.uppr, 
                    target.uppr_kw=src.uppr_kw, 
                    target.username=src.username, 
                    target.vatc=src.vatc, 
                    target.ETL_SEQUENCE_NUMBER=src.ETL_SEQUENCE_NUMBER,
                    target.etl_load_datetime=CURRENT_TIMESTAMP,
                    target.etl_load_metadatafilename=src.etl_load_metadatafilename,
                    target.ETL_DELETED=src.ETL_DELETED
        when not matched   then insert ( amth_1, amth_2, amth_3, bppr, bppr_kw, bptc, bptc_ref_compnr, byer, cadr, ccur, ccur_ref_compnr, cdec, ceno, ciko, ciko_kw, cipo, cish, cisq, citt, clas, clas_ref_compnr, clsb, clsb_kw, clsc, cmnf, compnr, cpay, cpay_ref_compnr, crit, crrf, crrf_kw, cvat, cvlo, cvyn, cvyn_kw, cwar, damt, deleted, fcpo, fire, fire_kw, fsli, glco, ifbp, ifbp_ref_compnr, issp, issp_kw, item, itgr, itsc, itsc_kw, ityp, ityp_kw, iuni, iuni_ref_compnr, koor, koor_kw, ladt, lmat, lmat_kw, loco, maam, maqu, mcfr, mcfr_kw, mcpr, mcpr_kw, mpnr, mqpu, mtch, mtch_kw, oamt, odat, omti, omti_kw, oqan, oref, orno, ortp, ortp_kw, oset, otbp, otyp, otyp_kw, paft, paft_kw, paya, paya_ref_compnr, poff, pono, ppvp, ppvp_kw, proj, prrc, prrc_kw, ptyp, ptyp_ref_compnr, ratd, rate_1, rate_2, rate_3, ratf_1, ratf_2, ratf_3, rcod, rcod_ref_compnr, rqty, rtyp, sequencenumber, sfad, sfbl, sfbl_kw, sfbp, site, site_ref_compnr, slcp, slso, sorn, sqnb, srtp, srtp_kw, tapq, timestamp, toma, toma_kw, tref, trgu, trqu, unit, unit_ref_compnr, uppr, uppr_kw, username, vatc, 
                    ETL_SEQUENCE_NUMBER,                       
                    etl_load_datetime,
                    etl_load_metadatafilename,
                    etl_is_deleted,
                    ETL_DELETED) 
            values (
                    src.amth_1, 
                    src.amth_2, 
                    src.amth_3, 
                    src.bppr, 
                    src.bppr_kw, 
                    src.bptc, 
                    src.bptc_ref_compnr, 
                    src.byer, 
                    src.cadr, 
                    src.ccur, 
                    src.ccur_ref_compnr, 
                    src.cdec, 
                    src.ceno, 
                    src.ciko, 
                    src.ciko_kw, 
                    src.cipo, 
                    src.cish, 
                    src.cisq, 
                    src.citt, 
                    src.clas, 
                    src.clas_ref_compnr, 
                    src.clsb, 
                    src.clsb_kw, 
                    src.clsc, 
                    src.cmnf, 
                    src.compnr, 
                    src.cpay, 
                    src.cpay_ref_compnr, 
                    src.crit, 
                    src.crrf, 
                    src.crrf_kw, 
                    src.cvat, 
                    src.cvlo, 
                    src.cvyn, 
                    src.cvyn_kw, 
                    src.cwar, 
                    src.damt, 
                    src.deleted, 
                    src.fcpo, 
                    src.fire, 
                    src.fire_kw, 
                    src.fsli, 
                    src.glco, 
                    src.ifbp, 
                    src.ifbp_ref_compnr, 
                    src.issp, 
                    src.issp_kw, 
                    src.item, 
                    src.itgr, 
                    src.itsc, 
                    src.itsc_kw, 
                    src.ityp, 
                    src.ityp_kw, 
                    src.iuni, 
                    src.iuni_ref_compnr, 
                    src.koor, 
                    src.koor_kw, 
                    src.ladt, 
                    src.lmat, 
                    src.lmat_kw, 
                    src.loco, 
                    src.maam, 
                    src.maqu, 
                    src.mcfr, 
                    src.mcfr_kw, 
                    src.mcpr, 
                    src.mcpr_kw, 
                    src.mpnr, 
                    src.mqpu, 
                    src.mtch, 
                    src.mtch_kw, 
                    src.oamt, 
                    src.odat, 
                    src.omti, 
                    src.omti_kw, 
                    src.oqan, 
                    src.oref, 
                    src.orno, 
                    src.ortp, 
                    src.ortp_kw, 
                    src.oset, 
                    src.otbp, 
                    src.otyp, 
                    src.otyp_kw, 
                    src.paft, 
                    src.paft_kw, 
                    src.paya, 
                    src.paya_ref_compnr, 
                    src.poff, 
                    src.pono, 
                    src.ppvp, 
                    src.ppvp_kw, 
                    src.proj, 
                    src.prrc, 
                    src.prrc_kw, 
                    src.ptyp, 
                    src.ptyp_ref_compnr, 
                    src.ratd, 
                    src.rate_1, 
                    src.rate_2, 
                    src.rate_3, 
                    src.ratf_1, 
                    src.ratf_2, 
                    src.ratf_3, 
                    src.rcod, 
                    src.rcod_ref_compnr, 
                    src.rqty, 
                    src.rtyp, 
                    src.sequencenumber, 
                    src.sfad, 
                    src.sfbl, 
                    src.sfbl_kw, 
                    src.sfbp, 
                    src.site, 
                    src.site_ref_compnr, 
                    src.slcp, 
                    src.slso, 
                    src.sorn, 
                    src.sqnb, 
                    src.srtp, 
                    src.srtp_kw, 
                    src.tapq, 
                    src.timestamp, 
                    src.toma, 
                    src.toma_kw, 
                    src.tref, 
                    src.trgu, 
                    src.trqu, 
                    src.unit, 
                    src.unit_ref_compnr, 
                    src.uppr, 
                    src.uppr_kw, 
                    src.username, 
                    src.vatc,     
                    src.ETL_SEQUENCE_NUMBER,
                    CURRENT_TIMESTAMP,
                    src.etl_load_metadatafilename,
                    case when ETL_DELETED=TRUE then TRUE else FALSE end,
                    ETL_DELETED);
    `
} );

                    
//  Get number of rows inserted
        
        var sqlStmt = snowflake.createStatement( {sqlText:  sql_command} );
        var rs = sqlStmt.execute();
        var number_of_rows_inserted = sqlStmt.getNumRowsInserted();
        var number_of_rows_updated =  sqlStmt.getNumRowsUpdated();
                    

        
    snowflake.execute ({sqlText: "commit"});

    log_sql_command = "call datahub_logging.sp_etl_log_ingestion_process('UpdateEnd','" + process_name + "','Success','Completed process execution.', 0 ," + number_of_rows_inserted.toString()+ "," +  number_of_rows_updated.toString() + ");";
    snowflake.execute({sqlText: log_sql_command});

    result = "Success"; 

    }       

    catch (err)  {
        snowflake.execute( {sqlText: "rollback;"} )
        var clean_error_msg = err.message.replace(/[^\w\s]/gi, '');
    //  Create a log entry to say INSERT STATEMENT failed
    
    log_sql_command = "call datahub_logging.sp_etl_log_ingestion_process('UpdateEnd','" + process_name + "','Failed','MERGE Failed. Error:" + err.code.toString()+" : "+ clean_error_msg  + "', 0 ,0,0);";
    snowflake.execute({sqlText: log_sql_command});
        ;
        throw "Failed: " + err.message;   // Return a success/error indicator.
        }
    return result;
    $$;