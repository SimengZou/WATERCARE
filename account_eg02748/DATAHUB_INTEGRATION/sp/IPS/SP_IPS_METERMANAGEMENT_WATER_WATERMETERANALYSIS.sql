create or replace procedure DATAHUB_INTEGRATION.SP_IPS_METERMANAGEMENT_WATER_WATERMETERANALYSIS()
    returns varchar not null
                language javascript
                as
                $$

//  Variables

var result = "";                                    // return status of this proc call
const process_name = Object.keys(this)[0];          // name of currently executing process
var number_of_rows_inserted = 0;                             // track number of rows we have inserted
var number_of_rows_updated = 0;                             // track number of rows we have updated


//  Step 1.

//  Start execution - log start

log_sql_command = "call datahub_logging.sp_etl_log_ingestion_process('Insert','" + process_name + "','Running','Started process execution.', 0,0,0);";
snowflake.execute({sqlText: log_sql_command});

snowflake.execute( {sqlText: "begin transaction;"} );
try
    {
        var sql_command = `
                            INSERT INTO LANDING_ERROR.IPS_RAW_ERROR
                            SELECT * FROM LANDING_ERROR.VW_STREAM_IPS_METERMANAGEMENT_WATER_WATERMETERANALYSIS_ERROR`;
    var sqlStmt = snowflake.createStatement( {sqlText:  sql_command} );
    var rs = sqlStmt.execute();
        
        var sql_command = ` 
                            merge into  DATAHUB_TARGET.IPS_METERMANAGEMENT_WATER_WATERMETERANALYSIS as target using (SELECT * FROM (SELECT 
            strm.ADDBY, 
            strm.ADDDTTM, 
            strm.ADDRESS, 
            strm.ADDRESSKEY, 
            strm.ADDRESSKEY1, 
            strm.APPROVE, 
            strm.AUDITFLAG, 
            strm.BATCHKEY, 
            strm.COLORASSIGNMENTNEEDED, 
            strm.COMPAREBILLABLE, 
            strm.COMPAREESTIMATEDFLAG, 
            strm.COMPAREHIGHBILLABLE, 
            strm.COMPAREHIGHREADING, 
            strm.COMPAREHIGHUSAGE, 
            strm.COMPAREOPTION, 
            strm.COMPAREREADING, 
            strm.COMPAREREADINGDATE, 
            strm.COMPAREREADINGKEY, 
            strm.COMPARETOTALBILLABLEUSAGE, 
            strm.COMPARETOTALUSAGE, 
            strm.COMPAREUSAGE, 
            strm.COMPAREUSAGEREADINGKEYS, 
            strm.CURRENTBILLABLE, 
            strm.CURRENTCOMPKEY, 
            strm.CURRENTESTIMATEDFLAG, 
            strm.CURRENTFIELDNOTES, 
            strm.CURRENTHIGHBILLABLE, 
            strm.CURRENTHIGHREADING, 
            strm.CURRENTHIGHUSAGE, 
            strm.CURRENTMETERID, 
            strm.CURRENTREADING, 
            strm.CURRENTREADINGDATE, 
            strm.CURRENTREADINGKEY, 
            strm.CURRENTTOTALBILLABLEUSAGE, 
            strm.CURRENTTOTALUSAGE, 
            strm.CURRENTUNITTYPE, 
            strm.CURRENTUSAGE, 
            strm.CURRENTUSAGEREADINGKEYS, 
            strm.DATALAKE_DELETED, 
            strm.DEFAULTACTION, 
            strm.EXCEPTION, 
            strm.EXCEPTIONTYPE, 
            strm.HIGHMULTIPLIER, 
            strm.INDEXNO, 
            strm.ISPBCODESRVREQRESOLVED, 
            strm.ISPBCODEWORESOLVED, 
            strm.ISPROBLEMCODEEXCEPTION, 
            strm.ISRDCODESRVREQRESOLVED, 
            strm.ISRDCODEWORESOLVED, 
            strm.ISREADERCODEEXCEPTION, 
            strm.ISREADINGAPPROVED, 
            strm.ISREREADRESOLVED, 
            strm.KEYCOLUMN, 
            strm.LOWMULTIPLIER, 
            strm.MANUALREVIEWFLAG, 
            strm.MODBY, 
            strm.MODDTTM, 
            strm.NOREADFLAG, 
            strm.OLDESTACCOUNTKEY, 
            strm.OLDESTACCOUNTNO, 
            strm.OTHERACTION, 
            strm.PARENTKEY, 
            strm.POSITION, 
            strm.PROBLEMCODE, 
            strm.PROBLEMCODEBACKCOLOR, 
            strm.PROBLEMCODESERVICEREQUESTNO, 
            strm.PROBLEMCODESERVICEREQUESTTYPE, 
            strm.PROBLEMCODETEXTCOLOR, 
            strm.PROBLEMCODEWORKORDERNO, 
            strm.PROBLEMCODEWORKORDERTYPE, 
            strm.READERCODE, 
            strm.READERCODEBACKCOLOR, 
            strm.READERCODESERVICEREQUESTNO, 
            strm.READERCODESERVICEREQUESTTYPE, 
            strm.READERCODETEXTCOLOR, 
            strm.READERCODEWORKORDERNO, 
            strm.READERCODEWORKORDERTYPE, 
            strm.READINGCOMPKEY, 
            strm.READINGCYCLE, 
            strm.READINGMETERID, 
            strm.READINGTYPE, 
            strm.READINGUNITTYPE, 
            strm.REREAD, 
            strm.REREADSERVICEREQUESTNO, 
            strm.ROUTEID, 
            strm.ROUTEKEY, 
            strm.SEQUENCENO, 
            strm.SERREQ, 
            strm.USAGEPERCENTAGE, 
            strm.VARIATION_ID, 
            strm.WATERMETERANALYSISKEY, 
            strm.WORKORDER, 
            strm.ETL_SEQUENCE_NUMBER,
            strm.ETL_DELETED,
            strm.etl_load_datetime,
            strm.etl_load_metadatafilename,
            ROW_NUMBER() OVER (PARTITION BY 
            strm.WATERMETERANALYSISKEY ORDER BY strm.ETL_SEQUENCE_NUMBER desc,IFNULL(TRY_TO_TIMESTAMP(replace(right(replace(lower(etl_load_metadatafilename),'.json'),23),'_','-'), 'yyyy-mm-dd-HH-MI-SS-FF') ,etl_load_datetime) desc) as ROWNUMBER
        FROM DATAHUB_INTEGRATION.VW_STREAM_IPS_METERMANAGEMENT_WATER_WATERMETERANALYSIS as  strm
                    )   
            WHERE ROWNUMBER=1  
            
                    ) as src on
            ((target.WATERMETERANALYSISKEY=src.WATERMETERANALYSISKEY) OR (target.WATERMETERANALYSISKEY IS NULL AND src.WATERMETERANALYSISKEY IS NULL)) 
                when matched and src.ETL_DELETED=TRUE THEN DELETE
                when matched then update set
                    target.ADDBY=src.ADDBY, 
                    target.ADDDTTM=src.ADDDTTM, 
                    target.ADDRESS=src.ADDRESS, 
                    target.ADDRESSKEY=src.ADDRESSKEY, 
                    target.ADDRESSKEY1=src.ADDRESSKEY1, 
                    target.APPROVE=src.APPROVE, 
                    target.AUDITFLAG=src.AUDITFLAG, 
                    target.BATCHKEY=src.BATCHKEY, 
                    target.COLORASSIGNMENTNEEDED=src.COLORASSIGNMENTNEEDED, 
                    target.COMPAREBILLABLE=src.COMPAREBILLABLE, 
                    target.COMPAREESTIMATEDFLAG=src.COMPAREESTIMATEDFLAG, 
                    target.COMPAREHIGHBILLABLE=src.COMPAREHIGHBILLABLE, 
                    target.COMPAREHIGHREADING=src.COMPAREHIGHREADING, 
                    target.COMPAREHIGHUSAGE=src.COMPAREHIGHUSAGE, 
                    target.COMPAREOPTION=src.COMPAREOPTION, 
                    target.COMPAREREADING=src.COMPAREREADING, 
                    target.COMPAREREADINGDATE=src.COMPAREREADINGDATE, 
                    target.COMPAREREADINGKEY=src.COMPAREREADINGKEY, 
                    target.COMPARETOTALBILLABLEUSAGE=src.COMPARETOTALBILLABLEUSAGE, 
                    target.COMPARETOTALUSAGE=src.COMPARETOTALUSAGE, 
                    target.COMPAREUSAGE=src.COMPAREUSAGE, 
                    target.COMPAREUSAGEREADINGKEYS=src.COMPAREUSAGEREADINGKEYS, 
                    target.CURRENTBILLABLE=src.CURRENTBILLABLE, 
                    target.CURRENTCOMPKEY=src.CURRENTCOMPKEY, 
                    target.CURRENTESTIMATEDFLAG=src.CURRENTESTIMATEDFLAG, 
                    target.CURRENTFIELDNOTES=src.CURRENTFIELDNOTES, 
                    target.CURRENTHIGHBILLABLE=src.CURRENTHIGHBILLABLE, 
                    target.CURRENTHIGHREADING=src.CURRENTHIGHREADING, 
                    target.CURRENTHIGHUSAGE=src.CURRENTHIGHUSAGE, 
                    target.CURRENTMETERID=src.CURRENTMETERID, 
                    target.CURRENTREADING=src.CURRENTREADING, 
                    target.CURRENTREADINGDATE=src.CURRENTREADINGDATE, 
                    target.CURRENTREADINGKEY=src.CURRENTREADINGKEY, 
                    target.CURRENTTOTALBILLABLEUSAGE=src.CURRENTTOTALBILLABLEUSAGE, 
                    target.CURRENTTOTALUSAGE=src.CURRENTTOTALUSAGE, 
                    target.CURRENTUNITTYPE=src.CURRENTUNITTYPE, 
                    target.CURRENTUSAGE=src.CURRENTUSAGE, 
                    target.CURRENTUSAGEREADINGKEYS=src.CURRENTUSAGEREADINGKEYS, 
                    target.DATALAKE_DELETED=src.DATALAKE_DELETED, 
                    target.DEFAULTACTION=src.DEFAULTACTION, 
                    target.EXCEPTION=src.EXCEPTION, 
                    target.EXCEPTIONTYPE=src.EXCEPTIONTYPE, 
                    target.HIGHMULTIPLIER=src.HIGHMULTIPLIER, 
                    target.INDEXNO=src.INDEXNO, 
                    target.ISPBCODESRVREQRESOLVED=src.ISPBCODESRVREQRESOLVED, 
                    target.ISPBCODEWORESOLVED=src.ISPBCODEWORESOLVED, 
                    target.ISPROBLEMCODEEXCEPTION=src.ISPROBLEMCODEEXCEPTION, 
                    target.ISRDCODESRVREQRESOLVED=src.ISRDCODESRVREQRESOLVED, 
                    target.ISRDCODEWORESOLVED=src.ISRDCODEWORESOLVED, 
                    target.ISREADERCODEEXCEPTION=src.ISREADERCODEEXCEPTION, 
                    target.ISREADINGAPPROVED=src.ISREADINGAPPROVED, 
                    target.ISREREADRESOLVED=src.ISREREADRESOLVED, 
                    target.KEYCOLUMN=src.KEYCOLUMN, 
                    target.LOWMULTIPLIER=src.LOWMULTIPLIER, 
                    target.MANUALREVIEWFLAG=src.MANUALREVIEWFLAG, 
                    target.MODBY=src.MODBY, 
                    target.MODDTTM=src.MODDTTM, 
                    target.NOREADFLAG=src.NOREADFLAG, 
                    target.OLDESTACCOUNTKEY=src.OLDESTACCOUNTKEY, 
                    target.OLDESTACCOUNTNO=src.OLDESTACCOUNTNO, 
                    target.OTHERACTION=src.OTHERACTION, 
                    target.PARENTKEY=src.PARENTKEY, 
                    target.POSITION=src.POSITION, 
                    target.PROBLEMCODE=src.PROBLEMCODE, 
                    target.PROBLEMCODEBACKCOLOR=src.PROBLEMCODEBACKCOLOR, 
                    target.PROBLEMCODESERVICEREQUESTNO=src.PROBLEMCODESERVICEREQUESTNO, 
                    target.PROBLEMCODESERVICEREQUESTTYPE=src.PROBLEMCODESERVICEREQUESTTYPE, 
                    target.PROBLEMCODETEXTCOLOR=src.PROBLEMCODETEXTCOLOR, 
                    target.PROBLEMCODEWORKORDERNO=src.PROBLEMCODEWORKORDERNO, 
                    target.PROBLEMCODEWORKORDERTYPE=src.PROBLEMCODEWORKORDERTYPE, 
                    target.READERCODE=src.READERCODE, 
                    target.READERCODEBACKCOLOR=src.READERCODEBACKCOLOR, 
                    target.READERCODESERVICEREQUESTNO=src.READERCODESERVICEREQUESTNO, 
                    target.READERCODESERVICEREQUESTTYPE=src.READERCODESERVICEREQUESTTYPE, 
                    target.READERCODETEXTCOLOR=src.READERCODETEXTCOLOR, 
                    target.READERCODEWORKORDERNO=src.READERCODEWORKORDERNO, 
                    target.READERCODEWORKORDERTYPE=src.READERCODEWORKORDERTYPE, 
                    target.READINGCOMPKEY=src.READINGCOMPKEY, 
                    target.READINGCYCLE=src.READINGCYCLE, 
                    target.READINGMETERID=src.READINGMETERID, 
                    target.READINGTYPE=src.READINGTYPE, 
                    target.READINGUNITTYPE=src.READINGUNITTYPE, 
                    target.REREAD=src.REREAD, 
                    target.REREADSERVICEREQUESTNO=src.REREADSERVICEREQUESTNO, 
                    target.ROUTEID=src.ROUTEID, 
                    target.ROUTEKEY=src.ROUTEKEY, 
                    target.SEQUENCENO=src.SEQUENCENO, 
                    target.SERREQ=src.SERREQ, 
                    target.USAGEPERCENTAGE=src.USAGEPERCENTAGE, 
                    target.VARIATION_ID=src.VARIATION_ID, 
                    target.WATERMETERANALYSISKEY=src.WATERMETERANALYSISKEY, 
                    target.WORKORDER=src.WORKORDER, 
                    target.ETL_SEQUENCE_NUMBER=src.ETL_SEQUENCE_NUMBER,
                    target.etl_load_datetime=CURRENT_TIMESTAMP,
                    target.etl_load_metadatafilename=src.etl_load_metadatafilename
        when not matched and (src.ETL_DELETED=FALSE OR src.ETL_DELETED IS NULL)  then insert ( 
                    ADDBY, 
                    ADDDTTM, 
                    ADDRESS, 
                    ADDRESSKEY, 
                    ADDRESSKEY1, 
                    APPROVE, 
                    AUDITFLAG, 
                    BATCHKEY, 
                    COLORASSIGNMENTNEEDED, 
                    COMPAREBILLABLE, 
                    COMPAREESTIMATEDFLAG, 
                    COMPAREHIGHBILLABLE, 
                    COMPAREHIGHREADING, 
                    COMPAREHIGHUSAGE, 
                    COMPAREOPTION, 
                    COMPAREREADING, 
                    COMPAREREADINGDATE, 
                    COMPAREREADINGKEY, 
                    COMPARETOTALBILLABLEUSAGE, 
                    COMPARETOTALUSAGE, 
                    COMPAREUSAGE, 
                    COMPAREUSAGEREADINGKEYS, 
                    CURRENTBILLABLE, 
                    CURRENTCOMPKEY, 
                    CURRENTESTIMATEDFLAG, 
                    CURRENTFIELDNOTES, 
                    CURRENTHIGHBILLABLE, 
                    CURRENTHIGHREADING, 
                    CURRENTHIGHUSAGE, 
                    CURRENTMETERID, 
                    CURRENTREADING, 
                    CURRENTREADINGDATE, 
                    CURRENTREADINGKEY, 
                    CURRENTTOTALBILLABLEUSAGE, 
                    CURRENTTOTALUSAGE, 
                    CURRENTUNITTYPE, 
                    CURRENTUSAGE, 
                    CURRENTUSAGEREADINGKEYS, 
                    DATALAKE_DELETED, 
                    DEFAULTACTION, 
                    EXCEPTION, 
                    EXCEPTIONTYPE, 
                    HIGHMULTIPLIER, 
                    INDEXNO, 
                    ISPBCODESRVREQRESOLVED, 
                    ISPBCODEWORESOLVED, 
                    ISPROBLEMCODEEXCEPTION, 
                    ISRDCODESRVREQRESOLVED, 
                    ISRDCODEWORESOLVED, 
                    ISREADERCODEEXCEPTION, 
                    ISREADINGAPPROVED, 
                    ISREREADRESOLVED, 
                    KEYCOLUMN, 
                    LOWMULTIPLIER, 
                    MANUALREVIEWFLAG, 
                    MODBY, 
                    MODDTTM, 
                    NOREADFLAG, 
                    OLDESTACCOUNTKEY, 
                    OLDESTACCOUNTNO, 
                    OTHERACTION, 
                    PARENTKEY, 
                    POSITION, 
                    PROBLEMCODE, 
                    PROBLEMCODEBACKCOLOR, 
                    PROBLEMCODESERVICEREQUESTNO, 
                    PROBLEMCODESERVICEREQUESTTYPE, 
                    PROBLEMCODETEXTCOLOR, 
                    PROBLEMCODEWORKORDERNO, 
                    PROBLEMCODEWORKORDERTYPE, 
                    READERCODE, 
                    READERCODEBACKCOLOR, 
                    READERCODESERVICEREQUESTNO, 
                    READERCODESERVICEREQUESTTYPE, 
                    READERCODETEXTCOLOR, 
                    READERCODEWORKORDERNO, 
                    READERCODEWORKORDERTYPE, 
                    READINGCOMPKEY, 
                    READINGCYCLE, 
                    READINGMETERID, 
                    READINGTYPE, 
                    READINGUNITTYPE, 
                    REREAD, 
                    REREADSERVICEREQUESTNO, 
                    ROUTEID, 
                    ROUTEKEY, 
                    SEQUENCENO, 
                    SERREQ, 
                    USAGEPERCENTAGE, 
                    VARIATION_ID, 
                    WATERMETERANALYSISKEY, 
                    WORKORDER, 
                    ETL_SEQUENCE_NUMBER,                       
                    etl_load_datetime,
                    etl_load_metadatafilename) 
            values (
                    src.ADDBY, 
                    src.ADDDTTM, 
                    src.ADDRESS, 
                    src.ADDRESSKEY, 
                    src.ADDRESSKEY1, 
                    src.APPROVE, 
                    src.AUDITFLAG, 
                    src.BATCHKEY, 
                    src.COLORASSIGNMENTNEEDED, 
                    src.COMPAREBILLABLE, 
                    src.COMPAREESTIMATEDFLAG, 
                    src.COMPAREHIGHBILLABLE, 
                    src.COMPAREHIGHREADING, 
                    src.COMPAREHIGHUSAGE, 
                    src.COMPAREOPTION, 
                    src.COMPAREREADING, 
                    src.COMPAREREADINGDATE, 
                    src.COMPAREREADINGKEY, 
                    src.COMPARETOTALBILLABLEUSAGE, 
                    src.COMPARETOTALUSAGE, 
                    src.COMPAREUSAGE, 
                    src.COMPAREUSAGEREADINGKEYS, 
                    src.CURRENTBILLABLE, 
                    src.CURRENTCOMPKEY, 
                    src.CURRENTESTIMATEDFLAG, 
                    src.CURRENTFIELDNOTES, 
                    src.CURRENTHIGHBILLABLE, 
                    src.CURRENTHIGHREADING, 
                    src.CURRENTHIGHUSAGE, 
                    src.CURRENTMETERID, 
                    src.CURRENTREADING, 
                    src.CURRENTREADINGDATE, 
                    src.CURRENTREADINGKEY, 
                    src.CURRENTTOTALBILLABLEUSAGE, 
                    src.CURRENTTOTALUSAGE, 
                    src.CURRENTUNITTYPE, 
                    src.CURRENTUSAGE, 
                    src.CURRENTUSAGEREADINGKEYS, 
                    src.DATALAKE_DELETED, 
                    src.DEFAULTACTION, 
                    src.EXCEPTION, 
                    src.EXCEPTIONTYPE, 
                    src.HIGHMULTIPLIER, 
                    src.INDEXNO, 
                    src.ISPBCODESRVREQRESOLVED, 
                    src.ISPBCODEWORESOLVED, 
                    src.ISPROBLEMCODEEXCEPTION, 
                    src.ISRDCODESRVREQRESOLVED, 
                    src.ISRDCODEWORESOLVED, 
                    src.ISREADERCODEEXCEPTION, 
                    src.ISREADINGAPPROVED, 
                    src.ISREREADRESOLVED, 
                    src.KEYCOLUMN, 
                    src.LOWMULTIPLIER, 
                    src.MANUALREVIEWFLAG, 
                    src.MODBY, 
                    src.MODDTTM, 
                    src.NOREADFLAG, 
                    src.OLDESTACCOUNTKEY, 
                    src.OLDESTACCOUNTNO, 
                    src.OTHERACTION, 
                    src.PARENTKEY, 
                    src.POSITION, 
                    src.PROBLEMCODE, 
                    src.PROBLEMCODEBACKCOLOR, 
                    src.PROBLEMCODESERVICEREQUESTNO, 
                    src.PROBLEMCODESERVICEREQUESTTYPE, 
                    src.PROBLEMCODETEXTCOLOR, 
                    src.PROBLEMCODEWORKORDERNO, 
                    src.PROBLEMCODEWORKORDERTYPE, 
                    src.READERCODE, 
                    src.READERCODEBACKCOLOR, 
                    src.READERCODESERVICEREQUESTNO, 
                    src.READERCODESERVICEREQUESTTYPE, 
                    src.READERCODETEXTCOLOR, 
                    src.READERCODEWORKORDERNO, 
                    src.READERCODEWORKORDERTYPE, 
                    src.READINGCOMPKEY, 
                    src.READINGCYCLE, 
                    src.READINGMETERID, 
                    src.READINGTYPE, 
                    src.READINGUNITTYPE, 
                    src.REREAD, 
                    src.REREADSERVICEREQUESTNO, 
                    src.ROUTEID, 
                    src.ROUTEKEY, 
                    src.SEQUENCENO, 
                    src.SERREQ, 
                    src.USAGEPERCENTAGE, 
                    src.VARIATION_ID, 
                    src.WATERMETERANALYSISKEY, 
                    src.WORKORDER,     
                    src.ETL_SEQUENCE_NUMBER,
                    CURRENT_TIMESTAMP,
                    src.etl_load_metadatafilename);`;

    var sqlStmt = snowflake.createStatement( {sqlText:  sql_command} );
    var rs = sqlStmt.execute();

    snowflake.execute( {sqlText: `merge into DATAHUB_TARGET_HISTORY.IPS_DELETED_METERMANAGEMENT_WATER_WATERMETERANALYSIS as target using (
                SELECT * FROM (SELECT 
            strm.ADDBY, 
            strm.ADDDTTM, 
            strm.ADDRESS, 
            strm.ADDRESSKEY, 
            strm.ADDRESSKEY1, 
            strm.APPROVE, 
            strm.AUDITFLAG, 
            strm.BATCHKEY, 
            strm.COLORASSIGNMENTNEEDED, 
            strm.COMPAREBILLABLE, 
            strm.COMPAREESTIMATEDFLAG, 
            strm.COMPAREHIGHBILLABLE, 
            strm.COMPAREHIGHREADING, 
            strm.COMPAREHIGHUSAGE, 
            strm.COMPAREOPTION, 
            strm.COMPAREREADING, 
            strm.COMPAREREADINGDATE, 
            strm.COMPAREREADINGKEY, 
            strm.COMPARETOTALBILLABLEUSAGE, 
            strm.COMPARETOTALUSAGE, 
            strm.COMPAREUSAGE, 
            strm.COMPAREUSAGEREADINGKEYS, 
            strm.CURRENTBILLABLE, 
            strm.CURRENTCOMPKEY, 
            strm.CURRENTESTIMATEDFLAG, 
            strm.CURRENTFIELDNOTES, 
            strm.CURRENTHIGHBILLABLE, 
            strm.CURRENTHIGHREADING, 
            strm.CURRENTHIGHUSAGE, 
            strm.CURRENTMETERID, 
            strm.CURRENTREADING, 
            strm.CURRENTREADINGDATE, 
            strm.CURRENTREADINGKEY, 
            strm.CURRENTTOTALBILLABLEUSAGE, 
            strm.CURRENTTOTALUSAGE, 
            strm.CURRENTUNITTYPE, 
            strm.CURRENTUSAGE, 
            strm.CURRENTUSAGEREADINGKEYS, 
            strm.DATALAKE_DELETED, 
            strm.DEFAULTACTION, 
            strm.EXCEPTION, 
            strm.EXCEPTIONTYPE, 
            strm.HIGHMULTIPLIER, 
            strm.INDEXNO, 
            strm.ISPBCODESRVREQRESOLVED, 
            strm.ISPBCODEWORESOLVED, 
            strm.ISPROBLEMCODEEXCEPTION, 
            strm.ISRDCODESRVREQRESOLVED, 
            strm.ISRDCODEWORESOLVED, 
            strm.ISREADERCODEEXCEPTION, 
            strm.ISREADINGAPPROVED, 
            strm.ISREREADRESOLVED, 
            strm.KEYCOLUMN, 
            strm.LOWMULTIPLIER, 
            strm.MANUALREVIEWFLAG, 
            strm.MODBY, 
            strm.MODDTTM, 
            strm.NOREADFLAG, 
            strm.OLDESTACCOUNTKEY, 
            strm.OLDESTACCOUNTNO, 
            strm.OTHERACTION, 
            strm.PARENTKEY, 
            strm.POSITION, 
            strm.PROBLEMCODE, 
            strm.PROBLEMCODEBACKCOLOR, 
            strm.PROBLEMCODESERVICEREQUESTNO, 
            strm.PROBLEMCODESERVICEREQUESTTYPE, 
            strm.PROBLEMCODETEXTCOLOR, 
            strm.PROBLEMCODEWORKORDERNO, 
            strm.PROBLEMCODEWORKORDERTYPE, 
            strm.READERCODE, 
            strm.READERCODEBACKCOLOR, 
            strm.READERCODESERVICEREQUESTNO, 
            strm.READERCODESERVICEREQUESTTYPE, 
            strm.READERCODETEXTCOLOR, 
            strm.READERCODEWORKORDERNO, 
            strm.READERCODEWORKORDERTYPE, 
            strm.READINGCOMPKEY, 
            strm.READINGCYCLE, 
            strm.READINGMETERID, 
            strm.READINGTYPE, 
            strm.READINGUNITTYPE, 
            strm.REREAD, 
            strm.REREADSERVICEREQUESTNO, 
            strm.ROUTEID, 
            strm.ROUTEKEY, 
            strm.SEQUENCENO, 
            strm.SERREQ, 
            strm.USAGEPERCENTAGE, 
            strm.VARIATION_ID, 
            strm.WATERMETERANALYSISKEY, 
            strm.WORKORDER, 
            strm.ETL_SEQUENCE_NUMBER,
            strm.ETL_DELETED,
            strm.etl_load_datetime,
            strm.etl_load_metadatafilename,
            ROW_NUMBER() OVER (PARTITION BY 
            strm.WATERMETERANALYSISKEY ORDER BY strm.ETL_SEQUENCE_NUMBER desc,IFNULL(TRY_TO_TIMESTAMP(replace(right(replace(lower(etl_load_metadatafilename),'.json'),23),'_','-'), 'yyyy-mm-dd-HH-MI-SS-FF') ,etl_load_datetime) desc) as ROWNUMBER
        FROM DATAHUB_INTEGRATION.VW_STREAM_IPS_METERMANAGEMENT_WATER_WATERMETERANALYSIS as  strm
        WHERE strm.ETL_DELETED=TRUE
                    )   
            WHERE ROWNUMBER=1  
            
                    ) as src on
            ((target.WATERMETERANALYSISKEY=src.WATERMETERANALYSISKEY) OR (target.WATERMETERANALYSISKEY IS NULL AND src.WATERMETERANALYSISKEY IS NULL)) 
                when matched then update set
                    target.ADDBY=src.ADDBY, 
                    target.ADDDTTM=src.ADDDTTM, 
                    target.ADDRESS=src.ADDRESS, 
                    target.ADDRESSKEY=src.ADDRESSKEY, 
                    target.ADDRESSKEY1=src.ADDRESSKEY1, 
                    target.APPROVE=src.APPROVE, 
                    target.AUDITFLAG=src.AUDITFLAG, 
                    target.BATCHKEY=src.BATCHKEY, 
                    target.COLORASSIGNMENTNEEDED=src.COLORASSIGNMENTNEEDED, 
                    target.COMPAREBILLABLE=src.COMPAREBILLABLE, 
                    target.COMPAREESTIMATEDFLAG=src.COMPAREESTIMATEDFLAG, 
                    target.COMPAREHIGHBILLABLE=src.COMPAREHIGHBILLABLE, 
                    target.COMPAREHIGHREADING=src.COMPAREHIGHREADING, 
                    target.COMPAREHIGHUSAGE=src.COMPAREHIGHUSAGE, 
                    target.COMPAREOPTION=src.COMPAREOPTION, 
                    target.COMPAREREADING=src.COMPAREREADING, 
                    target.COMPAREREADINGDATE=src.COMPAREREADINGDATE, 
                    target.COMPAREREADINGKEY=src.COMPAREREADINGKEY, 
                    target.COMPARETOTALBILLABLEUSAGE=src.COMPARETOTALBILLABLEUSAGE, 
                    target.COMPARETOTALUSAGE=src.COMPARETOTALUSAGE, 
                    target.COMPAREUSAGE=src.COMPAREUSAGE, 
                    target.COMPAREUSAGEREADINGKEYS=src.COMPAREUSAGEREADINGKEYS, 
                    target.CURRENTBILLABLE=src.CURRENTBILLABLE, 
                    target.CURRENTCOMPKEY=src.CURRENTCOMPKEY, 
                    target.CURRENTESTIMATEDFLAG=src.CURRENTESTIMATEDFLAG, 
                    target.CURRENTFIELDNOTES=src.CURRENTFIELDNOTES, 
                    target.CURRENTHIGHBILLABLE=src.CURRENTHIGHBILLABLE, 
                    target.CURRENTHIGHREADING=src.CURRENTHIGHREADING, 
                    target.CURRENTHIGHUSAGE=src.CURRENTHIGHUSAGE, 
                    target.CURRENTMETERID=src.CURRENTMETERID, 
                    target.CURRENTREADING=src.CURRENTREADING, 
                    target.CURRENTREADINGDATE=src.CURRENTREADINGDATE, 
                    target.CURRENTREADINGKEY=src.CURRENTREADINGKEY, 
                    target.CURRENTTOTALBILLABLEUSAGE=src.CURRENTTOTALBILLABLEUSAGE, 
                    target.CURRENTTOTALUSAGE=src.CURRENTTOTALUSAGE, 
                    target.CURRENTUNITTYPE=src.CURRENTUNITTYPE, 
                    target.CURRENTUSAGE=src.CURRENTUSAGE, 
                    target.CURRENTUSAGEREADINGKEYS=src.CURRENTUSAGEREADINGKEYS, 
                    target.DATALAKE_DELETED=src.DATALAKE_DELETED, 
                    target.DEFAULTACTION=src.DEFAULTACTION, 
                    target.EXCEPTION=src.EXCEPTION, 
                    target.EXCEPTIONTYPE=src.EXCEPTIONTYPE, 
                    target.HIGHMULTIPLIER=src.HIGHMULTIPLIER, 
                    target.INDEXNO=src.INDEXNO, 
                    target.ISPBCODESRVREQRESOLVED=src.ISPBCODESRVREQRESOLVED, 
                    target.ISPBCODEWORESOLVED=src.ISPBCODEWORESOLVED, 
                    target.ISPROBLEMCODEEXCEPTION=src.ISPROBLEMCODEEXCEPTION, 
                    target.ISRDCODESRVREQRESOLVED=src.ISRDCODESRVREQRESOLVED, 
                    target.ISRDCODEWORESOLVED=src.ISRDCODEWORESOLVED, 
                    target.ISREADERCODEEXCEPTION=src.ISREADERCODEEXCEPTION, 
                    target.ISREADINGAPPROVED=src.ISREADINGAPPROVED, 
                    target.ISREREADRESOLVED=src.ISREREADRESOLVED, 
                    target.KEYCOLUMN=src.KEYCOLUMN, 
                    target.LOWMULTIPLIER=src.LOWMULTIPLIER, 
                    target.MANUALREVIEWFLAG=src.MANUALREVIEWFLAG, 
                    target.MODBY=src.MODBY, 
                    target.MODDTTM=src.MODDTTM, 
                    target.NOREADFLAG=src.NOREADFLAG, 
                    target.OLDESTACCOUNTKEY=src.OLDESTACCOUNTKEY, 
                    target.OLDESTACCOUNTNO=src.OLDESTACCOUNTNO, 
                    target.OTHERACTION=src.OTHERACTION, 
                    target.PARENTKEY=src.PARENTKEY, 
                    target.POSITION=src.POSITION, 
                    target.PROBLEMCODE=src.PROBLEMCODE, 
                    target.PROBLEMCODEBACKCOLOR=src.PROBLEMCODEBACKCOLOR, 
                    target.PROBLEMCODESERVICEREQUESTNO=src.PROBLEMCODESERVICEREQUESTNO, 
                    target.PROBLEMCODESERVICEREQUESTTYPE=src.PROBLEMCODESERVICEREQUESTTYPE, 
                    target.PROBLEMCODETEXTCOLOR=src.PROBLEMCODETEXTCOLOR, 
                    target.PROBLEMCODEWORKORDERNO=src.PROBLEMCODEWORKORDERNO, 
                    target.PROBLEMCODEWORKORDERTYPE=src.PROBLEMCODEWORKORDERTYPE, 
                    target.READERCODE=src.READERCODE, 
                    target.READERCODEBACKCOLOR=src.READERCODEBACKCOLOR, 
                    target.READERCODESERVICEREQUESTNO=src.READERCODESERVICEREQUESTNO, 
                    target.READERCODESERVICEREQUESTTYPE=src.READERCODESERVICEREQUESTTYPE, 
                    target.READERCODETEXTCOLOR=src.READERCODETEXTCOLOR, 
                    target.READERCODEWORKORDERNO=src.READERCODEWORKORDERNO, 
                    target.READERCODEWORKORDERTYPE=src.READERCODEWORKORDERTYPE, 
                    target.READINGCOMPKEY=src.READINGCOMPKEY, 
                    target.READINGCYCLE=src.READINGCYCLE, 
                    target.READINGMETERID=src.READINGMETERID, 
                    target.READINGTYPE=src.READINGTYPE, 
                    target.READINGUNITTYPE=src.READINGUNITTYPE, 
                    target.REREAD=src.REREAD, 
                    target.REREADSERVICEREQUESTNO=src.REREADSERVICEREQUESTNO, 
                    target.ROUTEID=src.ROUTEID, 
                    target.ROUTEKEY=src.ROUTEKEY, 
                    target.SEQUENCENO=src.SEQUENCENO, 
                    target.SERREQ=src.SERREQ, 
                    target.USAGEPERCENTAGE=src.USAGEPERCENTAGE, 
                    target.VARIATION_ID=src.VARIATION_ID, 
                    target.WATERMETERANALYSISKEY=src.WATERMETERANALYSISKEY, 
                    target.WORKORDER=src.WORKORDER, 
                    target.ETL_SEQUENCE_NUMBER=src.ETL_SEQUENCE_NUMBER,
                    target.etl_load_datetime=CURRENT_TIMESTAMP,
                    target.etl_load_metadatafilename=src.etl_load_metadatafilename,
                    target.ETL_DELETED=src.ETL_DELETED
        when not matched   then insert ( ADDBY, ADDDTTM, ADDRESS, ADDRESSKEY, ADDRESSKEY1, APPROVE, AUDITFLAG, BATCHKEY, COLORASSIGNMENTNEEDED, COMPAREBILLABLE, COMPAREESTIMATEDFLAG, COMPAREHIGHBILLABLE, COMPAREHIGHREADING, COMPAREHIGHUSAGE, COMPAREOPTION, COMPAREREADING, COMPAREREADINGDATE, COMPAREREADINGKEY, COMPARETOTALBILLABLEUSAGE, COMPARETOTALUSAGE, COMPAREUSAGE, COMPAREUSAGEREADINGKEYS, CURRENTBILLABLE, CURRENTCOMPKEY, CURRENTESTIMATEDFLAG, CURRENTFIELDNOTES, CURRENTHIGHBILLABLE, CURRENTHIGHREADING, CURRENTHIGHUSAGE, CURRENTMETERID, CURRENTREADING, CURRENTREADINGDATE, CURRENTREADINGKEY, CURRENTTOTALBILLABLEUSAGE, CURRENTTOTALUSAGE, CURRENTUNITTYPE, CURRENTUSAGE, CURRENTUSAGEREADINGKEYS, DATALAKE_DELETED, DEFAULTACTION, EXCEPTION, EXCEPTIONTYPE, HIGHMULTIPLIER, INDEXNO, ISPBCODESRVREQRESOLVED, ISPBCODEWORESOLVED, ISPROBLEMCODEEXCEPTION, ISRDCODESRVREQRESOLVED, ISRDCODEWORESOLVED, ISREADERCODEEXCEPTION, ISREADINGAPPROVED, ISREREADRESOLVED, KEYCOLUMN, LOWMULTIPLIER, MANUALREVIEWFLAG, MODBY, MODDTTM, NOREADFLAG, OLDESTACCOUNTKEY, OLDESTACCOUNTNO, OTHERACTION, PARENTKEY, POSITION, PROBLEMCODE, PROBLEMCODEBACKCOLOR, PROBLEMCODESERVICEREQUESTNO, PROBLEMCODESERVICEREQUESTTYPE, PROBLEMCODETEXTCOLOR, PROBLEMCODEWORKORDERNO, PROBLEMCODEWORKORDERTYPE, READERCODE, READERCODEBACKCOLOR, READERCODESERVICEREQUESTNO, READERCODESERVICEREQUESTTYPE, READERCODETEXTCOLOR, READERCODEWORKORDERNO, READERCODEWORKORDERTYPE, READINGCOMPKEY, READINGCYCLE, READINGMETERID, READINGTYPE, READINGUNITTYPE, REREAD, REREADSERVICEREQUESTNO, ROUTEID, ROUTEKEY, SEQUENCENO, SERREQ, USAGEPERCENTAGE, VARIATION_ID, WATERMETERANALYSISKEY, WORKORDER, 
                    ETL_SEQUENCE_NUMBER,                       
                    etl_load_datetime,
                    etl_load_metadatafilename,
                    etl_is_deleted,
                    ETL_DELETED) 
            values (
                    src.ADDBY, 
                    src.ADDDTTM, 
                    src.ADDRESS, 
                    src.ADDRESSKEY, 
                    src.ADDRESSKEY1, 
                    src.APPROVE, 
                    src.AUDITFLAG, 
                    src.BATCHKEY, 
                    src.COLORASSIGNMENTNEEDED, 
                    src.COMPAREBILLABLE, 
                    src.COMPAREESTIMATEDFLAG, 
                    src.COMPAREHIGHBILLABLE, 
                    src.COMPAREHIGHREADING, 
                    src.COMPAREHIGHUSAGE, 
                    src.COMPAREOPTION, 
                    src.COMPAREREADING, 
                    src.COMPAREREADINGDATE, 
                    src.COMPAREREADINGKEY, 
                    src.COMPARETOTALBILLABLEUSAGE, 
                    src.COMPARETOTALUSAGE, 
                    src.COMPAREUSAGE, 
                    src.COMPAREUSAGEREADINGKEYS, 
                    src.CURRENTBILLABLE, 
                    src.CURRENTCOMPKEY, 
                    src.CURRENTESTIMATEDFLAG, 
                    src.CURRENTFIELDNOTES, 
                    src.CURRENTHIGHBILLABLE, 
                    src.CURRENTHIGHREADING, 
                    src.CURRENTHIGHUSAGE, 
                    src.CURRENTMETERID, 
                    src.CURRENTREADING, 
                    src.CURRENTREADINGDATE, 
                    src.CURRENTREADINGKEY, 
                    src.CURRENTTOTALBILLABLEUSAGE, 
                    src.CURRENTTOTALUSAGE, 
                    src.CURRENTUNITTYPE, 
                    src.CURRENTUSAGE, 
                    src.CURRENTUSAGEREADINGKEYS, 
                    src.DATALAKE_DELETED, 
                    src.DEFAULTACTION, 
                    src.EXCEPTION, 
                    src.EXCEPTIONTYPE, 
                    src.HIGHMULTIPLIER, 
                    src.INDEXNO, 
                    src.ISPBCODESRVREQRESOLVED, 
                    src.ISPBCODEWORESOLVED, 
                    src.ISPROBLEMCODEEXCEPTION, 
                    src.ISRDCODESRVREQRESOLVED, 
                    src.ISRDCODEWORESOLVED, 
                    src.ISREADERCODEEXCEPTION, 
                    src.ISREADINGAPPROVED, 
                    src.ISREREADRESOLVED, 
                    src.KEYCOLUMN, 
                    src.LOWMULTIPLIER, 
                    src.MANUALREVIEWFLAG, 
                    src.MODBY, 
                    src.MODDTTM, 
                    src.NOREADFLAG, 
                    src.OLDESTACCOUNTKEY, 
                    src.OLDESTACCOUNTNO, 
                    src.OTHERACTION, 
                    src.PARENTKEY, 
                    src.POSITION, 
                    src.PROBLEMCODE, 
                    src.PROBLEMCODEBACKCOLOR, 
                    src.PROBLEMCODESERVICEREQUESTNO, 
                    src.PROBLEMCODESERVICEREQUESTTYPE, 
                    src.PROBLEMCODETEXTCOLOR, 
                    src.PROBLEMCODEWORKORDERNO, 
                    src.PROBLEMCODEWORKORDERTYPE, 
                    src.READERCODE, 
                    src.READERCODEBACKCOLOR, 
                    src.READERCODESERVICEREQUESTNO, 
                    src.READERCODESERVICEREQUESTTYPE, 
                    src.READERCODETEXTCOLOR, 
                    src.READERCODEWORKORDERNO, 
                    src.READERCODEWORKORDERTYPE, 
                    src.READINGCOMPKEY, 
                    src.READINGCYCLE, 
                    src.READINGMETERID, 
                    src.READINGTYPE, 
                    src.READINGUNITTYPE, 
                    src.REREAD, 
                    src.REREADSERVICEREQUESTNO, 
                    src.ROUTEID, 
                    src.ROUTEKEY, 
                    src.SEQUENCENO, 
                    src.SERREQ, 
                    src.USAGEPERCENTAGE, 
                    src.VARIATION_ID, 
                    src.WATERMETERANALYSISKEY, 
                    src.WORKORDER,     
                    src.ETL_SEQUENCE_NUMBER,
                    CURRENT_TIMESTAMP,
                    src.etl_load_metadatafilename,
                    case when ETL_DELETED=TRUE then TRUE else FALSE end,
                    ETL_DELETED);
    `
} );

                    
//  Get number of rows inserted
        
        var sqlStmt = snowflake.createStatement( {sqlText:  sql_command} );
        var rs = sqlStmt.execute();
        var number_of_rows_inserted = sqlStmt.getNumRowsInserted();
        var number_of_rows_updated =  sqlStmt.getNumRowsUpdated();
                    

        
    snowflake.execute ({sqlText: "commit"});

    log_sql_command = "call datahub_logging.sp_etl_log_ingestion_process('UpdateEnd','" + process_name + "','Success','Completed process execution.', 0 ," + number_of_rows_inserted.toString()+ "," +  number_of_rows_updated.toString() + ");";
    snowflake.execute({sqlText: log_sql_command});

    result = "Success"; 

    }       

    catch (err)  {
        snowflake.execute( {sqlText: "rollback;"} )
        var clean_error_msg = err.message.replace(/[^\w\s]/gi, '');
    //  Create a log entry to say INSERT STATEMENT failed
    
    log_sql_command = "call datahub_logging.sp_etl_log_ingestion_process('UpdateEnd','" + process_name + "','Failed','MERGE Failed. Error:" + err.code.toString()+" : "+ clean_error_msg  + "', 0 ,0,0);";
    snowflake.execute({sqlText: log_sql_command});
        ;
        throw "Failed: " + err.message;   // Return a success/error indicator.
        }
    return result;
    $$;