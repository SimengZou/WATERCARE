create or replace procedure DATAHUB_INTEGRATION.SP_IPS_METERMANAGEMENT_WATER_READINGREVIEWSETUP()
    returns varchar not null
                language javascript
                as
                $$

//  Variables

var result = "";                                    // return status of this proc call
const process_name = Object.keys(this)[0];          // name of currently executing process
var number_of_rows_inserted = 0;                             // track number of rows we have inserted
var number_of_rows_updated = 0;                             // track number of rows we have updated


//  Step 1.

//  Start execution - log start

log_sql_command = "call datahub_logging.sp_etl_log_ingestion_process('Insert','" + process_name + "','Running','Started process execution.', 0,0,0);";
snowflake.execute({sqlText: log_sql_command});

snowflake.execute( {sqlText: "begin transaction;"} );
try
    {
        var sql_command = `
                            INSERT INTO LANDING_ERROR.IPS_RAW_ERROR
                            SELECT * FROM LANDING_ERROR.VW_STREAM_IPS_METERMANAGEMENT_WATER_READINGREVIEWSETUP_ERROR`;
    var sqlStmt = snowflake.createStatement( {sqlText:  sql_command} );
    var rs = sqlStmt.execute();
        
        var sql_command = ` 
                            merge into  DATAHUB_TARGET.IPS_METERMANAGEMENT_WATER_READINGREVIEWSETUP as target using (SELECT * FROM (SELECT 
            strm.ADDBY, 
            strm.ADDDTTM, 
            strm.CNCLREREADRESCODE, 
            strm.DAYSFORCURRD, 
            strm.DELETED, 
            strm.ESTBKG, 
            strm.ESTTXT, 
            strm.HI1BKG, 
            strm.HI1DEFACTION, 
            strm.HI1PCT, 
            strm.HI1PROCESS, 
            strm.HI1TXT, 
            strm.HI2BKG, 
            strm.HI2DEFACTION, 
            strm.HI2PCT, 
            strm.HI2PROCESS, 
            strm.HI2TXT, 
            strm.HI3BKG, 
            strm.HI3DEFACTION, 
            strm.HI3PCT, 
            strm.HI3PROCESS, 
            strm.HI3TXT, 
            strm.LO1BKG, 
            strm.LO1DEFACTION, 
            strm.LO1PCT, 
            strm.LO1PROCESS, 
            strm.LO1TXT, 
            strm.LO2BKG, 
            strm.LO2DEFACTION, 
            strm.LO2PCT, 
            strm.LO2PROCESS, 
            strm.LO2TXT, 
            strm.LO3BKG, 
            strm.LO3DEFACTION, 
            strm.LO3PCT, 
            strm.LO3PROCESS, 
            strm.LO3TXT, 
            strm.MARKREREAD, 
            strm.METERTYPE, 
            strm.MODBY, 
            strm.MODDTTM, 
            strm.NEGUSGBKG, 
            strm.NEGUSGDEFACTION, 
            strm.NEGUSGPROCESS, 
            strm.NEGUSGTXT, 
            strm.NOACCTBKG, 
            strm.NOACCTDEFACTION, 
            strm.NOACCTPROCESS, 
            strm.NOACCTTXT, 
            strm.NORDBKG, 
            strm.NORDDEFACTION, 
            strm.NORMALPROCESS, 
            strm.NOUSGBKG, 
            strm.NOUSGDEFACTION, 
            strm.NOUSGPROCESS, 
            strm.NOUSGTXT, 
            strm.PRESELECTACCTFORBILL, 
            strm.RDPROBKEY, 
            strm.RDREVIEWSUKEY, 
            strm.UPONADDIREADAPPROVAL, 
            strm.UPONCYREADAPPROVAL, 
            strm.VARIATION_ID, 
            strm.ETL_SEQUENCE_NUMBER,
            strm.ETL_DELETED,
            strm.etl_load_datetime,
            strm.etl_load_metadatafilename,
            ROW_NUMBER() OVER (PARTITION BY 
            strm.RDREVIEWSUKEY ORDER BY strm.ETL_SEQUENCE_NUMBER desc,IFNULL(TRY_TO_TIMESTAMP(replace(right(replace(lower(etl_load_metadatafilename),'.json'),23),'_','-'), 'yyyy-mm-dd-HH-MI-SS-FF') ,etl_load_datetime) desc) as ROWNUMBER
        FROM DATAHUB_INTEGRATION.VW_STREAM_IPS_METERMANAGEMENT_WATER_READINGREVIEWSETUP as  strm
                    )   
            WHERE ROWNUMBER=1  
            
                    ) as src on
            ((target.RDREVIEWSUKEY=src.RDREVIEWSUKEY) OR (target.RDREVIEWSUKEY IS NULL AND src.RDREVIEWSUKEY IS NULL)) 
                when matched and src.ETL_DELETED=TRUE THEN DELETE
                when matched then update set
                    target.ADDBY=src.ADDBY, 
                    target.ADDDTTM=src.ADDDTTM, 
                    target.CNCLREREADRESCODE=src.CNCLREREADRESCODE, 
                    target.DAYSFORCURRD=src.DAYSFORCURRD, 
                    target.DELETED=src.DELETED, 
                    target.ESTBKG=src.ESTBKG, 
                    target.ESTTXT=src.ESTTXT, 
                    target.HI1BKG=src.HI1BKG, 
                    target.HI1DEFACTION=src.HI1DEFACTION, 
                    target.HI1PCT=src.HI1PCT, 
                    target.HI1PROCESS=src.HI1PROCESS, 
                    target.HI1TXT=src.HI1TXT, 
                    target.HI2BKG=src.HI2BKG, 
                    target.HI2DEFACTION=src.HI2DEFACTION, 
                    target.HI2PCT=src.HI2PCT, 
                    target.HI2PROCESS=src.HI2PROCESS, 
                    target.HI2TXT=src.HI2TXT, 
                    target.HI3BKG=src.HI3BKG, 
                    target.HI3DEFACTION=src.HI3DEFACTION, 
                    target.HI3PCT=src.HI3PCT, 
                    target.HI3PROCESS=src.HI3PROCESS, 
                    target.HI3TXT=src.HI3TXT, 
                    target.LO1BKG=src.LO1BKG, 
                    target.LO1DEFACTION=src.LO1DEFACTION, 
                    target.LO1PCT=src.LO1PCT, 
                    target.LO1PROCESS=src.LO1PROCESS, 
                    target.LO1TXT=src.LO1TXT, 
                    target.LO2BKG=src.LO2BKG, 
                    target.LO2DEFACTION=src.LO2DEFACTION, 
                    target.LO2PCT=src.LO2PCT, 
                    target.LO2PROCESS=src.LO2PROCESS, 
                    target.LO2TXT=src.LO2TXT, 
                    target.LO3BKG=src.LO3BKG, 
                    target.LO3DEFACTION=src.LO3DEFACTION, 
                    target.LO3PCT=src.LO3PCT, 
                    target.LO3PROCESS=src.LO3PROCESS, 
                    target.LO3TXT=src.LO3TXT, 
                    target.MARKREREAD=src.MARKREREAD, 
                    target.METERTYPE=src.METERTYPE, 
                    target.MODBY=src.MODBY, 
                    target.MODDTTM=src.MODDTTM, 
                    target.NEGUSGBKG=src.NEGUSGBKG, 
                    target.NEGUSGDEFACTION=src.NEGUSGDEFACTION, 
                    target.NEGUSGPROCESS=src.NEGUSGPROCESS, 
                    target.NEGUSGTXT=src.NEGUSGTXT, 
                    target.NOACCTBKG=src.NOACCTBKG, 
                    target.NOACCTDEFACTION=src.NOACCTDEFACTION, 
                    target.NOACCTPROCESS=src.NOACCTPROCESS, 
                    target.NOACCTTXT=src.NOACCTTXT, 
                    target.NORDBKG=src.NORDBKG, 
                    target.NORDDEFACTION=src.NORDDEFACTION, 
                    target.NORMALPROCESS=src.NORMALPROCESS, 
                    target.NOUSGBKG=src.NOUSGBKG, 
                    target.NOUSGDEFACTION=src.NOUSGDEFACTION, 
                    target.NOUSGPROCESS=src.NOUSGPROCESS, 
                    target.NOUSGTXT=src.NOUSGTXT, 
                    target.PRESELECTACCTFORBILL=src.PRESELECTACCTFORBILL, 
                    target.RDPROBKEY=src.RDPROBKEY, 
                    target.RDREVIEWSUKEY=src.RDREVIEWSUKEY, 
                    target.UPONADDIREADAPPROVAL=src.UPONADDIREADAPPROVAL, 
                    target.UPONCYREADAPPROVAL=src.UPONCYREADAPPROVAL, 
                    target.VARIATION_ID=src.VARIATION_ID, 
                    target.ETL_SEQUENCE_NUMBER=src.ETL_SEQUENCE_NUMBER,
                    target.etl_load_datetime=CURRENT_TIMESTAMP,
                    target.etl_load_metadatafilename=src.etl_load_metadatafilename
        when not matched and (src.ETL_DELETED=FALSE OR src.ETL_DELETED IS NULL)  then insert ( 
                    ADDBY, 
                    ADDDTTM, 
                    CNCLREREADRESCODE, 
                    DAYSFORCURRD, 
                    DELETED, 
                    ESTBKG, 
                    ESTTXT, 
                    HI1BKG, 
                    HI1DEFACTION, 
                    HI1PCT, 
                    HI1PROCESS, 
                    HI1TXT, 
                    HI2BKG, 
                    HI2DEFACTION, 
                    HI2PCT, 
                    HI2PROCESS, 
                    HI2TXT, 
                    HI3BKG, 
                    HI3DEFACTION, 
                    HI3PCT, 
                    HI3PROCESS, 
                    HI3TXT, 
                    LO1BKG, 
                    LO1DEFACTION, 
                    LO1PCT, 
                    LO1PROCESS, 
                    LO1TXT, 
                    LO2BKG, 
                    LO2DEFACTION, 
                    LO2PCT, 
                    LO2PROCESS, 
                    LO2TXT, 
                    LO3BKG, 
                    LO3DEFACTION, 
                    LO3PCT, 
                    LO3PROCESS, 
                    LO3TXT, 
                    MARKREREAD, 
                    METERTYPE, 
                    MODBY, 
                    MODDTTM, 
                    NEGUSGBKG, 
                    NEGUSGDEFACTION, 
                    NEGUSGPROCESS, 
                    NEGUSGTXT, 
                    NOACCTBKG, 
                    NOACCTDEFACTION, 
                    NOACCTPROCESS, 
                    NOACCTTXT, 
                    NORDBKG, 
                    NORDDEFACTION, 
                    NORMALPROCESS, 
                    NOUSGBKG, 
                    NOUSGDEFACTION, 
                    NOUSGPROCESS, 
                    NOUSGTXT, 
                    PRESELECTACCTFORBILL, 
                    RDPROBKEY, 
                    RDREVIEWSUKEY, 
                    UPONADDIREADAPPROVAL, 
                    UPONCYREADAPPROVAL, 
                    VARIATION_ID, 
                    ETL_SEQUENCE_NUMBER,                       
                    etl_load_datetime,
                    etl_load_metadatafilename) 
            values (
                    src.ADDBY, 
                    src.ADDDTTM, 
                    src.CNCLREREADRESCODE, 
                    src.DAYSFORCURRD, 
                    src.DELETED, 
                    src.ESTBKG, 
                    src.ESTTXT, 
                    src.HI1BKG, 
                    src.HI1DEFACTION, 
                    src.HI1PCT, 
                    src.HI1PROCESS, 
                    src.HI1TXT, 
                    src.HI2BKG, 
                    src.HI2DEFACTION, 
                    src.HI2PCT, 
                    src.HI2PROCESS, 
                    src.HI2TXT, 
                    src.HI3BKG, 
                    src.HI3DEFACTION, 
                    src.HI3PCT, 
                    src.HI3PROCESS, 
                    src.HI3TXT, 
                    src.LO1BKG, 
                    src.LO1DEFACTION, 
                    src.LO1PCT, 
                    src.LO1PROCESS, 
                    src.LO1TXT, 
                    src.LO2BKG, 
                    src.LO2DEFACTION, 
                    src.LO2PCT, 
                    src.LO2PROCESS, 
                    src.LO2TXT, 
                    src.LO3BKG, 
                    src.LO3DEFACTION, 
                    src.LO3PCT, 
                    src.LO3PROCESS, 
                    src.LO3TXT, 
                    src.MARKREREAD, 
                    src.METERTYPE, 
                    src.MODBY, 
                    src.MODDTTM, 
                    src.NEGUSGBKG, 
                    src.NEGUSGDEFACTION, 
                    src.NEGUSGPROCESS, 
                    src.NEGUSGTXT, 
                    src.NOACCTBKG, 
                    src.NOACCTDEFACTION, 
                    src.NOACCTPROCESS, 
                    src.NOACCTTXT, 
                    src.NORDBKG, 
                    src.NORDDEFACTION, 
                    src.NORMALPROCESS, 
                    src.NOUSGBKG, 
                    src.NOUSGDEFACTION, 
                    src.NOUSGPROCESS, 
                    src.NOUSGTXT, 
                    src.PRESELECTACCTFORBILL, 
                    src.RDPROBKEY, 
                    src.RDREVIEWSUKEY, 
                    src.UPONADDIREADAPPROVAL, 
                    src.UPONCYREADAPPROVAL, 
                    src.VARIATION_ID,     
                    src.ETL_SEQUENCE_NUMBER,
                    CURRENT_TIMESTAMP,
                    src.etl_load_metadatafilename);`;

    var sqlStmt = snowflake.createStatement( {sqlText:  sql_command} );
    var rs = sqlStmt.execute();

    snowflake.execute( {sqlText: `merge into DATAHUB_TARGET_HISTORY.IPS_DELETED_METERMANAGEMENT_WATER_READINGREVIEWSETUP as target using (
                SELECT * FROM (SELECT 
            strm.ADDBY, 
            strm.ADDDTTM, 
            strm.CNCLREREADRESCODE, 
            strm.DAYSFORCURRD, 
            strm.DELETED, 
            strm.ESTBKG, 
            strm.ESTTXT, 
            strm.HI1BKG, 
            strm.HI1DEFACTION, 
            strm.HI1PCT, 
            strm.HI1PROCESS, 
            strm.HI1TXT, 
            strm.HI2BKG, 
            strm.HI2DEFACTION, 
            strm.HI2PCT, 
            strm.HI2PROCESS, 
            strm.HI2TXT, 
            strm.HI3BKG, 
            strm.HI3DEFACTION, 
            strm.HI3PCT, 
            strm.HI3PROCESS, 
            strm.HI3TXT, 
            strm.LO1BKG, 
            strm.LO1DEFACTION, 
            strm.LO1PCT, 
            strm.LO1PROCESS, 
            strm.LO1TXT, 
            strm.LO2BKG, 
            strm.LO2DEFACTION, 
            strm.LO2PCT, 
            strm.LO2PROCESS, 
            strm.LO2TXT, 
            strm.LO3BKG, 
            strm.LO3DEFACTION, 
            strm.LO3PCT, 
            strm.LO3PROCESS, 
            strm.LO3TXT, 
            strm.MARKREREAD, 
            strm.METERTYPE, 
            strm.MODBY, 
            strm.MODDTTM, 
            strm.NEGUSGBKG, 
            strm.NEGUSGDEFACTION, 
            strm.NEGUSGPROCESS, 
            strm.NEGUSGTXT, 
            strm.NOACCTBKG, 
            strm.NOACCTDEFACTION, 
            strm.NOACCTPROCESS, 
            strm.NOACCTTXT, 
            strm.NORDBKG, 
            strm.NORDDEFACTION, 
            strm.NORMALPROCESS, 
            strm.NOUSGBKG, 
            strm.NOUSGDEFACTION, 
            strm.NOUSGPROCESS, 
            strm.NOUSGTXT, 
            strm.PRESELECTACCTFORBILL, 
            strm.RDPROBKEY, 
            strm.RDREVIEWSUKEY, 
            strm.UPONADDIREADAPPROVAL, 
            strm.UPONCYREADAPPROVAL, 
            strm.VARIATION_ID, 
            strm.ETL_SEQUENCE_NUMBER,
            strm.ETL_DELETED,
            strm.etl_load_datetime,
            strm.etl_load_metadatafilename,
            ROW_NUMBER() OVER (PARTITION BY 
            strm.RDREVIEWSUKEY ORDER BY strm.ETL_SEQUENCE_NUMBER desc,IFNULL(TRY_TO_TIMESTAMP(replace(right(replace(lower(etl_load_metadatafilename),'.json'),23),'_','-'), 'yyyy-mm-dd-HH-MI-SS-FF') ,etl_load_datetime) desc) as ROWNUMBER
        FROM DATAHUB_INTEGRATION.VW_STREAM_IPS_METERMANAGEMENT_WATER_READINGREVIEWSETUP as  strm
        WHERE strm.ETL_DELETED=TRUE
                    )   
            WHERE ROWNUMBER=1  
            
                    ) as src on
            ((target.RDREVIEWSUKEY=src.RDREVIEWSUKEY) OR (target.RDREVIEWSUKEY IS NULL AND src.RDREVIEWSUKEY IS NULL)) 
                when matched then update set
                    target.ADDBY=src.ADDBY, 
                    target.ADDDTTM=src.ADDDTTM, 
                    target.CNCLREREADRESCODE=src.CNCLREREADRESCODE, 
                    target.DAYSFORCURRD=src.DAYSFORCURRD, 
                    target.DELETED=src.DELETED, 
                    target.ESTBKG=src.ESTBKG, 
                    target.ESTTXT=src.ESTTXT, 
                    target.HI1BKG=src.HI1BKG, 
                    target.HI1DEFACTION=src.HI1DEFACTION, 
                    target.HI1PCT=src.HI1PCT, 
                    target.HI1PROCESS=src.HI1PROCESS, 
                    target.HI1TXT=src.HI1TXT, 
                    target.HI2BKG=src.HI2BKG, 
                    target.HI2DEFACTION=src.HI2DEFACTION, 
                    target.HI2PCT=src.HI2PCT, 
                    target.HI2PROCESS=src.HI2PROCESS, 
                    target.HI2TXT=src.HI2TXT, 
                    target.HI3BKG=src.HI3BKG, 
                    target.HI3DEFACTION=src.HI3DEFACTION, 
                    target.HI3PCT=src.HI3PCT, 
                    target.HI3PROCESS=src.HI3PROCESS, 
                    target.HI3TXT=src.HI3TXT, 
                    target.LO1BKG=src.LO1BKG, 
                    target.LO1DEFACTION=src.LO1DEFACTION, 
                    target.LO1PCT=src.LO1PCT, 
                    target.LO1PROCESS=src.LO1PROCESS, 
                    target.LO1TXT=src.LO1TXT, 
                    target.LO2BKG=src.LO2BKG, 
                    target.LO2DEFACTION=src.LO2DEFACTION, 
                    target.LO2PCT=src.LO2PCT, 
                    target.LO2PROCESS=src.LO2PROCESS, 
                    target.LO2TXT=src.LO2TXT, 
                    target.LO3BKG=src.LO3BKG, 
                    target.LO3DEFACTION=src.LO3DEFACTION, 
                    target.LO3PCT=src.LO3PCT, 
                    target.LO3PROCESS=src.LO3PROCESS, 
                    target.LO3TXT=src.LO3TXT, 
                    target.MARKREREAD=src.MARKREREAD, 
                    target.METERTYPE=src.METERTYPE, 
                    target.MODBY=src.MODBY, 
                    target.MODDTTM=src.MODDTTM, 
                    target.NEGUSGBKG=src.NEGUSGBKG, 
                    target.NEGUSGDEFACTION=src.NEGUSGDEFACTION, 
                    target.NEGUSGPROCESS=src.NEGUSGPROCESS, 
                    target.NEGUSGTXT=src.NEGUSGTXT, 
                    target.NOACCTBKG=src.NOACCTBKG, 
                    target.NOACCTDEFACTION=src.NOACCTDEFACTION, 
                    target.NOACCTPROCESS=src.NOACCTPROCESS, 
                    target.NOACCTTXT=src.NOACCTTXT, 
                    target.NORDBKG=src.NORDBKG, 
                    target.NORDDEFACTION=src.NORDDEFACTION, 
                    target.NORMALPROCESS=src.NORMALPROCESS, 
                    target.NOUSGBKG=src.NOUSGBKG, 
                    target.NOUSGDEFACTION=src.NOUSGDEFACTION, 
                    target.NOUSGPROCESS=src.NOUSGPROCESS, 
                    target.NOUSGTXT=src.NOUSGTXT, 
                    target.PRESELECTACCTFORBILL=src.PRESELECTACCTFORBILL, 
                    target.RDPROBKEY=src.RDPROBKEY, 
                    target.RDREVIEWSUKEY=src.RDREVIEWSUKEY, 
                    target.UPONADDIREADAPPROVAL=src.UPONADDIREADAPPROVAL, 
                    target.UPONCYREADAPPROVAL=src.UPONCYREADAPPROVAL, 
                    target.VARIATION_ID=src.VARIATION_ID, 
                    target.ETL_SEQUENCE_NUMBER=src.ETL_SEQUENCE_NUMBER,
                    target.etl_load_datetime=CURRENT_TIMESTAMP,
                    target.etl_load_metadatafilename=src.etl_load_metadatafilename,
                    target.ETL_DELETED=src.ETL_DELETED
        when not matched   then insert ( ADDBY, ADDDTTM, CNCLREREADRESCODE, DAYSFORCURRD, DELETED, ESTBKG, ESTTXT, HI1BKG, HI1DEFACTION, HI1PCT, HI1PROCESS, HI1TXT, HI2BKG, HI2DEFACTION, HI2PCT, HI2PROCESS, HI2TXT, HI3BKG, HI3DEFACTION, HI3PCT, HI3PROCESS, HI3TXT, LO1BKG, LO1DEFACTION, LO1PCT, LO1PROCESS, LO1TXT, LO2BKG, LO2DEFACTION, LO2PCT, LO2PROCESS, LO2TXT, LO3BKG, LO3DEFACTION, LO3PCT, LO3PROCESS, LO3TXT, MARKREREAD, METERTYPE, MODBY, MODDTTM, NEGUSGBKG, NEGUSGDEFACTION, NEGUSGPROCESS, NEGUSGTXT, NOACCTBKG, NOACCTDEFACTION, NOACCTPROCESS, NOACCTTXT, NORDBKG, NORDDEFACTION, NORMALPROCESS, NOUSGBKG, NOUSGDEFACTION, NOUSGPROCESS, NOUSGTXT, PRESELECTACCTFORBILL, RDPROBKEY, RDREVIEWSUKEY, UPONADDIREADAPPROVAL, UPONCYREADAPPROVAL, VARIATION_ID, 
                    ETL_SEQUENCE_NUMBER,                       
                    etl_load_datetime,
                    etl_load_metadatafilename,
                    etl_is_deleted,
                    ETL_DELETED) 
            values (
                    src.ADDBY, 
                    src.ADDDTTM, 
                    src.CNCLREREADRESCODE, 
                    src.DAYSFORCURRD, 
                    src.DELETED, 
                    src.ESTBKG, 
                    src.ESTTXT, 
                    src.HI1BKG, 
                    src.HI1DEFACTION, 
                    src.HI1PCT, 
                    src.HI1PROCESS, 
                    src.HI1TXT, 
                    src.HI2BKG, 
                    src.HI2DEFACTION, 
                    src.HI2PCT, 
                    src.HI2PROCESS, 
                    src.HI2TXT, 
                    src.HI3BKG, 
                    src.HI3DEFACTION, 
                    src.HI3PCT, 
                    src.HI3PROCESS, 
                    src.HI3TXT, 
                    src.LO1BKG, 
                    src.LO1DEFACTION, 
                    src.LO1PCT, 
                    src.LO1PROCESS, 
                    src.LO1TXT, 
                    src.LO2BKG, 
                    src.LO2DEFACTION, 
                    src.LO2PCT, 
                    src.LO2PROCESS, 
                    src.LO2TXT, 
                    src.LO3BKG, 
                    src.LO3DEFACTION, 
                    src.LO3PCT, 
                    src.LO3PROCESS, 
                    src.LO3TXT, 
                    src.MARKREREAD, 
                    src.METERTYPE, 
                    src.MODBY, 
                    src.MODDTTM, 
                    src.NEGUSGBKG, 
                    src.NEGUSGDEFACTION, 
                    src.NEGUSGPROCESS, 
                    src.NEGUSGTXT, 
                    src.NOACCTBKG, 
                    src.NOACCTDEFACTION, 
                    src.NOACCTPROCESS, 
                    src.NOACCTTXT, 
                    src.NORDBKG, 
                    src.NORDDEFACTION, 
                    src.NORMALPROCESS, 
                    src.NOUSGBKG, 
                    src.NOUSGDEFACTION, 
                    src.NOUSGPROCESS, 
                    src.NOUSGTXT, 
                    src.PRESELECTACCTFORBILL, 
                    src.RDPROBKEY, 
                    src.RDREVIEWSUKEY, 
                    src.UPONADDIREADAPPROVAL, 
                    src.UPONCYREADAPPROVAL, 
                    src.VARIATION_ID,     
                    src.ETL_SEQUENCE_NUMBER,
                    CURRENT_TIMESTAMP,
                    src.etl_load_metadatafilename,
                    case when ETL_DELETED=TRUE then TRUE else FALSE end,
                    ETL_DELETED);
    `
} );

                    
//  Get number of rows inserted
        
        var sqlStmt = snowflake.createStatement( {sqlText:  sql_command} );
        var rs = sqlStmt.execute();
        var number_of_rows_inserted = sqlStmt.getNumRowsInserted();
        var number_of_rows_updated =  sqlStmt.getNumRowsUpdated();
                    

        
    snowflake.execute ({sqlText: "commit"});

    log_sql_command = "call datahub_logging.sp_etl_log_ingestion_process('UpdateEnd','" + process_name + "','Success','Completed process execution.', 0 ," + number_of_rows_inserted.toString()+ "," +  number_of_rows_updated.toString() + ");";
    snowflake.execute({sqlText: log_sql_command});

    result = "Success"; 

    }       

    catch (err)  {
        snowflake.execute( {sqlText: "rollback;"} )
        var clean_error_msg = err.message.replace(/[^\w\s]/gi, '');
    //  Create a log entry to say INSERT STATEMENT failed
    
    log_sql_command = "call datahub_logging.sp_etl_log_ingestion_process('UpdateEnd','" + process_name + "','Failed','MERGE Failed. Error:" + err.code.toString()+" : "+ clean_error_msg  + "', 0 ,0,0);";
    snowflake.execute({sqlText: log_sql_command});
        ;
        throw "Failed: " + err.message;   // Return a success/error indicator.
        }
    return result;
    $$;