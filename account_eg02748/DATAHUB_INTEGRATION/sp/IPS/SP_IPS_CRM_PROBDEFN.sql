create or replace procedure DATAHUB_INTEGRATION.SP_IPS_CRM_PROBDEFN()
    returns varchar not null
                language javascript
                as
                $$

//  Variables

var result = "";                                    // return status of this proc call
const process_name = Object.keys(this)[0];          // name of currently executing process
var number_of_rows_inserted = 0;                             // track number of rows we have inserted
var number_of_rows_updated = 0;                             // track number of rows we have updated


//  Step 1.

//  Start execution - log start

log_sql_command = "call datahub_logging.sp_etl_log_ingestion_process('Insert','" + process_name + "','Running','Started process execution.', 0,0,0);";
snowflake.execute({sqlText: log_sql_command});

snowflake.execute( {sqlText: "begin transaction;"} );
try
    {
        var sql_command = `
                            INSERT INTO LANDING_ERROR.IPS_RAW_ERROR
                            SELECT * FROM LANDING_ERROR.VW_STREAM_IPS_CRM_PROBDEFN_ERROR`;
    var sqlStmt = snowflake.createStatement( {sqlText:  sql_command} );
    var rs = sqlStmt.execute();
        
        var sql_command = ` 
                            merge into  DATAHUB_TARGET.IPS_CRM_PROBDEFN as target using (SELECT * FROM (SELECT 
            strm.ACCTFLAG, 
            strm.ADDBY, 
            strm.ADDDTTM, 
            strm.ADDRREQD, 
            strm.ALLOWASSETINSP, 
            strm.ALLOWCASE, 
            strm.ALLOWOOC, 
            strm.ALLOWWORKORDER, 
            strm.ASSETINSPTYPE, 
            strm.ASSETREQD, 
            strm.ASSETTYPE, 
            strm.ASSIGNNOTICE, 
            strm.AUTORES, 
            strm.CALLERFLG, 
            strm.CASERES, 
            strm.CASETYPE, 
            strm.CATEGORY, 
            strm.CHECKDUPLICATELOCALONLY, 
            strm.CHKDUPFLG, 
            strm.CORRPROCESSSETUP, 
            strm.CREATEDINLASTXMIN, 
            strm.CUSTFLAG, 
            strm.DATALAKE_DELETED, 
            strm.DETAILPAGE, 
            strm.DPDESC, 
            strm.EFFDATE, 
            strm.EXPDATE, 
            strm.FLLWBYBUS, 
            strm.GISICON, 
            strm.HOLIDAY, 
            strm.HOWTOCREATECASE, 
            strm.HOWTOCREATEINSP, 
            strm.HOWTOCREATEOOC, 
            strm.HOWTOCREATEWO, 
            strm.INCLACCTNUMINOOC, 
            strm.INCLADDRINCASE, 
            strm.INCLADDRINWO, 
            strm.INCLASSETININSP, 
            strm.INCLASSETINWO, 
            strm.INCLCOMMENTSINCASE, 
            strm.INCLCOMMENTSININSP, 
            strm.INCLCOMMENTSINOOC, 
            strm.INCLCOMMENTSINWO, 
            strm.INCLCONTACTINCASE, 
            strm.INCLCONTACTINWO, 
            strm.INCLLOCINCASE, 
            strm.INCLLOCINWO, 
            strm.INSPCTRTY, 
            strm.INSPDAYS, 
            strm.INSPECTNOTICE, 
            strm.INSPECTORNOTICE, 
            strm.INSPHRS, 
            strm.INSPMINS, 
            strm.INSPRES, 
            strm.ISPUBLIC, 
            strm.LOGGEDPERSONNOTICE, 
            strm.METERRESCODE, 
            strm.METERSERVSTAT, 
            strm.MODBY, 
            strm.MODDTTM, 
            strm.NOTIFYCUSTOMER, 
            strm.OOCRES, 
            strm.OOCTYPE, 
            strm.OVERRIDEGLOBALSETTINGFLG, 
            strm.POOLKEY, 
            strm.PORTALDESCRIPTION, 
            strm.PORTALSEARCHKEYWORDS, 
            strm.PRI, 
            strm.PRNUSGHIST, 
            strm.PROBCODE, 
            strm.PROBDESC, 
            strm.PROBGRP, 
            strm.PROBKEY, 
            strm.PROJECT, 
            strm.RESDAYS, 
            strm.RESHRS, 
            strm.RESOLVENOTICE, 
            strm.RESP, 
            strm.SAMEREQUESTTYPEFLG, 
            strm.SCHEDDAYS, 
            strm.SCHEDHRS, 
            strm.SCHEDNOTICE, 
            strm.SEARCHRADIUS, 
            strm.SERVREQASSETTYPE, 
            strm.SHOWINBILLPORTAL, 
            strm.SHOWINPORTAL, 
            strm.SHOWUSAGEDETAILS, 
            strm.STANDARDWORKORDERKEY, 
            strm.STARTDAYS, 
            strm.STARTHRS, 
            strm.STDRES, 
            strm.SUBMITINBILLPORTAL, 
            strm.SUBMITINPORTAL, 
            strm.SUBMITINPORTALPUBLIC, 
            strm.SUSPDAYS, 
            strm.SUSPHRS, 
            strm.VARIATION_ID, 
            strm.WEEKDAY, 
            strm.WEEKEND, 
            strm.WHENTOCREATECASE, 
            strm.WHENTOCREATEINSP, 
            strm.WHENTOCREATEOOC, 
            strm.WHENTOCREATEWO, 
            strm.WOACTIVITY, 
            strm.WORES, 
            strm.ETL_SEQUENCE_NUMBER,
            strm.ETL_DELETED,
            strm.etl_load_datetime,
            strm.etl_load_metadatafilename,
            ROW_NUMBER() OVER (PARTITION BY 
            strm.PROBKEY ORDER BY strm.ETL_SEQUENCE_NUMBER desc,IFNULL(TRY_TO_TIMESTAMP(replace(right(replace(lower(etl_load_metadatafilename),'.json'),23),'_','-'), 'yyyy-mm-dd-HH-MI-SS-FF') ,etl_load_datetime) desc) as ROWNUMBER
        FROM DATAHUB_INTEGRATION.VW_STREAM_IPS_CRM_PROBDEFN as  strm
                    )   
            WHERE ROWNUMBER=1  
            
                    ) as src on
            ((target.PROBKEY=src.PROBKEY) OR (target.PROBKEY IS NULL AND src.PROBKEY IS NULL)) 
                when matched and src.ETL_DELETED=TRUE THEN DELETE
                when matched then update set
                    target.ACCTFLAG=src.ACCTFLAG, 
                    target.ADDBY=src.ADDBY, 
                    target.ADDDTTM=src.ADDDTTM, 
                    target.ADDRREQD=src.ADDRREQD, 
                    target.ALLOWASSETINSP=src.ALLOWASSETINSP, 
                    target.ALLOWCASE=src.ALLOWCASE, 
                    target.ALLOWOOC=src.ALLOWOOC, 
                    target.ALLOWWORKORDER=src.ALLOWWORKORDER, 
                    target.ASSETINSPTYPE=src.ASSETINSPTYPE, 
                    target.ASSETREQD=src.ASSETREQD, 
                    target.ASSETTYPE=src.ASSETTYPE, 
                    target.ASSIGNNOTICE=src.ASSIGNNOTICE, 
                    target.AUTORES=src.AUTORES, 
                    target.CALLERFLG=src.CALLERFLG, 
                    target.CASERES=src.CASERES, 
                    target.CASETYPE=src.CASETYPE, 
                    target.CATEGORY=src.CATEGORY, 
                    target.CHECKDUPLICATELOCALONLY=src.CHECKDUPLICATELOCALONLY, 
                    target.CHKDUPFLG=src.CHKDUPFLG, 
                    target.CORRPROCESSSETUP=src.CORRPROCESSSETUP, 
                    target.CREATEDINLASTXMIN=src.CREATEDINLASTXMIN, 
                    target.CUSTFLAG=src.CUSTFLAG, 
                    target.DATALAKE_DELETED=src.DATALAKE_DELETED, 
                    target.DETAILPAGE=src.DETAILPAGE, 
                    target.DPDESC=src.DPDESC, 
                    target.EFFDATE=src.EFFDATE, 
                    target.EXPDATE=src.EXPDATE, 
                    target.FLLWBYBUS=src.FLLWBYBUS, 
                    target.GISICON=src.GISICON, 
                    target.HOLIDAY=src.HOLIDAY, 
                    target.HOWTOCREATECASE=src.HOWTOCREATECASE, 
                    target.HOWTOCREATEINSP=src.HOWTOCREATEINSP, 
                    target.HOWTOCREATEOOC=src.HOWTOCREATEOOC, 
                    target.HOWTOCREATEWO=src.HOWTOCREATEWO, 
                    target.INCLACCTNUMINOOC=src.INCLACCTNUMINOOC, 
                    target.INCLADDRINCASE=src.INCLADDRINCASE, 
                    target.INCLADDRINWO=src.INCLADDRINWO, 
                    target.INCLASSETININSP=src.INCLASSETININSP, 
                    target.INCLASSETINWO=src.INCLASSETINWO, 
                    target.INCLCOMMENTSINCASE=src.INCLCOMMENTSINCASE, 
                    target.INCLCOMMENTSININSP=src.INCLCOMMENTSININSP, 
                    target.INCLCOMMENTSINOOC=src.INCLCOMMENTSINOOC, 
                    target.INCLCOMMENTSINWO=src.INCLCOMMENTSINWO, 
                    target.INCLCONTACTINCASE=src.INCLCONTACTINCASE, 
                    target.INCLCONTACTINWO=src.INCLCONTACTINWO, 
                    target.INCLLOCINCASE=src.INCLLOCINCASE, 
                    target.INCLLOCINWO=src.INCLLOCINWO, 
                    target.INSPCTRTY=src.INSPCTRTY, 
                    target.INSPDAYS=src.INSPDAYS, 
                    target.INSPECTNOTICE=src.INSPECTNOTICE, 
                    target.INSPECTORNOTICE=src.INSPECTORNOTICE, 
                    target.INSPHRS=src.INSPHRS, 
                    target.INSPMINS=src.INSPMINS, 
                    target.INSPRES=src.INSPRES, 
                    target.ISPUBLIC=src.ISPUBLIC, 
                    target.LOGGEDPERSONNOTICE=src.LOGGEDPERSONNOTICE, 
                    target.METERRESCODE=src.METERRESCODE, 
                    target.METERSERVSTAT=src.METERSERVSTAT, 
                    target.MODBY=src.MODBY, 
                    target.MODDTTM=src.MODDTTM, 
                    target.NOTIFYCUSTOMER=src.NOTIFYCUSTOMER, 
                    target.OOCRES=src.OOCRES, 
                    target.OOCTYPE=src.OOCTYPE, 
                    target.OVERRIDEGLOBALSETTINGFLG=src.OVERRIDEGLOBALSETTINGFLG, 
                    target.POOLKEY=src.POOLKEY, 
                    target.PORTALDESCRIPTION=src.PORTALDESCRIPTION, 
                    target.PORTALSEARCHKEYWORDS=src.PORTALSEARCHKEYWORDS, 
                    target.PRI=src.PRI, 
                    target.PRNUSGHIST=src.PRNUSGHIST, 
                    target.PROBCODE=src.PROBCODE, 
                    target.PROBDESC=src.PROBDESC, 
                    target.PROBGRP=src.PROBGRP, 
                    target.PROBKEY=src.PROBKEY, 
                    target.PROJECT=src.PROJECT, 
                    target.RESDAYS=src.RESDAYS, 
                    target.RESHRS=src.RESHRS, 
                    target.RESOLVENOTICE=src.RESOLVENOTICE, 
                    target.RESP=src.RESP, 
                    target.SAMEREQUESTTYPEFLG=src.SAMEREQUESTTYPEFLG, 
                    target.SCHEDDAYS=src.SCHEDDAYS, 
                    target.SCHEDHRS=src.SCHEDHRS, 
                    target.SCHEDNOTICE=src.SCHEDNOTICE, 
                    target.SEARCHRADIUS=src.SEARCHRADIUS, 
                    target.SERVREQASSETTYPE=src.SERVREQASSETTYPE, 
                    target.SHOWINBILLPORTAL=src.SHOWINBILLPORTAL, 
                    target.SHOWINPORTAL=src.SHOWINPORTAL, 
                    target.SHOWUSAGEDETAILS=src.SHOWUSAGEDETAILS, 
                    target.STANDARDWORKORDERKEY=src.STANDARDWORKORDERKEY, 
                    target.STARTDAYS=src.STARTDAYS, 
                    target.STARTHRS=src.STARTHRS, 
                    target.STDRES=src.STDRES, 
                    target.SUBMITINBILLPORTAL=src.SUBMITINBILLPORTAL, 
                    target.SUBMITINPORTAL=src.SUBMITINPORTAL, 
                    target.SUBMITINPORTALPUBLIC=src.SUBMITINPORTALPUBLIC, 
                    target.SUSPDAYS=src.SUSPDAYS, 
                    target.SUSPHRS=src.SUSPHRS, 
                    target.VARIATION_ID=src.VARIATION_ID, 
                    target.WEEKDAY=src.WEEKDAY, 
                    target.WEEKEND=src.WEEKEND, 
                    target.WHENTOCREATECASE=src.WHENTOCREATECASE, 
                    target.WHENTOCREATEINSP=src.WHENTOCREATEINSP, 
                    target.WHENTOCREATEOOC=src.WHENTOCREATEOOC, 
                    target.WHENTOCREATEWO=src.WHENTOCREATEWO, 
                    target.WOACTIVITY=src.WOACTIVITY, 
                    target.WORES=src.WORES, 
                    target.ETL_SEQUENCE_NUMBER=src.ETL_SEQUENCE_NUMBER,
                    target.etl_load_datetime=CURRENT_TIMESTAMP,
                    target.etl_load_metadatafilename=src.etl_load_metadatafilename
        when not matched and (src.ETL_DELETED=FALSE OR src.ETL_DELETED IS NULL)  then insert ( 
                    ACCTFLAG, 
                    ADDBY, 
                    ADDDTTM, 
                    ADDRREQD, 
                    ALLOWASSETINSP, 
                    ALLOWCASE, 
                    ALLOWOOC, 
                    ALLOWWORKORDER, 
                    ASSETINSPTYPE, 
                    ASSETREQD, 
                    ASSETTYPE, 
                    ASSIGNNOTICE, 
                    AUTORES, 
                    CALLERFLG, 
                    CASERES, 
                    CASETYPE, 
                    CATEGORY, 
                    CHECKDUPLICATELOCALONLY, 
                    CHKDUPFLG, 
                    CORRPROCESSSETUP, 
                    CREATEDINLASTXMIN, 
                    CUSTFLAG, 
                    DATALAKE_DELETED, 
                    DETAILPAGE, 
                    DPDESC, 
                    EFFDATE, 
                    EXPDATE, 
                    FLLWBYBUS, 
                    GISICON, 
                    HOLIDAY, 
                    HOWTOCREATECASE, 
                    HOWTOCREATEINSP, 
                    HOWTOCREATEOOC, 
                    HOWTOCREATEWO, 
                    INCLACCTNUMINOOC, 
                    INCLADDRINCASE, 
                    INCLADDRINWO, 
                    INCLASSETININSP, 
                    INCLASSETINWO, 
                    INCLCOMMENTSINCASE, 
                    INCLCOMMENTSININSP, 
                    INCLCOMMENTSINOOC, 
                    INCLCOMMENTSINWO, 
                    INCLCONTACTINCASE, 
                    INCLCONTACTINWO, 
                    INCLLOCINCASE, 
                    INCLLOCINWO, 
                    INSPCTRTY, 
                    INSPDAYS, 
                    INSPECTNOTICE, 
                    INSPECTORNOTICE, 
                    INSPHRS, 
                    INSPMINS, 
                    INSPRES, 
                    ISPUBLIC, 
                    LOGGEDPERSONNOTICE, 
                    METERRESCODE, 
                    METERSERVSTAT, 
                    MODBY, 
                    MODDTTM, 
                    NOTIFYCUSTOMER, 
                    OOCRES, 
                    OOCTYPE, 
                    OVERRIDEGLOBALSETTINGFLG, 
                    POOLKEY, 
                    PORTALDESCRIPTION, 
                    PORTALSEARCHKEYWORDS, 
                    PRI, 
                    PRNUSGHIST, 
                    PROBCODE, 
                    PROBDESC, 
                    PROBGRP, 
                    PROBKEY, 
                    PROJECT, 
                    RESDAYS, 
                    RESHRS, 
                    RESOLVENOTICE, 
                    RESP, 
                    SAMEREQUESTTYPEFLG, 
                    SCHEDDAYS, 
                    SCHEDHRS, 
                    SCHEDNOTICE, 
                    SEARCHRADIUS, 
                    SERVREQASSETTYPE, 
                    SHOWINBILLPORTAL, 
                    SHOWINPORTAL, 
                    SHOWUSAGEDETAILS, 
                    STANDARDWORKORDERKEY, 
                    STARTDAYS, 
                    STARTHRS, 
                    STDRES, 
                    SUBMITINBILLPORTAL, 
                    SUBMITINPORTAL, 
                    SUBMITINPORTALPUBLIC, 
                    SUSPDAYS, 
                    SUSPHRS, 
                    VARIATION_ID, 
                    WEEKDAY, 
                    WEEKEND, 
                    WHENTOCREATECASE, 
                    WHENTOCREATEINSP, 
                    WHENTOCREATEOOC, 
                    WHENTOCREATEWO, 
                    WOACTIVITY, 
                    WORES, 
                    ETL_SEQUENCE_NUMBER,                       
                    etl_load_datetime,
                    etl_load_metadatafilename) 
            values (
                    src.ACCTFLAG, 
                    src.ADDBY, 
                    src.ADDDTTM, 
                    src.ADDRREQD, 
                    src.ALLOWASSETINSP, 
                    src.ALLOWCASE, 
                    src.ALLOWOOC, 
                    src.ALLOWWORKORDER, 
                    src.ASSETINSPTYPE, 
                    src.ASSETREQD, 
                    src.ASSETTYPE, 
                    src.ASSIGNNOTICE, 
                    src.AUTORES, 
                    src.CALLERFLG, 
                    src.CASERES, 
                    src.CASETYPE, 
                    src.CATEGORY, 
                    src.CHECKDUPLICATELOCALONLY, 
                    src.CHKDUPFLG, 
                    src.CORRPROCESSSETUP, 
                    src.CREATEDINLASTXMIN, 
                    src.CUSTFLAG, 
                    src.DATALAKE_DELETED, 
                    src.DETAILPAGE, 
                    src.DPDESC, 
                    src.EFFDATE, 
                    src.EXPDATE, 
                    src.FLLWBYBUS, 
                    src.GISICON, 
                    src.HOLIDAY, 
                    src.HOWTOCREATECASE, 
                    src.HOWTOCREATEINSP, 
                    src.HOWTOCREATEOOC, 
                    src.HOWTOCREATEWO, 
                    src.INCLACCTNUMINOOC, 
                    src.INCLADDRINCASE, 
                    src.INCLADDRINWO, 
                    src.INCLASSETININSP, 
                    src.INCLASSETINWO, 
                    src.INCLCOMMENTSINCASE, 
                    src.INCLCOMMENTSININSP, 
                    src.INCLCOMMENTSINOOC, 
                    src.INCLCOMMENTSINWO, 
                    src.INCLCONTACTINCASE, 
                    src.INCLCONTACTINWO, 
                    src.INCLLOCINCASE, 
                    src.INCLLOCINWO, 
                    src.INSPCTRTY, 
                    src.INSPDAYS, 
                    src.INSPECTNOTICE, 
                    src.INSPECTORNOTICE, 
                    src.INSPHRS, 
                    src.INSPMINS, 
                    src.INSPRES, 
                    src.ISPUBLIC, 
                    src.LOGGEDPERSONNOTICE, 
                    src.METERRESCODE, 
                    src.METERSERVSTAT, 
                    src.MODBY, 
                    src.MODDTTM, 
                    src.NOTIFYCUSTOMER, 
                    src.OOCRES, 
                    src.OOCTYPE, 
                    src.OVERRIDEGLOBALSETTINGFLG, 
                    src.POOLKEY, 
                    src.PORTALDESCRIPTION, 
                    src.PORTALSEARCHKEYWORDS, 
                    src.PRI, 
                    src.PRNUSGHIST, 
                    src.PROBCODE, 
                    src.PROBDESC, 
                    src.PROBGRP, 
                    src.PROBKEY, 
                    src.PROJECT, 
                    src.RESDAYS, 
                    src.RESHRS, 
                    src.RESOLVENOTICE, 
                    src.RESP, 
                    src.SAMEREQUESTTYPEFLG, 
                    src.SCHEDDAYS, 
                    src.SCHEDHRS, 
                    src.SCHEDNOTICE, 
                    src.SEARCHRADIUS, 
                    src.SERVREQASSETTYPE, 
                    src.SHOWINBILLPORTAL, 
                    src.SHOWINPORTAL, 
                    src.SHOWUSAGEDETAILS, 
                    src.STANDARDWORKORDERKEY, 
                    src.STARTDAYS, 
                    src.STARTHRS, 
                    src.STDRES, 
                    src.SUBMITINBILLPORTAL, 
                    src.SUBMITINPORTAL, 
                    src.SUBMITINPORTALPUBLIC, 
                    src.SUSPDAYS, 
                    src.SUSPHRS, 
                    src.VARIATION_ID, 
                    src.WEEKDAY, 
                    src.WEEKEND, 
                    src.WHENTOCREATECASE, 
                    src.WHENTOCREATEINSP, 
                    src.WHENTOCREATEOOC, 
                    src.WHENTOCREATEWO, 
                    src.WOACTIVITY, 
                    src.WORES,     
                    src.ETL_SEQUENCE_NUMBER,
                    CURRENT_TIMESTAMP,
                    src.etl_load_metadatafilename);`;

    var sqlStmt = snowflake.createStatement( {sqlText:  sql_command} );
    var rs = sqlStmt.execute();

    snowflake.execute( {sqlText: `merge into DATAHUB_TARGET_HISTORY.IPS_DELETED_CRM_PROBDEFN as target using (
                SELECT * FROM (SELECT 
            strm.ACCTFLAG, 
            strm.ADDBY, 
            strm.ADDDTTM, 
            strm.ADDRREQD, 
            strm.ALLOWASSETINSP, 
            strm.ALLOWCASE, 
            strm.ALLOWOOC, 
            strm.ALLOWWORKORDER, 
            strm.ASSETINSPTYPE, 
            strm.ASSETREQD, 
            strm.ASSETTYPE, 
            strm.ASSIGNNOTICE, 
            strm.AUTORES, 
            strm.CALLERFLG, 
            strm.CASERES, 
            strm.CASETYPE, 
            strm.CATEGORY, 
            strm.CHECKDUPLICATELOCALONLY, 
            strm.CHKDUPFLG, 
            strm.CORRPROCESSSETUP, 
            strm.CREATEDINLASTXMIN, 
            strm.CUSTFLAG, 
            strm.DATALAKE_DELETED, 
            strm.DETAILPAGE, 
            strm.DPDESC, 
            strm.EFFDATE, 
            strm.EXPDATE, 
            strm.FLLWBYBUS, 
            strm.GISICON, 
            strm.HOLIDAY, 
            strm.HOWTOCREATECASE, 
            strm.HOWTOCREATEINSP, 
            strm.HOWTOCREATEOOC, 
            strm.HOWTOCREATEWO, 
            strm.INCLACCTNUMINOOC, 
            strm.INCLADDRINCASE, 
            strm.INCLADDRINWO, 
            strm.INCLASSETININSP, 
            strm.INCLASSETINWO, 
            strm.INCLCOMMENTSINCASE, 
            strm.INCLCOMMENTSININSP, 
            strm.INCLCOMMENTSINOOC, 
            strm.INCLCOMMENTSINWO, 
            strm.INCLCONTACTINCASE, 
            strm.INCLCONTACTINWO, 
            strm.INCLLOCINCASE, 
            strm.INCLLOCINWO, 
            strm.INSPCTRTY, 
            strm.INSPDAYS, 
            strm.INSPECTNOTICE, 
            strm.INSPECTORNOTICE, 
            strm.INSPHRS, 
            strm.INSPMINS, 
            strm.INSPRES, 
            strm.ISPUBLIC, 
            strm.LOGGEDPERSONNOTICE, 
            strm.METERRESCODE, 
            strm.METERSERVSTAT, 
            strm.MODBY, 
            strm.MODDTTM, 
            strm.NOTIFYCUSTOMER, 
            strm.OOCRES, 
            strm.OOCTYPE, 
            strm.OVERRIDEGLOBALSETTINGFLG, 
            strm.POOLKEY, 
            strm.PORTALDESCRIPTION, 
            strm.PORTALSEARCHKEYWORDS, 
            strm.PRI, 
            strm.PRNUSGHIST, 
            strm.PROBCODE, 
            strm.PROBDESC, 
            strm.PROBGRP, 
            strm.PROBKEY, 
            strm.PROJECT, 
            strm.RESDAYS, 
            strm.RESHRS, 
            strm.RESOLVENOTICE, 
            strm.RESP, 
            strm.SAMEREQUESTTYPEFLG, 
            strm.SCHEDDAYS, 
            strm.SCHEDHRS, 
            strm.SCHEDNOTICE, 
            strm.SEARCHRADIUS, 
            strm.SERVREQASSETTYPE, 
            strm.SHOWINBILLPORTAL, 
            strm.SHOWINPORTAL, 
            strm.SHOWUSAGEDETAILS, 
            strm.STANDARDWORKORDERKEY, 
            strm.STARTDAYS, 
            strm.STARTHRS, 
            strm.STDRES, 
            strm.SUBMITINBILLPORTAL, 
            strm.SUBMITINPORTAL, 
            strm.SUBMITINPORTALPUBLIC, 
            strm.SUSPDAYS, 
            strm.SUSPHRS, 
            strm.VARIATION_ID, 
            strm.WEEKDAY, 
            strm.WEEKEND, 
            strm.WHENTOCREATECASE, 
            strm.WHENTOCREATEINSP, 
            strm.WHENTOCREATEOOC, 
            strm.WHENTOCREATEWO, 
            strm.WOACTIVITY, 
            strm.WORES, 
            strm.ETL_SEQUENCE_NUMBER,
            strm.ETL_DELETED,
            strm.etl_load_datetime,
            strm.etl_load_metadatafilename,
            ROW_NUMBER() OVER (PARTITION BY 
            strm.PROBKEY ORDER BY strm.ETL_SEQUENCE_NUMBER desc,IFNULL(TRY_TO_TIMESTAMP(replace(right(replace(lower(etl_load_metadatafilename),'.json'),23),'_','-'), 'yyyy-mm-dd-HH-MI-SS-FF') ,etl_load_datetime) desc) as ROWNUMBER
        FROM DATAHUB_INTEGRATION.VW_STREAM_IPS_CRM_PROBDEFN as  strm
        WHERE strm.ETL_DELETED=TRUE
                    )   
            WHERE ROWNUMBER=1  
            
                    ) as src on
            ((target.PROBKEY=src.PROBKEY) OR (target.PROBKEY IS NULL AND src.PROBKEY IS NULL)) 
                when matched then update set
                    target.ACCTFLAG=src.ACCTFLAG, 
                    target.ADDBY=src.ADDBY, 
                    target.ADDDTTM=src.ADDDTTM, 
                    target.ADDRREQD=src.ADDRREQD, 
                    target.ALLOWASSETINSP=src.ALLOWASSETINSP, 
                    target.ALLOWCASE=src.ALLOWCASE, 
                    target.ALLOWOOC=src.ALLOWOOC, 
                    target.ALLOWWORKORDER=src.ALLOWWORKORDER, 
                    target.ASSETINSPTYPE=src.ASSETINSPTYPE, 
                    target.ASSETREQD=src.ASSETREQD, 
                    target.ASSETTYPE=src.ASSETTYPE, 
                    target.ASSIGNNOTICE=src.ASSIGNNOTICE, 
                    target.AUTORES=src.AUTORES, 
                    target.CALLERFLG=src.CALLERFLG, 
                    target.CASERES=src.CASERES, 
                    target.CASETYPE=src.CASETYPE, 
                    target.CATEGORY=src.CATEGORY, 
                    target.CHECKDUPLICATELOCALONLY=src.CHECKDUPLICATELOCALONLY, 
                    target.CHKDUPFLG=src.CHKDUPFLG, 
                    target.CORRPROCESSSETUP=src.CORRPROCESSSETUP, 
                    target.CREATEDINLASTXMIN=src.CREATEDINLASTXMIN, 
                    target.CUSTFLAG=src.CUSTFLAG, 
                    target.DATALAKE_DELETED=src.DATALAKE_DELETED, 
                    target.DETAILPAGE=src.DETAILPAGE, 
                    target.DPDESC=src.DPDESC, 
                    target.EFFDATE=src.EFFDATE, 
                    target.EXPDATE=src.EXPDATE, 
                    target.FLLWBYBUS=src.FLLWBYBUS, 
                    target.GISICON=src.GISICON, 
                    target.HOLIDAY=src.HOLIDAY, 
                    target.HOWTOCREATECASE=src.HOWTOCREATECASE, 
                    target.HOWTOCREATEINSP=src.HOWTOCREATEINSP, 
                    target.HOWTOCREATEOOC=src.HOWTOCREATEOOC, 
                    target.HOWTOCREATEWO=src.HOWTOCREATEWO, 
                    target.INCLACCTNUMINOOC=src.INCLACCTNUMINOOC, 
                    target.INCLADDRINCASE=src.INCLADDRINCASE, 
                    target.INCLADDRINWO=src.INCLADDRINWO, 
                    target.INCLASSETININSP=src.INCLASSETININSP, 
                    target.INCLASSETINWO=src.INCLASSETINWO, 
                    target.INCLCOMMENTSINCASE=src.INCLCOMMENTSINCASE, 
                    target.INCLCOMMENTSININSP=src.INCLCOMMENTSININSP, 
                    target.INCLCOMMENTSINOOC=src.INCLCOMMENTSINOOC, 
                    target.INCLCOMMENTSINWO=src.INCLCOMMENTSINWO, 
                    target.INCLCONTACTINCASE=src.INCLCONTACTINCASE, 
                    target.INCLCONTACTINWO=src.INCLCONTACTINWO, 
                    target.INCLLOCINCASE=src.INCLLOCINCASE, 
                    target.INCLLOCINWO=src.INCLLOCINWO, 
                    target.INSPCTRTY=src.INSPCTRTY, 
                    target.INSPDAYS=src.INSPDAYS, 
                    target.INSPECTNOTICE=src.INSPECTNOTICE, 
                    target.INSPECTORNOTICE=src.INSPECTORNOTICE, 
                    target.INSPHRS=src.INSPHRS, 
                    target.INSPMINS=src.INSPMINS, 
                    target.INSPRES=src.INSPRES, 
                    target.ISPUBLIC=src.ISPUBLIC, 
                    target.LOGGEDPERSONNOTICE=src.LOGGEDPERSONNOTICE, 
                    target.METERRESCODE=src.METERRESCODE, 
                    target.METERSERVSTAT=src.METERSERVSTAT, 
                    target.MODBY=src.MODBY, 
                    target.MODDTTM=src.MODDTTM, 
                    target.NOTIFYCUSTOMER=src.NOTIFYCUSTOMER, 
                    target.OOCRES=src.OOCRES, 
                    target.OOCTYPE=src.OOCTYPE, 
                    target.OVERRIDEGLOBALSETTINGFLG=src.OVERRIDEGLOBALSETTINGFLG, 
                    target.POOLKEY=src.POOLKEY, 
                    target.PORTALDESCRIPTION=src.PORTALDESCRIPTION, 
                    target.PORTALSEARCHKEYWORDS=src.PORTALSEARCHKEYWORDS, 
                    target.PRI=src.PRI, 
                    target.PRNUSGHIST=src.PRNUSGHIST, 
                    target.PROBCODE=src.PROBCODE, 
                    target.PROBDESC=src.PROBDESC, 
                    target.PROBGRP=src.PROBGRP, 
                    target.PROBKEY=src.PROBKEY, 
                    target.PROJECT=src.PROJECT, 
                    target.RESDAYS=src.RESDAYS, 
                    target.RESHRS=src.RESHRS, 
                    target.RESOLVENOTICE=src.RESOLVENOTICE, 
                    target.RESP=src.RESP, 
                    target.SAMEREQUESTTYPEFLG=src.SAMEREQUESTTYPEFLG, 
                    target.SCHEDDAYS=src.SCHEDDAYS, 
                    target.SCHEDHRS=src.SCHEDHRS, 
                    target.SCHEDNOTICE=src.SCHEDNOTICE, 
                    target.SEARCHRADIUS=src.SEARCHRADIUS, 
                    target.SERVREQASSETTYPE=src.SERVREQASSETTYPE, 
                    target.SHOWINBILLPORTAL=src.SHOWINBILLPORTAL, 
                    target.SHOWINPORTAL=src.SHOWINPORTAL, 
                    target.SHOWUSAGEDETAILS=src.SHOWUSAGEDETAILS, 
                    target.STANDARDWORKORDERKEY=src.STANDARDWORKORDERKEY, 
                    target.STARTDAYS=src.STARTDAYS, 
                    target.STARTHRS=src.STARTHRS, 
                    target.STDRES=src.STDRES, 
                    target.SUBMITINBILLPORTAL=src.SUBMITINBILLPORTAL, 
                    target.SUBMITINPORTAL=src.SUBMITINPORTAL, 
                    target.SUBMITINPORTALPUBLIC=src.SUBMITINPORTALPUBLIC, 
                    target.SUSPDAYS=src.SUSPDAYS, 
                    target.SUSPHRS=src.SUSPHRS, 
                    target.VARIATION_ID=src.VARIATION_ID, 
                    target.WEEKDAY=src.WEEKDAY, 
                    target.WEEKEND=src.WEEKEND, 
                    target.WHENTOCREATECASE=src.WHENTOCREATECASE, 
                    target.WHENTOCREATEINSP=src.WHENTOCREATEINSP, 
                    target.WHENTOCREATEOOC=src.WHENTOCREATEOOC, 
                    target.WHENTOCREATEWO=src.WHENTOCREATEWO, 
                    target.WOACTIVITY=src.WOACTIVITY, 
                    target.WORES=src.WORES, 
                    target.ETL_SEQUENCE_NUMBER=src.ETL_SEQUENCE_NUMBER,
                    target.etl_load_datetime=CURRENT_TIMESTAMP,
                    target.etl_load_metadatafilename=src.etl_load_metadatafilename,
                    target.ETL_DELETED=src.ETL_DELETED
        when not matched   then insert ( ACCTFLAG, ADDBY, ADDDTTM, ADDRREQD, ALLOWASSETINSP, ALLOWCASE, ALLOWOOC, ALLOWWORKORDER, ASSETINSPTYPE, ASSETREQD, ASSETTYPE, ASSIGNNOTICE, AUTORES, CALLERFLG, CASERES, CASETYPE, CATEGORY, CHECKDUPLICATELOCALONLY, CHKDUPFLG, CORRPROCESSSETUP, CREATEDINLASTXMIN, CUSTFLAG, DATALAKE_DELETED, DETAILPAGE, DPDESC, EFFDATE, EXPDATE, FLLWBYBUS, GISICON, HOLIDAY, HOWTOCREATECASE, HOWTOCREATEINSP, HOWTOCREATEOOC, HOWTOCREATEWO, INCLACCTNUMINOOC, INCLADDRINCASE, INCLADDRINWO, INCLASSETININSP, INCLASSETINWO, INCLCOMMENTSINCASE, INCLCOMMENTSININSP, INCLCOMMENTSINOOC, INCLCOMMENTSINWO, INCLCONTACTINCASE, INCLCONTACTINWO, INCLLOCINCASE, INCLLOCINWO, INSPCTRTY, INSPDAYS, INSPECTNOTICE, INSPECTORNOTICE, INSPHRS, INSPMINS, INSPRES, ISPUBLIC, LOGGEDPERSONNOTICE, METERRESCODE, METERSERVSTAT, MODBY, MODDTTM, NOTIFYCUSTOMER, OOCRES, OOCTYPE, OVERRIDEGLOBALSETTINGFLG, POOLKEY, PORTALDESCRIPTION, PORTALSEARCHKEYWORDS, PRI, PRNUSGHIST, PROBCODE, PROBDESC, PROBGRP, PROBKEY, PROJECT, RESDAYS, RESHRS, RESOLVENOTICE, RESP, SAMEREQUESTTYPEFLG, SCHEDDAYS, SCHEDHRS, SCHEDNOTICE, SEARCHRADIUS, SERVREQASSETTYPE, SHOWINBILLPORTAL, SHOWINPORTAL, SHOWUSAGEDETAILS, STANDARDWORKORDERKEY, STARTDAYS, STARTHRS, STDRES, SUBMITINBILLPORTAL, SUBMITINPORTAL, SUBMITINPORTALPUBLIC, SUSPDAYS, SUSPHRS, VARIATION_ID, WEEKDAY, WEEKEND, WHENTOCREATECASE, WHENTOCREATEINSP, WHENTOCREATEOOC, WHENTOCREATEWO, WOACTIVITY, WORES, 
                    ETL_SEQUENCE_NUMBER,                       
                    etl_load_datetime,
                    etl_load_metadatafilename,
                    etl_is_deleted,
                    ETL_DELETED) 
            values (
                    src.ACCTFLAG, 
                    src.ADDBY, 
                    src.ADDDTTM, 
                    src.ADDRREQD, 
                    src.ALLOWASSETINSP, 
                    src.ALLOWCASE, 
                    src.ALLOWOOC, 
                    src.ALLOWWORKORDER, 
                    src.ASSETINSPTYPE, 
                    src.ASSETREQD, 
                    src.ASSETTYPE, 
                    src.ASSIGNNOTICE, 
                    src.AUTORES, 
                    src.CALLERFLG, 
                    src.CASERES, 
                    src.CASETYPE, 
                    src.CATEGORY, 
                    src.CHECKDUPLICATELOCALONLY, 
                    src.CHKDUPFLG, 
                    src.CORRPROCESSSETUP, 
                    src.CREATEDINLASTXMIN, 
                    src.CUSTFLAG, 
                    src.DATALAKE_DELETED, 
                    src.DETAILPAGE, 
                    src.DPDESC, 
                    src.EFFDATE, 
                    src.EXPDATE, 
                    src.FLLWBYBUS, 
                    src.GISICON, 
                    src.HOLIDAY, 
                    src.HOWTOCREATECASE, 
                    src.HOWTOCREATEINSP, 
                    src.HOWTOCREATEOOC, 
                    src.HOWTOCREATEWO, 
                    src.INCLACCTNUMINOOC, 
                    src.INCLADDRINCASE, 
                    src.INCLADDRINWO, 
                    src.INCLASSETININSP, 
                    src.INCLASSETINWO, 
                    src.INCLCOMMENTSINCASE, 
                    src.INCLCOMMENTSININSP, 
                    src.INCLCOMMENTSINOOC, 
                    src.INCLCOMMENTSINWO, 
                    src.INCLCONTACTINCASE, 
                    src.INCLCONTACTINWO, 
                    src.INCLLOCINCASE, 
                    src.INCLLOCINWO, 
                    src.INSPCTRTY, 
                    src.INSPDAYS, 
                    src.INSPECTNOTICE, 
                    src.INSPECTORNOTICE, 
                    src.INSPHRS, 
                    src.INSPMINS, 
                    src.INSPRES, 
                    src.ISPUBLIC, 
                    src.LOGGEDPERSONNOTICE, 
                    src.METERRESCODE, 
                    src.METERSERVSTAT, 
                    src.MODBY, 
                    src.MODDTTM, 
                    src.NOTIFYCUSTOMER, 
                    src.OOCRES, 
                    src.OOCTYPE, 
                    src.OVERRIDEGLOBALSETTINGFLG, 
                    src.POOLKEY, 
                    src.PORTALDESCRIPTION, 
                    src.PORTALSEARCHKEYWORDS, 
                    src.PRI, 
                    src.PRNUSGHIST, 
                    src.PROBCODE, 
                    src.PROBDESC, 
                    src.PROBGRP, 
                    src.PROBKEY, 
                    src.PROJECT, 
                    src.RESDAYS, 
                    src.RESHRS, 
                    src.RESOLVENOTICE, 
                    src.RESP, 
                    src.SAMEREQUESTTYPEFLG, 
                    src.SCHEDDAYS, 
                    src.SCHEDHRS, 
                    src.SCHEDNOTICE, 
                    src.SEARCHRADIUS, 
                    src.SERVREQASSETTYPE, 
                    src.SHOWINBILLPORTAL, 
                    src.SHOWINPORTAL, 
                    src.SHOWUSAGEDETAILS, 
                    src.STANDARDWORKORDERKEY, 
                    src.STARTDAYS, 
                    src.STARTHRS, 
                    src.STDRES, 
                    src.SUBMITINBILLPORTAL, 
                    src.SUBMITINPORTAL, 
                    src.SUBMITINPORTALPUBLIC, 
                    src.SUSPDAYS, 
                    src.SUSPHRS, 
                    src.VARIATION_ID, 
                    src.WEEKDAY, 
                    src.WEEKEND, 
                    src.WHENTOCREATECASE, 
                    src.WHENTOCREATEINSP, 
                    src.WHENTOCREATEOOC, 
                    src.WHENTOCREATEWO, 
                    src.WOACTIVITY, 
                    src.WORES,     
                    src.ETL_SEQUENCE_NUMBER,
                    CURRENT_TIMESTAMP,
                    src.etl_load_metadatafilename,
                    case when ETL_DELETED=TRUE then TRUE else FALSE end,
                    ETL_DELETED);
    `
} );

                    
//  Get number of rows inserted
        
        var sqlStmt = snowflake.createStatement( {sqlText:  sql_command} );
        var rs = sqlStmt.execute();
        var number_of_rows_inserted = sqlStmt.getNumRowsInserted();
        var number_of_rows_updated =  sqlStmt.getNumRowsUpdated();
                    

        
    snowflake.execute ({sqlText: "commit"});

    log_sql_command = "call datahub_logging.sp_etl_log_ingestion_process('UpdateEnd','" + process_name + "','Success','Completed process execution.', 0 ," + number_of_rows_inserted.toString()+ "," +  number_of_rows_updated.toString() + ");";
    snowflake.execute({sqlText: log_sql_command});

    result = "Success"; 

    }       

    catch (err)  {
        snowflake.execute( {sqlText: "rollback;"} )
        var clean_error_msg = err.message.replace(/[^\w\s]/gi, '');
    //  Create a log entry to say INSERT STATEMENT failed
    
    log_sql_command = "call datahub_logging.sp_etl_log_ingestion_process('UpdateEnd','" + process_name + "','Failed','MERGE Failed. Error:" + err.code.toString()+" : "+ clean_error_msg  + "', 0 ,0,0);";
    snowflake.execute({sqlText: log_sql_command});
        ;
        throw "Failed: " + err.message;   // Return a success/error indicator.
        }
    return result;
    $$;