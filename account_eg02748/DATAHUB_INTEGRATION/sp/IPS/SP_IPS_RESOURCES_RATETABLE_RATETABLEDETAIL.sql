create or replace procedure DATAHUB_INTEGRATION.SP_IPS_RESOURCES_RATETABLE_RATETABLEDETAIL()
    returns varchar not null
                language javascript
                as
                $$

//  Variables

var result = "";                                    // return status of this proc call
const process_name = Object.keys(this)[0];          // name of currently executing process
var number_of_rows_inserted = 0;                             // track number of rows we have inserted
var number_of_rows_updated = 0;                             // track number of rows we have updated


//  Step 1.

//  Start execution - log start

log_sql_command = "call datahub_logging.sp_etl_log_ingestion_process('Insert','" + process_name + "','Running','Started process execution.', 0,0,0);";
snowflake.execute({sqlText: log_sql_command});

snowflake.execute( {sqlText: "begin transaction;"} );
try
    {
        var sql_command = `
                            INSERT INTO LANDING_ERROR.IPS_RAW_ERROR
                            SELECT * FROM LANDING_ERROR.VW_STREAM_IPS_RESOURCES_RATETABLE_RATETABLEDETAIL_ERROR`;
    var sqlStmt = snowflake.createStatement( {sqlText:  sql_command} );
    var rs = sqlStmt.execute();
        
        var sql_command = ` 
                            merge into  DATAHUB_TARGET.IPS_RESOURCES_RATETABLE_RATETABLEDETAIL as target using (SELECT * FROM (SELECT 
            strm.ADDBY, 
            strm.ADDDTTM, 
            strm.BRANCHKEY, 
            strm.CONVERSIONFACTOR, 
            strm.CYCLEDAYS, 
            strm.DELETED, 
            strm.EFFECTIVEDATE, 
            strm.EFFECTIVETODATE, 
            strm.FINALCYCLEDAYS, 
            strm.FORMULAKEY, 
            strm.ISRATECHANGEPRORATIONDISABLED, 
            strm.MAXIMUMCHARGE, 
            strm.MINIMUMCHARGE, 
            strm.MODBY, 
            strm.MODDTTM, 
            strm.MONIKER, 
            strm.NODENAME, 
            strm.NODESOURCE, 
            strm.NUMBEROFSTEPS, 
            strm.PARENTVALUE, 
            strm.PRORATEBASEFLAG, 
            strm.PRORATECYCLEBILLS, 
            strm.PRORATESTEPSFLAG, 
            strm.RANGEVALUE, 
            strm.RATEFORSTEP1, 
            strm.RATEFORSTEP10, 
            strm.RATEFORSTEP2, 
            strm.RATEFORSTEP3, 
            strm.RATEFORSTEP4, 
            strm.RATEFORSTEP5, 
            strm.RATEFORSTEP6, 
            strm.RATEFORSTEP7, 
            strm.RATEFORSTEP8, 
            strm.RATEFORSTEP9, 
            strm.RATEPERUNIT, 
            strm.RATESTEP1, 
            strm.RATESTEP10, 
            strm.RATESTEP2, 
            strm.RATESTEP3, 
            strm.RATESTEP4, 
            strm.RATESTEP5, 
            strm.RATESTEP6, 
            strm.RATESTEP7, 
            strm.RATESTEP8, 
            strm.RATESTEP9, 
            strm.RATETABLEDETAILKEY, 
            strm.RATETABLESETUPKEY, 
            strm.RATETYPE, 
            strm.RECURRINGFLAG, 
            strm.ROUNDPRORATESTEPS, 
            strm.ROUNDUP, 
            strm.SORTORDER, 
            strm.UOM, 
            strm.USEFORPRORATING, 
            strm.USEOVERAGE, 
            strm.VALUE, 
            strm.VARIATION_ID, 
            strm.ETL_SEQUENCE_NUMBER,
            strm.ETL_DELETED,
            strm.etl_load_datetime,
            strm.etl_load_metadatafilename,
            ROW_NUMBER() OVER (PARTITION BY 
            strm.RATETABLEDETAILKEY ORDER BY strm.ETL_SEQUENCE_NUMBER desc,IFNULL(TRY_TO_TIMESTAMP(replace(right(replace(lower(etl_load_metadatafilename),'.json'),23),'_','-'), 'yyyy-mm-dd-HH-MI-SS-FF') ,etl_load_datetime) desc) as ROWNUMBER
        FROM DATAHUB_INTEGRATION.VW_STREAM_IPS_RESOURCES_RATETABLE_RATETABLEDETAIL as  strm
                    )   
            WHERE ROWNUMBER=1  
            
                    ) as src on
            ((target.RATETABLEDETAILKEY=src.RATETABLEDETAILKEY) OR (target.RATETABLEDETAILKEY IS NULL AND src.RATETABLEDETAILKEY IS NULL)) 
                when matched and src.ETL_DELETED=TRUE THEN DELETE
                when matched then update set
                    target.ADDBY=src.ADDBY, 
                    target.ADDDTTM=src.ADDDTTM, 
                    target.BRANCHKEY=src.BRANCHKEY, 
                    target.CONVERSIONFACTOR=src.CONVERSIONFACTOR, 
                    target.CYCLEDAYS=src.CYCLEDAYS, 
                    target.DELETED=src.DELETED, 
                    target.EFFECTIVEDATE=src.EFFECTIVEDATE, 
                    target.EFFECTIVETODATE=src.EFFECTIVETODATE, 
                    target.FINALCYCLEDAYS=src.FINALCYCLEDAYS, 
                    target.FORMULAKEY=src.FORMULAKEY, 
                    target.ISRATECHANGEPRORATIONDISABLED=src.ISRATECHANGEPRORATIONDISABLED, 
                    target.MAXIMUMCHARGE=src.MAXIMUMCHARGE, 
                    target.MINIMUMCHARGE=src.MINIMUMCHARGE, 
                    target.MODBY=src.MODBY, 
                    target.MODDTTM=src.MODDTTM, 
                    target.MONIKER=src.MONIKER, 
                    target.NODENAME=src.NODENAME, 
                    target.NODESOURCE=src.NODESOURCE, 
                    target.NUMBEROFSTEPS=src.NUMBEROFSTEPS, 
                    target.PARENTVALUE=src.PARENTVALUE, 
                    target.PRORATEBASEFLAG=src.PRORATEBASEFLAG, 
                    target.PRORATECYCLEBILLS=src.PRORATECYCLEBILLS, 
                    target.PRORATESTEPSFLAG=src.PRORATESTEPSFLAG, 
                    target.RANGEVALUE=src.RANGEVALUE, 
                    target.RATEFORSTEP1=src.RATEFORSTEP1, 
                    target.RATEFORSTEP10=src.RATEFORSTEP10, 
                    target.RATEFORSTEP2=src.RATEFORSTEP2, 
                    target.RATEFORSTEP3=src.RATEFORSTEP3, 
                    target.RATEFORSTEP4=src.RATEFORSTEP4, 
                    target.RATEFORSTEP5=src.RATEFORSTEP5, 
                    target.RATEFORSTEP6=src.RATEFORSTEP6, 
                    target.RATEFORSTEP7=src.RATEFORSTEP7, 
                    target.RATEFORSTEP8=src.RATEFORSTEP8, 
                    target.RATEFORSTEP9=src.RATEFORSTEP9, 
                    target.RATEPERUNIT=src.RATEPERUNIT, 
                    target.RATESTEP1=src.RATESTEP1, 
                    target.RATESTEP10=src.RATESTEP10, 
                    target.RATESTEP2=src.RATESTEP2, 
                    target.RATESTEP3=src.RATESTEP3, 
                    target.RATESTEP4=src.RATESTEP4, 
                    target.RATESTEP5=src.RATESTEP5, 
                    target.RATESTEP6=src.RATESTEP6, 
                    target.RATESTEP7=src.RATESTEP7, 
                    target.RATESTEP8=src.RATESTEP8, 
                    target.RATESTEP9=src.RATESTEP9, 
                    target.RATETABLEDETAILKEY=src.RATETABLEDETAILKEY, 
                    target.RATETABLESETUPKEY=src.RATETABLESETUPKEY, 
                    target.RATETYPE=src.RATETYPE, 
                    target.RECURRINGFLAG=src.RECURRINGFLAG, 
                    target.ROUNDPRORATESTEPS=src.ROUNDPRORATESTEPS, 
                    target.ROUNDUP=src.ROUNDUP, 
                    target.SORTORDER=src.SORTORDER, 
                    target.UOM=src.UOM, 
                    target.USEFORPRORATING=src.USEFORPRORATING, 
                    target.USEOVERAGE=src.USEOVERAGE, 
                    target.VALUE=src.VALUE, 
                    target.VARIATION_ID=src.VARIATION_ID, 
                    target.ETL_SEQUENCE_NUMBER=src.ETL_SEQUENCE_NUMBER,
                    target.etl_load_datetime=CURRENT_TIMESTAMP,
                    target.etl_load_metadatafilename=src.etl_load_metadatafilename
        when not matched and (src.ETL_DELETED=FALSE OR src.ETL_DELETED IS NULL)  then insert ( 
                    ADDBY, 
                    ADDDTTM, 
                    BRANCHKEY, 
                    CONVERSIONFACTOR, 
                    CYCLEDAYS, 
                    DELETED, 
                    EFFECTIVEDATE, 
                    EFFECTIVETODATE, 
                    FINALCYCLEDAYS, 
                    FORMULAKEY, 
                    ISRATECHANGEPRORATIONDISABLED, 
                    MAXIMUMCHARGE, 
                    MINIMUMCHARGE, 
                    MODBY, 
                    MODDTTM, 
                    MONIKER, 
                    NODENAME, 
                    NODESOURCE, 
                    NUMBEROFSTEPS, 
                    PARENTVALUE, 
                    PRORATEBASEFLAG, 
                    PRORATECYCLEBILLS, 
                    PRORATESTEPSFLAG, 
                    RANGEVALUE, 
                    RATEFORSTEP1, 
                    RATEFORSTEP10, 
                    RATEFORSTEP2, 
                    RATEFORSTEP3, 
                    RATEFORSTEP4, 
                    RATEFORSTEP5, 
                    RATEFORSTEP6, 
                    RATEFORSTEP7, 
                    RATEFORSTEP8, 
                    RATEFORSTEP9, 
                    RATEPERUNIT, 
                    RATESTEP1, 
                    RATESTEP10, 
                    RATESTEP2, 
                    RATESTEP3, 
                    RATESTEP4, 
                    RATESTEP5, 
                    RATESTEP6, 
                    RATESTEP7, 
                    RATESTEP8, 
                    RATESTEP9, 
                    RATETABLEDETAILKEY, 
                    RATETABLESETUPKEY, 
                    RATETYPE, 
                    RECURRINGFLAG, 
                    ROUNDPRORATESTEPS, 
                    ROUNDUP, 
                    SORTORDER, 
                    UOM, 
                    USEFORPRORATING, 
                    USEOVERAGE, 
                    VALUE, 
                    VARIATION_ID, 
                    ETL_SEQUENCE_NUMBER,                       
                    etl_load_datetime,
                    etl_load_metadatafilename) 
            values (
                    src.ADDBY, 
                    src.ADDDTTM, 
                    src.BRANCHKEY, 
                    src.CONVERSIONFACTOR, 
                    src.CYCLEDAYS, 
                    src.DELETED, 
                    src.EFFECTIVEDATE, 
                    src.EFFECTIVETODATE, 
                    src.FINALCYCLEDAYS, 
                    src.FORMULAKEY, 
                    src.ISRATECHANGEPRORATIONDISABLED, 
                    src.MAXIMUMCHARGE, 
                    src.MINIMUMCHARGE, 
                    src.MODBY, 
                    src.MODDTTM, 
                    src.MONIKER, 
                    src.NODENAME, 
                    src.NODESOURCE, 
                    src.NUMBEROFSTEPS, 
                    src.PARENTVALUE, 
                    src.PRORATEBASEFLAG, 
                    src.PRORATECYCLEBILLS, 
                    src.PRORATESTEPSFLAG, 
                    src.RANGEVALUE, 
                    src.RATEFORSTEP1, 
                    src.RATEFORSTEP10, 
                    src.RATEFORSTEP2, 
                    src.RATEFORSTEP3, 
                    src.RATEFORSTEP4, 
                    src.RATEFORSTEP5, 
                    src.RATEFORSTEP6, 
                    src.RATEFORSTEP7, 
                    src.RATEFORSTEP8, 
                    src.RATEFORSTEP9, 
                    src.RATEPERUNIT, 
                    src.RATESTEP1, 
                    src.RATESTEP10, 
                    src.RATESTEP2, 
                    src.RATESTEP3, 
                    src.RATESTEP4, 
                    src.RATESTEP5, 
                    src.RATESTEP6, 
                    src.RATESTEP7, 
                    src.RATESTEP8, 
                    src.RATESTEP9, 
                    src.RATETABLEDETAILKEY, 
                    src.RATETABLESETUPKEY, 
                    src.RATETYPE, 
                    src.RECURRINGFLAG, 
                    src.ROUNDPRORATESTEPS, 
                    src.ROUNDUP, 
                    src.SORTORDER, 
                    src.UOM, 
                    src.USEFORPRORATING, 
                    src.USEOVERAGE, 
                    src.VALUE, 
                    src.VARIATION_ID,     
                    src.ETL_SEQUENCE_NUMBER,
                    CURRENT_TIMESTAMP,
                    src.etl_load_metadatafilename);`;

    var sqlStmt = snowflake.createStatement( {sqlText:  sql_command} );
    var rs = sqlStmt.execute();

    snowflake.execute( {sqlText: `merge into DATAHUB_TARGET_HISTORY.IPS_DELETED_RESOURCES_RATETABLE_RATETABLEDETAIL as target using (
                SELECT * FROM (SELECT 
            strm.ADDBY, 
            strm.ADDDTTM, 
            strm.BRANCHKEY, 
            strm.CONVERSIONFACTOR, 
            strm.CYCLEDAYS, 
            strm.DELETED, 
            strm.EFFECTIVEDATE, 
            strm.EFFECTIVETODATE, 
            strm.FINALCYCLEDAYS, 
            strm.FORMULAKEY, 
            strm.ISRATECHANGEPRORATIONDISABLED, 
            strm.MAXIMUMCHARGE, 
            strm.MINIMUMCHARGE, 
            strm.MODBY, 
            strm.MODDTTM, 
            strm.MONIKER, 
            strm.NODENAME, 
            strm.NODESOURCE, 
            strm.NUMBEROFSTEPS, 
            strm.PARENTVALUE, 
            strm.PRORATEBASEFLAG, 
            strm.PRORATECYCLEBILLS, 
            strm.PRORATESTEPSFLAG, 
            strm.RANGEVALUE, 
            strm.RATEFORSTEP1, 
            strm.RATEFORSTEP10, 
            strm.RATEFORSTEP2, 
            strm.RATEFORSTEP3, 
            strm.RATEFORSTEP4, 
            strm.RATEFORSTEP5, 
            strm.RATEFORSTEP6, 
            strm.RATEFORSTEP7, 
            strm.RATEFORSTEP8, 
            strm.RATEFORSTEP9, 
            strm.RATEPERUNIT, 
            strm.RATESTEP1, 
            strm.RATESTEP10, 
            strm.RATESTEP2, 
            strm.RATESTEP3, 
            strm.RATESTEP4, 
            strm.RATESTEP5, 
            strm.RATESTEP6, 
            strm.RATESTEP7, 
            strm.RATESTEP8, 
            strm.RATESTEP9, 
            strm.RATETABLEDETAILKEY, 
            strm.RATETABLESETUPKEY, 
            strm.RATETYPE, 
            strm.RECURRINGFLAG, 
            strm.ROUNDPRORATESTEPS, 
            strm.ROUNDUP, 
            strm.SORTORDER, 
            strm.UOM, 
            strm.USEFORPRORATING, 
            strm.USEOVERAGE, 
            strm.VALUE, 
            strm.VARIATION_ID, 
            strm.ETL_SEQUENCE_NUMBER,
            strm.ETL_DELETED,
            strm.etl_load_datetime,
            strm.etl_load_metadatafilename,
            ROW_NUMBER() OVER (PARTITION BY 
            strm.RATETABLEDETAILKEY ORDER BY strm.ETL_SEQUENCE_NUMBER desc,IFNULL(TRY_TO_TIMESTAMP(replace(right(replace(lower(etl_load_metadatafilename),'.json'),23),'_','-'), 'yyyy-mm-dd-HH-MI-SS-FF') ,etl_load_datetime) desc) as ROWNUMBER
        FROM DATAHUB_INTEGRATION.VW_STREAM_IPS_RESOURCES_RATETABLE_RATETABLEDETAIL as  strm
        WHERE strm.ETL_DELETED=TRUE
                    )   
            WHERE ROWNUMBER=1  
            
                    ) as src on
            ((target.RATETABLEDETAILKEY=src.RATETABLEDETAILKEY) OR (target.RATETABLEDETAILKEY IS NULL AND src.RATETABLEDETAILKEY IS NULL)) 
                when matched then update set
                    target.ADDBY=src.ADDBY, 
                    target.ADDDTTM=src.ADDDTTM, 
                    target.BRANCHKEY=src.BRANCHKEY, 
                    target.CONVERSIONFACTOR=src.CONVERSIONFACTOR, 
                    target.CYCLEDAYS=src.CYCLEDAYS, 
                    target.DELETED=src.DELETED, 
                    target.EFFECTIVEDATE=src.EFFECTIVEDATE, 
                    target.EFFECTIVETODATE=src.EFFECTIVETODATE, 
                    target.FINALCYCLEDAYS=src.FINALCYCLEDAYS, 
                    target.FORMULAKEY=src.FORMULAKEY, 
                    target.ISRATECHANGEPRORATIONDISABLED=src.ISRATECHANGEPRORATIONDISABLED, 
                    target.MAXIMUMCHARGE=src.MAXIMUMCHARGE, 
                    target.MINIMUMCHARGE=src.MINIMUMCHARGE, 
                    target.MODBY=src.MODBY, 
                    target.MODDTTM=src.MODDTTM, 
                    target.MONIKER=src.MONIKER, 
                    target.NODENAME=src.NODENAME, 
                    target.NODESOURCE=src.NODESOURCE, 
                    target.NUMBEROFSTEPS=src.NUMBEROFSTEPS, 
                    target.PARENTVALUE=src.PARENTVALUE, 
                    target.PRORATEBASEFLAG=src.PRORATEBASEFLAG, 
                    target.PRORATECYCLEBILLS=src.PRORATECYCLEBILLS, 
                    target.PRORATESTEPSFLAG=src.PRORATESTEPSFLAG, 
                    target.RANGEVALUE=src.RANGEVALUE, 
                    target.RATEFORSTEP1=src.RATEFORSTEP1, 
                    target.RATEFORSTEP10=src.RATEFORSTEP10, 
                    target.RATEFORSTEP2=src.RATEFORSTEP2, 
                    target.RATEFORSTEP3=src.RATEFORSTEP3, 
                    target.RATEFORSTEP4=src.RATEFORSTEP4, 
                    target.RATEFORSTEP5=src.RATEFORSTEP5, 
                    target.RATEFORSTEP6=src.RATEFORSTEP6, 
                    target.RATEFORSTEP7=src.RATEFORSTEP7, 
                    target.RATEFORSTEP8=src.RATEFORSTEP8, 
                    target.RATEFORSTEP9=src.RATEFORSTEP9, 
                    target.RATEPERUNIT=src.RATEPERUNIT, 
                    target.RATESTEP1=src.RATESTEP1, 
                    target.RATESTEP10=src.RATESTEP10, 
                    target.RATESTEP2=src.RATESTEP2, 
                    target.RATESTEP3=src.RATESTEP3, 
                    target.RATESTEP4=src.RATESTEP4, 
                    target.RATESTEP5=src.RATESTEP5, 
                    target.RATESTEP6=src.RATESTEP6, 
                    target.RATESTEP7=src.RATESTEP7, 
                    target.RATESTEP8=src.RATESTEP8, 
                    target.RATESTEP9=src.RATESTEP9, 
                    target.RATETABLEDETAILKEY=src.RATETABLEDETAILKEY, 
                    target.RATETABLESETUPKEY=src.RATETABLESETUPKEY, 
                    target.RATETYPE=src.RATETYPE, 
                    target.RECURRINGFLAG=src.RECURRINGFLAG, 
                    target.ROUNDPRORATESTEPS=src.ROUNDPRORATESTEPS, 
                    target.ROUNDUP=src.ROUNDUP, 
                    target.SORTORDER=src.SORTORDER, 
                    target.UOM=src.UOM, 
                    target.USEFORPRORATING=src.USEFORPRORATING, 
                    target.USEOVERAGE=src.USEOVERAGE, 
                    target.VALUE=src.VALUE, 
                    target.VARIATION_ID=src.VARIATION_ID, 
                    target.ETL_SEQUENCE_NUMBER=src.ETL_SEQUENCE_NUMBER,
                    target.etl_load_datetime=CURRENT_TIMESTAMP,
                    target.etl_load_metadatafilename=src.etl_load_metadatafilename,
                    target.ETL_DELETED=src.ETL_DELETED
        when not matched   then insert ( ADDBY, ADDDTTM, BRANCHKEY, CONVERSIONFACTOR, CYCLEDAYS, DELETED, EFFECTIVEDATE, EFFECTIVETODATE, FINALCYCLEDAYS, FORMULAKEY, ISRATECHANGEPRORATIONDISABLED, MAXIMUMCHARGE, MINIMUMCHARGE, MODBY, MODDTTM, MONIKER, NODENAME, NODESOURCE, NUMBEROFSTEPS, PARENTVALUE, PRORATEBASEFLAG, PRORATECYCLEBILLS, PRORATESTEPSFLAG, RANGEVALUE, RATEFORSTEP1, RATEFORSTEP10, RATEFORSTEP2, RATEFORSTEP3, RATEFORSTEP4, RATEFORSTEP5, RATEFORSTEP6, RATEFORSTEP7, RATEFORSTEP8, RATEFORSTEP9, RATEPERUNIT, RATESTEP1, RATESTEP10, RATESTEP2, RATESTEP3, RATESTEP4, RATESTEP5, RATESTEP6, RATESTEP7, RATESTEP8, RATESTEP9, RATETABLEDETAILKEY, RATETABLESETUPKEY, RATETYPE, RECURRINGFLAG, ROUNDPRORATESTEPS, ROUNDUP, SORTORDER, UOM, USEFORPRORATING, USEOVERAGE, VALUE, VARIATION_ID, 
                    ETL_SEQUENCE_NUMBER,                       
                    etl_load_datetime,
                    etl_load_metadatafilename,
                    etl_is_deleted,
                    ETL_DELETED) 
            values (
                    src.ADDBY, 
                    src.ADDDTTM, 
                    src.BRANCHKEY, 
                    src.CONVERSIONFACTOR, 
                    src.CYCLEDAYS, 
                    src.DELETED, 
                    src.EFFECTIVEDATE, 
                    src.EFFECTIVETODATE, 
                    src.FINALCYCLEDAYS, 
                    src.FORMULAKEY, 
                    src.ISRATECHANGEPRORATIONDISABLED, 
                    src.MAXIMUMCHARGE, 
                    src.MINIMUMCHARGE, 
                    src.MODBY, 
                    src.MODDTTM, 
                    src.MONIKER, 
                    src.NODENAME, 
                    src.NODESOURCE, 
                    src.NUMBEROFSTEPS, 
                    src.PARENTVALUE, 
                    src.PRORATEBASEFLAG, 
                    src.PRORATECYCLEBILLS, 
                    src.PRORATESTEPSFLAG, 
                    src.RANGEVALUE, 
                    src.RATEFORSTEP1, 
                    src.RATEFORSTEP10, 
                    src.RATEFORSTEP2, 
                    src.RATEFORSTEP3, 
                    src.RATEFORSTEP4, 
                    src.RATEFORSTEP5, 
                    src.RATEFORSTEP6, 
                    src.RATEFORSTEP7, 
                    src.RATEFORSTEP8, 
                    src.RATEFORSTEP9, 
                    src.RATEPERUNIT, 
                    src.RATESTEP1, 
                    src.RATESTEP10, 
                    src.RATESTEP2, 
                    src.RATESTEP3, 
                    src.RATESTEP4, 
                    src.RATESTEP5, 
                    src.RATESTEP6, 
                    src.RATESTEP7, 
                    src.RATESTEP8, 
                    src.RATESTEP9, 
                    src.RATETABLEDETAILKEY, 
                    src.RATETABLESETUPKEY, 
                    src.RATETYPE, 
                    src.RECURRINGFLAG, 
                    src.ROUNDPRORATESTEPS, 
                    src.ROUNDUP, 
                    src.SORTORDER, 
                    src.UOM, 
                    src.USEFORPRORATING, 
                    src.USEOVERAGE, 
                    src.VALUE, 
                    src.VARIATION_ID,     
                    src.ETL_SEQUENCE_NUMBER,
                    CURRENT_TIMESTAMP,
                    src.etl_load_metadatafilename,
                    case when ETL_DELETED=TRUE then TRUE else FALSE end,
                    ETL_DELETED);
    `
} );

                    
//  Get number of rows inserted
        
        var sqlStmt = snowflake.createStatement( {sqlText:  sql_command} );
        var rs = sqlStmt.execute();
        var number_of_rows_inserted = sqlStmt.getNumRowsInserted();
        var number_of_rows_updated =  sqlStmt.getNumRowsUpdated();
                    

        
    snowflake.execute ({sqlText: "commit"});

    log_sql_command = "call datahub_logging.sp_etl_log_ingestion_process('UpdateEnd','" + process_name + "','Success','Completed process execution.', 0 ," + number_of_rows_inserted.toString()+ "," +  number_of_rows_updated.toString() + ");";
    snowflake.execute({sqlText: log_sql_command});

    result = "Success"; 

    }       

    catch (err)  {
        snowflake.execute( {sqlText: "rollback;"} )
        var clean_error_msg = err.message.replace(/[^\w\s]/gi, '');
    //  Create a log entry to say INSERT STATEMENT failed
    
    log_sql_command = "call datahub_logging.sp_etl_log_ingestion_process('UpdateEnd','" + process_name + "','Failed','MERGE Failed. Error:" + err.code.toString()+" : "+ clean_error_msg  + "', 0 ,0,0);";
    snowflake.execute({sqlText: log_sql_command});
        ;
        throw "Failed: " + err.message;   // Return a success/error indicator.
        }
    return result;
    $$;